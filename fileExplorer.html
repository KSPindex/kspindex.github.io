<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete File Explorer v6.0 - Index-Space</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-background: #0D1117;
            --color-text-primary: #E6EDF3;
            --color-text-secondary: #8B949E;
            --color-surface-1: #161B22;
            --color-surface-2: #0D1117;
            --color-border: #30363D;
            --color-accent: #58A6FF;
            --color-selection-bg: rgba(88, 166, 255, 0.2);
            --color-modal-bg: rgba(13, 17, 23, 0.9);
            --color-danger: #DA3633;
            --color-success: #238636;
            --color-warning: #D29922;
            --font-primary: 'Inter', 'Segoe UI', 'Helvetica Neue', 'Arial', sans-serif;
            --font-mono: 'JetBrains Mono', 'Consolas', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body { 
            width: 100%; height: 100%; overflow: hidden; 
            background-color: var(--color-background); color: var(--color-text-primary); 
            font-family: var(--font-primary); user-select: none; 
        }

        .app-container { 
            display: flex; flex-direction: column; width: 100%; height: 100%; 
            background-color: var(--color-surface-1); 
        }

        /* Toolbar Styles */
        .explorer-toolbar { 
            display: flex; align-items: center; padding: 8px; 
            border-bottom: 1px solid var(--color-border); gap: 8px; 
            background: linear-gradient(135deg, var(--color-surface-2), #1a1f26);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .nav-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--color-border); 
            color: var(--color-text-secondary); border-radius: 8px; 
            width: 32px; height: 32px; cursor: pointer; font-size: 1.1rem; 
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s ease;
        }

        .nav-btn:hover:not(:disabled) { 
            background: var(--color-accent); color: white; 
            transform: translateY(-1px); box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
        }

        .nav-btn:disabled { 
            color: #444; cursor: not-allowed; opacity: 0.5;
        }

        .path-bar { 
            flex-grow: 1; background: rgba(13, 17, 23, 0.8); 
            border: 1px solid var(--color-border); border-radius: 8px; 
            padding: 8px 12px; font-size: 0.9em; color: var(--color-text-primary);
            font-family: var(--font-mono);
            transition: all 0.2s ease;
        }

        .path-bar:focus {
            outline: none; border-color: var(--color-accent);
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
        }

        /* Main Content */
        .explorer-body { 
            display: flex; flex-grow: 1; height: calc(100% - 57px - 30px); 
        }

        .sidebar {
            width: 250px; background: var(--color-surface-2);
            border-right: 1px solid var(--color-border);
            padding: 16px; overflow-y: auto;
        }

        .sidebar h3 {
            color: var(--color-text-secondary);
            font-size: 0.85rem; font-weight: 500;
            margin-bottom: 12px; text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .quick-access-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
            margin-bottom: 4px; transition: all 0.2s ease;
        }
        
        .quick-access-item:hover, .quick-access-item.active {
            background: rgba(255,255,255,0.1);
        }

        .explorer-main { 
            flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; 
        }

        .view-controls {
            display: flex; align-items: center; padding: 12px 16px;
            background: var(--color-surface-2); border-bottom: 1px solid var(--color-border);
            gap: 12px;
        }

        .view-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--color-border);
            color: var(--color-text-secondary); border-radius: 6px;
            padding: 6px 12px; cursor: pointer; font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .view-btn.active, .view-btn:hover {
            background: var(--color-accent); color: white;
        }
        
        .search-box {
            background: rgba(13, 17, 23, 0.6); border: 1px solid var(--color-border);
            border-radius: 6px; padding: 6px 12px; color: var(--color-text-primary);
            font-size: 0.85rem; width: 200px; margin-left: auto;
        }
        
        .search-box:focus {
            outline: none; border-color: var(--color-accent);
        }

        .content-area { 
            flex-grow: 1; overflow-y: auto; padding: 16px;
            background: var(--color-background);
        }
        
        /* File Items */
        .file-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 16px;
        }

        .file-list {
            display: flex; flex-direction: column; gap: 2px;
        }

        .file-item { 
            display: flex; padding: 12px; border-radius: 8px; 
            border: 2px solid transparent; cursor: pointer; 
            align-items: center; gap: 12px; position: relative;
            transition: all 0.2s ease;
            background: rgba(255,255,255,0.02);
        }
        
        .file-item:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-1px);
        }
        
        .file-item.selected { 
            background: var(--color-selection-bg); 
            border-color: var(--color-accent);
            box-shadow: 0 4px 16px rgba(88, 166, 255, 0.3);
        }
        
        .file-item.drag-over {
             border: 2px dashed var(--color-accent) !important;
        }

        .file-item-icon { 
            font-size: 2.5em; text-align: center;
            width: 60px; height: 60px; display: flex;
            align-items: center; justify-content: center;
        }

        .file-list .file-item-icon {
            font-size: 1.8em; width: 32px; height: 32px;
        }
        
        .file-item-details {
            flex-grow: 1; min-width: 0;
        }
        
        .file-item-name { 
            font-size: 0.9em; font-weight: 500;
            word-break: break-all; margin-bottom: 4px;
        }
        
        .file-list .file-item-name {
            margin-bottom: 0;
        }

        .file-item-name.renaming {
            background: white; color: black; outline: none; padding: 2px 4px;
            border-radius: 4px; border: 1px solid var(--color-accent);
        }
        
        .file-item-meta {
            font-size: 0.75em; color: var(--color-text-secondary);
            display: flex; gap: 12px;
        }
        
        .file-grid .file-item {
            flex-direction: column; text-align: center;
            padding: 16px 8px;
        }
        
        .file-grid .file-item-details {
            width: 100%;
        }
        
        .file-grid .file-item-name {
            margin-bottom: 8px;
        }

        /* Status Bar */
        .explorer-statusbar { 
            height: 30px; background: var(--color-surface-2); 
            border-top: 1px solid var(--color-border); 
            padding: 0 16px; font-size: 0.8rem; color: var(--color-text-secondary); 
            display: flex; align-items: center; justify-content: space-between;
        }

        /* Context Menu */
        .context-menu { 
            position: fixed; background: #21262d; 
            border: 1px solid var(--color-border); border-radius: 8px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.4); padding: 6px; 
            z-index: 10001; opacity: 0; transform: scale(0.95); 
            transition: all 0.15s ease-out; pointer-events: none;
            backdrop-filter: blur(8px);
        }
        
        .context-menu.visible { 
            opacity: 1; transform: scale(1); pointer-events: auto; 
        }
        
        .context-menu-item { 
            padding: 10px 16px; cursor: pointer; border-radius: 6px; 
            white-space: nowrap; display: flex; align-items: center; gap: 10px;
            font-size: 0.85rem; transition: all 0.1s ease;
        }
        
        .context-menu-item:hover:not(.disabled) { 
            background: var(--color-accent); color: white;
        }
        
        .context-menu-item.disabled {
            color: var(--color-text-secondary); cursor: not-allowed;
            opacity: 0.5;
        }
        
        .context-menu-divider { 
            height: 1px; background: var(--color-border); 
            margin: 6px 8px; 
        }

        /* Modal */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--color-modal-bg); backdrop-filter: blur(8px); 
            z-index: 20000; display: flex; justify-content: center; align-items: center;
            animation: fadeIn 0.2s ease-out;
        }
        
        .modal-dialog { 
            background: var(--color-surface-1); padding: 2rem; border-radius: 12px; 
            border: 1px solid var(--color-border); text-align: center; 
            max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
            box-shadow: 0 16px 64px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out;
        }
        
        .modal-dialog h3 {
            margin-bottom: 1rem; color: var(--color-text-primary);
        }
        
        .modal-dialog p { 
            margin-bottom: 1.5rem; color: var(--color-text-secondary);
        }
        
        .modal-dialog button { 
            background: var(--color-surface-2); border: 1px solid var(--color-border); 
            color: var(--color-text-primary); padding: 10px 20px; border-radius: 6px; 
            cursor: pointer; margin: 0 8px; font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        
        .modal-dialog button:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .modal-dialog .primary-btn { 
            background: var(--color-accent); border-color: var(--color-accent);
        }
        
        .modal-dialog .danger-btn { 
            background: var(--color-danger); border-color: var(--color-danger);
        }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-20px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        
        /* Drag and Drop */
        .drag-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(88, 166, 255, 0.1); z-index: 9999;
            display: none; align-items: center; justify-content: center;
            border: 3px dashed var(--color-accent);
        }
        
        .drag-overlay.active { display: flex; }
        
        .drag-message {
            background: var(--color-surface-1); padding: 2rem;
            border-radius: 12px; border: 2px solid var(--color-accent);
            font-size: 1.2rem; color: var(--color-accent);
        }

        /* Utility */
        .hidden { display: none !important; }

    </style>
</head>
<body>
    <main id="app-container" class="app-container"></main>
    <div id="context-menu-container"></div>
    <div id="modal-container"></div>
    <input type="file" id="file-uploader" multiple class="hidden" />
    <a id="file-downloader" class="hidden"></a>
    <div id="drag-overlay" class="drag-overlay">
        <div class="drag-message">📁 Drop files here to upload</div>
    </div>

    <script>
    /**
     * Complete File Explorer v6.0 - Final Script
     * A fully-featured, browser-only file explorer with advanced capabilities.
     */
    const App = {
        init() {
            this.dom = {
                appContainer: document.getElementById('app-container'),
                contextMenuContainer: document.getElementById('context-menu-container'),
                modalContainer: document.getElementById('modal-container'),
                fileUploader: document.getElementById('file-uploader'),
                fileDownloader: document.getElementById('file-downloader'),
                dragOverlay: document.getElementById('drag-overlay')
            };
            this.VFS.init().then(() => {
                this.ContextMenu.init(this);
                this.Modal.init(this);
                this.DragDrop.init(this);
                this.FileExplorer.init(this);
            });
        }
    };

    App.VFS = { /* Complete VFS Logic - See previous versions for full implementation */
        DB_NAME: 'IndexSpace_VFS_v6', db: null,
        init() { return new Promise((resolve, reject) => { const req = indexedDB.open(this.DB_NAME, 1); req.onupgradeneeded = e => { const db = e.target.result; if (!db.objectStoreNames.contains('nodes')) { const store = db.createObjectStore('nodes', { keyPath: 'id' }); store.createIndex('path', ['parentId', 'name'], { unique: true }); }}; req.onsuccess = async e => { this.db = e.target.result; await this.initDefaultFS(); resolve(); }; req.onerror = reject; }); },
        async initDefaultFS() { if (!(await this.getNodeByPath('/'))) { await this.mkdir('/'); await this.mkdir('/Home'); await this.mkdir('/Documents'); await this.write('/Documents/README.txt', 'Welcome!'); await this.mkdir('/.trash'); } },
        async _runTx(storeName, mode, operation) { return new Promise((resolve, reject) => { const tx = this.db.transaction(storeName, mode); const store = tx.objectStore(storeName); let req; try { req = operation(store); } catch (e) { reject(e); return; } tx.oncomplete = () => resolve(req ? req.result : undefined); tx.onerror = () => reject(tx.error); tx.onabort = () => reject(tx.error); }); },
        async _getNewId() { return `node-${Date.now()}-${Math.random()}`; },
        async mkdir(path) { if (path === '/') { return this._runTx('nodes', 'readwrite', s => s.add({ id: '/', type: 'folder' })); } const { parentPath, name } = this._parsePath(path); const parent = await this.getNodeByPath(parentPath); if (!parent || parent.type !== 'folder') throw new Error(`Invalid path`); const id = await this._getNewId(); await this._runTx('nodes', 'readwrite', s => s.add({ id, parentId: parent.id, name, type: 'folder', ctime: new Date(), mtime: new Date(), size: 0 })); return id; },
        async write(path, content = '') { const { parentPath, name } = this._parsePath(path); const parent = await this.getNodeByPath(parentPath); if (!parent || parent.type !== 'folder') throw new Error(`Parent not found`); const id = await this._getNewId(); const size = content instanceof Blob ? content.size : new Blob([String(content)]).size; await this._runTx('nodes', 'readwrite', s => s.add({ id, parentId: parent.id, name, type: 'file', content, size, ctime: new Date(), mtime: new Date() })); return id; },
        async list(path) { const p = await this.getNodeByPath(path); if (!p) return []; return this._runTx('nodes', 'readonly', s => s.index('path').getAll(IDBKeyRange.bound([p.id, ''], [p.id, '\uffff']))); },
        async delete(id) { const n = await this.getNode(id); if (!n) return; if (n.type === 'folder') { const c = await this.list(await this.constructPath(id)); for (const i of c) await this.delete(i.id); } await this._runTx('nodes', 'readwrite', s => s.delete(id)); },
        async rename(id, newName) { await this._runTx('nodes', 'readwrite', s => { s.get(id).onsuccess = e => { const n = e.target.result; n.name = newName; n.mtime = new Date(); s.put(n); } }); },
        async move(id, newParentPath) { const p = await this.getNodeByPath(newParentPath); if (!p || p.type !== 'folder') throw new Error(`Invalid target`); await this._runTx('nodes', 'readwrite', s => { s.get(id).onsuccess = e => { const n = e.target.result; n.parentId = p.id; n.mtime = new Date(); s.put(n); } }); },
        async copy(id, newParentPath) { const n = await this.getNode(id); if(!n) return; const np = `${newParentPath==='/'?'':newParentPath}/${n.name}`; if (n.type === 'folder') { const nfid = await this.mkdir(np); const c = await this.list(await this.constructPath(id)); for (const i of c) await this.copy(i.id, await this.constructPath(nfid)); } else { await this.write(np, n.content); } },
        async getNode(id) { return this._runTx('nodes', 'readonly', s => s.get(id)); },
        async getNodeByPath(path) { if (path === '/') return this.getNode('/'); let pid = '/'; let n = null; for (const name of path.split('/').filter(p => p)) { n = await this._runTx('nodes', 'readonly', s => s.index('path').get([pid, name])); if (!n) return null; pid = n.id; } return n; },
        async constructPath(id) { if (id === '/') return '/'; let p = []; let n = await this.getNode(id); while (n && n.parentId) { p.unshift(n.name); if (n.parentId === '/') break; n = await this.getNode(n.parentId); } return `/${p.join('/')}`; },
        _parsePath(path) { const p = path.split('/').filter(Boolean); const n = p.pop() || ''; const pp = `/${p.join('/')}`; return { parentPath: pp, name: n }; },
    };

    App.ContextMenu = { init(app) { this.app = app; this.container = app.dom.contextMenuContainer; window.addEventListener('click', () => this.hide(), true); this.container.addEventListener('contextmenu', e=>e.stopPropagation()); }, show(x, y, items) { this.hide(); const menu = document.createElement('div'); menu.className = 'context-menu'; menu.style.left = `${x}px`; menu.style.top = `${y}px`; items.forEach(item => { if (!item) { menu.appendChild(document.createElement('div')).className = 'context-menu-divider'; return; } const itemEl = document.createElement('div'); itemEl.className = `context-menu-item ${item.disabled ? 'disabled' : ''}`; itemEl.textContent = item.label; if (!item.disabled) itemEl.onclick = e => { e.stopPropagation(); this.hide(); item.action(); }; menu.appendChild(itemEl); }); this.container.appendChild(menu); setTimeout(() => menu.classList.add('visible'), 0); }, hide() { this.container.innerHTML = ''; } };
    App.Modal = { init(app) { this.app = app; this.container = app.dom.modalContainer; }, confirm({ title, message, onConfirm }) { this.container.innerHTML = `<div class="modal-overlay"><div class="modal-dialog"><h3>${title}</h3><p>${message}</p><button class="cancel-btn">Cancel</button><button class="confirm-btn danger-btn">Confirm</button></div></div>`; this.container.querySelector('.cancel-btn').onclick = () => this.container.innerHTML = ''; this.container.querySelector('.confirm-btn').onclick = () => { this.container.innerHTML = ''; onConfirm(); }; } };
    
    App.DragDrop = {
        init(app) {
            this.app = app;
            this.overlay = app.dom.dragOverlay;
            window.addEventListener('dragenter', e => this.onDragEnter(e));
            this.overlay.addEventListener('dragleave', e => this.onDragLeave(e));
            this.overlay.addEventListener('dragover', e => e.preventDefault());
            this.overlay.addEventListener('drop', e => this.onDrop(e));
        },
        onDragEnter(e) { e.preventDefault(); this.overlay.classList.add('active'); },
        onDragLeave(e) { if(e.target === this.overlay) this.overlay.classList.remove('active'); },
        async onDrop(e) {
            e.preventDefault();
            this.overlay.classList.remove('active');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                await this.app.FileExplorer.uploadFiles(files);
            }
        }
    };
    
    App.FileExplorer = {
        init(app) {
            this.app = app; this.currentPath = '/'; this.selection = new Set(); this.clipboard = { mode: null, itemIds: [] }; this.history = ['/']; this.historyIndex = 0; this.sort = { key: 'name', order: 'asc' }; this.items = []; this.lastClickedId = null;
            this.app.dom.appContainer.innerHTML = `<div class="explorer-toolbar"><button class="nav-btn back-btn" title="Back">←</button><button class="nav-btn fwd-btn" title="Forward">→</button><button class="nav-btn up-btn" title="Up">↑</button><input type="text" class="path-bar" /><input type="search" class="search-bar" placeholder="Search..." /><button class="nav-btn upload-btn" title="Upload">📥</button></div><div class="explorer-body"><div class="sidebar"><h3>Favorites</h3><div class="quick-access-item" data-path="/Home">🏠 Home</div><div class="quick-access-item" data-path="/Documents">📄 Documents</div></div><div class="explorer-main"><div class="content-area"></div></div></div><div class="explorer-statusbar"></div>`;
            this.dom = { sidebar: app.dom.appContainer.querySelector('.sidebar'), pathBar: app.dom.appContainer.querySelector('.path-bar'), searchBar: app.dom.appContainer.querySelector('.search-bar'), contentArea: app.dom.appContainer.querySelector('.content-area'), statusBar: app.dom.appContainer.querySelector('.explorer-statusbar'), toolbar: app.dom.appContainer.querySelector('.explorer-toolbar'), };
            this.render(); this.bindEvents();
        },
        async render() {
            let items = await this.app.VFS.list(this.currentPath);
            const searchTerm = this.dom.searchBar.value.toLowerCase();
            if (searchTerm) items = items.filter(item => item.name.toLowerCase().includes(searchTerm));
            items.sort((a, b) => { const valA = a[this.sort.key]||0; const valB = b[this.sort.key]||0; const comparison = typeof valA === 'string' ? valA.localeCompare(valB) : valA > valB ? 1 : -1; return this.sort.order === 'desc' ? comparison * -1 : comparison; });
            this.items = items; this.dom.contentArea.innerHTML = '';
            this.dom.contentArea.appendChild(this.createListHeaderElement());
            items.forEach(item => this.dom.contentArea.appendChild(this.createItemElement(item)));
            this.dom.pathBar.value = this.currentPath;
            this.updateNavButtons(); this.updateStatusBar(); this.updateSelection();
        },
        createListHeaderElement() { const h = document.createElement('div'); h.className = 'list-header'; h.innerHTML = `<div class="list-header-item list-col-name" data-sort-key="name">Name</div><div class="list-header-item list-col-size" data-sort-key="size">Size</div><div class="list-header-item list-col-date" data-sort-key="mtime">Date Modified</div>`; const c = h.querySelector(`[data-sort-key="${this.sort.key}"]`); if(c) c.classList.add(this.sort.order === 'asc' ? 'sort-asc' : 'sort-desc'); return h; },
        createItemElement(item) { const e = document.createElement('div'); e.className = 'file-item file-list'; e.dataset.id = item.id; e.draggable = true; e.innerHTML = `<div class="file-item-icon">${this.getIcon(item)}</div><div class="file-item-name">${item.name}</div><div class="file-item-meta list-col-size">${item.type === 'file' ? this.formatBytes(item.size) : '—'}</div><div class="file-item-meta list-col-date">${new Date(item.mtime).toLocaleString()}</div>`; return e; },
        bindEvents() {
            const t = this.dom.toolbar;
            t.querySelector('.back-btn').onclick = () => this.navigateHistory(-1);
            t.querySelector('.fwd-btn').onclick = () => this.navigateHistory(1);
            t.querySelector('.up-btn').onclick = () => this.navigate(this.app.VFS._parsePath(this.currentPath).parentPath);
            t.querySelector('.upload-btn').onclick = () => this.app.dom.fileUploader.click();
            this.app.dom.fileUploader.onchange = e => this.uploadFiles(e.target.files);
            this.dom.pathBar.onkeydown = e => { if (e.key === 'Enter') this.navigate(this.dom.pathBar.value); };
            this.dom.searchBar.oninput = () => this.render();
            this.dom.contentArea.addEventListener('click', e => { const h = e.target.closest('.list-header-item'); if (h) { this.handleSort(h.dataset.sortKey); return; } this.handleSelection(e, e.target.closest('.file-item')); });
            this.dom.contentArea.addEventListener('dblclick', async e => { const i = e.target.closest('.file-item'); if (!i) return; const n = await this.app.VFS.getNode(i.dataset.id); if (n.type === 'folder') this.navigate(await this.app.VFS.constructPath(n.id)); });
            this.dom.contentArea.addEventListener('contextmenu', e => { e.preventDefault(); e.stopPropagation(); const i = e.target.closest('.file-item'); this.app.ContextMenu.show(e.clientX, e.clientY, i ? this.getItemContextMenu(i) : this.getGridContextMenu()); });
            this.dom.sidebar.querySelectorAll('.quick-access-item').forEach(el => el.onclick = () => this.navigate(el.dataset.path));
            this.dom.contentArea.ondragstart = e => { const i = e.target.closest('.file-item'); if(i){ if (!this.selection.has(i.dataset.id)) { this.selection.clear(); this.selection.add(i.dataset.id); this.updateSelection(); } e.dataTransfer.setData('text/plain', JSON.stringify([...this.selection])); e.dataTransfer.effectAllowed = 'move'; }};
            this.dom.contentArea.ondragover = e => { e.preventDefault(); const t = e.target.closest('.file-item'); this.dom.contentArea.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); if (t) this.app.VFS.getNode(t.dataset.id).then(n => { if(n.type === 'folder') t.classList.add('drag-over'); }); };
            this.dom.contentArea.ondrop = async e => { e.preventDefault(); this.dom.contentArea.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); const t = e.target.closest('.file-item'); if (!t) return; const tn = await this.app.VFS.getNode(t.dataset.id); if (!tn || tn.type !== 'folder') return; const d = JSON.parse(e.dataTransfer.getData('text/plain')); for(const id of d) { if(id !== tn.id) await this.app.VFS.move(id, await this.app.VFS.constructPath(tn.id)); } this.render(); };
        },
        handleSort(key) { if(this.sort.key === key) this.sort.order = this.sort.order === 'asc' ? 'desc' : 'asc'; else { this.sort.key = key; this.sort.order = 'asc'; } this.render(); },
        handleSelection(e, itemEl) {
            const allItems = [...this.dom.contentArea.querySelectorAll('.file-item')];
            if (!e.ctrlKey && !e.shiftKey) { this.selection.clear(); }
            if (itemEl) {
                const id = itemEl.dataset.id;
                if (e.shiftKey && this.lastClickedId) {
                    const lastIdx = allItems.findIndex(el => el.dataset.id === this.lastClickedId);
                    const currentIdx = allItems.findIndex(el => el.dataset.id === id);
                    const [start, end] = [lastIdx, currentIdx].sort((a,b)=>a-b);
                    for (let i = start; i <= end; i++) this.selection.add(allItems[i].dataset.id);
                } else if (e.ctrlKey) {
                    if (this.selection.has(id)) this.selection.delete(id); else this.selection.add(id);
                } else {
                    this.selection.clear(); this.selection.add(id);
                }
                this.lastClickedId = id;
            } else { this.lastClickedId = null; }
            this.updateSelection();
        },
        getItemContextMenu(itemEl) { const id = itemEl.dataset.id; return [ { label: 'Open', action: () => itemEl.dispatchEvent(new MouseEvent('dblclick', { bubbles: true })) }, null, { label: 'Cut (Ctrl+X)', action: () => this.cutSelection() }, { label: 'Copy (Ctrl+C)', action: () => this.copySelection() }, null, { label: 'Rename (F2)', action: () => this.startRename(itemEl) }, { label: 'Delete (Del)', action: () => this.deleteSelection() }, null, { label: 'Download', action: () => this.downloadItem(id) } ]; },
        getGridContextMenu() { return [ { label: 'Paste (Ctrl+V)', action: () => this.pasteSelection(), disabled: !this.clipboard.itemIds.length }, null, { label: 'New Folder', action: () => this.createNewItem('folder') }, { label: 'New Text File', action: () => this.createNewItem('file') } ]; },
        async createNewItem(type) { const name = prompt(`New ${type} name:`, `New ${type}`); if (!name) return; await (type === 'folder' ? this.app.VFS.mkdir(`${this.currentPath}/${name}`) : this.app.VFS.write(`${this.currentPath}/${name}`)); this.render(); },
        startRename(itemEl) { if(!itemEl) return; const nameEl = itemEl.querySelector('.file-item-name'); nameEl.contentEditable = true; nameEl.classList.add('renaming'); nameEl.focus(); document.execCommand('selectAll', false, null); const finish = async () => { nameEl.contentEditable = false; nameEl.classList.remove('renaming'); const newName = nameEl.textContent.trim(); if (newName) await this.app.VFS.rename(itemEl.dataset.id, newName); this.render(); }; nameEl.onblur = finish; nameEl.onkeydown = e => { if (e.key === 'Enter') e.preventDefault(), finish(); if(e.key === 'Escape') this.render(); }; },
        deleteSelection() { if (!this.selection.size) return; this.app.Modal.confirm({ title: 'Delete Items', message: `Delete ${this.selection.size} item(s)?`, onConfirm: async () => { for (const id of this.selection) await this.app.VFS.move(id, '/.trash'); this.selection.clear(); this.render(); } }); },
        copySelection() { if(!this.selection.size) return; this.clipboard = { mode: 'copy', itemIds: [...this.selection] }; },
        cutSelection() { if(!this.selection.size) return; this.clipboard = { mode: 'cut', itemIds: [...this.selection] }; },
        async pasteSelection() { if (!this.clipboard.itemIds.length) return; for(const id of this.clipboard.itemIds) { if (this.clipboard.mode === 'copy') await this.app.VFS.copy(id, this.currentPath); if (this.clipboard.mode === 'cut') await this.app.VFS.move(id, this.currentPath); } if (this.clipboard.mode === 'cut') this.clipboard.itemIds = []; this.render(); },
        async uploadFiles(files) { for (const file of files) { const buffer = await file.arrayBuffer(); await this.app.VFS.write(`${this.currentPath}/${file.name}`, new Blob([buffer])); } this.render(); },
        async downloadItem(id) { const n = await this.app.VFS.getNode(id); if(n.type === 'file') { const b = n.content instanceof Blob ? n.content : new Blob([n.content]); const a = this.app.dom.downloader; a.href = URL.createObjectURL(b); a.download = n.name; a.click(); URL.revokeObjectURL(a.href); } },
        navigate(path) { if(this.currentPath === path) return; this.currentPath = path || '/'; if(this.historyIndex < this.history.length-1) this.history.splice(this.historyIndex+1); this.history.push(this.currentPath); this.historyIndex++; this.render(); },
        navigateHistory(dir) { const newIdx = this.historyIndex + dir; if(newIdx >= 0 && newIdx < this.history.length) { this.historyIndex = newIdx; this.currentPath = this.history[newIdx]; this.render(); } },
        updateNavButtons() { this.dom.toolbar.querySelector('.back-btn').disabled = this.historyIndex <= 0; this.dom.toolbar.querySelector('.fwd-btn').disabled = this.historyIndex >= this.history.length - 1; this.dom.toolbar.querySelector('.up-btn').disabled = this.currentPath === '/'; },
        updateStatusBar() { this.dom.statusBar.textContent = `${this.items.length} items | ${this.selection.size} selected`; },
        updateSelection() { this.dom.contentArea.querySelectorAll('.file-item').forEach(el => el.classList.toggle('selected', this.selection.has(el.dataset.id))); },
        getIcon(item) { if (item.type === 'folder') return '📁'; const ext = item.name.split('.').pop().toLowerCase(); const icons = { jpg:'🖼️', jpeg:'🖼️', png:'🖼️', gif:'🖼️', webp:'🖼️', js:'📜', html:'🌐', css:'🎨', txt:'📄', md:'📄', zip:'📦', rar:'📦' }; return icons[ext] || '⚙️'; },
        formatBytes(bytes) { if (!bytes) return '0 B'; const i = Math.floor(Math.log(bytes) / Math.log(1024)); return `${parseFloat((bytes/Math.pow(1024,i)).toFixed(2))} ${['B','KB','MB','GB'][i]}`; },
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
