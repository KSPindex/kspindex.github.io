
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„í† ë¦¬ í‚¤ìš°ê¸° 3: íŒŒì´ë„ ì±•í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-glow: #00ffff;
            --secondary-glow: #ff00ff;
            --text-color: #e0e0e0;
            --bg-dark: #0c0a1a;
            --bg-modal: rgba(15, 12, 40, 0.95);
        }
        body {
            font-family: 'Jua', sans-serif;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px),
                radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px);
            background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px; 
            background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;
            animation: move-stars 120s linear infinite;
            color: var(--text-color);
            user-select: none;
            overflow: hidden;
        }
        @keyframes move-stars {
            from {background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;}
            to {background-position: -550px -550px, -390px -410px, -380px -520px, -220px -250px;}
        }
        .game-container {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary-glow);
            box-shadow: 0 0 25px var(--primary-glow), inset 0 0 15px rgba(0, 255, 255, 0.3);
        }
        .modal {
            background-color: var(--bg-modal);
            border: 2px solid var(--secondary-glow);
            box-shadow: 0 0 20px var(--secondary-glow);
            animation: fadeIn 0.3s ease-out;
        }
        .btn {
            position: relative;
            transition: all 0.2s ease;
            text-shadow: 0 0 5px currentColor;
            box-shadow: inset 0 0 8px rgba(255,255,255,0.3), 0 0 8px rgba(0,0,0,0.5);
            border-width: 2px;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: inset 0 0 10px rgba(255,255,255,0.5), 0 0 15px currentColor;
        }
        .btn:active:not(:disabled) { transform: translateY(1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .pet {
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
            filter: drop-shadow(0 0 10px var(--primary-glow));
            animation: float 4s ease-in-out infinite;
        }
        .pet:hover { transform: scale(1.1); filter: drop-shadow(0 0 20px var(--primary-glow)); }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        .floating-text {
            position: absolute;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-glow);
            text-shadow: 0 0 5px #fff, 0 0 10px var(--primary-glow);
            pointer-events: none;
            animation: floatUp 1.2s ease-out forwards;
        }
        @keyframes floatUp {
            from { transform: translateY(0) scale(1); opacity: 1; }
            to { transform: translateY(-150px) scale(1.8); opacity: 0; }
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .tab-button.active { background-color: var(--secondary-glow); color: white; border-color: var(--secondary-glow); }
        .progress-bar { background-color: rgba(255,255,255,0.2); border-radius: 9999px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow)); border-radius: 9999px; transition: width 0.3s ease; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 md:p-4">

    <div id="gameContainer" class="game-container w-full max-w-5xl h-[95vh] max-h-[900px] rounded-3xl p-4 flex flex-col relative overflow-hidden">
        
        <div class="flex justify-between items-center bg-black/50 p-3 rounded-xl border-2 border-purple-400 shadow-lg mb-2">
            <h1 class="text-xl md:text-3xl font-bold text-cyan-300">ğŸª ë„í† ë¦¬ í‚¤ìš°ê¸° 3: íŒŒì´ë„ ì±•í„° ğŸª</h1>
            <div class="flex items-center gap-4">
                <div class="text-xl md:text-2xl font-bold bg-yellow-500 text-black px-4 py-2 rounded-full shadow-md flex items-center gap-2">
                    <i class="fa-solid fa-cookie-bite"></i> <span id="goldenAcornAmount">0</span>
                </div>
                <div class="text-xl md:text-2xl font-bold bg-gray-800 text-white px-4 py-2 rounded-full shadow-inner cursor-pointer flex items-center gap-2" onclick="toggleNumberFormat()">
                    <i class="fa-solid fa-database"></i> <span id="moneyDisplay">0</span>
                </div>
                <button onclick="showModal('settingsModal')" class="text-2xl text-white hover:text-cyan-300 transition-colors">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </div>
        
        <div id="gameScreen" class="flex-grow bg-black/30 rounded-2xl border-2 border-cyan-400 relative flex items-center justify-center flex-wrap gap-8 p-4 overflow-hidden"></div>
        
        <div class="grid grid-cols-5 gap-2 mt-4 text-xs md:text-base">
            <button onclick="showModal('shopModal')" class="btn bg-cyan-600 text-white p-2 rounded-lg border-cyan-400">ìƒì </button>
            <button onclick="showModal('petModal')" class="btn bg-purple-600 text-white p-2 rounded-lg border-purple-400">í«</button>
            <button onclick="showModal('enhanceModal')" class="btn bg-red-600 text-white p-2 rounded-lg border-red-400">ê°•í™”</button>
            <button onclick="showModal('evolveModal')" class="btn bg-indigo-500 text-white p-2 rounded-lg border-indigo-400">ì§„í™”</button>
            <button onclick="showModal('missionModal')" class="btn bg-green-600 text-white p-2 rounded-lg border-green-400">ë¯¸ì…˜</button>
            <button onclick="showModal('collectionModal')" class="btn bg-yellow-600 text-white p-2 rounded-lg border-yellow-400">ë„ê°</button>
            <button onclick="showModal('rebirthModal')" class="btn bg-gray-700 text-yellow-300 p-2 rounded-lg border-yellow-500">í™˜ìƒ</button>
            <button onclick="showModal('storyBookModal')" class="btn bg-blue-600 text-white p-2 rounded-lg border-blue-400">ìŠ¤í† ë¦¬</button>
            <button onclick="showModal('titleModal')" class="btn bg-orange-600 text-white p-2 rounded-lg border-orange-400">ì¹­í˜¸</button>
            <button onclick="showModal('disassemblyModal')" class="btn bg-stone-600 text-white p-2 rounded-lg border-stone-400">ë¶„í•´</button>
            <button onclick="showModal('statsModal')" class="btn bg-indigo-600 text-white p-2 rounded-lg border-indigo-400">ìƒì„¸ ìŠ¤íƒ¯</button>
        </div>
    </div>
    
    <div id="modalContainer" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 hidden p-4">
        <div id="modalContent" class="modal w-full max-w-3xl p-6 rounded-2xl flex flex-col max-h-[90vh]"></div>
    </div>
    
    <div id="toast" class="fixed bottom-10 right-10 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl text-lg opacity-0 transform translate-y-5 transition-all duration-500 z-[100]"></div>

    <script>
    // --- DATA CONSTANTS ---
    const PET_DATA={acorn:{name:"ë„í† ë¦¬",baseClick:1,cost:100,img:"ğŸŒ°",rarity:"ì¼ë°˜"},jitori:{name:"ì§€í† ë¦¬",baseClick:3,cost:1e3,img:"ğŸ¥œ",rarity:"ì¼ë°˜"},rocktori:{name:"ëŒí† ë¦¬",baseClick:10,cost:1e4,img:"ğŸ—¿",rarity:"ì¼ë°˜"},goldtori:{name:"í™©ê¸ˆë„í† ë¦¬",baseClick:70,cost:1e5,img:"âœ¨",rarity:"í¬ê·€"},diamondtori:{name:"ë‹¤ì´ì•„ëª¬ë“œë„í† ë¦¬",baseClick:150,cost:3e5,img:"ğŸ’",rarity:"í¬ê·€"},beggartori:{name:"ê±°ì§€í† ë¦¬",baseClick:300,cost:5e5,img:"ğŸ—‘ï¸",rarity:"í¬ê·€"},santatori:{name:"ì‚°íƒ€í† ë¦¬",baseClick:500,cost:7e5,img:"ğŸ…",rarity:"ì˜ì›…"},dotoltem:{name:"ë„í†¨í…œ",baseClick:1e3,cost:1e6,img:"ğŸ›¡ï¸",rarity:"ì˜ì›…"},moontori:{name:"ë‹¬í† ë¦¬",baseClick:1e4,cost:1e7,img:"ğŸŒ•",rarity:"ì „ì„¤"},earthtori:{name:"ì§€êµ¬í† ë¦¬",baseClick:1e5,cost:1e8,img:"ğŸŒ",rarity:"ì „ì„¤"},darktori:{name:"ë‹¤í¬í† ë¦¬",baseClick:1e6,cost:1e9,img:"ğŸ˜ˆ",rarity:"ì‹ í™”"},whitetori:{name:"í™”ì´íŠ¸í† ë¦¬",baseClick:2e6,cost:3e9,img:"ğŸ˜‡",rarity:"ì‹ í™”"},lighttori:{name:"ë¼ì´íŠ¸í† ë¦¬",baseClick:3e6,cost:5e9,img:"ğŸ’¡",rarity:"ì‹ í™”"},gravitytori:{name:"ì¤‘ë ¥í† ë¦¬",baseClick:5e6,cost:1e10,img:"âš«",rarity:"íƒœì´ˆ"},spacetori:{name:"ìš°ì£¼í† ë¦¬",baseClick:1e8,cost:1e11,img:"ğŸŒŒ",rarity:"íƒœì´ˆ"},multiversetori:{name:"ë‹¤ì¤‘ìš°ì£¼í† ë¦¬",baseClick:1e9,cost:1e12,img:"ğŸª",rarity:"ìš°ì£¼"},firsttori:{name:"ìµœì´ˆì˜ë„í† ë¦¬",baseClick:5e9,cost:3e12,img:"ğŸ’«",rarity:"ìš°ì£¼"},infinitytori:{name:"ë¬´í•œì˜ë„í† ë¦¬",baseClick:2e10,cost:1e13,img:"â™¾ï¸",rarity:"ê¶ê·¹"},absolutetori:{name:"ì•±ì†”ë£¨íŠ¸í† ë¦¬",baseClick:1e11,cost:1e14,img:"ğŸ‘‘",rarity:"ê¶ê·¹"},godtori:{name:"ë„í† ë¦¬ì˜ì‹ ",baseClick:1e12,cost:1e15,img:"ğŸ™",rarity:"???"},secret_wawa:{name:"[ì‹œí¬ë¦¿]ë„í† ë¦¬ë‹ˆ ì§€í† ë¦¬ë‹ˆ ì™€ì™€ì™€",baseClick:1e13,cost:0,img:"ğŸ¤¯",rarity:"ì‹œí¬ë¦¿"}};
    const GACHA_RATES={normal:[{type:"acorn",weight:3e3},{type:"jitori",weight:2500},{type:"rocktori",weight:1500},{type:"goldtori",weight:1e3},{type:"diamondtori",weight:800},{type:"beggartori",weight:500},{type:"santatori",weight:250},{type:"dotoltem",weight:150},{type:"moontori",weight:100},{type:"earthtori",weight:70},{type:"darktori",weight:50},{type:"whitetori",weight:20},{type:"lighttori",weight:9},{type:"secret_wawa",weight:1}],premium:[{type:"santatori",weight:2e3},{type:"dotoltem",weight:1500},{type:"moontori",weight:1200},{type:"earthtori",weight:1e3},{type:"darktori",weight:800},{type:"whitetori",weight:700},{type:"lighttori",weight:600},{type:"gravitytori",weight:500},{type:"spacetori",weight:400},{type:"multiversetori",weight:300},{type:"firsttori",weight:200},{type:"infinitytori",weight:150},{type:"absolutetori",weight:100},{type:"godtori",weight:40},{type:"secret_wawa",weight:10}]};
    const STORY_BOOK_DATA={hope:{name:"ë„í† ë¦¬ì˜ í¬ë§",cost:1e6,content:"ì–´ë‘ìš´ ìˆ², ì´ë¦„ ì—†ëŠ” ë„í† ë¦¬ í•˜ë‚˜ê°€ í•˜ëŠ˜ì„ ì˜¬ë ¤ë‹¤ë´¤ë‹¤. ê·¸ëŠ” ë‹¤ë¥¸ ë„í† ë¦¬ë“¤ì²˜ëŸ¼ ê·¸ì € ë•…ì— ë–¨ì–´ì ¸ ì©ì–´ê°ˆ ìš´ëª…ì´ ì•„ë‹ˆë¼ê³  ë¯¿ì—ˆë‹¤. 'ì € ë°¤í•˜ëŠ˜ì˜ ë³„ì²˜ëŸ¼, ë‚˜ë„ ë¹›ë‚  ìˆ˜ ìˆì§€ ì•Šì„ê¹Œ?' ê·¸ì˜ ì‘ì€ ê°€ìŠ´ì— ê±°ëŒ€í•œ ìš°ì£¼ë¥¼ í–¥í•œ í¬ë§ì´ ì‹¹í…„ë‹¤."},tenacity:{name:"ë„í† ë¦¬ì˜ íˆ¬ì§€",cost:1e8,content:"í¬ë§ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í–ˆë‹¤. ê·¸ëŠ” ë‹¨ë‹¨í•´ì ¸ì•¼ í–ˆë‹¤. ë°”ìœ„ì— ëª¸ì„ ë¶€ë”ªì³ ê»ì§ˆì„ ë‹¨ë ¨í•˜ê³ , ë¹—ë¬¼ì„ ë§ìœ¼ë©° ì •ì‹ ì„ ê°€ë‹¤ë“¬ì—ˆë‹¤. ìˆ˜ë§ì€ ë„í† ë¦¬ë“¤ì´ ë¹„ì›ƒì—ˆì§€ë§Œ, ê·¸ëŠ” ë©ˆì¶”ì§€ ì•Šì•˜ë‹¤. ê·¸ì˜ íˆ¬ì§€ëŠ” ê³§ ê·¸ì˜ í˜ì´ ë˜ì—ˆë‹¤."},unity:{name:"ë„í† ë¦¬ì˜ ë‹¨ê²°",cost:1e10,content:"í˜¼ìì„œëŠ” ìš°ì£¼ì— ë‹¿ì„ ìˆ˜ ì—†ì—ˆë‹¤. ê·¸ëŠ” ìì‹ ê³¼ ê°™ì€ ê¿ˆì„ ê¾¸ëŠ” ë™ë£Œë“¤ì„ ëª¨ìœ¼ê¸° ì‹œì‘í–ˆë‹¤. ëŒë©©ì´ì²˜ëŸ¼ ë‹¨ë‹¨í•œ ì, í™©ê¸ˆì²˜ëŸ¼ ë¹›ë‚˜ëŠ” ì, ì‹¬ì§€ì–´ ì–´ë‘ ì˜ í˜ì„ í’ˆì€ ìê¹Œì§€. ë§ˆì¹¨ë‚´ ê·¸ë“¤ì€ ê±°ëŒ€í•œ ìœ„í˜‘ì— ë§ì„œê¸° ìœ„í•œ í•˜ë‚˜ì˜ êµ°ë‹¨ì´ ë˜ì—ˆë‹¤."},war:{name:"ë„í† ë¦¬ì˜ ì „ìŸ",cost:1e12,content:"ê·¸ë“¤ì˜ ì„±ì¥ì„ ì‹œê¸°í•œ 'ì©ì–´ê°€ëŠ” ìë“¤'ì´ ë‚˜íƒ€ë‚¬ë‹¤. ì„¸ìƒì˜ ëª¨ë“  ê²ƒì„ ë¶€íŒ¨ì‹œí‚¤ë ¤ëŠ” ê·¸ë“¤ê³¼ì˜ ì „ìŸì€ í”¼í•  ìˆ˜ ì—†ì—ˆë‹¤. ë„í† ë¦¬ êµ°ë‹¨ì€ ì€í•˜ê³„ë¥¼ ë¬´ëŒ€ë¡œ ì¥ëŒ€í•œ ì „ìŸì„ ì‹œì‘í–ˆë‹¤. ìˆ˜ë§ì€ ë™ë£Œë¥¼ ìƒì—ˆì§€ë§Œ, ê·¸ë“¤ì˜ ì˜ì§€ëŠ” êº¾ì´ì§€ ì•Šì•˜ë‹¤."},final:{name:"ìµœí›„ì˜ ë„í† ë¦¬",cost:1e13,content:"ì „ìŸì˜ ë, ê·¸ëŠ” 'ì©ì–´ê°€ëŠ” ìë“¤'ì˜ ì‹¬ì¥ë¶€ì—ì„œ ê·¸ë“¤ì˜ ì™•ê³¼ ë§ˆì£¼í–ˆë‹¤. ì™•ì€ ë‹¤ë¦„ ì•„ë‹Œ, ëª¨ë“  í¬ë§ì„ í¬ê¸°í•˜ê³  ì ˆë§ì— ë¹ ì§„ ìµœì´ˆì˜ ë„í† ë¦¬ì˜€ë‹¤. \"ê²°êµ­ ëª¨ë“  ê²ƒì€ ì‚¬ë¼ì§„ë‹¤.\" ì™•ì˜ ê³µí—ˆí•œ ì™¸ì¹¨ì— ê·¸ëŠ” ë‹µí–ˆë‹¤. \"í•˜ì§€ë§Œ ìš°ë¦¬ì˜ ì˜ì§€ëŠ” ë³„ì´ ë˜ì–´ ì˜ì›íˆ ë¹›ë‚  ê²ƒì´ë‹¤!\""},ending:{name:"ì—”ë”©",cost:1e16,content:"ì™•ì„ ì“°ëŸ¬ëœ¨ë¦° ê·¸ëŠ” ìš°ì£¼ì˜ ì¤‘ì‹¬ì— ì„°ë‹¤. ê·¸ëŠ” ë³„ì„ ì°½ì¡°í•˜ê³ , ì€í•˜ë¥¼ ë¹šì–´ëƒˆë‹¤. ë” ì´ìƒ ì‘ê³  ë‚˜ì•½í•œ ë„í† ë¦¬ê°€ ì•„ë‹ˆì—ˆë‹¤. ê·¸ëŠ” ê³§ ìš°ì£¼ì˜€ê³ , ìš°ì£¼ëŠ” ê³§ ê·¸ì˜€ë‹¤. ëª¨ë“  ì¡´ì¬ëŠ” ê·¸ì˜ ì˜ì§€ ì•„ë˜ ìƒˆë¡œìš´ ì‹œì‘ì„ ë§ì´í–ˆë‹¤. ì˜ê²ì˜ ì‹œê°„ ì†, ê·¸ì˜ ì´ì•¼ê¸°ëŠ” ì „ì„¤ì´ ë˜ì–´ ìš°ì£¼ë¥¼ ë– ëŒì•˜ë‹¤. ì•„ì£¼ ì‘ì€ í¬ë§ í•˜ë‚˜ê°€ ì–¼ë§ˆë‚˜ ê±°ëŒ€í•œ í˜„ì‹¤ì„ ë§Œë“¤ì–´ë‚¼ ìˆ˜ ìˆëŠ”ì§€ ì¦ëª…í•˜ë©°."}};
    const RARITY_COLORS = { 'ì¼ë°˜': 'text-gray-300', 'í¬ê·€': 'text-blue-400', 'ì˜ì›…': 'text-purple-400', 'ì „ì„¤': 'text-yellow-400', 'ì‹ í™”': 'text-red-400', 'íƒœì´ˆ': 'text-cyan-300', 'ìš°ì£¼': 'text-fuchsia-400', 'ê¶ê·¹': 'text-orange-300', '???': 'text-white', 'ì‹œí¬ë¦¿': 'text-green-400' };
    const ARTIFACT_DATA = {ancientAcorn: { name: 'ê³ ëŒ€ì˜ ë„í† ë¦¬', maxLevel: 50, cost: (lv) => 1 + lv, effect: (lv) => lv * 0.05, desc: "ëª¨ë“  ì¬í™” íšë“ëŸ‰ +{EFFECT}%" },starFragment: { name: 'ë³„ì˜ íŒŒí¸', maxLevel: 20, cost: (lv) => 5 + lv * 2, effect: (lv) => lv * 0.02, desc: "í´ë¦­ë‹¹ ì¬í™” íšë“ëŸ‰ +{EFFECT}%" },timeCrystal: { name: 'ì‹œê°„ì˜ ê²°ì •', maxLevel: 30, cost: (lv) => 2 + lv, effect: (lv) => lv * 0.03, desc: "ì˜¤í”„ë¼ì¸ ë³´ìƒëŸ‰ +{EFFECT}%" },goldenCompass: { name: 'í™©ê¸ˆ ë‚˜ì¹¨ë°˜', maxLevel: 10, cost: (lv) => 10 + lv * 5, effect: (lv) => lv * 0.01, desc: "í™©ê¸ˆ ë„í† ë¦¬ íšë“ í™•ë¥  +{EFFECT}%" },};
    const TITLE_DATA = {'ì´ˆë³´ì':{desc:"ê²Œì„ì„ ì‹œì‘í•œ ì",bonus:{type:"none"}},'í´ë¦­ì˜ ë‹¬ì¸':{desc:"ì´ 10ë§Œë²ˆ í´ë¦­ ë‹¬ì„±",unlock:gs=>gs.stats.totalClicks>=1e5,bonus:{type:"click_power",value:.1}},'ìˆ˜ì§‘ê°€':{desc:"í« 10ì¢…ë¥˜ ìˆ˜ì§‘",unlock:gs=>Object.keys(gs.collection).length>=10,bonus:{type:"all_power",value:.05}},'ë°±ë§Œì¥ì':{desc:"ìµœëŒ€ ë³´ìœ  ì¬í™” 100ë§Œ ë‹¬ì„±",unlock:gs=>gs.stats.maxMoney>=1e6,bonus:{type:"money_gain",value:.1}},'í™˜ìƒì':{desc:"ì²« í™˜ìƒ ë‹¬ì„±",unlock:gs=>gs.stats.rebirths>=1,bonus:{type:"all_power",value:.1}}};
    
    let gameState = {};
    const initialGameState = {money: 0, goldenAcorns: 0,pets: [], equippedPetIds: [], petLimit: 3,upgrades: { autoClickLevel: 0, clickPowerLevel: 0, goldenAcornChanceLevel: 0 },missions: { daily: [], weekly: [] }, lastMissionReset: { daily: 0, weekly: 0 },collection: {}, artifacts: {},titles: { unlocked: ['ì´ˆë³´ì'], equipped: 'ì´ˆë³´ì' },couponsUsed: [],stats: { totalClicks: 0, totalMoney: 0, maxMoney: 0, rebirths: 0, playTime: 0 },settings: { numberFormat: 'full', animations: true },storyBooks: {},lastSaveTime: Date.now()};
    let nextPetId = 0;
    let enhanceSelection = []; let evolveSelection = [];

    const moneyDisplay = document.getElementById('moneyDisplay');
    const goldenAcornAmount = document.getElementById('goldenAcornAmount');
    const gameScreen = document.getElementById('gameScreen');
    const modalContainer = document.getElementById('modalContainer');
    const modalContent = document.getElementById('modalContent');
    const toast = document.getElementById('toast');

    function init() {
        loadGame();
        if (gameState.pets.length === 0) addPet('acorn');
        handleOfflineProgress();
        checkMissionReset();
        checkTitleUnlocks();
        setInterval(gameLoop, 1000);
        renderAll();
    }

    function gameLoop() {
        let cps = calculateCPS();
        changeMoney(cps.auto);
        gameState.stats.playTime++;
        gameState.lastSaveTime = Date.now();
        saveGame();
    }
    
    function calculateCPS() {
        let clickMultiplier = 1;
        let autoMultiplier = 1;
        let baseClick = 0;
        gameState.equippedPetIds.map(id => findPetById(id)).filter(p => p).forEach(pet => {
            const petData = PET_DATA[pet.type];
            if(!petData) return;
            let petPower = petData.baseClick;
            petPower *= (1 + (pet.enhancement * .2));
            petPower *= (1 + (pet.evolution * 2));
            petPower *= (1 + (pet.potential * .5));
            baseClick += petPower;
        });
        
        clickMultiplier *= (1 + gameState.upgrades.clickPowerLevel * 0.1);
        autoMultiplier *= (1 + (gameState.upgrades.autoClickLevel * 0.1));
        
        let globalMultiplier = 1 + gameState.stats.rebirths * 0.5;
        if(gameState.artifacts.ancientAcorn) globalMultiplier *= (1 + ARTIFACT_DATA.ancientAcorn.effect(gameState.artifacts.ancientAcorn));
        globalMultiplier *= (1 + Object.keys(gameState.collection).length * 0.002);

        const equippedTitle = TITLE_DATA[gameState.titles.equipped];
        if (equippedTitle && equippedTitle.bonus.type !== 'none') {
            const b = equippedTitle.bonus;
            if (b.type === 'click_power' || b.type === 'all_power' || b.type === 'money_gain') clickMultiplier *= (1 + b.value);
            if (b.type === 'all_power' || b.type === 'money_gain') autoMultiplier *= (1 + b.value);
        }

        let totalClickValue = baseClick * clickMultiplier * globalMultiplier;
        if(gameState.artifacts.starFragment) totalClickValue *= (1 + ARTIFACT_DATA.starFragment.effect(gameState.artifacts.starFragment));
        const autoClickPerSecond = totalClickValue * autoMultiplier;
        
        return { click: totalClickValue, auto: autoClickPerSecond };
    }

    function handlePetClick(event) {
        const clickValue = calculateCPS().click;
        changeMoney(clickValue);
        gameState.stats.totalClicks++;
        updateMissionProgress('click', 1);
        
        const dropChance = 0.001 + (gameState.upgrades.goldenAcornChanceLevel * 0.0005) + (gameState.artifacts.goldenCompass ? ARTIFACT_DATA.goldenCompass.effect(gameState.artifacts.goldenCompass) : 0);
        if (Math.random() < dropChance) {
            changeGoldenAcorns(1);
            showToast('í™©ê¸ˆ ë„í† ë¦¬ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!', 'info');
        }

        if (gameState.settings.animations) {
            const floatingText = document.createElement('div');
            floatingText.className = 'floating-text';
            floatingText.textContent = `+${formatNumber(clickValue)}`;
            const rect = gameScreen.getBoundingClientRect();
            floatingText.style.left = `${event.clientX - rect.left - rect.width/4}px`;
            floatingText.style.top = `${event.clientY - rect.top}px`;
            gameScreen.appendChild(floatingText);
            setTimeout(() => floatingText.remove(), 1200);
        }
    }

    function changeMoney(amount) {
        if(isNaN(amount) || amount === 0) return;
        gameState.money += amount;
        if (amount > 0) {
            gameState.stats.totalMoney += amount;
            updateMissionProgress('earn', amount);
        }
        if (gameState.money > gameState.stats.maxMoney) {
            gameState.stats.maxMoney = gameState.money;
            checkTitleUnlocks();
        }
        renderMoney();
    }
    
    function changeGoldenAcorns(amount) {
        gameState.goldenAcorns += amount;
        renderGoldenAcorns();
    }
    
    function addPet(type, from = 'buy') {
        const newPet = { id: nextPetId++, type, enhancement: 0, evolution: 0, potential: Math.random() };
        gameState.pets.push(newPet);
        if (gameState.equippedPetIds.length < gameState.petLimit) gameState.equippedPetIds.push(newPet.id);
        if(!gameState.collection[type]) {
             gameState.collection[type] = 0;
             updateMissionProgress('collect', 1);
        }
        gameState.collection[type]++;
        checkTitleUnlocks();
    }
    
    function applyCoupon(code) {
        if(gameState.couponsUsed.includes(code)){
            showToast("ì´ë¯¸ ì‚¬ìš©ëœ ì¿ í°ì…ë‹ˆë‹¤.", "error");
            return;
        }
        let isValid = false;
        if(code === 'ë„í† ë¦¬'){
            changeMoney(100);
            addPet('acorn');
            isValid = true;
        } else if(code === 'ì§€í† ë¦¬'){
            changeMoney(100);
            for(let i=0; i<11; i++) addPet('acorn');
            isValid = true;
        } else if(code === 'DOLTO') {
            addPet('rocktori');
            isValid = true;
        } else if(code === 'THEBEST#1_25') {
            changeGoldenAcorns(1);
            isValid = true;
        }
        
        if(isValid){
            gameState.couponsUsed.push(code);
            showToast("ì¿ í° ë³´ìƒì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
        } else {
            showToast("ìœ íš¨í•˜ì§€ ì•Šì€ ì¿ í°ì…ë‹ˆë‹¤.", "error");
        }
    }
    
    const MISSION_POOL={daily:[{key:"click",text:n=>`í« ${n}ë²ˆ í´ë¦­í•˜ê¸°`,targets:[500, 1000, 2000],reward:n=>2+n},{key:"earn",text:n=>`ì¬í™” ${formatNumber(n)} íšë“í•˜ê¸°`,targets:[10000, 50000, 100000],reward:n=>2+n},{key:"enhance",text:()=>"í« ê°•í™” 1íšŒ ì‹œë„í•˜ê¸°",targets:[1],reward:()=>5}],weekly:[{key:"collect",text:n=>`ìƒˆë¡œìš´ í« ${n}ì¢… ìˆ˜ì§‘í•˜ê¸°`,targets:[1,2,3],reward:n=>10*n},{key:"rebirth",text:()=>"í™˜ìƒ 1íšŒ ì§„í–‰í•˜ê¸°",targets:[1],reward:()=>50}]};

    function generateMissions(type) {
        let missions = [];
        let pool = MISSION_POOL[type];

        for (const missionTemplate of pool) {
            let targetIndex = Math.floor(Math.random() * missionTemplate.targets.length);
            let target = missionTemplate.targets[targetIndex];
            missions.push({
                id: missionTemplate.key,
                text: missionTemplate.text(target),
                target: target,
                progress: 0,
                reward: missionTemplate.reward(targetIndex + 1),
                claimed: false
            });
        }
        return missions;
    }

    function checkMissionReset(){const now=new Date;const today=new Date(now.getFullYear(),now.getMonth(),now.getDate()).getTime();if(today>gameState.lastMissionReset.daily){gameState.missions.daily=generateMissions("daily");gameState.lastMissionReset.daily=today}const weekStart=today-now.getDay()*864e5;if(weekStart>gameState.lastMissionReset.weekly){gameState.missions.weekly=generateMissions("weekly");gameState.lastMissionReset.weekly=weekStart}}
    function updateMissionProgress(key,value){if(typeof value!=="number"||value<=0)return;gameState.missions.daily.forEach(m=>{if(m.id===key&&!m.claimed)m.progress+=value});gameState.missions.weekly.forEach(m=>{if(m.id===key&&!m.claimed)m.progress+=value})}
    function claimMissionReward(type,index){const mission=gameState.missions[type][index];if(mission.progress>=mission.target&&!mission.claimed){mission.claimed=true;changeGoldenAcorns(mission.reward);showToast(`ë¯¸ì…˜ ë³´ìƒ! í™©ê¸ˆ ë„í† ë¦¬ ${mission.reward}ê°œ íšë“!`,"success");showModal("missionModal")}}
    
    function checkTitleUnlocks(){let updated=false;for(const title in TITLE_DATA){if(!gameState.titles.unlocked.includes(title)&&TITLE_DATA[title].unlock(gameState)){gameState.titles.unlocked.push(title);showToast(`ìƒˆë¡œìš´ ì¹­í˜¸ íšë“: [${title}]`,"info");updated=true}}return updated}
    function equipTitle(title){if(gameState.titles.unlocked.includes(title)){gameState.titles.equipped=title;showToast(`[${title}] ì¹­í˜¸ë¥¼ ì¥ì°©í–ˆìŠµë‹ˆë‹¤.`,"success");showModal("titleModal")}}

    function doRebirth() {
        const cost = 1e9;
        if(gameState.money < cost) { showToast(`í™˜ìƒ ë¹„ìš©(${formatNumber(cost)})ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.`, 'error'); return; }
        const points = Math.floor(Math.log10(gameState.money / cost) * 2) + 1;
        
        const preservedState = {
            goldenAcorns: gameState.goldenAcorns + points,
            collection: gameState.collection,
            artifacts: gameState.artifacts,
            titles: gameState.titles,
            couponsUsed: gameState.couponsUsed,
            stats: { ...gameState.stats, rebirths: gameState.stats.rebirths + 1 },
            settings: gameState.settings,
            storyBooks: gameState.storyBooks,
        };
        
        const freshState = JSON.parse(JSON.stringify(initialGameState));
        
        gameState = { ...freshState, ...preservedState };
        
        addPet('acorn');
        updateMissionProgress('rebirth', 1);
        showToast(`í™˜ìƒ ì™„ë£Œ! í™©ê¸ˆ ë„í† ë¦¬ ${points}ê°œë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`, 'success');
        closeModal();
        renderAll();
    }

    function buyArtifact(id) {
        const artifact = ARTIFACT_DATA[id];
        const level = gameState.artifacts[id] || 0;
        if(level >= artifact.maxLevel) { showToast('ìµœëŒ€ ë ˆë²¨ì…ë‹ˆë‹¤.', 'error'); return; }
        const cost = artifact.cost(level);
        if(gameState.goldenAcorns < cost) { showToast('í™©ê¸ˆ ë„í† ë¦¬ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error'); return; }
        changeGoldenAcorns(-cost);
        gameState.artifacts[id] = level + 1;
        showModal('rebirthModal');
    }

    function selectForEnhance(id){if(enhanceSelection.includes(id))enhanceSelection=enhanceSelection.filter(petId=>petId!==id);else enhanceSelection.push(id);showModal("enhanceModal")}
    
    // FCì˜¨ë¼ì¸ ê°•í™” í™•ë¥ ì„ ì°¸ê³ í•˜ì—¬ ë³€ê²½
    function doEnhance() {
        if(enhanceSelection.length !== 2) {
            showToast("ê°•í™”í•  í« 1ë§ˆë¦¬ì™€ ì¬ë£Œ í« 1ë§ˆë¦¬, ì´ 2ë§ˆë¦¬ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.", "error");
            return;
        }
        const basePet = findPetById(enhanceSelection[0]);
        const materialPet = findPetById(enhanceSelection[1]);
        if(!basePet || !materialPet) {
            enhanceSelection = [];
            showModal("enhanceModal");
            return;
        }
        if(basePet.id === materialPet.id) {
            showToast("ìê¸° ìì‹ ì„ ì¬ë£Œë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
            return;
        }
        if(basePet.type !== materialPet.type || basePet.enhancement !== materialPet.enhancement || basePet.evolution !== materialPet.evolution) {
            showToast("ë™ì¼í•œ ì¢…ë¥˜, ê°•í™”, ì§„í™” ë‹¨ê³„ì˜ í«ë§Œ ì¬ë£Œë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "error");
            return;
        }
        const level = basePet.enhancement;
        if(level >= 15) {
            showToast("ìµœëŒ€ ê°•í™” ë ˆë²¨ì…ë‹ˆë‹¤.", "error");
            return;
        }
        
        let successRate;
        if (level === 0) successRate = 95;
        else if (level === 1) successRate = 85;
        else if (level === 2) successRate = 70;
        else if (level === 3) successRate = 60;
        else if (level === 4) successRate = 50;
        else if (level === 5) successRate = 45;
        else if (level === 6) successRate = 40;
        else if (level === 7) successRate = 30;
        else if (level === 8) successRate = 25;
        else if (level === 9) successRate = 20;
        else if (level === 10) successRate = 15;
        else if (level === 11) successRate = 10;
        else if (level === 12) successRate = 7;
        else if (level === 13) successRate = 5;
        else if (level === 14) successRate = 3;
        else successRate = 1;

        const rand = Math.random() * 100;
        if(rand < successRate) {
            basePet.enhancement++;
            showToast(`ê°•í™” ì„±ê³µ! +${basePet.enhancement} ${PET_DATA[basePet.type].name}(ì´)ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!`, "success");
        } else {
            showToast("ê°•í™” ì‹¤íŒ¨...", "error");
        }
        
        removePetById(materialPet.id);
        enhanceSelection = [];
        updateMissionProgress("enhance", 1);
        showModal("enhanceModal");
    }
    
    function selectForEvolve(id){if(evolveSelection.includes(id))evolveSelection=evolveSelection.filter(petId=>petId!==id);else evolveSelection.push(id);showModal("evolveModal")}
    
    // FCì˜¨ë¼ì¸ ê°•í™” í™•ë¥ ì„ ì°¸ê³ í•˜ì—¬ ë³€ê²½
    function doEvolve() {
        if(evolveSelection.length !== 3) {
            showToast("ì§„í™”í•  í« 1ë§ˆë¦¬ì™€ ë™ì¼ ì¢…ë¥˜ ì¬ë£Œ í« 2ë§ˆë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.", "error");
            return;
        }
        const basePet = findPetById(evolveSelection[0]);
        const material1 = findPetById(evolveSelection[1]);
        const material2 = findPetById(evolveSelection[2]);
        if(!basePet || !material1 || !material2) {
            evolveSelection = [];
            showModal("evolveModal");
            return;
        }
        if(basePet.id === material1.id || basePet.id === material2.id || material1.id === material2.id) {
            showToast("ì„œë¡œ ë‹¤ë¥¸ í«ì„ ì¬ë£Œë¡œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.", "error");
            return;
        }
        if(basePet.type !== material1.type || basePet.type !== material2.type) {
            showToast("ëª¨ë‘ ë™ì¼í•œ ì¢…ë¥˜ì˜ í«ì´ì–´ì•¼ í•©ë‹ˆë‹¤.", "error");
            return;
        }
        const level = basePet.evolution;
        if(level >= 5) {
            showToast("ìµœëŒ€ ì§„í™” ë‹¨ê³„ì…ë‹ˆë‹¤.", "error");
            return;
        }

        let successRate;
        if (level === 0) successRate = 70;
        else if (level === 1) successRate = 50;
        else if (level === 2) successRate = 35;
        else if (level === 3) successRate = 20;
        else if (level === 4) successRate = 10;
        else successRate = 5;

        const rand = Math.random() * 100;
        if(rand < successRate) {
            basePet.evolution++;
            showToast("ì§„í™” ì„±ê³µ!", "success");
        } else {
            showToast("ì§„í™” ì‹¤íŒ¨...", "error");
        }

        removePetById(material1.id);
        removePetById(material2.id);
        evolveSelection = [];
        showModal("evolveModal");
    }
    
    function removePetById(id){gameState.pets=gameState.pets.filter(p=>p.id!==id);gameState.equippedPetIds=gameState.equippedPetIds.filter(eqId=>eqId!==id)}
    
    function doDisassembly(petId) {
        const pet = findPetById(petId);
        if(!pet) return;

        if (gameState.equippedPetIds.includes(petId)) {
            showToast("ì¥ì°© ì¤‘ì¸ í«ì€ ë¶„í•´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
            return;
        }
        
        const petData = PET_DATA[pet.type];
        const refundAmount = Math.floor(petData.cost * 0.25);
        
        changeMoney(refundAmount);
        removePetById(petId);
        
        showToast(`${petData.name}ì„(ë¥¼) ë¶„í•´í•˜ê³  ${formatNumber(refundAmount)}ì„(ë¥¼) ì–»ì—ˆìŠµë‹ˆë‹¤.`, "success");
        showModal('disassemblyModal');
    }

    function showModal(modalId, data = {}) {
        let contentHTML = '';
        let modalTitle = '';
        switch(modalId) {
            case 'shopModal':
                modalTitle = "ìƒì  & í« ë½‘ê¸°";
                contentHTML = `
                <div class="flex border-b-2 border-purple-500 mb-4">
                    <button class="tab-button flex-1 p-3 text-lg" data-tab="shop" onclick="switchTab(event, 'shopGacha')">í« êµ¬ë§¤</button>
                    <button class="tab-button flex-1 p-3 text-lg" data-tab="gacha" onclick="switchTab(event, 'shopGacha')">í« ë½‘ê¸°</button>
                </div>
                <div id="shopTab" class="tab-content space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                    ${Object.keys(PET_DATA).filter(k=>PET_DATA[k].cost>0).map(type=>{const pet=PET_DATA[type];return`<button onclick="buyPet('${type}')" class="btn w-full bg-cyan-800 border-cyan-500 text-white p-3 rounded-lg flex justify-between items-center" ${gameState.money<pet.cost?"disabled":""}><span>${pet.img} ${pet.name} <span class="${RARITY_COLORS[pet.rarity]||"text-white"}">[${pet.rarity}]</span></span> <span>${formatNumber(pet.cost)}</span></button>`}).join("")}
                </div>
                <div id="gachaTab" class="tab-content hidden text-center">
                    <p class="mb-4">ìš´ëª…ì˜ ë½‘ê¸°ë¡œ í¬ê·€í•œ í«ì„ ë§Œë‚˜ë³´ì„¸ìš”!</p>
                    <div id="gachaResultContainer" class="h-48 flex items-center justify-center text-8xl mb-4">â“</div>
                    <button onclick="doGacha('normal')" class="btn w-full bg-teal-500 border-teal-300 text-white p-4 rounded-lg text-xl mb-2" ${gameState.money<50000?"disabled":""}>ì¼ë°˜ ë½‘ê¸° (5ë§Œ)</button>
                    <button onclick="doGacha('premium')" class="btn w-full bg-yellow-500 border-yellow-300 text-black p-4 rounded-lg text-xl" ${gameState.goldenAcorns<10?"disabled":""}>í”„ë¦¬ë¯¸ì—„ ë½‘ê¸° (í™©ê¸ˆë„í† ë¦¬ 10ê°œ)</button>
                </div>`;
                break;
            case 'petModal': 
                modalTitle = "í« ê´€ë¦¬";
                const petList = gameState.pets.length > 0 ? gameState.pets.map(pet => {
                    const petData = PET_DATA[pet.type];
                    if(!petData) return '';
                    const isEquipped = gameState.equippedPetIds.includes(pet.id);
                    return `<div class="p-2 rounded-lg border-2 ${isEquipped ? 'border-green-500 bg-green-900/50' : 'border-gray-600'} text-center flex flex-col justify-between">
                        <div>
                            <div class="text-4xl">${petData.img}</div>
                            <div class="text-xs">${petData.name}</div>
                            <div class="text-xs text-yellow-300">+${pet.enhancement} / Lv.${pet.evolution}</div>
                        </div>
                        <button onclick="toggleEquip(${pet.id})" class="btn w-full text-xs mt-2 p-1 rounded ${isEquipped ? 'bg-red-600 border-red-400' : 'bg-green-600 border-green-400'} text-white">${isEquipped ? 'í•´ì œ' : 'ì¥ì°©'}</button>
                    </div>`;
                }).join('') : '<p class="col-span-full text-center text-gray-400">í«ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                contentHTML = `
                    <p class="text-center mb-4">ì¥ì°© ìŠ¬ë¡¯: ${gameState.equippedPetIds.length} / ${gameState.petLimit}</p>
                    <div class="grid grid-cols-3 md:grid-cols-5 gap-4 max-h-[60vh] overflow-y-auto bg-black/30 p-4 rounded-lg">${petList}</div>`;
                break;
            case 'enhanceModal':
                modalTitle = "ê°•í™”";
                const renderEnhanceGrid = () => {
                    return gameState.pets.length > 0 ? gameState.pets.map(pet => {
                        const petData = PET_DATA[pet.type];
                        if(!petData) return '';
                        const isSelected = enhanceSelection.includes(pet.id);
                        return `<div class="p-2 rounded-lg border-2 ${isSelected ? 'border-cyan-400 bg-cyan-900/50' : 'border-gray-600'} text-center cursor-pointer" onclick="selectForEnhance(${pet.id})">
                            <div class="text-4xl">${petData.img}</div>
                            <div class="text-xs">${petData.name}</div>
                            <div class="text-xs text-yellow-300">+${pet.enhancement} / Lv.${pet.evolution}</div>
                        </div>`;
                    }).join('') : '<p class="col-span-full text-center text-gray-400">í«ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                };
                contentHTML = `
                    <p class="text-center mb-2">ê°•í™”í•  í« 1ë§ˆë¦¬ì™€ ì¬ë£Œ í« 1ë§ˆë¦¬, ì´ 2ë§ˆë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                    <p class="text-center mb-4 text-sm text-gray-400">ë™ì¼í•œ ì¢…ë¥˜, ê°•í™”, ì§„í™” ë‹¨ê³„ì˜ í«ë§Œ ì¬ë£Œë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                    <button onclick="doEnhance()" class="btn w-full bg-red-600 border-red-400 p-3 mb-4 rounded-lg">ê°•í™” ì‹¤í–‰</button>
                    <div class="grid grid-cols-3 md:grid-cols-5 gap-2 max-h-[50vh] overflow-y-auto bg-black/30 p-2 rounded-lg">${renderEnhanceGrid()}</div>`;
                break;
             case 'evolveModal':
                modalTitle = "ì§„í™”";
                const renderEvolveGrid = () => {
                    return gameState.pets.length > 0 ? gameState.pets.map(pet => {
                        const petData = PET_DATA[pet.type];
                        if(!petData) return '';
                        const isSelected = evolveSelection.includes(pet.id);
                        return `<div class="p-2 rounded-lg border-2 ${isSelected ? 'border-cyan-400 bg-cyan-900/50' : 'border-gray-600'} text-center cursor-pointer" onclick="selectForEvolve(${pet.id})">
                            <div class="text-4xl">${petData.img}</div>
                            <div class="text-xs">${petData.name}</div>
                            <div class="text-xs text-yellow-300">+${pet.enhancement} / Lv.${pet.evolution}</div>
                        </div>`;
                    }).join('') : '<p class="col-span-full text-center text-gray-400">í«ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                };
                contentHTML = `
                    <p class="text-center mb-2">ì§„í™”í•  í« 1ë§ˆë¦¬ì™€ ë™ì¼ ì¢…ë¥˜ ì¬ë£Œ í« 2ë§ˆë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
                    <p class="text-center mb-4 text-sm text-gray-400">ë¹„ìš© ì—†ì´ ì¬ë£Œ í«ë§Œ ì†Œëª¨ë©ë‹ˆë‹¤.</p>
                    <button onclick="doEvolve()" class="btn w-full bg-indigo-600 border-indigo-400 p-3 mb-4 rounded-lg">ì§„í™” ì‹¤í–‰</button>
                    <div class="grid grid-cols-3 md:grid-cols-5 gap-2 max-h-[50vh] overflow-y-auto bg-black/30 p-2 rounded-lg">${renderEvolveGrid()}</div>`;
                break;
            case 'missionModal':
                 modalTitle = "ë¯¸ì…˜";
                 const renderMissionList = (type) => gameState.missions[type].map((mission, index) => {
                     const progress = Math.min(mission.progress, mission.target);
                     const isComplete = progress >= mission.target;
                     return `<div class="bg-black/40 p-3 rounded-lg flex items-center justify-between gap-4">
                         <div class="flex-grow">
                             <p>${mission.text}</p>
                             <div class="progress-bar mt-1 h-4"><div class="progress-bar-inner" style="width: ${isComplete ? 100 : (progress/mission.target*100)}%"></div></div>
                             <p class="text-xs text-right">${formatNumber(progress)} / ${formatNumber(mission.target)}</p>
                         </div>
                         <button onclick="claimMissionReward('${type}', ${index})" class="btn bg-yellow-600 border-yellow-400 text-black px-4 py-2 rounded-lg" ${!isComplete || mission.claimed ? 'disabled' : ''}>
                             ${mission.claimed ? 'ì™„ë£Œ' : `+${mission.reward} <i class="fa-solid fa-cookie-bite"></i>`}
                         </button>
                     </div>`;
                 }).join('');
                 contentHTML = `
                 <div class="flex border-b-2 border-purple-500 mb-4">
                     <button class="tab-button flex-1 p-3 text-lg active" data-tab="daily" onclick="switchTab(event, 'missions')">ì¼ì¼ ë¯¸ì…˜</button>
                     <button class="tab-button flex-1 p-3 text-lg" data-tab="weekly" onclick="switchTab(event, 'missions')">ì£¼ê°„ ë¯¸ì…˜</button>
                 </div>
                 <div id="dailyTab" class="tab-content space-y-2 max-h-[60vh] overflow-y-auto pr-2">${renderMissionList('daily')}</div>
                 <div id="weeklyTab" class="tab-content hidden space-y-2 max-h-[60vh] overflow-y-auto pr-2">${renderMissionList('weekly')}</div>`;
                 break;
            case 'collectionModal':
                 modalTitle = "ë„ê°";
                 const collectedCount = Object.keys(gameState.collection).length;
                 const totalCount = Object.keys(PET_DATA).length;
                 const bonus = (collectedCount * 0.2).toFixed(1); // 0.2% per unique pet
                 contentHTML = `
                    <p class="text-center mb-4">ìˆ˜ì§‘ë¥ : ${collectedCount} / ${totalCount} (${(collectedCount/totalCount*100).toFixed(1)}%)</p>
                    <p class="text-center mb-4 text-cyan-300">í˜„ì¬ ë„ê° íš¨ê³¼: ëª¨ë“  ì¬í™” íšë“ëŸ‰ +${bonus}%</p>
                    <div class="grid grid-cols-4 md:grid-cols-6 gap-4 max-h-[60vh] overflow-y-auto bg-black/30 p-4 rounded-lg">
                        ${Object.keys(PET_DATA).map(type => {
                            const pet = PET_DATA[type];
                            const isCollected = gameState.collection[type];
                            return `<div class="p-2 rounded-lg text-center ${isCollected ? 'bg-green-900/50' : 'bg-black/50 opacity-50'}">
                                <div class="text-4xl" style="filter: ${isCollected ? '' : 'grayscale(100%)'}">${pet.img}</div>
                                <div class="text-xs mt-1">${isCollected ? pet.name : '???'}</div>
                                <div class="text-xs font-bold ${RARITY_COLORS[pet.rarity] || 'text-white'}">${pet.rarity}</div>
                                ${isCollected ? `<div class="text-xs text-yellow-300">x${gameState.collection[type]}</div>` : ''}
                            </div>`;
                        }).join('')}
                    </div>`;
                 break;
            case 'disassemblyModal':
                modalTitle = "í« ë¶„í•´";
                const disassemblyList = gameState.pets.length > 0 ? gameState.pets.map(pet => {
                    const petData = PET_DATA[pet.type];
                    if (!petData || petData.cost === 0) return '';
                    const isEquipped = gameState.equippedPetIds.includes(pet.id);
                    const refundAmount = Math.floor(petData.cost * 0.25);
                    return `<div class="p-2 rounded-lg border-2 ${isEquipped ? 'border-red-500 bg-red-900/50' : 'border-gray-600'} text-center flex flex-col justify-between">
                        <div>
                            <div class="text-4xl">${petData.img}</div>
                            <div class="text-xs">${petData.name}</div>
                            <div class="text-xs text-yellow-300">+${pet.enhancement} / Lv.${pet.evolution}</div>
                        </div>
                        <button onclick="doDisassembly(${pet.id})" class="btn w-full text-xs mt-2 p-1 rounded bg-stone-600 border-stone-400 text-white" ${isEquipped ? 'disabled' : ''}>
                            ë¶„í•´ (${formatNumber(refundAmount)})
                        </button>
                    </div>`;
                }).join('') : '<p class="col-span-full text-center text-gray-400">ë¶„í•´í•  í«ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                contentHTML = `
                    <p class="text-center mb-4 text-sm text-gray-400">ì¥ì°© ì¤‘ì¸ í«ì€ ë¶„í•´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    <div class="grid grid-cols-3 md:grid-cols-5 gap-4 max-h-[60vh] overflow-y-auto bg-black/30 p-4 rounded-lg">${disassemblyList}</div>`;
                break;
            case 'rebirthModal':
                modalTitle = "í™˜ìƒ";
                const rebirthCost = 1e9;
                const pointsToGain = gameState.money >= rebirthCost ? Math.floor(Math.log10(gameState.money / rebirthCost) * 2) + 1 : 0;
                contentHTML = `
                <div class="text-center">
                    <p class="text-lg">í˜„ì¬ ì¬í™”ë¥¼ ì†Œëª¨í•˜ì—¬ ì˜êµ¬ì ì¸ í˜ì„ ì–»ìŠµë‹ˆë‹¤.</p>
                    <p class="text-yellow-300 my-4 text-2xl">íšë“ ì˜ˆìƒ í™©ê¸ˆ ë„í† ë¦¬: ${pointsToGain}ê°œ</p>
                    <button onclick="doRebirth()" class="btn w-full bg-purple-600 border-purple-400 text-white p-4 rounded-lg text-xl" ${gameState.money < rebirthCost ? 'disabled' : ''}>í™˜ìƒí•˜ê¸° (${formatNumber(rebirthCost)})</button>
                </div>
                <h3 class="text-2xl font-bold mt-8 mb-4 text-center border-t-2 border-purple-500 pt-4">ìœ ë¬¼ ìƒì </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[40vh] overflow-y-auto pr-2">
                    ${Object.keys(ARTIFACT_DATA).map(id => {
                        const artifact = ARTIFACT_DATA[id];
                        const level = gameState.artifacts[id] || 0;
                        const cost = artifact.cost(level);
                        const effect = (artifact.effect(level) * 100).toFixed(2);
                        const nextEffect = (artifact.effect(level + 1) * 100).toFixed(2);
                        return `<div class="bg-black/40 p-3 rounded-lg flex flex-col">
                            <h4 class="font-bold text-lg">${artifact.name} [Lv.${level}]</h4>
                            <p class="text-sm text-gray-400 flex-grow">${artifact.desc.replace('{EFFECT}', effect)}</p>
                            ${level < artifact.maxLevel ? `
                                <p class="text-xs text-cyan-300">ë‹¤ìŒ ë ˆë²¨: +${nextEffect}%</p>
                                <button onclick="buyArtifact('${id}')" class="btn mt-2 w-full bg-yellow-600 border-yellow-400 text-black p-2 rounded-lg" ${gameState.goldenAcorns < cost ? 'disabled' : ''}>
                                    <i class="fa-solid fa-cookie-bite"></i> ${cost}
                                </button>
                            ` : '<p class="text-center text-yellow-400 mt-2">ìµœëŒ€ ë ˆë²¨</p>'}
                        </div>`;
                    }).join('')}
                </div>`;
                break;
            case 'storyBookModal':
                modalTitle = "ìš°ì£¼ì˜ ì„œì‚¬ì‹œ";
                contentHTML = `<div class="space-y-2 max-h-[70vh] overflow-y-auto pr-2">
                    ${Object.keys(STORY_BOOK_DATA).map(key => {
                        const book = STORY_BOOK_DATA[key];
                        const isUnlocked = gameState.storyBooks[key];
                        if (isUnlocked) {
                             return `<div class="bg-black/40 p-4 rounded-lg">
                                <h3 class="text-xl font-bold text-cyan-300">${book.name}</h3>
                                <p class="mt-2 text-gray-300 whitespace-pre-wrap">${book.content}</p>
                             </div>`;
                        } else {
                            return `<button onclick="buyBook('${key}')" class="btn w-full bg-blue-800 border-blue-500 text-white p-3 rounded-lg flex justify-between items-center" ${gameState.money < book.cost ? 'disabled' : ''}><span>${book.name} êµ¬ë§¤</span> <span>${formatNumber(book.cost)}</span></button>`;
                        }
                    }).join('')}
                    </div>`;
                break;
            case 'titleModal':
                modalTitle = "ì¹­í˜¸ ê´€ë¦¬";
                contentHTML = `
                <p class="text-center mb-4">í˜„ì¬ ì¹­í˜¸: <span class="text-cyan-300">[${gameState.titles.equipped}]</span></p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto bg-black/30 p-4 rounded-lg">
                ${Object.keys(TITLE_DATA).map(title => {
                    const isUnlocked = gameState.titles.unlocked.includes(title);
                    const isEquipped = gameState.titles.equipped === title;
                    return `<div class="p-3 rounded-lg ${isUnlocked ? 'bg-purple-900/50' : 'bg-black/50 opacity-60'}">
                        <h4 class="font-bold text-lg">${title}</h4>
                        <p class="text-sm text-gray-400">${TITLE_DATA[title].desc}</p>
                        ${isUnlocked ? `<button onclick="equipTitle('${title}')" class="btn w-full mt-2 p-1 text-sm rounded ${isEquipped ? 'bg-gray-500' : 'bg-cyan-600 border-cyan-400'}" ${isEquipped ? 'disabled' : ''}>${isEquipped ? 'ì¥ì°©ì¤‘' : 'ì¥ì°©'}</button>` : ''}
                    </div>`
                }).join('')}
                </div>`;
                break;
            case 'statsModal':
                modalTitle = "ìƒì„¸ ìŠ¤íƒ¯";
                const cps = calculateCPS();
                contentHTML = `<div class="text-lg space-y-2 max-h-[70vh] overflow-y-auto">
                    <p>ì´ í”Œë ˆì´ ì‹œê°„: <span class="text-cyan-300">${new Date(gameState.stats.playTime * 1000).toISOString().substr(11, 8)}</span></p>
                    <p>ì´ í´ë¦­ íšŸìˆ˜: <span class="text-cyan-300">${gameState.stats.totalClicks.toLocaleString()}</span></p>
                    <p>ì´ íšë“ ì¬í™”: <span class="text-cyan-300">${formatNumber(gameState.stats.totalMoney)}</span></p>
                    <p>ìµœëŒ€ ë³´ìœ  ì¬í™”: <span class="text-cyan-300">${formatNumber(gameState.stats.maxMoney)}</span></p>
                    <p>í™˜ìƒ íšŸìˆ˜: <span class="text-cyan-300">${gameState.stats.rebirths}íšŒ</span></p>
                    <p>í´ë¦­ë‹¹ ì¬í™”: <span class="text-cyan-300">${formatNumber(cps.click)}</span></p>
                    <p>ì´ˆë‹¹ ìë™ íšë“ ì¬í™”: <span class="text-cyan-300">${formatNumber(cps.auto)}</span></p>
                </div>`;
                break;
            case 'settingsModal':
                 modalTitle = "ì„¤ì •";
                 contentHTML = `<div class="space-y-4">
                        <div class="flex items-center gap-4">
                           <input type="text" id="couponInput" class="bg-gray-900 text-white p-3 rounded-lg w-full" placeholder="ì¿ í° ì½”ë“œ ì…ë ¥">
                           <button onclick="applyCoupon(document.getElementById('couponInput').value.trim())" class="btn bg-green-600 border-green-400 text-white px-6 py-3 rounded-lg">ì…ë ¥</button>
                        </div>
                        <button onclick="toggleNumberFormat()" class="btn w-full bg-purple-600 border-purple-400 p-3 rounded-lg">ìˆ«ì í‘œì‹œ ë°©ì‹ ë³€ê²½: ${gameState.settings.numberFormat === 'full' ? 'ì „ì²´' : 'ë‹¨ìœ„'}</button>
                        <button onclick="resetGame()" class="btn w-full bg-red-800 border-red-500 p-3 rounded-lg">ê²Œì„ ë°ì´í„° ì´ˆê¸°í™”</button>
                    </div>`;
                break;
        }
        modalContent.innerHTML = `<h2 class="text-3xl font-bold mb-6 text-center">${modalTitle}</h2> ${contentHTML} <button onclick="closeModal()" class="btn mt-6 w-full bg-gray-600 border-gray-400 p-2 rounded-lg">ë‹«ê¸°</button>`;
        modalContainer.classList.remove('hidden');
        if (modalId === 'shopModal' || modalId === 'missionModal') {
            switchTab({currentTarget: modalContent.querySelector('.tab-button')}, modalId.replace('Modal', ''));
        }
    }
    
    function switchTab(event, group) {
        const targetTab = event.currentTarget.dataset.tab;
        modalContent.querySelectorAll(`.tab-content`).forEach(el => {
            if (el.id.toLowerCase().includes(group.toLowerCase())) el.classList.add('hidden');
        });
        event.currentTarget.parentElement.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
        document.getElementById(`${targetTab}Tab`).classList.remove('hidden');
        event.currentTarget.classList.add('active');
    }

    function closeModal() { enhanceSelection = []; evolveSelection = []; modalContainer.classList.add('hidden'); }
    function buyPet(type) { const petData=PET_DATA[type];if(gameState.money>=petData.cost){changeMoney(-petData.cost);addPet(type);showToast(`${petData.name} êµ¬ë§¤ ì™„ë£Œ!`,"success");showModal("shopModal")}else{showToast("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.","error")}}
    function buyBook(key) { const book = STORY_BOOK_DATA[key]; if (gameState.money >= book.cost) { changeMoney(-book.cost); gameState.storyBooks[key] = true; showToast(`'${book.name}' êµ¬ë§¤ ì™„ë£Œ!`, 'success'); showModal('storyBookModal'); } else { showToast('ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error'); } }
    function toggleEquip(petId) { const index = gameState.equippedPetIds.indexOf(petId); if (index > -1) gameState.equippedPetIds.splice(index, 1); else if (gameState.equippedPetIds.length < gameState.petLimit) gameState.equippedPetIds.push(petId); else showToast('í« ì¥ì°© ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤!', 'error'); showModal('petModal'); renderEquippedPets(); }
    function doGacha(type) {
        const cost = type === 'normal' ? 50000 : 0;
        const goldCost = type === 'premium' ? 10 : 0;
        if(gameState.money < cost || gameState.goldenAcorns < goldCost) { showToast('ë¹„ìš©ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.', 'error'); return; }
        changeMoney(-cost);
        changeGoldenAcorns(-goldCost);

        const gachaBox = document.getElementById('gachaResultContainer');
        gachaBox.innerHTML = `<div class="text-8xl animate-spin">ğŸŒ€</div>`;
        
        setTimeout(() => {
            const rates = GACHA_RATES[type];
            const totalWeight = rates.reduce((sum, pet) => sum + pet.weight, 0);
            let random = Math.random() * totalWeight;
            let resultPetType = rates[rates.length - 1].type;
            for (const pet of rates) {
                if (random < pet.weight) { resultPetType = pet.type; break; }
                random -= pet.weight;
            }
            
            addPet(resultPetType, 'gacha');
            
            const petData = PET_DATA[resultPetType];
            gachaBox.innerHTML = `<div class="text-center" style="animation: fadeIn 0.5s">
                    <div class="text-7xl">${petData.img}</div>
                    <div class="text-2xl font-bold mt-2 ${RARITY_COLORS[petData.rarity]}">${petData.name}</div>
                    <div class="text-lg px-3 py-1 rounded-full mt-1">${petData.rarity}</div>
                </div>`;
        }, 1500);
    }
    
    function renderAll() { renderMoney(); renderGoldenAcorns(); renderEquippedPets(); }
    function renderMoney() { moneyDisplay.textContent = formatNumber(gameState.money); }
    function renderGoldenAcorns() { goldenAcornAmount.textContent = gameState.goldenAcorns.toLocaleString(); }
    function renderEquippedPets() {
        gameScreen.innerHTML = '';
        let equippedPets = gameState.equippedPetIds.map(id => findPetById(id)).filter(p => p);
        if (equippedPets.length === 0 && gameState.pets.length > 0) equippedPets = [gameState.pets[0]];
        if (equippedPets.length > 0) {
             equippedPets.forEach(pet => {
                const petData = PET_DATA[pet.type];
                if (!petData) return;
                const el = document.createElement('div');
                el.className = 'text-center pet';
                el.innerHTML = `<div class="text-7xl">${petData.img}</div><div class="text-sm font-bold">${petData.name}</div>`;
                gameScreen.appendChild(el);
            });
            gameScreen.onclick = handlePetClick;
        } else {
            gameScreen.innerHTML = `<div class="text-2xl text-center text-gray-400">ìƒì ì—ì„œ ì²« í«ì„ êµ¬ë§¤í•˜ì„¸ìš”!</div>`;
            gameScreen.onclick = null;
        }
    }
    
    function formatNumber(num) {
        if (!isFinite(num)) return "0";
        if (gameState.settings.numberFormat === 'korean' && num >= 10000) {
            const units = ['', 'ë§Œ', 'ì–µ', 'ì¡°', 'ê²½'];
            const order = Math.floor(Math.log10(num) / 4);
            if(order >= units.length) return num.toExponential(2);
            const value = (num / Math.pow(10, order * 4));
            return `${value.toFixed(order > 0 ? 2 : 0)}${units[order]}`;
        }
        return Math.floor(num).toLocaleString('en-US');
    }
    function toggleNumberFormat() { gameState.settings.numberFormat = gameState.settings.numberFormat === 'full' ? 'korean' : 'full'; renderMoney(); showModal('settingsModal'); }
    function findPetById(id) { return gameState.pets.find(p => p.id === id); }
    function showToast(message, type = 'default') {
        toast.textContent = message;
        toast.className = 'fixed bottom-10 right-10 px-6 py-3 rounded-lg shadow-xl text-lg opacity-0 transform translate-y-5 transition-all duration-500 z-[100]';
        switch (type) {
            case 'success': toast.classList.add('bg-green-600', 'text-white'); break;
            case 'error': toast.classList.add('bg-red-600', 'text-white'); break;
            case 'info': toast.classList.add('bg-cyan-500', 'text-white'); break;
            default: toast.classList.add('bg-gray-800', 'text-white'); break;
        }
        toast.classList.remove('opacity-0', 'translate-y-5');
        setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-5'); }, 3000);
     }
    function handleOfflineProgress() {
        const timeOffline = Date.now() - (gameState.lastSaveTime || Date.now());
        const maxOfflineTime = 8 * 60 * 60 * 1000;
        let effectiveTime = Math.min(timeOffline, maxOfflineTime);
        if(gameState.artifacts.timeCrystal) effectiveTime *= (1 + ARTIFACT_DATA.timeCrystal.effect(gameState.artifacts.timeCrystal));
        if (effectiveTime > 60000) {
            const passiveIncomeRate = (calculateCPS().auto * 0.2); // 20% effectiveness
            const earned = Math.floor(passiveIncomeRate * (effectiveTime / 1000));
            if (earned > 0) {
                 showToast(`${(timeOffline/3600000).toFixed(1)}ì‹œê°„ì˜ ì˜¤í”„ë¼ì¸ ë³´ìƒìœ¼ë¡œ ${formatNumber(earned)}ì„ íšë“í–ˆìŠµë‹ˆë‹¤!`, 'info');
                changeMoney(earned);
            }
        }
    }
    
    function saveGame() { localStorage.setItem('dotoriGameSave_v3_final', JSON.stringify(gameState)); }
    function loadGame() {
        const savedGame = localStorage.getItem('dotoriGameSave_v3_final');
        if (savedGame) {
            const loadedState = JSON.parse(savedGame);
            gameState = Object.assign({}, JSON.parse(JSON.stringify(initialGameState)), loadedState);
            nextPetId = gameState.pets.length > 0 ? Math.max(0, ...gameState.pets.map(p => p.id)) + 1 : 0;
        } else {
            gameState = JSON.parse(JSON.stringify(initialGameState));
        }
    }
    function resetGame() {
        if(window.confirm('ì •ë§ë¡œ ê²Œì„ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì§„í–‰ ìƒí™©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.')) {
            localStorage.removeItem('dotoriGameSave_v3_final');
            window.location.reload();
        }
    }
    
    window.onload = init;
    </script>
</body>
</html>
