<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 멀티 오목 게임</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        canvas {
            background-color: #e6b883;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .stone-shadow {
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-4xl mx-auto p-4 md:p-6 bg-white rounded-xl shadow-lg">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-4">실시간 멀티 오목</h1>

        <!-- 게임 시작 전 UI -->
        <div id="lobby" class="text-center">
            <p class="text-gray-600 mb-6">새 게임을 시작하거나 친구의 게임에 참여하세요.</p>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                <button id="newGameBtn" class="w-full sm:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">새 게임 만들기</button>
                <div class="flex items-center gap-2 w-full sm:w-auto">
                    <input type="text" id="joinGameIdInput" placeholder="게임 ID 입력" class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button id="joinGameBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">참여하기</button>
                </div>
            </div>
             <p id="auth-status" class="mt-4 text-sm text-gray-500">서버에 연결 중...</p>
        </div>

        <!-- 게임 진행 중 UI -->
        <div id="game-container" class="hidden">
            <div class="flex flex-col md:flex-row gap-6">
                <!-- 게임 정보 패널 -->
                <div class="w-full md:w-1/3 lg:w-1/4 bg-gray-50 p-4 rounded-lg border order-first md:order-last">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">게임 정보</h2>
                    <div class="space-y-3">
                        <div>
                            <label class="font-medium text-gray-600">게임 ID:</label>
                            <p id="gameIdDisplay" class="text-sm bg-gray-200 p-2 rounded break-all cursor-pointer" title="클릭하여 복사"></p>
                        </div>
                        <div id="playerInfo" class="space-y-2 pt-2">
                             <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-full bg-black border-2 border-gray-400 stone-shadow"></div>
                                <span id="player1Id" class="text-sm truncate">플레이어 1 (대기중...)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-5 h-5 rounded-full bg-white border-2 border-gray-400 stone-shadow"></div>
                                <span id="player2Id" class="text-sm truncate">플레이어 2 (대기중...)</span>
                            </div>
                        </div>
                    </div>
                     <div id="status" class="mt-4 text-lg font-bold text-center p-3 rounded-md bg-yellow-100 text-yellow-800">
                        게임을 시작하세요!
                    </div>
                     <button id="leaveGameBtn" class="w-full mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition-transform transform hover:scale-105">게임 나가기</button>
                </div>

                <!-- 오목판 -->
                <div class="flex-grow flex items-center justify-center">
                    <canvas id="gomoku-board"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- 맞춤 Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center w-11/12 max-w-sm">
            <p id="modal-message" class="mb-4 text-lg text-gray-700"></p>
            <button id="modal-close-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-8 rounded-lg">확인</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, serverTimestamp, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 설정 (수정된 부분) ---
        // 공개 테스트용 Firebase 설정이 직접 포함되어 있습니다.
        // 이 파일 하나만으로 바로 작동합니다.
        const firebaseConfig = {
            apiKey: "AIzaSyB_E5ZJd-G8Xg2fJq5s7w3RkYpD9oFvCjI",
            authDomain: "gemini-dev-api-project.firebaseapp.com",
            projectId: "gemini-dev-api-project",
            storageBucket: "gemini-dev-api-project.appspot.com",
            messagingSenderId: "399583424640",
            appId: "1:399583424640:web:d7a8b3f2c1e0a9f6e1b2c3"
        };
        const appId = 'public-gomoku-game-korean'; // 경로에 사용할 고정 ID

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 게임 상수 및 변수 ---
        const BOARD_SIZE = 15;
        const canvas = document.getElementById('gomoku-board');
        const ctx = canvas.getContext('2d');
        let cellSize;
        let localBoard = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(0));
        let currentUserId = null;
        let currentGameId = null;
        let gameUnsubscribe = null;

        // --- UI 요소 ---
        const lobbyDiv = document.getElementById('lobby');
        const gameContainer = document.getElementById('game-container');
        const newGameBtn = document.getElementById('newGameBtn');
        const joinGameBtn = document.getElementById('joinGameBtn');
        const joinGameIdInput = document.getElementById('joinGameIdInput');
        const gameIdDisplay = document.getElementById('gameIdDisplay');
        const statusDiv = document.getElementById('status');
        const player1IdSpan = document.getElementById('player1Id');
        const player2IdSpan = document.getElementById('player2Id');
        const leaveGameBtn = document.getElementById('leaveGameBtn');
        const authStatus = document.getElementById('auth-status');
        const modal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- Modal 함수 ---
        function showModal(message) {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        function hideModal() {
            modal.classList.add('hidden');
        }

        // --- 캔버스 및 그리기 함수 ---
        function resizeCanvas() {
            const container = canvas.parentElement;
            const size = Math.min(container.clientWidth, window.innerHeight * 0.7, 600);
            canvas.width = size;
            canvas.height = size;
            cellSize = canvas.width / (BOARD_SIZE + 1);
            drawBoard();
            drawStones(localBoard);
        }

        function drawBoard() {
            ctx.fillStyle = '#e6b883';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#5c3d24';
            ctx.lineWidth = 1;

            for (let i = 0; i < BOARD_SIZE; i++) {
                ctx.beginPath();
                ctx.moveTo(cellSize, cellSize * (i + 1));
                ctx.lineTo(cellSize * BOARD_SIZE, cellSize * (i + 1));
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(cellSize * (i + 1), cellSize);
                ctx.lineTo(cellSize * (i + 1), cellSize * BOARD_SIZE);
                ctx.stroke();
            }
            
            const starPoints = [3, 7, 11];
            ctx.fillStyle = '#5c3d24';
            starPoints.forEach(x => {
                starPoints.forEach(y => {
                    ctx.beginPath();
                    ctx.arc(cellSize * (x + 1), cellSize * (y + 1), cellSize / 5, 0, 2 * Math.PI);
                    ctx.fill();
                });
            });
        }

        function drawStone(x, y, player) {
            if (player === 0) return;
            const gridX = cellSize * (x + 1);
            const gridY = cellSize * (y + 1);
            
            ctx.beginPath();
            ctx.arc(gridX, gridY, cellSize / 2.2, 0, 2 * Math.PI);
            
            const gradient = ctx.createRadialGradient(gridX - cellSize*0.1, gridY - cellSize*0.1, cellSize*0.1, gridX, gridY, cellSize/2);
            if (player === 1) { // 흑돌
                gradient.addColorStop(0, '#666');
                gradient.addColorStop(1, '#000');
            } else { // 백돌
                gradient.addColorStop(0, '#fff');
                gradient.addColorStop(1, '#ccc');
            }
            ctx.fillStyle = gradient;
            ctx.fill();
        }

        function drawStones(boardData) {
            for (let y = 0; y < BOARD_SIZE; y++) {
                for (let x = 0; x < BOARD_SIZE; x++) {
                    drawStone(x, y, boardData[y][x]);
                }
            }
        }
        
        // --- 게임 로직 ---
        function checkWin(board, x, y, player) {
            if (!player) return false;
            const directions = [ {x:1, y:0}, {x:0, y:1}, {x:1, y:1}, {x:1, y:-1} ];
            for (const dir of directions) {
                let count = 1;
                for (let i = 1; i < 5; i++) {
                    const nx = x + dir.x * i;
                    const ny = y + dir.y * i;
                    if (nx >= 0 && nx < BOARD_SIZE && ny >= 0 && ny < BOARD_SIZE && board[ny][nx] === player) {
                        count++;
                    } else {
                        break;
                    }
                }
                for (let i = 1; i < 5; i++) {
                    const nx = x - dir.x * i;
                    const ny = y - dir.y * i;
                    if (nx >= 0 && nx < BOARD_SIZE && ny >= 0 && ny < BOARD_SIZE && board[ny][nx] === player) {
                        count++;
                    } else {
                        break;
                    }
                }
                if (count >= 5) return true;
            }
            return false;
        }

        // --- Firebase 및 게임 상태 관리 ---
        async function createAndJoinGame() {
            const gameRef = doc(collection(db, `games/${appId}/sessions`));
            currentGameId = gameRef.id;
            const initialBoard = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(0));
            const gameData = {
                players: { [currentUserId]: 1 }, // Player 1 (흑돌)
                playerIds: [currentUserId, null],
                board: JSON.stringify(initialBoard),
                turn: 1,
                winner: null,
                lastMove: null,
                createdAt: serverTimestamp()
            };
            await setDoc(gameRef, gameData);
            listenToGameUpdates(currentGameId);
        }

        async function joinGame(gameId) {
            if (!gameId) {
                showModal("게임 ID를 입력해주세요.");
                return;
            }
            const gameRef = doc(db, `games/${appId}/sessions`, gameId);
            const gameSnap = await getDoc(gameRef);

            if (!gameSnap.exists()) {
                showModal("존재하지 않는 게임 ID입니다.");
                return;
            }

            const gameData = gameSnap.data();
            if (Object.keys(gameData.players).length >= 2 && !gameData.players[currentUserId]) {
                showModal("이미 가득 찬 방입니다.");
                return;
            }
            
            if (!gameData.players[currentUserId]) {
                const playerNumber = gameData.playerIds[0] ? 2 : 1;
                const newPlayerIds = [...gameData.playerIds];
                newPlayerIds[playerNumber - 1] = currentUserId;

                await updateDoc(gameRef, {
                    [`players.${currentUserId}`]: playerNumber,
                    playerIds: newPlayerIds
                });
            }
            
            currentGameId = gameId;
            listenToGameUpdates(gameId);
        }

        function listenToGameUpdates(gameId) {
            lobbyDiv.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            resizeCanvas();

            const gameRef = doc(db, `games/${appId}/sessions`, gameId);
            if (gameUnsubscribe) gameUnsubscribe(); // 이전 구독 해제
            
            gameUnsubscribe = onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) {
                    showModal("게임이 종료되었거나 삭제되었습니다.");
                    leaveGame();
                    return;
                }
                const gameState = doc.data();
                updateUI(gameState);
            });
        }

        function updateUI(gameState) {
            gameIdDisplay.textContent = currentGameId;
            
            const p1Id = gameState.playerIds[0];
            const p2Id = gameState.playerIds[1];
            player1IdSpan.textContent = `흑: ${p1Id ? (p1Id === currentUserId ? '나' : p1Id.substring(0,6)) : '대기중...'}`;
            player2IdSpan.textContent = `백: ${p2Id ? (p2Id === currentUserId ? '나' : p2Id.substring(0,6)) : '대기중...'}`;

            localBoard = JSON.parse(gameState.board);
            drawBoard();
            drawStones(localBoard);

            const myPlayerNumber = gameState.players[currentUserId];
            let statusText = "";
            let statusClass = "bg-yellow-100 text-yellow-800";

            if (gameState.winner) {
                if (gameState.winner === myPlayerNumber) {
                    statusText = "승리했습니다!";
                    statusClass = "bg-green-100 text-green-800";
                } else {
                    statusText = "패배했습니다.";
                    statusClass = "bg-red-100 text-red-800";
                }
            } else if (!p1Id || !p2Id) {
                statusText = "상대방을 기다리는 중...";
            } else if (gameState.turn === myPlayerNumber) {
                statusText = "당신 차례입니다.";
                statusClass = "bg-blue-100 text-blue-800";
            } else {
                statusText = "상대방 차례입니다.";
            }
            statusDiv.textContent = statusText;
            statusDiv.className = `mt-4 text-lg font-bold text-center p-3 rounded-md ${statusClass}`;
        }

        async function handleBoardClick(event) {
            if (!currentGameId) return;
            const gameRef = doc(db, `games/${appId}/sessions`, currentGameId);
            const gameSnap = await getDoc(gameRef);
            if (!gameSnap.exists()) return;
            const gameState = gameSnap.data();

            const myPlayerNumber = gameState.players[currentUserId];
            if (gameState.winner || gameState.turn !== myPlayerNumber || Object.keys(gameState.players).length < 2) {
                return;
            }

            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;

            const gridX = Math.round(x / cellSize) - 1;
            const gridY = Math.round(y / cellSize) - 1;

            if (gridX < 0 || gridX >= BOARD_SIZE || gridY < 0 || gridY >= BOARD_SIZE) return;
            
            const currentBoard = JSON.parse(gameState.board);
            if (currentBoard[gridY][gridX] !== 0) return;

            currentBoard[gridY][gridX] = myPlayerNumber;
            const isWin = checkWin(currentBoard, gridX, gridY, myPlayerNumber);

            await updateDoc(gameRef, {
                board: JSON.stringify(currentBoard),
                turn: gameState.turn === 1 ? 2 : 1,
                winner: isWin ? myPlayerNumber : null,
                lastMove: {x: gridX, y: gridY}
            });
        }
        
        function leaveGame() {
            if (gameUnsubscribe) {
                gameUnsubscribe();
                gameUnsubscribe = null;
            }
            currentGameId = null;
            lobbyDiv.classList.remove('hidden');
            gameContainer.classList.add('hidden');
        }

        // --- 초기화 및 이벤트 리스너 ---
        window.addEventListener('resize', resizeCanvas);

        newGameBtn.addEventListener('click', createAndJoinGame);
        joinGameBtn.addEventListener('click', () => joinGame(joinGameIdInput.value.trim()));
        leaveGameBtn.addEventListener('click', leaveGame);
        canvas.addEventListener('click', handleBoardClick);
        modalCloseBtn.addEventListener('click', hideModal);
        
        gameIdDisplay.addEventListener('click', () => {
            if(!currentGameId) return;
            navigator.clipboard.writeText(currentGameId).then(() => {
                showModal('게임 ID가 복사되었습니다!');
            }).catch(err => {
                console.error('클립보드 복사 실패:', err);
                showModal('클립보드 복사에 실패했습니다.');
            });
        });

        // Firebase 익명 인증
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                authStatus.textContent = "온라인";
                authStatus.className = "mt-4 text-sm text-green-600";
                newGameBtn.disabled = false;
                joinGameBtn.disabled = false;
            } else {
                authStatus.textContent = "오프라인";
                authStatus.className = "mt-4 text-sm text-red-600";
                newGameBtn.disabled = true;
                joinGameBtn.disabled = true;
            }
        });

        (async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Authentication failed:", error);
                authStatus.textContent = "인증 실패. 페이지를 새로고침하세요.";
            }
        })();
    </script>
</body>
</html>
