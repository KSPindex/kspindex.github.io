<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyperIDE - The Ultimate IDE [v4.0]</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-language_tools.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-modelist.js"></script>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>

    <style>
        :root {
            --font-family: 'Fira Code', monospace;
            --bg-primary: #11111b; --bg-secondary: #1a1b26; --bg-tertiary: #161620; --bg-hover: #2a2c3d;
            --text-primary: #c0caf5; --text-secondary: #a9b1d6; --text-inactive: #5c637a;
            --border-primary: #343b58; --accent-primary: #7aa2f7; --accent-secondary: #bb9af7; --error-color: #f7768e;
        }
        body { font-family: var(--font-family); background-color: var(--bg-primary); color: var(--text-primary); overflow: hidden; font-size: 14px; user-select: none;}
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        
        #main-grid { display: grid; grid-template-columns: 48px 250px 5px 1fr; grid-template-rows: 35px 1fr 5px 200px 24px; height: 100vh; width: 100vw; }
        #top-bar { grid-area: 1 / 1 / 2 / 6; background-color: var(--bg-tertiary); display: flex; align-items: center; padding: 0 10px; z-index: 60; }
        #activity-bar { grid-area: 2 / 1 / 5 / 2; background-color: var(--bg-primary); z-index: 50; }
        #sidebar { grid-area: 2 / 2 / 5 / 3; background-color: var(--bg-tertiary); z-index: 40; display: flex; flex-direction: column;}
        #resizer-v { grid-area: 2 / 3 / 5 / 4; cursor: col-resize; }
        #main-view { grid-area: 2 / 4 / 3 / 5; display: flex; flex-direction: column; }
        #resizer-h { grid-area: 3 / 4 / 4 / 5; cursor: row-resize; }
        #bottom-panel { grid-area: 4 / 4 / 5 / 5; background-color: var(--bg-secondary); }
        #status-bar { grid-area: 5 / 1 / 6 / 6; background-color: var(--accent-primary); color: var(--bg-primary); z-index: 100;}

        .ace_editor { font-family: var(--font-family) !important; background: var(--bg-secondary) !important; color: var(--text-primary) !important; }
        .ace_gutter { background: var(--bg-secondary) !important; color: var(--text-inactive) !important; }
        .ace_active-line { background: rgba(255, 255, 255, 0.05) !important; }
        .ace_cursor { color: var(--text-secondary) !important; }
        .ace_selection { background: rgba(122, 162, 247, 0.25) !important; }

        .overlay { position: fixed; inset: 0; background:rgba(0,0,0,0.6); z-index: 1000; display:flex; align-items: flex-start; justify-content:center; }
        .modal-base { background: var(--bg-secondary); margin-top:15vh; width: 600px; max-width: 90vw; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.5); display:flex; flex-direction:column; border: 1px solid var(--border-primary); }
        .modal-input { background:var(--bg-primary); border:1px solid var(--border-primary); outline:none; padding:8px; width:100%; border-radius:4px; }
        .context-menu-item:hover, .command-palette-item.active { background-color: var(--bg-hover); }

        .activity-bar-icon.active { color: white; box-shadow: inset 2px 0 0 var(--accent-primary); }
        .sidebar-panel, .bottom-panel-content { display: none; }
        .sidebar-panel.active, .bottom-panel-content.active { display: flex; flex-direction: column; height: 100%; }
        .bottom-panel-tab.active { background-color: var(--accent-secondary); color: var(--bg-primary); }
        .editor-tab.active { background-color: var(--bg-secondary); border-top: 1px solid var(--accent-primary); }
        .editor-tab.modified .tab-name::after { content: " ‚óè"; color: var(--text-primary); }
    </style>
</head>
<body>

    <div id="main-grid">
        <div id="top-bar">
            <button id="run-btn" title="Run Code (Ctrl+Enter)" class="p-1.5 rounded hover:bg-[var(--bg-hover)] disabled:text-[var(--text-inactive)] disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
            </button>
        </div>

        <div id="activity-bar" class="flex flex-col items-center py-2 text-gray-400 text-xs">
            <div data-view="explorer" class="activity-bar-icon w-full p-3 my-1 cursor-pointer" title="Explorer"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg></div>
            <div class="flex-grow"></div>
            <div data-view="settings" class="activity-bar-icon w-full p-3 my-1 cursor-pointer" title="Settings"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg></div>
        </div>
        
        <div id="sidebar">
            <div id="view-explorer" class="sidebar-panel">
                <div class="p-2 flex justify-between items-center"><h2 class="text-xs uppercase font-bold tracking-wider">Explorer</h2><div class="flex items-center"><button id="new-untitled-file-global" class="p-1 hover:bg-[var(--bg-hover)] rounded" title="New Untitled Lua File"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg></button><button id="new-folder-global" class="p-1 hover:bg-[var(--bg-hover)] rounded" title="New Folder"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg></button></div></div>
                <div id="file-explorer" class="flex-1 overflow-auto p-1"></div>
            </div>
             <div id="view-settings" class="sidebar-panel p-4 overflow-y-auto">
                <h2 class="text-lg font-bold mb-4">Settings</h2>
                <div class="space-y-4">
                    <div>
                        <label for="setting-theme" class="block text-sm font-medium">Theme</label>
                        <select id="setting-theme" class="modal-input mt-1"></select>
                    </div>
                     <div>
                        <label for="setting-fontsize" class="block text-sm font-medium">Font Size</label>
                        <input type="number" id="setting-fontsize" class="modal-input mt-1 w-24" min="8" max="24">
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="setting-linenumbers" class="text-sm font-medium">Show Line Numbers</label>
                        <input type="checkbox" id="setting-linenumbers" class="h-4 w-4 rounded accent-[var(--accent-primary)]">
                    </div>
                </div>
             </div>
        </div>

        <div id="resizer-v"></div>

        <div id="main-view">
            <div id="editor-tabs" class="flex-shrink-0 flex bg-[var(--bg-tertiary)]"></div>
            <div id="editor-container" class="flex-1 relative"></div>
            <div id="welcome-screen" class="absolute inset-0 flex items-center justify-center text-center text-[var(--text-inactive)]"><div><h1 class="text-3xl mb-4">HyperIDE</h1><p>Welcome. Create or open a file to begin.</p></div></div>
        </div>
        
        <div id="resizer-h"></div>
        
        <div id="bottom-panel" class="flex flex-col">
            <div class="tabs flex-shrink-0 flex bg-[var(--bg-tertiary)] border-b border-[var(--border-primary)] text-sm">
                <div data-panel="terminal" class="bottom-panel-tab p-2 cursor-pointer">Terminal</div>
            </div>
            <div id="panel-terminal" class="bottom-panel-content flex-1 p-2 overflow-y-auto">
                <div id="terminal-output"></div>
                <div class="flex"><span class="text-[var(--accent-primary)] mr-2">$</span><input type="text" id="terminal-input" class="bg-transparent border-none outline-none w-full"/></div>
            </div>
        </div>

        <div id="status-bar" class="flex items-center justify-between px-4 text-xs z-50">
            <div class="flex items-center gap-4"><button id="cmd-palette-btn" class="hover:bg-black/20 px-2 py-0.5 rounded">Command Palette</button></div>
            <div class="flex items-center gap-4"><span id="line-col"></span><span id="language-status">Plain Text</span></div>
        </div>
    </div>
    
    <div id="modal-overlay" class="overlay hidden"></div>
    <div id="context-menu" class="absolute z-[2000] bg-[var(--bg-secondary)] border border-[var(--border-primary)] rounded-md shadow-lg text-sm hidden py-1"></div>
    <div id="notification-toast" class="fixed bottom-10 right-5 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg opacity-0 transition-opacity duration-300"></div>
    <input type="file" id="file-importer" class="hidden" multiple>

<script type="module">
    const H_IDE = {
        state: {
            fs: null, activeEditor: null, openFiles: new Map(), activePath: null,
            activeSidebarView: 'explorer', activeBottomPanel: 'terminal',
            pyodide: null, pyodideReady: false, contextMenuTarget: null, untitledCounter: 1,
            settings: { theme: 'Hyper Dark', fontSize: 14, showLineNumbers: true },
            themes: { 'Hyper Dark': {}, 'VS Code Dark': {'--bg-primary':'#1e1e1e','--bg-secondary':'#252526','--bg-tertiary':'#333333','--text-primary':'#d4d4d4'}, 'Solarized Light': {'--bg-primary':'#fdf6e3','--bg-secondary':'#f0eada','--text-primary':'#657b83','--accent-primary':'#268bd2'} }
        },
        dom: {},

        async init() {
            this.cacheDomElements();
            this.fs.init();
            this.editor.init(); // Editor must be ready before settings
            this.settings.init(); // Now settings can be applied
            this.layout.init();
            this.ui.init();
            this.terminal.init();
            this.events.init();

            this.ui.renderExplorer();
            this.terminal.log('HyperIDE v4.1 [Fixed] Initialized.');
            this.terminal.log('Loading Python environment...');
            
            try {
                this.state.pyodide = await loadPyodide();
                this.state.pyodide.setStdout({ batched: (str) => this.terminal.log(str) });
                this.state.pyodide.setStderr({ batched: (str) => this.terminal.log(str, 'error') });
                this.state.pyodideReady = true;
                this.terminal.log('Python environment ready. Use `python <filename>.py` to run.');
            } catch (error) { this.terminal.log(`Failed to load Python: ${error}`, 'error'); }
        },

        cacheDomElements() {
            const ids = ['main-grid', 'top-bar', 'run-btn', 'activity-bar', 'sidebar', 'resizer-v', 'main-view', 'resizer-h', 'bottom-panel', 'status-bar', 'file-explorer', 'editor-tabs', 'editor-container', 'welcome-screen', 'terminal-output', 'terminal-input', 'context-menu', 'notification-toast', 'line-col', 'language-status', 'new-untitled-file-global', 'new-folder-global', 'modal-overlay', 'cmd-palette-btn', 'setting-theme', 'setting-fontsize', 'setting-linenumbers', 'file-importer', 'view-settings'];
            ids.forEach(id => this.dom[id.replace(/-/g, '_')] = document.getElementById(id));
        },
        
        fs: {
            init() {
                const savedFS = localStorage.getItem('hyperide_fs_v4');
                H_IDE.state.fs = savedFS ? JSON.parse(savedFS) : {
                    'main.lua': { type: 'file', content: '-- Welcome to your Lua-centric IDE!\nfunction greet(name)\n  print("Hello, " .. name .. "!")\nend\n\ngreet("HyperIDE")' },
                    'runnable_examples': { type: 'folder', isOpen: true, children: {
                        'app.js': { type: 'file', content: 'console.log("This file can be run via the Run button or `node runnable_examples/app.js` in terminal.");' },
                        'script.py': { type: 'file', content: 'print("This file can be run via the Run button or `python runnable_examples/script.py` in terminal.")' }
                    }}
                };
            },
            save() { localStorage.setItem('hyperide_fs_v4', JSON.stringify(H_IDE.state.fs)); },
            get(path) {
                if (!path || path === '/') return { node: H_IDE.state.fs, parent: null, name: null };
                const parts = path.split('/'); let parent = null; let current = { children: H_IDE.state.fs };
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (!current || !current.children) return null;
                    parent = current; if (!parent.children[part]) return null;
                    current = parent.children[part];
                }
                return { node: current, parent: parent.children, name: parts.pop() };
            },
            create(path, type, content = '') {
                const parts = path.split('/'); const name = parts.pop();
                const parentPath = parts.join('/');
                const parentDir = this.get(parentPath)?.node;
                const parent = (parentDir && parentDir.type === 'folder') ? parentDir.children : H_IDE.state.fs;
                if (parent[name]) return H_IDE.ui.showNotification(`'${name}' already exists.`, 'error');
                parent[name] = type === 'file' ? { type: 'file', content } : { type: 'folder', children: {} };
                this.save(); H_IDE.ui.renderExplorer();
                if (type === 'file') H_IDE.files.open(path);
            },
            delete(path) {
                const { node, parent, name } = this.get(path); if (!node || !parent) return;
                if (H_IDE.state.openFiles.has(path)) H_IDE.files.close(path, true);
                if (node.type === 'folder') {
                    const closeDescendants = (p, currentDir) => Object.keys(currentDir).forEach(childName => {
                        const childPath = `${p}/${childName}`;
                        if (H_IDE.state.openFiles.has(childPath)) H_IDE.files.close(childPath, true);
                        if (currentDir[childName].type === 'folder') closeDescendants(childPath, currentDir[childName].children);
                    });
                    closeDescendants(path, node.children);
                }
                delete parent[name]; this.save(); H_IDE.ui.renderExplorer(); H_IDE.ui.showNotification(`Deleted '${name}'.`);
            },
            rename(oldPath, newName) {
                if (oldPath.split('/').pop() === newName) return;
                const { node, parent, name } = this.get(oldPath); if (!node || !parent) return;
                if (parent[newName]) return H_IDE.ui.showNotification(`'${newName}' already exists.`, 'error');
                parent[newName] = node; delete parent[name];
                const newPath = oldPath.substring(0, oldPath.length - name.length) + newName;
                if (H_IDE.state.openFiles.has(oldPath)) {
                    const fileData = H_IDE.state.openFiles.get(oldPath);
                    H_IDE.state.openFiles.delete(oldPath); H_IDE.state.openFiles.set(newPath, fileData);
                    fileData.tabEl.dataset.path = newPath; fileData.tabEl.querySelector('.tab-name').textContent = newName;
                    if (H_IDE.state.activePath === oldPath) H_IDE.state.activePath = newPath;
                }
                this.save(); H_IDE.ui.renderExplorer();
            }
        },
        
        settings: {
            init() {
                const saved = localStorage.getItem('hyperide_settings_v4');
                if (saved) H_IDE.state.settings = JSON.parse(saved);
                this.populateUI();
                this.applyAll();
            },
            save() { localStorage.setItem('hyperide_settings_v4', JSON.stringify(H_IDE.state.settings)); },
            populateUI() {
                H_IDE.dom.setting_theme.innerHTML = Object.keys(H_IDE.state.themes).map(t => `<option value="${t}">${t}</option>`).join('');
                H_IDE.dom.setting_theme.value = H_IDE.state.settings.theme;
                H_IDE.dom.setting_fontsize.value = H_IDE.state.settings.fontSize;
                H_IDE.dom.setting_linenumbers.checked = H_IDE.state.settings.showLineNumbers;
            },
            applyAll() {
                const theme = H_IDE.state.themes[H_IDE.state.settings.theme] || {};
                Object.entries(H_IDE.state.themes['Hyper Dark']).forEach(([key,val]) => document.documentElement.style.setProperty(key, val));
                Object.entries(theme).forEach(([key,val]) => document.documentElement.style.setProperty(key, val));
                
                H_IDE.state.activeEditor.setOptions({
                    fontSize: H_IDE.state.settings.fontSize + 'px',
                    showGutter: H_IDE.state.settings.showLineNumbers,
                });
            },
            update(key, value) {
                H_IDE.state.settings[key] = value;
                this.applyAll();
                this.save();
            }
        },

        editor: {
            init() {
                const editor = ace.edit(H_IDE.dom.editor_container);
                ace.require("ace/ext/language_tools");
                editor.setOptions({ enableBasicAutocompletion: true, enableLiveAutocompletion: true, enableSnippets: true, showPrintMargin: false, highlightActiveLine: true, fontFamily: 'var(--font-family)', theme: 'ace/theme/tomorrow_night_eighties' });
                editor.commands.addCommand({ name: "save", bindKey: {win: "Ctrl-S", mac: "Command-S"}, exec: () => H_IDE.files.save() });
                editor.commands.addCommand({ name: "run", bindKey: {win: "Ctrl-Enter", mac: "Command-Enter"}, exec: () => H_IDE.files.runActive() });
                editor.on("changeSelection", () => H_IDE.ui.updateStatus());
                editor.on("change", () => {
                    if (H_IDE.state.activePath) {
                        const data = H_IDE.state.openFiles.get(H_IDE.state.activePath);
                        if (data) data.tabEl.classList.add('modified');
                    }
                });
                H_IDE.state.activeEditor = editor;
            }
        },

        ui: {
            init() { this.switchSidebarView('explorer'); this.switchBottomPanel('terminal'); },
            renderExplorer(container = H_IDE.dom.file_explorer, dir = H_IDE.state.fs, pathPrefix = '', level = 0) {
                if (level === 0) container.innerHTML = '';
                Object.entries(dir).sort(([a,nodeA],[b,nodeB])=>(nodeA.type.localeCompare(nodeB.type)) || a.localeCompare(b)).forEach(([name, node]) => {
                    const path = pathPrefix ? `${pathPrefix}/${name}` : name;
                    const el = document.createElement('div');
                    el.className = 'file-item p-1 rounded cursor-pointer flex items-center hover:bg-[var(--bg-hover)]';
                    el.style.paddingLeft = `${level * 16}px`;
                    el.dataset.path = path;
                    el.innerHTML = `<span>${node.type === 'folder' ? (node.isOpen ? 'üìÇ' : 'üìÅ') : 'üìÑ'} ${name}</span>`;
                    container.appendChild(el);
                    el.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (node.type === 'folder') { node.isOpen = !node.isOpen; this.renderExplorer(); }
                        else { H_IDE.files.open(path); }
                    });
                    if (node.type === 'folder' && node.isOpen) { this.renderExplorer(container, node.children, path, level + 1); }
                });
            },
            updateStatus() {
                const editor = H_IDE.state.activeEditor;
                if (!editor || !H_IDE.state.activePath) {
                    H_IDE.dom.line_col.textContent = ''; H_IDE.dom.language_status.textContent = ''; return;
                }
                const pos = editor.getCursorPosition();
                H_IDE.dom.line_col.textContent = `Ln ${pos.row + 1}, Col ${pos.column + 1}`;
                H_IDE.dom.language_status.textContent = ace.require("ace/ext/modelist").getModeForPath(H_IDE.state.activePath).caption;
            },
            switchSidebarView(viewId) {
                document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(`view-${viewId}`)?.classList.add('active');
                document.querySelectorAll('.activity-bar-icon').forEach(i => i.classList.remove('active'));
                document.querySelector(`.activity-bar-icon[data-view="${viewId}"]`)?.classList.add('active');
            },
            switchBottomPanel(panelId) {
                document.querySelectorAll('.bottom-panel-content').forEach(p => p.classList.remove('active'));
                document.getElementById(`panel-${panelId}`)?.classList.add('active');
                document.querySelectorAll('.bottom-panel-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`.bottom-panel-tab[data-panel="${panelId}"]`)?.classList.add('active');
            },
            showNotification(msg, type = 'success') {
                const toast = H_IDE.dom.notification_toast;
                toast.textContent = msg;
                toast.style.backgroundColor = type === 'error' ? 'var(--error-color)' : 'var(--accent-secondary)';
                toast.classList.remove('opacity-0');
                setTimeout(() => toast.classList.add('opacity-0'), 3000);
            },
            showModal(content) {
                H_IDE.dom.modal_overlay.innerHTML = '';
                H_IDE.dom.modal_overlay.appendChild(content);
                H_IDE.dom.modal_overlay.classList.remove('hidden');
            },
            hideModal() { H_IDE.dom.modal_overlay.classList.add('hidden'); }
        },
        
        layout: {
            init() {
                const onDrag = (resizer, onMove) => resizer.addEventListener('mousedown', e => { e.preventDefault(); const cb = (ev)=>onMove(ev); document.addEventListener('mousemove', cb); document.addEventListener('mouseup', () => document.removeEventListener('mousemove', cb), { once: true }); });
                onDrag(H_IDE.dom.resizer_v, e => H_IDE.dom.main_grid.style.gridTemplateColumns = `48px ${e.clientX - 48}px 5px 1fr`);
                onDrag(H_IDE.dom.resizer_h, e => H_IDE.dom.main_grid.style.gridTemplateRows = `35px 1fr 5px ${window.innerHeight - e.clientY - 24 - 35}px 24px`);
            }
        },

        files: {
            open(path, isUntitled = false, content = '') {
                if (H_IDE.state.openFiles.has(path)) return this.switch(path);
                let fileContent = content;
                if (!isUntitled) {
                    const file = H_IDE.fs.get(path)?.node;
                    if (!file || file.type !== 'file') return;
                    fileContent = file.content;
                }
                H_IDE.dom.welcome_screen.style.display = 'none';
                const session = ace.createEditSession(fileContent, ace.require("ace/ext/modelist").getModeForPath(path).mode);
                session.on('change', () => { if(H_IDE.state.openFiles.has(path)) H_IDE.state.openFiles.get(path).tabEl.classList.add('modified'); });
                const tabEl = document.createElement('div');
                tabEl.className = 'editor-tab px-4 py-2 border-r border-[var(--border-primary)] cursor-pointer flex items-center gap-2';
                tabEl.dataset.path = path;
                const fileName = path.split('/').pop();
                tabEl.innerHTML = `<span class="tab-name">${fileName}</span><span class="close-tab text-xs p-1 rounded-full hover:bg-[var(--bg-hover)]">x</span>`;
                tabEl.onclick = () => this.switch(path);
                tabEl.querySelector('.close-tab').onclick = (e) => { e.stopPropagation(); this.close(path); };
                H_IDE.dom.editor_tabs.appendChild(tabEl);
                H_IDE.state.openFiles.set(path, { session, tabEl, isUntitled });
                this.switch(path);
            },
            openUntitled() {
                const path = `Untitled-${H_IDE.state.untitledCounter++}.lua`;
                this.open(path, true, '-- New Lua File');
            },
            switch(path) {
                if (H_IDE.state.activePath === path) return;
                if(H_IDE.state.activePath && H_IDE.state.openFiles.has(H_IDE.state.activePath)) H_IDE.state.openFiles.get(H_IDE.state.activePath).tabEl.classList.remove('active');
                H_IDE.state.activePath = path;
                const data = H_IDE.state.openFiles.get(path);
                data.tabEl.classList.add('active');
                H_IDE.state.activeEditor.setSession(data.session);
                H_IDE.state.activeEditor.focus();
                H_IDE.ui.updateStatus();
                H_IDE.dom.run_btn.disabled = false;
            },
            close(path, force = false) {
                const data = H_IDE.state.openFiles.get(path); if (!data) return;
                H_IDE.dom.editor_tabs.removeChild(data.tabEl); H_IDE.state.openFiles.delete(path);
                if (H_IDE.state.activePath === path) {
                    const nextPath = [...H_IDE.state.openFiles.keys()].pop();
                    if (nextPath) this.switch(nextPath);
                    else {
                        H_IDE.state.activePath = null;
                        H_IDE.dom.welcome_screen.style.display = 'flex';
                        H_IDE.dom.run_btn.disabled = true;
                        H_IDE.ui.updateStatus();
                    }
                }
            },
            save() {
                if (!H_IDE.state.activePath) return;
                const path = H_IDE.state.activePath;
                const data = H_IDE.state.openFiles.get(path); if (!data) return;
                if (data.isUntitled) { H_IDE.events.showSaveAsModal(path); }
                else {
                    const file = H_IDE.fs.get(path)?.node;
                    file.content = data.session.getValue();
                    H_IDE.fs.save();
                    data.tabEl.classList.remove('modified');
                    H_IDE.ui.showNotification(`${path.split('/').pop()} saved.`);
                }
            },
            runActive() {
                if (!H_IDE.state.activePath) return H_IDE.ui.showNotification('No active file to run.', 'error');
                const path = H_IDE.state.activePath;
                const ext = path.split('.').pop();
                let command;
                if (ext === 'js') command = 'node';
                else if (ext === 'py') command = 'python';
                else if (ext === 'lua') command = 'lua';
                else return H_IDE.ui.showNotification(`Cannot run .${ext} files.`, 'error');
                
                H_IDE.terminal.exec(`${command} ${path}`);
                H_IDE.ui.switchBottomPanel('terminal');
            }
        },

        terminal: {
            init() { H_IDE.dom.terminal_input.addEventListener('keydown', e => { if (e.key === 'Enter' && e.target.value) { this.exec(e.target.value); e.target.value = ''; }}); },
            log(msg, type = 'log') {
                const line = document.createElement('div');
                if (type === 'error') line.classList.add('text-[var(--error-color)]');
                line.innerHTML = String(msg).replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
                H_IDE.dom.terminal_output.appendChild(line);
                H_IDE.dom.terminal_output.scrollTop = H_IDE.dom.terminal_output.scrollHeight;
            },
            async exec(cmdStr) {
                this.log(`$ ${cmdStr}`);
                const [cmd, ...args] = cmdStr.split(' ');
                const path = args.join(' ');
                const content = H_IDE.fs.get(path)?.node?.content;
                if (cmd === 'python' && H_IDE.state.pyodideReady) {
                    if(content !== undefined) await H_IDE.state.pyodide.runPythonAsync(content); else this.log(`File not found: ${path}`, 'error');
                } else if (cmd === 'node') {
                    if(content !== undefined) try { const cLogs = []; const tLog = console.log; console.log = (...a) => cLogs.push(a.join(' ')); new Function(content)(); console.log = tLog; this.log(cLogs.join('\n')); } catch(e) { this.log(e.message, 'error'); } else this.log(`File not found: ${path}`, 'error');
                } else if (cmd === 'clear') { H_IDE.dom.terminal_output.innerHTML = '';
                } else if (cmd === 'lua') { this.log(`Lua execution via terminal is not supported in this browser environment. You can only edit .lua files.`, 'error');
                } else { this.log(`Command not found: ${cmd}. Available: node, python, clear, lua (info).`, 'error'); }
            }
        },

        events: {
            init() {
                H_IDE.dom.activity_bar.addEventListener('click', e => { const view = e.target.closest('.activity-bar-icon')?.dataset.view; if (view) H_IDE.ui.switchSidebarView(view); });
                H_IDE.dom.bottom_panel.querySelector('.tabs').addEventListener('click', e => { const panel = e.target.closest('.bottom-panel-tab')?.dataset.panel; if (panel) H_IDE.ui.switchBottomPanel(panel); });
                H_IDE.dom.new_untitled_file_global.onclick = () => H_IDE.files.openUntitled();
                H_IDE.dom.new_folder_global.onclick = () => this.showNewItemModal('folder');
                H_IDE.dom.file_explorer.oncontextmenu = (e) => this.showContextMenu(e);
                H_IDE.dom.cmd_palette_btn.onclick = () => this.showCommandPalette();
                H_IDE.dom.run_btn.onclick = () => H_IDE.files.runActive();
                H_IDE.dom.setting_theme.onchange = (e) => H_IDE.settings.update('theme', e.target.value);
                H_IDE.dom.setting_fontsize.onchange = (e) => H_IDE.settings.update('fontSize', parseInt(e.target.value));
                H_IDE.dom.setting_linenumbers.onchange = (e) => H_IDE.settings.update('showLineNumbers', e.target.checked);
                H_IDE.dom.file_importer.onchange = (e) => this.handleFileImport(e);
                document.addEventListener('click', (e) => { if (!e.target.closest('.context-menu')) H_IDE.dom.context_menu.classList.add('hidden'); });
                document.addEventListener('keydown', (e) => { if(e.key === 'Escape') { H_IDE.ui.hideModal(); H_IDE.dom.context_menu.classList.add('hidden'); }});
            },
            showNewItemModal(type, basePath = '') {
                const content = document.createElement('div'); content.className = 'modal-base p-4';
                content.innerHTML = `<h3 class="text-lg font-bold mb-4">New ${type}</h3><input type="text" id="modal-input-name" class="modal-input" placeholder="Enter name...">`;
                H_IDE.ui.showModal(content);
                const input = document.getElementById('modal-input-name'); input.focus();
                input.onkeydown = (e) => { if (e.key === 'Enter' && input.value) { const path = basePath ? `${basePath}/${input.value}` : input.value; H_IDE.fs.create(path, type); H_IDE.ui.hideModal(); } else if (e.key === 'Escape') H_IDE.ui.hideModal(); };
            },
            showContextMenu(e) {
                e.preventDefault(); e.stopPropagation();
                const target = e.target.closest('.file-item');
                const path = target?.dataset.path || '/';
                const isRoot = path === '/';
                const nodeType = isRoot ? 'folder' : H_IDE.fs.get(path)?.node.type;
                let items = [];
                if (nodeType === 'folder') {
                    items.push({ label: 'New File', action: () => this.showNewItemModal('file', isRoot ? '' : path) });
                    items.push({ label: 'New Folder', action: () => this.showNewItemModal('folder', isRoot ? '' : path) });
                }
                if (!isRoot) { items.push({ label: 'Rename', action: () => this.showRenameModal(path) }); items.push({ label: 'Delete', action: () => H_IDE.fs.delete(path) }); }
                const menu = H_IDE.dom.context_menu;
                menu.innerHTML = items.map(item => `<div class="context-menu-item p-2" data-action="${item.label}">${item.label}</div>`).join('');
                menu.onclick = (ev) => { const action = ev.target.dataset.action; items.find(i => i.label === action)?.action(); };
                menu.style.left = `${e.clientX}px`; menu.style.top = `${e.clientY}px`;
                menu.classList.remove('hidden');
            },
            showRenameModal(path) {
                const oldName = path.split('/').pop();
                const content = document.createElement('div'); content.className = 'modal-base p-4';
                content.innerHTML = `<h3 class="text-lg font-bold mb-4">Rename</h3><input type="text" id="modal-input-rename" class="modal-input">`;
                H_IDE.ui.showModal(content);
                const input = document.getElementById('modal-input-rename'); input.value = oldName; input.focus(); input.select();
                input.onkeydown = (e) => { if (e.key === 'Enter' && input.value) { H_IDE.fs.rename(path, input.value); H_IDE.ui.hideModal(); } else if (e.key === 'Escape') H_IDE.ui.hideModal(); };
            },
            showSaveAsModal(untitledPath) {
                const content = document.createElement('div'); content.className = 'modal-base p-4';
                content.innerHTML = `<h3 class="text-lg font-bold mb-4">Save As</h3><input type="text" id="modal-input-save" class="modal-input" placeholder="Enter file path (e.g., src/app.lua)">`;
                H_IDE.ui.showModal(content);
                const input = document.getElementById('modal-input-save'); input.focus();
                input.onkeydown = (e) => {
                    if (e.key === 'Enter' && input.value) {
                        const newPath = input.value;
                        const data = H_IDE.state.openFiles.get(untitledPath); if (!data) return H_IDE.ui.hideModal();
                        H_IDE.fs.create(newPath, 'file', data.session.getValue());
                        H_IDE.files.close(untitledPath, true);
                        H_IDE.files.open(newPath);
                        H_IDE.ui.hideModal();
                    } else if (e.key === 'Escape') H_IDE.ui.hideModal();
                };
            },
            handleFileImport(event) {
                const files = event.target.files;
                for(const file of files) {
                    const reader = new FileReader();
                    reader.onload = (e) => H_IDE.fs.create(file.name, 'file', e.target.result);
                    reader.readAsText(file);
                }
            },
            showCommandPalette() {
                const content = document.createElement('div'); content.className = 'modal-base';
                content.innerHTML = `<input type="text" id="cmd-input" class="modal-input m-2" placeholder="Search files and commands..."><div id="cmd-list" class="overflow-y-auto"></div>`;
                H_IDE.ui.showModal(content);
                const input = document.getElementById('cmd-input'); const list = document.getElementById('cmd-list');
                const commands = [
                    { label: 'File: Open from Computer...', action: () => H_IDE.dom.file_importer.click() },
                    { label: 'File: New Untitled File', action: () => H_IDE.files.openUntitled() },
                    { label: 'File: Save Active File', action: () => H_IDE.files.save() },
                ];
                const allFiles = (dir=H_IDE.state.fs, prefix='') => Object.entries(dir).flatMap(([name, node])=>{ const p = prefix?`${prefix}/${name}`:name; return node.type==='folder'?allFiles(node.children, p):p; });
                const renderList = (query='') => {
                    const fileItems = allFiles().map(p => ({ label: `üìÑ ${p}`, action: () => H_IDE.files.open(p) }));
                    const filtered = [...commands, ...fileItems].filter(c=>c.label.toLowerCase().includes(query.toLowerCase()));
                    list.innerHTML = filtered.map(c=>`<div class="command-palette-item p-2 cursor-pointer hover:bg-[var(--bg-hover)]" data-label="${c.label}">${c.label}</div>`).join('');
                };
                list.onclick = (e) => { const label = e.target.closest('.command-palette-item')?.dataset.label; if(label) { [...commands, ...allFiles().map(p => ({ label: `üìÑ ${p}`, action: () => H_IDE.files.open(p) }))].find(c=>c.label===label)?.action(); H_IDE.ui.hideModal(); }};
                input.oninput = () => renderList(input.value);
                input.focus();
                renderList('');
            }
        },
    };
    H_IDE.init();
    window.H_IDE = H_IDE;
</script>
</body>
</html>
