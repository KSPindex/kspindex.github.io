<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎèÑÌÜ†Î¶¨ ÌÇ§Ïö∞Í∏∞ Z: ÌååÏù¥ÎÑê Ï±ïÌÑ∞</title>
    
    <!-- Core Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- 3D Background Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        :root {
            --primary-glow: #00ffff;
            --secondary-glow: #ff00ff;
            --tertiary-glow: #ffff00;
            --danger-glow: #ff4d4d;
            --text-color: #e0e0e0;
            --bg-dark: #0c0a1a;
            --bg-modal: rgba(15, 12, 40, 0.95);
            --font-main: 'Jua', sans-serif;
        }

        /* Base Setup */
        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            color: var(--text-color);
            user-select: none;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        
        #background-canvas {
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
            width: 100vw;
            height: 100vh;
        }

        /* Game Container & Theming */
        .game-container {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid var(--primary-glow);
            box-shadow: 0 0 25px var(--primary-glow), inset 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .modal {
            background-color: var(--bg-modal);
            border: 2px solid var(--secondary-glow);
            box-shadow: 0 0 20px var(--secondary-glow);
            transform: scale(0.9);
            opacity: 0;
        }
        
        /* Buttons & Interactive Elements */
        .btn {
            position: relative;
            transition: all 0.2s ease;
            text-shadow: 0 0 5px currentColor;
            box-shadow: inset 0 0 8px rgba(255,255,255,0.3), 0 0 8px rgba(0,0,0,0.5);
            border-width: 2px;
            will-change: transform, box-shadow;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.03);
            box-shadow: inset 0 0 10px rgba(255,255,255,0.5), 0 0 20px currentColor;
        }
        .btn:active:not(:disabled) { transform: translateY(1px) scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(80%); }

        /* Pet Styles */
        .pet {
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
            filter: drop-shadow(0 0 10px var(--primary-glow));
            will-change: transform;
        }
        .pet-container {
            animation: float 4s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulse-glow { 
            0%, 100% { box-shadow: 0 0 20px var(--danger-glow); transform: scale(1.05); }
            50% { box-shadow: 0 0 35px var(--danger-glow); transform: scale(1.1); }
        }
        @keyframes screen-shake {
            0%, 100% { transform: translate(0, 0) rotate(0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-2px, 2px) rotate(-1deg); }
            20%, 40%, 60%, 80% { transform: translate(2px, -2px) rotate(1deg); }
        }
        .screen-shake { animation: screen-shake 0.3s ease-in-out; }
        
        .is-targeted {
            animation: pulse-glow 1.5s infinite;
            border-radius: 1rem;
            border: 2px solid var(--danger-glow);
        }

        /* Floating text & particles */
         .floating-text {
            position: absolute;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-glow);
            text-shadow: 0 0 5px #fff, 0 0 10px var(--primary-glow);
            pointer-events: none;
            animation: floatUp 1.2s ease-out forwards;
            z-index: 10;
        }
        @keyframes floatUp {
            from { transform: translateY(0) scale(1); opacity: 1; }
            to { transform: translateY(-150px) scale(1.8); opacity: 0; }
        }
        
        .particle {
            position: absolute;
            background: var(--primary-glow);
            border-radius: 50%;
            pointer-events: none;
            box-shadow: 0 0 10px var(--primary-glow);
        }

        /* UI Components */
        .progress-bar { background-color: rgba(255,255,255,0.2); border-radius: 9999px; overflow: hidden; }
        .progress-bar-inner { height: 100%; transition: width 0.3s ease; }
        .hp-bar { background: linear-gradient(90deg, #d32f2f, #f44336); }
        .exp-bar { background: linear-gradient(90deg, var(--primary-glow), var(--secondary-glow)); }
        .tab-button.active { background-color: var(--secondary-glow); color: white; border-color: var(--secondary-glow); }
        .pet-card { transition: all 0.2s ease; border: 2px solid transparent; }
        .pet-card.selected { border-color: var(--tertiary-glow); transform: scale(1.05); box-shadow: 0 0 15px var(--tertiary-glow); }
        .pet-card.equipped-glow { box-shadow: 0 0 15px var(--primary-glow); }
        .grayscale { filter: grayscale(100%) brightness(0.5); }
        
        .skill-cooldown {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            pointer-events: none;
        }

        /* Custom scrollbar for modals */
        .modal-scroll::-webkit-scrollbar { width: 8px; }
        .modal-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 4px; }
        .modal-scroll::-webkit-scrollbar-thumb { background: var(--secondary-glow); border-radius: 4px; }
        .modal-scroll::-webkit-scrollbar-thumb:hover { background: #ff4dff; }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed;
            inset: 0;
            background-color: var(--bg-dark);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: var(--primary-glow);
            text-shadow: 0 0 10px var(--primary-glow);
        }
        #loadingIcon { font-size: 5rem; animation: spin 2s linear infinite; }
        #loadingText { font-size: 2rem; margin-top: 1.5rem; letter-spacing: 0.1em; }
        @keyframes spin { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }
        
        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 2.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            opacity: 0;
            z-index: 1000;
            backdrop-filter: blur(5px);
            border-width: 2px;
            min-width: 300px;
        }
        #toast-progress {
            position: absolute;
            bottom: 0; left: 0; height: 4px;
            background: var(--primary-glow);
        }
        select.weapon-select {
            background-color: #1a1a2e;
            color: white;
            border: 1px solid var(--primary-glow);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-2 md:p-4">
    
    <canvas id="background-canvas"></canvas>

    <div id="loadingOverlay">
        <div id="loadingIcon">üå∞</div>
        <div id="loadingText" class="font-bold">ÎèÑÌÜ†Î¶¨ Ïú†ÎãàÎ≤ÑÏä§ Ï†ëÏÜç Ï§ë...</div>
    </div>

    <div id="gameContainer" class="game-container w-full max-w-6xl h-[95vh] max-h-[1000px] rounded-3xl p-4 flex flex-col relative overflow-hidden">
        
        <!-- Top Stats Bar -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-2 text-center text-sm md:text-base">
            <div class="bg-black/50 p-2 rounded-xl border border-purple-400">
                üëë LV: <span id="playerLevelDisplay">1</span>
                <div class="progress-bar mt-1 h-2"><div id="playerExpBar" class="progress-bar-inner exp-bar" style="width: 0%"></div></div>
            </div>
             <div class="bg-black/50 p-2 rounded-xl border border-purple-400 flex items-center justify-center gap-2 cursor-pointer" onclick="window.gameAPI.toggleNumberFormat()">
                <i class="fa-solid fa-database text-cyan-300"></i> <span id="moneyDisplay">0</span>
            </div>
            <div class="bg-black/50 p-2 rounded-xl border border-purple-400 flex items-center justify-center gap-2">
                <i class="fa-solid fa-cookie-bite text-yellow-400"></i> <span id="goldenAcornAmount">0</span>
            </div>
            <div class="bg-black/50 p-2 rounded-xl border border-purple-400 flex items-center justify-center gap-2">
                <i class="fa-solid fa-star text-yellow-300"></i> <span id="stardustAmount">0</span>
            </div>
        </div>
        
        <!-- Header -->
        <div class="flex justify-between items-center bg-black/50 p-3 rounded-xl border-2 border-purple-400 shadow-lg mb-2">
            <h1 id="gameTitle" class="text-xl md:text-3xl font-bold text-cyan-300">ü™ê ÎèÑÌÜ†Î¶¨ ÌÇ§Ïö∞Í∏∞ Z: ÌååÏù¥ÎÑê Ï±ïÌÑ∞ ü™ê</h1>
            <div>
                <button onclick="window.gameAPI.showModal('settingsModal')" class="text-2xl text-white hover:text-cyan-300 transition-colors">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div id="gameScreen" class="flex-grow bg-black/30 rounded-2xl border-2 border-cyan-400 relative flex items-center justify-center flex-col gap-8 p-4 overflow-hidden"></div>
        
        <!-- Active Potions & Skills Bar -->
        <div class="flex justify-between items-center">
            <div id="activePotionsBar" class="flex gap-2 mt-4"></div>
            <div id="skillBar" class="flex justify-center gap-2 mt-4"></div>
        </div>

        <!-- Main Menu Buttons -->
        <div class="grid grid-cols-4 md:grid-cols-8 gap-2 mt-4 text-xs md:text-base">
            <button onclick="window.gameAPI.showModal('shopModal')" class="btn bg-cyan-600 text-white p-2 rounded-lg border-cyan-400">ÏÉÅÏ†ê</button>
            <button onclick="window.gameAPI.showModal('petModal')" class="btn bg-purple-600 text-white p-2 rounded-lg border-purple-400">Ìé´</button>
            <button onclick="window.gameAPI.showModal('enhanceModal')" class="btn bg-red-600 text-white p-2 rounded-lg border-red-400">Í∞ïÌôî</button>
            <button onclick="window.gameAPI.showModal('evolveModal')" class="btn bg-indigo-500 text-white p-2 rounded-lg border-indigo-400">ÏßÑÌôî</button>
            <button onclick="window.gameAPI.showModal('missionModal')" class="btn bg-green-600 text-white p-2 rounded-lg border-green-400">ÎØ∏ÏÖò</button>
            <button onclick="window.gameAPI.showModal('collectionModal')" class="btn bg-yellow-600 text-white p-2 rounded-lg border-yellow-400">ÎèÑÍ∞ê</button>
            <button onclick="window.gameAPI.showModal('rebirthModal')" class="btn bg-gray-700 text-yellow-300 p-2 rounded-lg border-yellow-500">ÌôòÏÉù</button>
            <button onclick="window.gameAPI.showModal('explorationModal')" class="btn bg-teal-600 text-white p-2 rounded-lg border-teal-400">ÌÉêÌóò</button>
            <button onclick="window.gameAPI.showModal('craftingModal')" class="btn bg-amber-700 text-white p-2 rounded-lg border-amber-500">Ï†úÏûë</button>
            <button onclick="window.gameAPI.showModal('skillModal')" class="btn bg-rose-600 text-white p-2 rounded-lg border-rose-400">Ïä§ÌÇ¨</button>
            <button onclick="window.gameAPI.showModal('bossModal')" class="btn bg-red-800 text-white p-2 rounded-lg border-red-600">Î≥¥Ïä§</button>
            <button onclick="window.gameAPI.showModal('dungeonModal')" class="btn bg-lime-600 text-white p-2 rounded-lg border-lime-400">ÎçòÏ†Ñ</button>
            <button onclick="window.gameAPI.showModal('storyBookModal')" class="btn bg-blue-600 text-white p-2 rounded-lg border-blue-400">Ïä§ÌÜ†Î¶¨</button>
            <button onclick="window.gameAPI.showModal('titleModal')" class="btn bg-orange-600 text-white p-2 rounded-lg border-orange-400">Ïπ≠Ìò∏</button>
            <button onclick="window.gameAPI.showModal('statsModal')" class="btn bg-indigo-600 text-white p-2 rounded-lg border-indigo-400">ÏÉÅÏÑ∏ Ïä§ÌÉØ</button>
            <button onclick="window.gameAPI.showModal('worldBossModal')" class="btn bg-black text-red-400 p-2 rounded-lg border-red-600">ÏõîÎìúÎ≥¥Ïä§</button>
        </div>
    </div>
    
    <!-- Modal Container -->
    <div id="modalContainer" class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4" style="visibility: hidden;">
        <div id="modalContent" class="modal w-full max-w-4xl p-6 rounded-2xl flex flex-col max-h-[90vh]"></div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="bg-gray-800/80 text-white px-6 py-3 rounded-lg shadow-xl text-lg border-gray-500">
        <p id="toast-text"></p>
        <div id="toast-progress"></div>
    </div>

    <script>
    // --- IIFE to encapsulate game logic ---
    (function() {
        'use strict';

        // --- DOM Elements ---
        const DOMElements = {
            loadingOverlay: document.getElementById("loadingOverlay"),
            gameContainer: document.getElementById("gameContainer"),
            moneyDisplay: document.getElementById("moneyDisplay"),
            goldenAcornAmount: document.getElementById("goldenAcornAmount"),
            stardustAmount: document.getElementById("stardustAmount"),
            playerLevelDisplay: document.getElementById("playerLevelDisplay"),
            playerExpBar: document.getElementById("playerExpBar"),
            gameScreen: document.getElementById("gameScreen"),
            skillBar: document.getElementById("skillBar"),
            activePotionsBar: document.getElementById('activePotionsBar'),
            modalContainer: document.getElementById("modalContainer"),
            modalContent: document.getElementById("modalContent"),
            toast: document.getElementById("toast"),
            toastText: document.getElementById("toast-text"),
            toastProgress: document.getElementById("toast-progress"),
            backgroundCanvas: document.getElementById('background-canvas')
        };
        
        // --- Game Data Constants ---
        const PET_DATA={acorn:{name:"ÎèÑÌÜ†Î¶¨",baseClick:1,cost:100,img:"üå∞",rarity:"ÏùºÎ∞ò"},jitori:{name:"ÏßÄÌÜ†Î¶¨",baseClick:3,cost:1e3,img:"ü•ú",rarity:"ÏùºÎ∞ò"},rocktori:{name:"ÎèåÌÜ†Î¶¨",baseClick:10,cost:1e4,img:"üóø",rarity:"ÏùºÎ∞ò"},goldtori:{name:"Ìô©Í∏àÎèÑÌÜ†Î¶¨",baseClick:70,cost:1e5,img:"‚ú®",rarity:"Ìù¨Í∑Ä"},diamondtori:{name:"Îã§Ïù¥ÏïÑÎ™¨ÎìúÎèÑÌÜ†Î¶¨",baseClick:150,cost:3e5,img:"üíé",rarity:"Ìù¨Í∑Ä"},beggartori:{name:"Í±∞ÏßÄÌÜ†Î¶¨",baseClick:300,cost:5e5,img:"üóëÔ∏è",rarity:"Ìù¨Í∑Ä"},santatori:{name:"ÏÇ∞ÌÉÄÌÜ†Î¶¨",baseClick:500,cost:7e5,img:"üéÖ",rarity:"ÏòÅÏõÖ"},dotoltem:{name:"ÎèÑÌÜ®ÌÖú",baseClick:1e3,cost:1e6,img:"üõ°Ô∏è",rarity:"ÏòÅÏõÖ"},moontori:{name:"Îã¨ÌÜ†Î¶¨",baseClick:1e4,cost:1e7,img:"üåï",rarity:"Ï†ÑÏÑ§"},earthtori:{name:"ÏßÄÍµ¨ÌÜ†Î¶¨",baseClick:1e5,cost:1e8,img:"üåç",rarity:"Ï†ÑÏÑ§"},darktori:{name:"Îã§ÌÅ¨ÌÜ†Î¶¨",baseClick:1e6,cost:1e9,img:"üòà",rarity:"Ïã†Ìôî"},whitetori:{name:"ÌôîÏù¥Ìä∏ÌÜ†Î¶¨",baseClick:2e6,cost:3e9,img:"üòá",rarity:"Ïã†Ìôî"},lighttori:{name:"ÎùºÏù¥Ìä∏ÌÜ†Î¶¨",baseClick:3e6,cost:5e9,img:"üí°",rarity:"Ïã†Ìôî"},gravitytori:{name:"Ï§ëÎ†•ÌÜ†Î¶¨",baseClick:5e6,cost:1e10,img:"‚ö´",rarity:"ÌÉúÏ¥à"},spacetori:{name:"Ïö∞Ï£ºÌÜ†Î¶¨",baseClick:1e8,cost:1e11,img:"üåå",rarity:"ÌÉúÏ¥à"},multiversetori:{name:"Îã§Ï§ëÏö∞Ï£ºÌÜ†Î¶¨",baseClick:1e9,cost:1e12,img:"ü™ê",rarity:"Ïö∞Ï£º"},firsttori:{name:"ÏµúÏ¥àÏùòÎèÑÌÜ†Î¶¨",baseClick:5e9,cost:3e12,img:"üí´",rarity:"Ïö∞Ï£º"},infinitytori:{name:"Î¨¥ÌïúÏùòÎèÑÌÜ†Î¶¨",baseClick:2e10,cost:1e13,img:"‚ôæÔ∏è",rarity:"Í∂ÅÍ∑π"},absolutetori:{name:"Ïï±ÏÜîÎ£®Ìä∏ÌÜ†Î¶¨",baseClick:1e11,cost:1e14,img:"üëë",rarity:"Í∂ÅÍ∑π"},godtori:{name:"ÎèÑÌÜ†Î¶¨ÏùòÏã†",baseClick:1e12,cost:1e15,img:"üôè",rarity:"???"},chronotori:{name:"ÌÅ¨Î°úÎÖ∏ÌÜ†Î¶¨",baseClick:5e12,cost:1e16,img:"‚è≥",rarity:"ÏΩîÏ¶àÎØπ"},novatori:{name:"ÎÖ∏Î∞îÌÜ†Î¶¨",baseClick:2e13,cost:1e17,img:"üåü",rarity:"ÏΩîÏ¶àÎØπ"},glitchtori:{name:"Í∏ÄÎ¶¨ÏπòÌÜ†Î¶¨",baseClick:1e14,cost:1e18,img:"ü§ñ",rarity:"ÎîîÎ∞îÏù∏"},zetatori:{name:"Ï†úÌÉÄÌÜ†Î¶¨",baseClick:1e15,cost:1e20,img:"üí§",rarity:"ÎîîÎ∞îÏù∏"},abysstori:{name:"Ïã¨Ïó∞ÌÜ†Î¶¨",baseClick:1e16,cost:1e22,img:"‚ö´",rarity:"Ïñ¥ÎπÑÏÖú"},secret_wawa:{name:"[ÏãúÌÅ¨Î¶ø]ÎèÑÌÜ†Î¶¨Îãà ÏßÄÌÜ†Î¶¨Îãà ÏôÄÏôÄÏôÄ",baseClick:1e13,cost:0,img:"ü§Ø",rarity:"ÏãúÌÅ¨Î¶ø"}};
        const GACHA_RATES={normal:[{type:"acorn",weight:3e3},{type:"jitori",weight:2500},{type:"rocktori",weight:1500},{type:"goldtori",weight:1e3},{type:"diamondtori",weight:800},{type:"beggartori",weight:500},{type:"santatori",weight:250},{type:"dotoltem",weight:150},{type:"moontori",weight:100},{type:"earthtori",weight:70},{type:"darktori",weight:50},{type:"whitetori",weight:20},{type:"lighttori",weight:9},{type:"secret_wawa",weight:1}],premium:[{type:"santatori",weight:2e3},{type:"dotoltem",weight:1500},{type:"moontori",weight:1200},{type:"earthtori",weight:1e3},{type:"darktori",weight:800},{type:"whitetori",weight:700},{type:"lighttori",weight:600},{type:"gravitytori",weight:500},{type:"spacetori",weight:400},{type:"multiversetori",weight:300},{type:"firsttori",weight:200},{type:"infinitytori",weight:150},{type:"absolutetori",weight:100},{type:"godtori",weight:40},{type:"secret_wawa",weight:10}],stardust:[{type:"godtori",weight:1e3},{type:"chronotori",weight:500},{type:"novatori",weight:250},{type:"glitchtori",weight:100},{type:"zetatori",weight:50},{type:"abysstori",weight:10},{type:"secret_wawa",weight:5}]};
        const STORY_BOOK_DATA={hope:{name:"ÎèÑÌÜ†Î¶¨Ïùò Ìù¨Îßù",cost:1e6,content:"ÏûëÏùÄ ÎèÑÌÜ†Î¶¨ ÌïòÎÇòÍ∞Ä Ïö∞Ï£ºÎ•º ÍøàÍø®Îã§. Î™®ÎëêÍ∞Ä ÎπÑÏõÉÏóàÏßÄÎßå, Í∑∏Ïùò ÏïàÏóêÎäî Î¨¥ÌïúÌïú Í∞ÄÎä•ÏÑ±Ïù¥ Ïû†Ïû¨ÎêòÏñ¥ ÏûàÏóàÎã§."},tenacity:{name:"ÎèÑÌÜ†Î¶¨Ïùò Ìà¨ÏßÄ",cost:1e8,content:"ÏàòÎßéÏùÄ ÏãúÎ†®Ïù¥ Îã•Ï≥§Îã§. Í±∞Ïπú ÎπÑÎ∞îÎûåÍ≥º Ìè¨ÏãùÏûêÎì§Ïùò ÏúÑÌòë ÏÜçÏóêÏÑúÎèÑ ÎèÑÌÜ†Î¶¨Îäî ÏãπÏùÑ ÌãîÏö∞Í∏∞ ÏúÑÌï¥ Î≤ÑÎã§."},unity:{name:"ÎèÑÌÜ†Î¶¨Ïùò Îã®Í≤∞",cost:1e10,content:"ÌòºÏûêÎäî ÏïΩÌñàÏßÄÎßå, Ìï®ÍªòÎäî Í∞ïÌñàÎã§. Ïà≤Ïùò Î™®Îì† ÎèÑÌÜ†Î¶¨Îì§Ïù¥ Î™®Ïó¨ Í±∞ÎåÄÌïú ÏùòÏßÄÎ•º ÎßåÎì§Ïñ¥ÎÉàÎã§."},war:{name:"ÎèÑÌÜ†Î¶¨Ïùò Ï†ÑÏüÅ",cost:1e12,content:"Ïö∞Ï£ºÏ†Å Ï°¥Ïû¨ 'Í≥µÌóà'Í∞Ä Î™®Îì† Í≤ÉÏùÑ ÏßëÏñ¥ÏÇºÌÇ§Î†§ Ìï† Îïå, ÎèÑÌÜ†Î¶¨ Ïó∞Ìï©ÏùÄ Ïä§Ïä§Î°úÏùò Ï°¥Ïû¨Î•º Í±∏Í≥† ÎßûÏÑú Ïã∏Ïõ†Îã§."},final:{name:"ÏµúÌõÑÏùò ÎèÑÌÜ†Î¶¨",cost:1e13,content:"Î™®Îì† Ìù¨ÏÉù ÎÅùÏóê, Îã® ÌïòÎÇòÏùò ÎèÑÌÜ†Î¶¨Í∞Ä ÎÇ®ÏïÑ Í≥µÌóàÏùò Ïã¨Ïû•Î∂ÄÎ°ú Ìñ•ÌñàÎã§. Í∑∏Ïùò ÏÜêÏóê Î™®Îì† Í≤ÉÏùò Ïö¥Î™ÖÏù¥ Îã¨Î†§ÏûàÏóàÎã§."},ending:{name:"ÏóîÎî©",cost:1e16,content:"Í≥µÌóàÎ•º Î¨ºÎ¶¨Ïπú ÎèÑÌÜ†Î¶¨Îäî Ïö∞Ï£ºÏùò ÏÉàÎ°úÏö¥ Ïã†Ïù¥ ÎêòÏóàÎã§. Í∑∏Ïùò ÏùòÏßÄÎäî Î≥ÑÏù¥ ÎêòÍ≥†, Í∑∏Ïùò Ïà®Í≤∞ÏùÄ ÏùÄÌïòÏàòÍ∞Ä ÎêòÏóàÎã§."},zeta:{name:"Ï†úÌÉÄ Ïú†ÎãàÎ≤ÑÏä§",cost:1e20,content:"ÏôïÏùÑ Ïì∞Îü¨Îú®Î¶∞ Í∑∏Îäî Ïö∞Ï£º Í∑∏ ÏûêÏ≤¥Í∞Ä ÎêòÏóàÎã§. ÌïòÏßÄÎßå ÎÅùÏù¥ ÏïÑÎãàÏóàÎã§. Í∑∏Ïùò ÏùòÏãùÏù¥ ÎãøÏßÄ ÏïäÎäî Îçî ÎÜíÏùÄ Ï∞®Ïõê, 'Ï†úÌÉÄ Ïú†ÎãàÎ≤ÑÏä§'Ïùò Ï°¥Ïû¨Î•º Íπ®Îã¨ÏïòÎã§. Í∑∏Í≥≥ÏùÄ Î™®Îì† Í∞ÄÎä•ÏÑ±Ïù¥ ÌòÑÏã§Ïù¥ ÎêòÎäî Í≥≥, ÏÉÅÏÉÅÏ°∞Ï∞® Ìï† Ïàò ÏóÜÎäî Ï°¥Ïû¨Îì§Ïù¥ ÏÇ¥ÏïÑÍ∞ÄÎäî Í≥≥Ïù¥ÏóàÎã§."},abyss:{name:"Ïã¨Ïó∞Ïùò Î∂ÄÎ¶Ñ",cost:1e24,content:"Ï†úÌÉÄ Ïú†ÎãàÎ≤ÑÏä§Ïùò Í≥†ÏöîÎ•º Íπ®Îú®Î¶∞ Í≤ÉÏùÄ Ïã¨Ïó∞Ïùò Î∂ÄÎ¶ÑÏù¥ÏóàÎã§. Î™®Îì† Í≤ÉÏùÑ Î¨¥Î°ú ÎêòÎèåÎ¶¨Î†§Îäî ÏóîÌä∏Î°úÌîºÏùò ÏùòÏßÄ, Ïñ¥ÎπÑÏÖú(Abyssal) Ï°¥Ïû¨Îì§Ïù¥ Íπ®Ïñ¥ÎÇú Í≤ÉÏù¥Îã§. ÎèÑÌÜ†Î¶¨Ïùò Ïã†ÏùÄ Îã§Ïãú ÌïúÎ≤à, Ïù¥Î≤àÏóî ÏûêÏã†Ïùò Ï∞ΩÏ°∞Î¨º Ï†ÑÎ∂ÄÎ•º Í±∏Í≥† Ïã∏ÏõåÏïº ÌñàÎã§."}};
        const RARITY_COLORS = { 'ÏùºÎ∞ò': 'text-gray-300', 'Ìù¨Í∑Ä': 'text-blue-400', 'ÏòÅÏõÖ': 'text-purple-400', 'Ï†ÑÏÑ§': 'text-yellow-400', 'Ïã†Ìôî': 'text-red-400', 'ÌÉúÏ¥à': 'text-cyan-300', 'Ïö∞Ï£º': 'text-fuchsia-400', 'Í∂ÅÍ∑π': 'text-orange-300', '???': 'text-white', 'ÏãúÌÅ¨Î¶ø': 'text-green-400', 'ÏΩîÏ¶àÎØπ': 'text-indigo-300', 'ÎîîÎ∞îÏù∏': 'text-yellow-200', 'Ïñ¥ÎπÑÏÖú': 'text-gray-400' };
        const ARTIFACT_DATA = {ancientAcorn:{name:"Í≥†ÎåÄÏùò ÎèÑÌÜ†Î¶¨",maxLevel:50,cost:lv=>1+lv,effect:lv=>lv*0.05,desc:"Î™®Îì† Ïû¨Ìôî ÌöçÎìùÎüâ +{EFFECT}%"},starFragment:{name:"Î≥ÑÏùò ÌååÌé∏",maxLevel:20,cost:lv=>5+lv*2,effect:lv=>lv*0.02,desc:"ÌÅ¥Î¶≠Îãπ Ïû¨Ìôî ÌöçÎìùÎüâ +{EFFECT}%"},timeCrystal:{name:"ÏãúÍ∞ÑÏùò Í≤∞Ï†ï",maxLevel:30,cost:lv=>2+lv,effect:lv=>lv*0.03,desc:"Ïò§ÌîÑÎùºÏù∏ Î≥¥ÏÉÅÎüâ +{EFFECT}%"},goldenCompass:{name:"Ìô©Í∏à ÎÇòÏπ®Î∞ò",maxLevel:10,cost:lv=>10+lv*5,effect:lv=>lv*0.01,desc:"Ìô©Í∏à ÎèÑÌÜ†Î¶¨ ÌöçÎìù ÌôïÎ•† +{EFFECT}%"},enhancersCharm:{name:"Í∞ïÌôîÏà†ÏÇ¨Ïùò Î∂ÄÏ†Å",maxLevel:10,cost:lv=>20+lv*10,effect:lv=>lv*0.01,desc:"Í∞ïÌôî ÏÑ±Í≥µ ÌôïÎ•† +{EFFECT}%"}};
        const TITLE_DATA = {'Ï¥àÎ≥¥Ïûê':{desc:"Í≤åÏûÑÏùÑ ÏãúÏûëÌïú Ïûê",bonus:{type:"none"}},'ÌÅ¥Î¶≠Ïùò Îã¨Ïù∏':{desc:"Ï¥ù 10ÎßåÎ≤à ÌÅ¥Î¶≠ Îã¨ÏÑ±",unlock:gs=>gs.stats.totalClicks>=1e5,bonus:{type:"click_power",value:.1}},'ÏàòÏßëÍ∞Ä':{desc:"Ìé´ 10Ï¢ÖÎ•ò ÏàòÏßë",unlock:gs=>Object.keys(gs.collection).length>=10,bonus:{type:"all_power",value:.05}},'Î∞±ÎßåÏû•Ïûê':{desc:"ÏµúÎåÄ Î≥¥Ïú† Ïû¨Ìôî 100Îßå Îã¨ÏÑ±",unlock:gs=>gs.stats.maxMoney>=1e6,bonus:{type:"money_gain",value:.1}},'ÌôòÏÉùÏûê':{desc:"Ï≤´ ÌôòÏÉù Îã¨ÏÑ±",unlock:gs=>gs.stats.rebirths>=1,bonus:{type:"all_power",value:.1}},'ÌÉêÌóòÍ∞Ä':{desc:"ÌÉêÌóò 10Ìöå ÏôÑÎ£å",unlock:gs=>gs.stats.explorations>=10,bonus:{type:"all_power",value:.15}},'Î≥¥Ïä§ Ïä¨Î†àÏù¥Ïñ¥':{desc:"Î≥¥Ïä§ 'ÏßÄÌÜ†Î¶¨Ïùò ÏïÖÎ™Ω' Ï≤òÏπò",unlock:gs=>gs.boss.cleared.includes('nightmare'),bonus:{type:"click_power",value:.2}}};
        const EXPLORATION_DATA = {forest: {name: "Ï¥àÏã¨ÏûêÏùò Ïà≤", duration: 60 * 5, minRarity: 0, teamSize: 1, rewards: () => ({ money: 5e3, exp: 10, materials: { wood: Math.floor(Math.random() * 3) + 1 } })},cave: {name: "Ïã†ÎπÑÌïú ÎèôÍµ¥", duration: 60 * 30, minRarity: 1, teamSize: 2, rewards: () => ({ money: 5e5, exp: 50, materials: { stone: Math.floor(Math.random() * 3) + 1 } })},abyss: {name: "Ïã¨Ïó∞Ïùò Í∑†Ïó¥", duration: 60 * 60 * 4, minRarity: 4, teamSize: 3, rewards: () => ({ stardust: Math.floor(Math.random() * 5) + 1, exp: 200, materials: { dark_matter: 1 } })}};
        const CRAFTING_DATA = {clickPotion: {name: "ÌÅ¥Î¶≠ Ìè¨ÏÖò (5Î∂Ñ)", materials: {wood: 5}, result: {type: 'potion', id: 'clickBoost', duration: 300, effect: {type: 'click_power_mult', value: 2}, img: 'üß™'}},moneyPotion: {name: "Ïû¨Ìôî Ìè¨ÏÖò (10Î∂Ñ)", materials: {wood: 3, stone: 3}, result: {type: 'potion', id: 'moneyBoost', duration: 600, effect: {type: 'money_gain_mult', value: 1.5}, img: 'üí∞'}}};
        const SKILL_DATA = {s001: { name: "ÌÅ¥Î¶≠ Ìè≠Ï£º", type: 'active', maxLevel: 10, sp: 1, cooldown: 180, desc: lv => `10Ï¥àÍ∞Ñ ÌÅ¥Î¶≠Îãπ Ïû¨Ìôî ${5 + lv * 0.5}Î∞∞ Ï¶ùÍ∞Ä`},s002: { name: "Ïû¨Ìôî Ï¶âÎ∞ú", type: 'active', maxLevel: 10, sp: 2, cooldown: 3600, desc: lv => `${10 + lv}Î∂ÑÏπò ÏûêÎèô Ïû¨Ìôî Ï¶âÏãú ÌöçÎìù`},s003: { name: "Ìô©Í∏à ÎèÑÌÜ†Î¶¨", type: 'active', maxLevel: 5, sp: 3, cooldown: 7200, desc: lv => `Ï¶âÏãú ${lv}Í∞úÏùò Ìô©Í∏à ÎèÑÌÜ†Î¶¨ ÌöçÎìù`},p001: { name: "Í≤¨Í≥†Ìïú ÍªçÏßà", type: 'passive', maxLevel: 20, sp: 1, desc: lv => `ÌÅ¥Î¶≠Îãπ Ïû¨Ìôî ÌöçÎìùÎüâ ${lv * 5}% Ï¶ùÍ∞Ä`, effect: lv => lv * 0.05 },p002: { name: "Ìô©Í∏à ÌÑ∞Ïπò", type: 'passive', maxLevel: 10, sp: 2, desc: lv => `Ìô©Í∏à ÎèÑÌÜ†Î¶¨ ÌöçÎìù ÌôïÎ•† ${lv * 10}% Ï¶ùÍ∞Ä`, effect: lv => lv * 0.1 },a001: { name: "ÏûêÎèô ÌöåÏ†Ñ", type: 'passive', maxLevel: 20, sp: 1, desc: lv => `Ï¥àÎãπ ÏûêÎèô Ïû¨Ìôî ÌöçÎìùÎüâ ${lv * 5}% Ï¶ùÍ∞Ä`, effect: lv => lv * 0.05 },a002: { name: "Î≥ÑÏùò Ï∂ïÎ≥µ", type: 'passive', maxLevel: 10, sp: 2, desc: lv => `Ïò§ÌîÑÎùºÏù∏ Î≥¥ÏÉÅÎüâ ${lv * 10}% Ï¶ùÍ∞Ä`, effect: lv => lv * 0.1 }};
        const BOSS_DATA = {nightmare: { name: "ÏßÄÌÜ†Î¶¨Ïùò ÏïÖÎ™Ω", hp: 1e5, reward: { money: 5e5 }, attack: 500, attackSpeed: 4, img: 'üëª', animation: 'shake' },devil: { name: "ÏßÄÌÜ†Î¶¨Ïùò ÏïÖÎßà", hp: 1e8, reward: { money: 5e8 }, attack: 50000, attackSpeed: 4, img: 'üëø', animation: 'pulse' },reaper: { name: "ÏßÄÌÜ†Î¶¨Ïùò ÏÇ¨Ïã†", hp: 1e12, reward: { money: 1e13, stardust: 100 }, attack: 1e9, attackSpeed: 3.5, img: 'üíÄ', animation: 'lunge' },glitch: { name: "?#@*„Öá!„Öì„ÖÅÎµì", hp: 1e14, reward: { money: 1e15, stardust: 1000 }, attack: 1e11, attackSpeed: 3, img: 'üëæ', animation: 'shake' },discovery: {name: "Î∞úÍ≤¨", hp: 1e16, reward: { money: 1e17, stardust: 10000 }, attack: 1e13, attackSpeed: 5, img: 'üëÅÔ∏è', animation: 'pulse', story: "Ïö∞Ï£ºÏùò ÎÅù, Î™®Îì† Í≤ÉÏù¥ ÏãúÏûëÎêú Í≥≥ÏóêÏÑú 'Í∑∏Í≤É'ÏùÑ Î∞úÍ≤¨ÌñàÎã§. 'Í∑∏Í≤É'ÏùÄ ÌòïÌÉúÍ∞Ä ÏóÜÏóàÎã§. Î™®Îì† Í∞ÄÎä•ÏÑ±Ïù¥Ïûê ÎÅùÏóÜÎäî Î¨¥(ÁÑ°)ÏòÄÎã§. 'Í∑∏Í≤É'ÏùÄ Ïö∞Î¶¨Î•º Î∞îÎùºÎ≥¥Î©∞ Î¨ºÏóàÎã§. 'ÎÑàÌù¨Ïùò Ï°¥Ïû¨ Ïù¥Ïú†Îäî Î¨¥ÏóáÏù∏Í∞Ä?' ...ÎãµÌï¥Ïïº ÌïúÎã§. Ïö∞Î¶¨Ïùò Î™®Îì† Í≤ÉÏùÑ Í±∏Í≥†."}};
        const WEAPON_DATA = {w001:{name:"ÎÇ°ÏùÄ ÎÇòÎ≠áÍ∞ÄÏßÄ",bonus:1,cost:1e8},w002:{name:"Îã®Îã®Ìïú Ï°∞ÏïΩÎèå",bonus:2,cost:1e10},w003:{name:"Í∞ïÏ≤† ÎèÑÌÜ†Î¶¨ ÍπçÏßÄ",bonus:3,cost:1e12},w004:{name:"Î≥ÑÎπõÏù¥ ÍπÉÎì† Í≤Ä",bonus:10,cost:1e14},w005:{name:"ÏùÄÌïòÏàò ÎåÄÌè¨",bonus:100,cost:1e15},w006:{name:"Ï∞®ÏõêÏùò ÌååÌé∏",bonus:999,cost:5e16},w007:{name:"Ïö∞Ï£º Í∑∏ ÏûêÏ≤¥",bonus:1e9,cost:1e19}};
        const DUNGEON_DATA = {d01: { name: "ÏûäÌòÄÏßÑ Ïà≤", stages: [{ bossId: 'nightmare', hpMultiplier: 0.5 }, { bossId: 'nightmare', hpMultiplier: 1 }], reward: { money: 1e6, materials: { wood: 5 } } }};
        const WORLD_BOSS_DATA = { omegaAcorn: { name: "Ïò§Î©îÍ∞Ä ÎèÑÌÜ†Î¶¨", totalHp: 1e30, endDate: new Date('2025-12-31T23:59:59'), img: 'üí•' } };
        const COUPONS = { 
            "WELCOME2025": { reward: { goldenAcorns: 50, stardust: 10 }, message: "ÌôòÏòÅÌï©ÎãàÎã§! Ìô©Í∏àÎèÑÌÜ†Î¶¨ 50Í∞ú, Ïä§ÌÉÄÎçîÏä§Ìä∏ 10Í∞ú ÌöçÎìù!" },
            "ACORN": { reward: { money: 1e27 }, message: "ÎπÑÎ∞Ä Ïø†Ìè∞ÏùÑ Î∞úÍ≤¨ÌñàÏäµÎãàÎã§! 1000Ìï¥ Ïû¨Ìôî ÏßÄÍ∏â!" }
        };
        
        // --- Game State & Variables ---
        let gameState = {};
        const initialGameState = {money:0,goldenAcorns:0,stardust:0,playerLevel:1,playerExp:0,pets:[],equippedPetIds:[],petLimit:3,upgrades:{autoClickLevel:0,clickPowerLevel:0,goldenAcornChanceLevel:0},missions:[],collection:{},artifacts:{},titles:{unlocked:["Ï¥àÎ≥¥Ïûê"],equipped:"Ï¥àÎ≥¥Ïûê"},couponsUsed:[],stats:{totalClicks:0,totalMoney:0,maxMoney:0,rebirths:0,playTime:0,explorations:0, gachaCount:0, statsHistory:[], worldBossDamage:0},settings:{numberFormat:"korean",animations:true, sound: 0.5, music: 0.3},storyBooks:{},lastSaveTime:Date.now(),explorationSlots:[{team:[],returnTime:0,area:null}],inventory:{materials:{wood:0,stone:0,dark_matter:0}},activePotions:[],skills:{points:0,levels:{}, unlocked: [], cooldowns: {}, active: {}},boss:{team:[],activeBoss:null,bossHp:0,petHps:{},cleared:[],isAttacking:false,attackTargetId:null,nextAttackTime:0},worldBoss:{damageDealt:0},dungeon:{active:null,stage:0},weapons:{owned:[],equipped:{}}};
        
        let nextPetId = 0;
        let selectionState = { enhance: [], evolve: [] };
        let currentModal = null;
        let gameLoopInterval = null;
        let statChart = null;
        
        // --- Sound Manager ---
        const SoundManager = {
            sounds: {},
            music: null,
            init() {
                this.sounds.click = new Howl({ src: ['https://actions.google.com/sounds/v1/ui/page_turn.ogg'], volume: 0.3 });
                this.sounds.buy = new Howl({ src: ['https://actions.google.com/sounds/v1/eartraining/coin_drop_positive.ogg'] });
                this.sounds.success = new Howl({ src: ['https://actions.google.com/sounds/v1/achievements/achievement_unlocked.ogg'] });
                this.sounds.error = new Howl({ src: ['https://actions.google.com/sounds/v1/emergency/beeper_emergency_call.ogg'], volume: 0.4 });
                this.sounds.levelUp = new Howl({ src: ['https://actions.google.com/sounds/v1/cartoon/magic_chime.ogg'] });
                this.sounds.gacha = new Howl({ src: ['https://actions.google.com/sounds/v1/mystery/magic_portal_opening_1.ogg'] });
                this.sounds.bossHit = new Howl({ src: ['https://actions.google.com/sounds/v1/weapons/punch_heavy_hard.ogg'], volume: 0.5 });
                this.music = new Howl({ src: ['https://actions.google.com/sounds/v1/ambiences/ambient_soundscape.ogg'], loop: true, html5: true });
                this.updateVolumes();
            },
            play(soundId) {
                if (this.sounds[soundId] && gameState.settings.sound > 0) {
                    this.sounds[soundId].play();
                }
            },
            toggleMusic(forcePlay = false) {
                if (this.music.playing()) {
                    if (!forcePlay) this.music.fade(gameState.settings.music, 0, 1000);
                } else if (gameState.settings.music > 0) {
                    this.music.play();
                    this.music.fade(0, gameState.settings.music, 1000);
                }
            },
            updateVolumes() {
                Object.values(this.sounds).forEach(s => s.volume(gameState.settings.sound));
                if(this.music) this.music.volume(gameState.settings.music);
            }
        };

        // --- Three.js Background ---
        let scene, camera, renderer, stars;
        function init3DBackground() {
            try {
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 1000);
                camera.position.z = 1;
                renderer = new THREE.WebGLRenderer({ canvas: DOMElements.backgroundCanvas, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);

                const starGeo = new THREE.BufferGeometry();
                const starVertices = [];
                for (let i = 0; i < 6000; i++) {
                    const x = (Math.random() - 0.5) * 2000;
                    const y = (Math.random() - 0.5) * 2000;
                    const z = (Math.random() - 0.5) * 2000;
                    starVertices.push(x, y, z);
                }
                starGeo.setAttribute('position', new THREE.Float32BufferAttribute(starVertices, 3));
                
                const sprite = new THREE.TextureLoader().load( 'https://threejs.org/examples/textures/sprites/disc.png' );
                const starMaterial = new THREE.PointsMaterial({
                    color: 0xaaaaaa,
                    size: 0.7,
                    map: sprite,
                    transparent: true
                });

                stars = new THREE.Points(starGeo, starMaterial);
                scene.add(stars);

                window.addEventListener('resize', onWindowResize, false);
                document.body.addEventListener('mousemove', onMouseMove, false);
                animate3D();
            } catch(e) {
                console.error("3D Background initialization failed:", e);
                DOMElements.backgroundCanvas.style.display = 'none'; // Hide canvas if it fails
            }
        }
        function animate3D() {
            if(!renderer) return;
            requestAnimationFrame(animate3D);
            stars.rotation.y += 0.0001;
            renderer.render(scene, camera);
        }
        function onWindowResize() {
            if(!renderer) return;
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        function onMouseMove(event) {
            if(!camera) return;
            const mouseX = (event.clientX / window.innerWidth) * 2 - 1;
            const mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
            gsap.to(camera.position, {
                x: mouseX * 0.5,
                y: mouseY * 0.5,
                duration: 1,
                ease: 'power2.out'
            });
        }
        
        // --- Game Initialization ---
        function init() {
            loadGame();
            
            if (gameState.pets.length === 0) addPet('acorn', 'init');
            
            SoundManager.init();
            init3DBackground();
            handleOfflineProgress();
            generateMissions();
            checkTitleUnlocks();
            
            // Hide loading overlay and start game
            DOMElements.loadingOverlay.style.display = 'none';
            
            gameLoopInterval = setInterval(gameLoop, 1000);
            SoundManager.toggleMusic(true);
            
            renderAll();
        }
        
        // --- Core Game Loop ---
        function gameLoop() {
            let cps = calculateCPS();
            changeMoney(cps.auto, 'auto');
            gameState.stats.playTime++;

            Object.keys(gameState.skills.cooldowns || {}).forEach(id => { if (gameState.skills.cooldowns[id] > 0) gameState.skills.cooldowns[id]--; });
            if (gameState.stats.playTime % 2 == 0) renderSkillBar(); // Update skill bar cooldowns visually
            updatePotions();
            
            if (gameState.boss.activeBoss) updateBossFight();
            
            if (gameState.stats.playTime % 30 === 0) saveGame();
            if (gameState.stats.playTime % 60 === 0) {
                gameState.stats.statsHistory.push({ time: Date.now(), money: gameState.money });
                if (gameState.stats.statsHistory.length > 60) gameState.stats.statsHistory.shift();
            }
        }
        
        // --- Calculation Logic ---
        function calculateCPS() {
            let baseClick = 0;
            let clickMultiplier = 1;
            let autoMultiplier = 1;
            let globalMultiplier = 1;

            gameState.equippedPetIds.map(id => findPetById(id)).filter(p => p).forEach(pet => {
                const petData = PET_DATA[pet.type];
                if (!petData) return;
                let petPower = petData.baseClick;
                petPower *= (1 + (pet.enhancement * .2));
                petPower *= (1 + (pet.evolution * 2));
                petPower *= (1 + (pet.potential * .5));
                baseClick += petPower;
            });
            baseClick = Math.max(1, baseClick);
            
            globalMultiplier *= (1 + gameState.stats.rebirths * 0.5);
            if(gameState.artifacts.ancientAcorn) globalMultiplier *= (1 + ARTIFACT_DATA.ancientAcorn.effect(gameState.artifacts.ancientAcorn.level));
            globalMultiplier *= (1 + Object.keys(gameState.collection).length * 0.005);
            
            clickMultiplier *= (1 + (gameState.skills.levels['p001'] ? SKILL_DATA['p001'].effect(gameState.skills.levels['p001']) : 0));
            autoMultiplier *= (1 + (gameState.skills.levels['a001'] ? SKILL_DATA['a001'].effect(gameState.skills.levels['a001']) : 0));

            const equippedTitle = TITLE_DATA[gameState.titles.equipped];
            if (equippedTitle && equippedTitle.bonus.type !== 'none') {
                const b = equippedTitle.bonus;
                if (b.type === 'click_power' || b.type === 'all_power') clickMultiplier *= (1 + b.value);
                if (b.type === 'money_gain' || b.type === 'all_power') autoMultiplier *= (1 + b.value);
            }
            
            gameState.activePotions.forEach(p => {
                if(p.effect.type === 'click_power_mult') clickMultiplier *= p.effect.value;
                if(p.effect.type === 'money_gain_mult') autoMultiplier *= p.effect.value;
            });

            let totalClickValue = baseClick * clickMultiplier * globalMultiplier;
            if(gameState.artifacts.starFragment) totalClickValue *= (1 + ARTIFACT_DATA.starFragment.effect(gameState.artifacts.starFragment.level));
            const autoClickPerSecond = totalClickValue * autoMultiplier * 0.1;

            return { click: totalClickValue, auto: autoClickPerSecond };
        }
        
        // --- Event Handlers & Core Actions ---
        function handlePetClick(event) {
            if (gameState.boss.activeBoss) return; // Boss clicks are handled differently

            let { click: clickValue } = calculateCPS();
            SoundManager.play('click');

            if (gameState.skills.active && gameState.skills.active['s001'] && gameState.skills.active['s001'] > Date.now()) {
                const skillLevel = gameState.skills.levels['s001'] || 1;
                clickValue *= (5 + skillLevel * 0.5);
            }

            changeMoney(clickValue, 'click');
            gameState.stats.totalClicks++;
            updateMissionProgress('click', 1);
            gainExp(1);

            let dropChance = 0.001 + (gameState.artifacts.goldenCompass ? ARTIFACT_DATA.goldenCompass.effect(gameState.artifacts.goldenCompass.level) : 0);
            dropChance *= (1 + (gameState.skills.levels['p002'] ? SKILL_DATA['p002'].effect(gameState.skills.levels['p002']) : 0));
            if (Math.random() < dropChance) {
                changeGoldenAcorns(1);
                showToast('Ìô©Í∏à ÎèÑÌÜ†Î¶¨Î•º ÌöçÎìùÌñàÏäµÎãàÎã§!', 'info');
                updateMissionProgress('getGoldenAcorn', 1);
            }

            if (gameState.settings.animations) {
                 const floatingText = document.createElement('div');
                floatingText.className = 'floating-text';
                floatingText.textContent = `+${formatNumber(clickValue)}`;
                const rect = DOMElements.gameScreen.getBoundingClientRect();
                floatingText.style.left = `${event.clientX - rect.left - 50}px`;
                floatingText.style.top = `${event.clientY - rect.top}px`;
                DOMElements.gameScreen.appendChild(floatingText);
                setTimeout(() => floatingText.remove(), 1200);
            }
        }
        
        // --- State Changes ---
        function changeMoney(amount, source) {
            if (isNaN(amount) || amount === 0) return;
            const startMoney = gameState.money;
            gameState.money += amount;
            
            if (amount > 0) {
                gameState.stats.totalMoney += amount;
                if (source !== 'auto') updateMissionProgress('earnMoney', amount);
            }
            if (gameState.money > gameState.stats.maxMoney) {
                gameState.stats.maxMoney = gameState.money;
                checkTitleUnlocks();
            }
            renderMoney(startMoney);
        }

        function changeGoldenAcorns(amount) {
            const startAmount = gameState.goldenAcorns;
            gameState.goldenAcorns += amount;
            renderGoldenAcorns(startAmount);
        }

        function changeStardust(amount) {
            const startAmount = gameState.stardust;
            gameState.stardust += amount;
            renderStardust(startAmount);
        }
        
        function getRequiredExp(level) { return Math.floor(100 * Math.pow(1.15, level - 1)); }

        function gainExp(amount) {
            gameState.playerExp += amount;
            let requiredExp = getRequiredExp(gameState.playerLevel);
            let leveledUp = false;
            while (gameState.playerExp >= requiredExp) {
                gameState.playerLevel++;
                gameState.playerExp -= requiredExp;
                gameState.skills.points = (gameState.skills.points || 0) + 1;
                leveledUp = true;
                requiredExp = getRequiredExp(gameState.playerLevel);
            }
            if(leveledUp) {
                showToast(`Î†àÎ≤® ÏóÖ! LV.${gameState.playerLevel} Îã¨ÏÑ±! (Ïä§ÌÇ¨Ìè¨Ïù∏Ìä∏ +1)`, 'success');
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                SoundManager.play('levelUp');
            }
            renderPlayerLevel();
        }

        function addPet(type, from = 'buy') {
            const newPet = { id: nextPetId++, type, enhancement: 0, evolution: 0, potential: Math.random(), locked: false };
            gameState.pets.push(newPet);
            if (gameState.equippedPetIds.length < gameState.petLimit) gameState.equippedPetIds.push(newPet.id);
            if(!gameState.collection[type]) {
                updateMissionProgress('collectPet', 1);
            }
            gameState.collection[type] = true;
            checkTitleUnlocks();
            if(from !== 'load') renderEquippedPets();
        }
        
        function removePetById(id) {
            gameState.pets = gameState.pets.filter(p => p.id !== id);
            gameState.equippedPetIds = gameState.equippedPetIds.filter(petId => petId !== id);
            gameState.boss.team = gameState.boss.team.filter(petId => petId !== id);
            renderEquippedPets();
        }

        // --- Systems (Exploration, Crafting, etc) ---
        function updatePotions() {
            const now = Date.now();
            let potionsChanged = false;
            gameState.activePotions = gameState.activePotions.filter(p => {
                const stillActive = p.expires > now;
                if(!stillActive) potionsChanged = true;
                return stillActive;
            });
            if(potionsChanged) renderActivePotions();
        }

        function doCraft(id) {
            const craft = CRAFTING_DATA[id];
            if (!craft) return;
            if (Object.keys(craft.materials).some(mat => (gameState.inventory.materials[mat] || 0) < craft.materials[mat])) {
                showToast("Ïû¨Î£åÍ∞Ä Î∂ÄÏ°±Ìï©ÎãàÎã§.", "error");
                return;
            }
            Object.keys(craft.materials).forEach(mat => gameState.inventory.materials[mat] -= craft.materials[mat]);
            const newPotion = { id: craft.result.id, craftId: id, expires: Date.now() + craft.result.duration * 1000, effect: craft.result.effect };
            const existingPotion = gameState.activePotions.find(p => p.id === newPotion.id);
            if (existingPotion) {
                existingPotion.expires += craft.result.duration * 1000;
            } else {
                gameState.activePotions.push(newPotion);
            }
            showToast(`${craft.name} Ï†úÏûë ÏôÑÎ£å!`, "success");
            SoundManager.play('success');
            renderActivePotions();
            if (currentModal === 'craftingModal') showModal('craftingModal');
        }

        function unlockStory(id) {
            const story = STORY_BOOK_DATA[id];
            if (gameState.money >= story.cost) {
                changeMoney(-story.cost);
                gameState.storyBooks[id] = true;
                showToast(`[${story.name}] Ïä§ÌÜ†Î¶¨Î•º Ïû†Í∏à Ìï¥Ï†úÌñàÏäµÎãàÎã§!`, 'success');
                if (currentModal === 'storyBookModal') showModal('storyBookModal');
            }
        }

        function startExploration(slotIndex, areaId, team) {
            const area = EXPLORATION_DATA[areaId];
            let slot = gameState.explorationSlots[slotIndex];
            if (slot.returnTime > 0 || team.length === 0) return;
            const durationInSeconds = area.duration;
            slot.area = areaId;
            slot.team = team;
            slot.returnTime = Date.now() + durationInSeconds * 1000;
            showToast(`${area.name} ÌÉêÌóò ÏãúÏûë!`, "success");
            closeModal();
        }

        function claimExploration(slotIndex) {
            let slot = gameState.explorationSlots[slotIndex];
            if (!slot.area || slot.returnTime > Date.now()) return;
            const area = EXPLORATION_DATA[slot.area];
            const rewards = area.rewards();
            let teamPower = slot.team.reduce((sum, petId) => {
                const pet = findPetById(petId);
                return sum + (pet ? PET_DATA[pet.type].baseClick : 0);
            }, 1);
            rewards.money *= Math.log10(teamPower + 1);
            let rewardText = `${area.name} ÌÉêÌóò ÏôÑÎ£å! `;
            if (rewards.money) { changeMoney(rewards.money); rewardText += `Ïû¨Ìôî ${formatNumber(rewards.money)}, `; }
            if (rewards.exp) { gainExp(rewards.exp); rewardText += `Í≤ΩÌóòÏπò ${rewards.exp}, `; }
            if (rewards.stardust) { changeStardust(rewards.stardust); rewardText += `Ïä§ÌÉÄÎçîÏä§Ìä∏ ${rewards.stardust}, `; }
            if (rewards.materials) {
                for (const mat in rewards.materials) {
                    gameState.inventory.materials[mat] = (gameState.inventory.materials[mat] || 0) + rewards.materials[mat];
                    rewardText += `${mat} ${rewards.materials[mat]}Í∞ú, `;
                }
            }
            slot.area = null;
            slot.returnTime = 0;
            slot.team = [];
            gameState.stats.explorations++;
            updateMissionProgress('exploration', 1);
            showToast(rewardText.slice(0, -2), "success");
            showModal('explorationModal');
        }
        
        // --- Rendering ---
        function renderAll() {
            renderMoney(gameState.money, true);
            renderGoldenAcorns(gameState.goldenAcorns, true);
            renderStardust(gameState.stardust, true);
            renderPlayerLevel();
            renderEquippedPets();
            renderSkillBar();
            renderActivePotions();
        }

        function renderWithAnimation(element, startValue, endValue, formatter, isInstant = false) {
            if (isInstant || !gameState.settings.animations) {
                element.textContent = formatter(endValue);
                return;
            }
            const obj = { value: startValue };
            gsap.to(obj, {
                value: endValue,
                duration: 0.5,
                ease: 'power2.out',
                onUpdate: () => {
                    element.textContent = formatter(obj.value);
                }
            });
        }
        
        function renderMoney(start = 0, instant = false) { renderWithAnimation(DOMElements.moneyDisplay, start, gameState.money, (v) => formatNumber(v), instant); }
        function renderGoldenAcorns(start = 0, instant = false) { renderWithAnimation(DOMElements.goldenAcornAmount, start, gameState.goldenAcorns, (v) => Math.floor(v).toLocaleString(), instant); }
        function renderStardust(start = 0, instant = false) { renderWithAnimation(DOMElements.stardustAmount, start, gameState.stardust, (v) => Math.floor(v).toLocaleString(), instant); }
        
        function renderPlayerLevel() {
            DOMElements.playerLevelDisplay.textContent = gameState.playerLevel;
            const requiredExp = getRequiredExp(gameState.playerLevel);
            gsap.to(DOMElements.playerExpBar, { width: `${Math.min(100, (gameState.playerExp / requiredExp) * 100)}%`, duration: 0.3 });
        }
        
        function renderEquippedPets() {
            if(gameState.boss.activeBoss){
                renderBossFightScreen();
                return;
            }

            const { gameScreen } = DOMElements;
            gameScreen.innerHTML = '';
            
            let equippedPets = gameState.equippedPetIds.map(id => findPetById(id)).filter(p => p);
            if (equippedPets.length === 0 && gameState.pets.length > 0) {
                equippedPets = [gameState.pets.find(p => p)];
            }

            if (equippedPets.length > 0) {
                 gameScreen.classList.remove('flex-col');
                gameScreen.classList.add('flex-row', 'flex-wrap');
                equippedPets.forEach(pet => {
                    const petData = PET_DATA[pet.type];
                    if (!petData) return;
                    const el = document.createElement('div');
                    el.className = 'text-center pet-container';
                    el.innerHTML = `<div class="text-7xl pet">${petData.img}</div><div class="text-sm font-bold">${petData.name}</div>`;
                    gameScreen.appendChild(el);
                    gsap.from(el, { scale: 0, opacity: 0, duration: 0.5, ease: 'back.out(1.7)' });
                });
                gameScreen.onclick = handlePetClick;
            } else {
                gameScreen.classList.add('flex-col');
                gameScreen.classList.remove('flex-row', 'flex-wrap');
                gameScreen.innerHTML = `<div class="text-2xl text-center text-gray-400">ÏÉÅÏ†êÏóêÏÑú Ï≤´ Ìé´ÏùÑ Íµ¨Îß§ÌïòÏÑ∏Ïöî!</div>`;
                gameScreen.onclick = null;
            }
        }

        function renderBossFightScreen() {
            const { gameScreen } = DOMElements;
            gameScreen.classList.add('flex-col');
            gameScreen.classList.remove('flex-row', 'flex-wrap');

            const bossData = BOSS_DATA[gameState.boss.activeBoss];
            const bossHpPercent = (gameState.boss.bossHp / bossData.hp) * 100;

            const teamPetsHtml = gameState.boss.team.map(petId => {
                const pet = findPetById(petId);
                if (!pet) return '';
                const petData = PET_DATA[pet.type];
                const maxHp = (petData.cost / 10) * (1 + pet.evolution * 0.5);
                const currentHp = gameState.boss.petHps[petId];
                const hpPercent = (currentHp / maxHp) * 100;
                const isTargeted = gameState.boss.attackTargetId === petId;
                const isDead = currentHp <= 0;

                return `
                    <div
                        class="pet-raid-unit flex flex-col items-center p-2 rounded-lg transition-all duration-200 ${isTargeted ? 'is-targeted' : ''} ${isDead ? 'grayscale opacity-50' : 'cursor-pointer hover:scale-110'}"
                        onclick="${isDead ? '' : `window.gameAPI.handlePetAttackOnBoss(${pet.id})`}"
                    >
                        <div class="text-6xl">${petData.img}</div>
                        <div class="w-20 bg-gray-700 rounded-full h-3 mt-2 border border-gray-500">
                            <div class="progress-bar-inner hp-bar h-full rounded-full" style="width: ${hpPercent}%"></div>
                        </div>
                <div class="text-xs mt-1">${formatNumber(currentHp)} / ${formatNumber(maxHp)}</div>
                    </div>
                `;
            }).join('');

            gameScreen.innerHTML = `
                <div id="boss-area" class="w-full h-1/2 flex flex-col items-center justify-center relative">
                    <div class="absolute top-2 left-1/2 -translate-x-1/2 text-center w-full px-4">
                        <h2 class="text-3xl text-red-400 font-bold">${bossData.name}</h2>
                        <div class="w-full max-w-lg mx-auto bg-gray-700 rounded-full h-6 mt-2 border-2 border-red-500">
                            <div class="progress-bar-inner hp-bar h-full rounded-full" style="width: ${bossHpPercent}%"></div>
                        </div>
                        <p class="text-white text-lg mt-1">${formatNumber(gameState.boss.bossHp)} / ${formatNumber(bossData.hp)}</p>
                    </div>
                    <div id="boss-sprite" class="text-9xl">${bossData.img}</div>
                </div>
                <div id="pet-team-area" class="w-full h-1/2 flex items-end justify-center gap-4 p-4 bg-black/30 rounded-t-xl absolute bottom-0 left-0 right-0">
                    ${teamPetsHtml}
                </div>
            `;
            gameScreen.onclick = null; // Disable the generic screen click
        }
        
        function renderSkillBar() {
            DOMElements.skillBar.innerHTML = '';
            (gameState.skills.unlocked || []).forEach(skillId => {
                const skill = SKILL_DATA[skillId];
                if(skill.type !== 'active') return;
                const cooldown = gameState.skills.cooldowns[skillId] || 0;
                const el = document.createElement('button');
                el.className = 'btn bg-rose-800 border-rose-500 text-white p-2 rounded-lg relative w-24 h-24 flex flex-col items-center justify-center';
                el.disabled = cooldown > 0;
                el.onclick = () => window.gameAPI.activateSkill(skillId);
                el.innerHTML = `<span>${skill.name}</span> ${cooldown > 0 ? `<div class="skill-cooldown">${Math.ceil(cooldown)}s</div>` : ''}`;
                DOMElements.skillBar.appendChild(el);
            });
        }
        
        function renderActivePotions() {
            DOMElements.activePotionsBar.innerHTML = gameState.activePotions.map(p => {
                const timeLeft = Math.ceil((p.expires - Date.now()) / 1000);
                const craftData = CRAFTING_DATA[p.craftId];
                return `<div class="bg-black/50 p-2 rounded-full border border-purple-400 text-2xl" title="${craftData ? craftData.name : 'Ìè¨ÏÖò'} (${timeLeft}s)">
                    ${craftData ? craftData.result.img : '‚ùì'}
                </div>`
            }).join('');
        }
        
        function renderStatsChart() {
            const canvas = document.getElementById('statsChartCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const data = gameState.stats.statsHistory;
            if (statChart) statChart.destroy();
            statChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_, i) => `${60 - i}s ago`),
                    datasets: [{
                        label: 'Ïû¨Ìôî',
                        data: data.map(d => d.money),
                        borderColor: 'rgba(0, 255, 255, 1)',
                        backgroundColor: 'rgba(0, 255, 255, 0.2)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: false, ticks: { color: '#e0e0e0', callback: value => formatNumber(value) }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: '#e0e0e0' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Modals ---
        function showModal(modalId, data = {}) {
            currentModal = modalId;
            DOMElements.modalContent.innerHTML = ''; 
            
            const modalGenerator = MODAL_GENERATORS[modalId];
            if (!modalGenerator) return;

            const { title, content } = modalGenerator(data);
            DOMElements.modalContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-center text-secondary-glow flex-grow">${title}</h2>
                    <button onclick="window.gameAPI.closeModal()" class="text-3xl hover:text-red-500 transition-colors">&times;</button>
                </div>
                <div class="flex-grow overflow-y-auto pr-2 modal-scroll">${content}</div>
            `;
            
            DOMElements.modalContainer.style.visibility = 'visible';
            gsap.to(DOMElements.modalContainer, { opacity: 1, duration: 0.3 });
            gsap.fromTo(DOMElements.modalContent, { opacity: 0, scale: 0.9 }, { opacity: 1, scale: 1, duration: 0.3, ease: 'power2.out' });
            
            if (modalId === 'statsModal') {
                setTimeout(renderStatsChart, 50);
            }
        }
        
        function closeModal() {
            gsap.to(DOMElements.modalContent, { opacity: 0, scale: 0.9, duration: 0.2, ease: 'power2.in' });
            gsap.to(DOMElements.modalContainer, { opacity: 0, duration: 0.2, delay: 0.1, onComplete: () => {
                DOMElements.modalContainer.style.visibility = 'hidden';
                currentModal = null;
                selectionState = { enhance: [], evolve: [] };
                if (statChart) {
                    statChart.destroy();
                    statChart = null;
                }
            }});
        }

        // --- All Modal Generators ---
        const MODAL_GENERATORS = {
             shopModal: () => ({
                title: "ÏÉÅÏ†ê & Ìé´ ÎΩëÍ∏∞",
                content: `
                <div class="flex border-b-2 border-purple-500 mb-4">
                    <button class="tab-button active flex-1 p-3 text-lg" onclick="window.gameAPI.switchTab(event, 'shopTab')">Ìé´ Íµ¨Îß§</button>
                    <button class="tab-button flex-1 p-3 text-lg" onclick="window.gameAPI.switchTab(event, 'gachaTab')">Ìé´ ÎΩëÍ∏∞</button>
                </div>
                <div id="shopTab" class="tab-content space-y-2 max-h-[60vh] overflow-y-auto pr-2">
                    ${Object.keys(PET_DATA).filter(k=>PET_DATA[k].cost>0).map(type=>{const pet=PET_DATA[type];return`<button onclick="window.gameAPI.buyPet('${type}')" class="btn w-full bg-cyan-800 border-cyan-500 text-white p-3 rounded-lg flex justify-between items-center" ${gameState.money<pet.cost?"disabled":""}><span>${pet.img} ${pet.name} <span class="${RARITY_COLORS[pet.rarity]||"text-white"}">[${pet.rarity}]</span></span> <span>${formatNumber(pet.cost)}</span></button>`}).join("")}
                </div>
                <div id="gachaTab" class="tab-content hidden text-center">
                    <p class="mb-4">Ïö¥Î™ÖÏùò ÎΩëÍ∏∞Î°ú Ìù¨Í∑ÄÌïú Ìé´ÏùÑ ÎßåÎÇòÎ≥¥ÏÑ∏Ïöî!</p>
                    <div id="gachaResultContainer" class="h-48 flex items-center justify-center text-8xl mb-4">‚ùì</div>
                    <button onclick="window.gameAPI.doGacha('normal')" class="btn w-full bg-teal-500 border-teal-300 text-white p-4 rounded-lg text-xl mb-2" ${gameState.money<50000?"disabled":""}>ÏùºÎ∞ò ÎΩëÍ∏∞ (5Îßå)</button>
                    <button onclick="window.gameAPI.doGacha('premium')" class="btn w-full bg-yellow-500 border-yellow-300 text-black p-4 rounded-lg text-xl mb-2" ${gameState.goldenAcorns<10?"disabled":""}>ÌîÑÎ¶¨ÎØ∏ÏóÑ ÎΩëÍ∏∞ (Ìô©Í∏àÎèÑÌÜ†Î¶¨ 10Í∞ú)</button>
                    <button onclick="window.gameAPI.doGacha('stardust')" class="btn w-full bg-indigo-500 border-indigo-300 text-white p-4 rounded-lg text-xl" ${gameState.stardust<100?"disabled":""}>Ïä§ÌÉÄÎçîÏä§Ìä∏ ÎΩëÍ∏∞ (Ïä§ÌÉÄÎçîÏä§Ìä∏ 100Í∞ú)</button>
                </div>`
            }),
            petModal: () => {
                const petHtml = gameState.pets.map(pet => {
                    const petData = PET_DATA[pet.type];
                    const isEquipped = gameState.equippedPetIds.includes(pet.id);
                    return `
                    <div class="pet-card bg-black/40 p-3 rounded-lg text-center ${isEquipped ? 'equipped-glow' : ''}">
                        <div class="text-5xl">${petData.img}</div>
                        <div class="font-bold">${petData.name} <span class="text-yellow-300">+${pet.enhancement}</span> Lv.${pet.evolution}</div>
                        <div class="text-sm ${RARITY_COLORS[petData.rarity]}">[${petData.rarity}]</div>
                        <div class="text-xs">Ïû†Ïû¨Î†•: ${(pet.potential * 100).toFixed(1)}%</div>
                        <div class="mt-2 flex justify-center gap-2">
                            <button onclick="window.gameAPI.toggleEquip(${pet.id})" class="btn text-xs px-2 py-1 rounded ${isEquipped ? 'bg-yellow-600 border-yellow-400' : 'bg-gray-600 border-gray-400'}">${isEquipped ? 'Ìï¥Ï†ú' : 'Ïû•Ï∞©'}</button>
                            <button onclick="window.gameAPI.toggleLock(${pet.id})" class="btn text-xs px-2 py-1 rounded ${pet.locked ? 'bg-red-600 border-red-400' : 'bg-gray-600 border-gray-400'}"><i class="fa-solid ${pet.locked ? 'fa-lock' : 'fa-lock-open'}"></i></button>
                        </div>
                    </div>`;
                }).join('');
                return {
                    title: `ÎÇ¥ Ìé´ Í¥ÄÎ¶¨ (${gameState.equippedPetIds.length}/${gameState.petLimit})`,
                    content: `<div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2 max-h-[70vh] overflow-y-auto">${petHtml || '<p>Î≥¥Ïú†Ìïú Ìé´Ïù¥ ÏóÜÏäµÎãàÎã§.</p>'}</div>`
                };
            },
            enhanceModal: () => {
                const petListHtml = gameState.pets.map(p => {
                    const pData = PET_DATA[p.type];
                    const isSelected = selectionState.enhance.includes(p.id);
                    return `<div onclick="window.gameAPI.selectForEnhance(${p.id})" class="pet-card bg-black/40 p-2 rounded-lg text-center cursor-pointer ${isSelected ? 'selected' : ''} ${p.locked ? 'grayscale':''}">
                        <div class="text-3xl">${pData.img}</div>
                        <div class="text-xs font-bold">${pData.name}+${p.enhancement} Lv.${p.evolution}</div>
                    </div>`;
                }).join('');

                return {
                    title: "Ìé´ Í∞ïÌôî",
                    content: `
                    <p class="text-center mb-2">Í∞ïÌôîÌï† Ìé´ 1ÎßàÎ¶¨ÏôÄ Ïû¨Î£å Ìé´ 1ÎßàÎ¶¨, Ï¥ù 2ÎßàÎ¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
                    <p class="text-center mb-4 text-sm text-gray-400">ÎèôÏùºÌïú Ï¢ÖÎ•ò, Í∞ïÌôî, ÏßÑÌôî Îã®Í≥ÑÏùò Ìé´Îßå Ïû¨Î£åÎ°ú ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§. (ÏµúÎåÄ +15)</p>
                    <button onclick="window.gameAPI.doEnhance()" class="btn bg-red-600 border-red-400 w-full mt-4 p-3" ${selectionState.enhance.length !== 2 ? 'disabled' : ''}>Í∞ïÌôîÌïòÍ∏∞</button>
                    <div class="grid grid-cols-4 sm:grid-cols-6 gap-2 max-h-[60vh] overflow-y-auto p-1 mt-4">${petListHtml}</div>`
                }
            },
            evolveModal: () => {
                const petListHtml = gameState.pets.map(p => {
                    const pData = PET_DATA[p.type];
                    const isSelected = selectionState.evolve.includes(p.id);
                    return `<div onclick="window.gameAPI.selectForEvolve(${p.id})" class="pet-card bg-black/40 p-2 rounded-lg text-center cursor-pointer ${isSelected ? 'selected' : ''} ${p.locked ? 'grayscale':''}">
                        <div class="text-3xl">${pData.img}</div>
                        <div class="text-xs font-bold">${pData.name}+${p.enhancement} Lv.${p.evolution}</div>
                    </div>`;
                }).join('');

                return {
                    title: "Ìé´ ÏßÑÌôî",
                    content: `
                    <p class="text-center text-gray-400 mb-4">ÏßÑÌôîÌï† Ìé´ 1ÎßàÎ¶¨ÏôÄ ÎèôÏùº Ï¢ÖÎ•ò Ïû¨Î£å Ìé´ 2ÎßàÎ¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. (ÏµúÎåÄ 5ÏßÑÌôî)</p>
                    <button onclick="window.gameAPI.doEvolve()" class="btn bg-indigo-600 border-indigo-400 w-full mt-4 block p-3" ${selectionState.evolve.length !== 3 ? 'disabled' : ''}>ÏßÑÌôîÌïòÍ∏∞</button>
                    <div class="grid grid-cols-4 sm:grid-cols-6 gap-2 max-h-[60vh] overflow-y-auto p-1 mt-4">${petListHtml}</div>`
                }
            },
            missionModal: () => ({
                title: "ÎØ∏ÏÖò",
                content: `<div class="space-y-3 max-h-[70vh] overflow-y-auto pr-2">${gameState.missions.map((m, i) => renderMission(m, i)).join('') || '<p>Î™®Îì† ÎØ∏ÏÖòÏùÑ ÏôÑÎ£åÌñàÏäµÎãàÎã§!</p>'}</div>`
            }),
            collectionModal: () => {
                 const collectionHtml = Object.keys(PET_DATA).map(type => {
                    const petData = PET_DATA[type];
                    const isCollected = !!gameState.collection[type];
                    return `<div class="bg-black/40 p-3 rounded-lg text-center ${!isCollected ? 'grayscale' : ''}">
                        <div class="text-6xl">${petData.img}</div>
                        <div class="font-bold">${isCollected ? petData.name : '???'}</div>
                        <div class="text-sm ${RARITY_COLORS[petData.rarity]}">[${petData.rarity}]</div>
                    </div>`;
                 }).join('');
                 return {
                     title: `Ìé´ ÎèÑÍ∞ê (${Object.keys(gameState.collection).length}/${Object.keys(PET_DATA).length})`,
                     content: `<p class="text-center text-gray-300 mb-4">ÎèÑÍ∞ê ÏôÑÏÑ± Î≥¥ÎÑàÏä§: Î™®Îì† Ïû¨Ìôî ÌöçÎìùÎüâ +${(Object.keys(gameState.collection).length * 0.5).toFixed(1)}%</p>
                     <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 max-h-[70vh] overflow-y-auto">${collectionHtml}</div>`
                 }
            },
            rebirthModal: () => {
                const rebirthReq = 1e9;
                const canRebirth = gameState.money >= rebirthReq;
                const stardustGain = canRebirth ? Math.floor(Math.log10(gameState.money) - 7) : 0;
                const artifactHtml = Object.keys(ARTIFACT_DATA).map(id => {
                    const artifact = ARTIFACT_DATA[id];
                    const currentLevel = gameState.artifacts[id] ? gameState.artifacts[id].level : 0;
                    const cost = artifact.cost(currentLevel);
                    const canBuy = gameState.stardust >= cost;
                    return `<div class="bg-black/40 p-3 rounded-lg flex items-center justify-between">
                        <div>
                            <h4 class="font-bold">${artifact.name} (Lv.${currentLevel})</h4>
                            <p class="text-sm text-gray-300">${artifact.desc.replace('{EFFECT}', (artifact.effect(currentLevel)*100).toFixed(2))}</p>
                        </div>
                        <button onclick="window.gameAPI.buyArtifact('${id}')" class="btn bg-yellow-600 border-yellow-400 text-sm p-2" ${!canBuy || currentLevel >= artifact.maxLevel ? 'disabled' : ''}>
                            ${currentLevel >= artifact.maxLevel ? 'MAX' : `ÏóÖÍ∑∏Î†àÏù¥Îìú<br/>(${cost} <i class="fa-solid fa-star text-yellow-300"></i>)`}
                        </button>
                    </div>`;
                }).join('');
                return {
                    title: "ÌôòÏÉù",
                    content: `
                    <div class="text-center bg-black/30 p-4 rounded-lg">
                        <h3 class="text-xl font-bold">ÌôòÏÉùÏùÑ ÌÜµÌï¥ Îçî Í∞ïÌï¥ÏßÄÏÑ∏Ïöî!</h3>
                        <p class="text-gray-300 mt-2">ÌòÑÏû¨ ÏßÑÌñâ ÏÉÅÌô©(Ïû¨Ìôî, Ìé´, Í∞ïÌôî Îì±)Ïù¥ Ï¥àÍ∏∞ÌôîÎêòÏßÄÎßå, <span class="text-yellow-300">Ïä§ÌÉÄÎçîÏä§Ìä∏</span>ÏôÄ Í∞ïÎ†•Ìïú <span class="text-cyan-300">ÏòÅÍµ¨ Î≥¥ÎÑàÏä§</span>Î•º ÏñªÏäµÎãàÎã§.</p>
                        <p class="mt-1">ÌòÑÏû¨ ÌôòÏÉù ÌöüÏàò: ${gameState.stats.rebirths}Ìöå (Î™®Îì† Ïû¨Ìôî +${gameState.stats.rebirths * 50}%)</p>
                        <p class="mt-4 text-lg">ÌôòÏÉù Ï°∞Í±¥: Ïû¨Ìôî ${formatNumber(rebirthReq)} Î≥¥Ïú†</p>
                        <p class="text-lg">ÌöçÎìù ÏòàÏÉÅ Ïä§ÌÉÄÎçîÏä§Ìä∏: <span class="text-yellow-300">${stardustGain > 0 ? stardustGain : 0}</span></p>
                        <button onclick="window.gameAPI.doRebirth()" class="btn bg-gray-700 border-yellow-500 text-yellow-300 w-full mt-4 p-3 text-xl" ${!canRebirth ? 'disabled' : ''}>ÌôòÏÉùÌïòÍ∏∞</button>
                    </div>
                    <div class="mt-6">
                        <h3 class="text-2xl text-center mb-3">Ïú†Î¨º</h3>
                        <div class="space-y-2 max-h-[40vh] overflow-y-auto pr-2">${artifactHtml}</div>
                    </div>`
                }
            },
            explorationModal: () => {
                if (!window.explorationTeam) window.explorationTeam = [];
                const petSelectionHtml = gameState.pets.map(pet => {
                    const petData = PET_DATA[pet.type];
                    const isSelected = window.explorationTeam.includes(pet.id);
                    const isExploring = gameState.explorationSlots.some(slot => slot.team.includes(pet.id));
                    return `<div onclick="window.gameAPI.toggleExplorationTeam(${pet.id})" class="pet-card bg-black/40 p-2 rounded-lg text-center cursor-pointer ${isSelected ? 'selected' : ''} ${isExploring ? 'grayscale' : ''}">
                        <div class="text-3xl">${petData.img}</div>
                        <div class="text-xs font-bold">${petData.name}</div>
                    </div>`;
                }).join('');
                return {
                    title: "ÌÉêÌóò",
                    content: `<div class="space-y-4 max-h-[70vh] overflow-y-auto">
                        ${gameState.explorationSlots.map((slot, index) => {
                            if (slot.returnTime > 0) {
                                const remaining = Math.max(0, Math.ceil((slot.returnTime - Date.now())/1000));
                                return `<div class="bg-black/40 p-4 rounded-lg">
                                    <h3 class="font-bold text-lg">${EXPLORATION_DATA[slot.area].name} ÌÉêÌóò Ï§ë...</h3>
                                    <p>ÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${new Date(remaining * 1000).toISOString().substr(11, 8)}</p>
                                    <button onclick="window.gameAPI.claimExploration(${index})" class="btn w-full mt-2 bg-green-600 border-green-400" ${remaining > 0 ? 'disabled' : ''}>Î≥¥ÏÉÅ Î∞õÍ∏∞</button>
                                </div>`;
                            } else {
                                return `<div class="bg-black/40 p-4 rounded-lg">
                                    <h3 class="font-bold text-lg">ÌÉêÌóò Ïä¨Î°Ø ${index+1} (ÎπÑÏñ¥ÏûàÏùå)</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mt-2">
                                        ${Object.keys(EXPLORATION_DATA).map(areaId => `<button onclick="window.gameAPI.startExplorationWrapper(${index}, '${areaId}')" class="btn bg-teal-700 border-teal-500 p-2 rounded">${EXPLORATION_DATA[areaId].name}</button>`).join('')}
                                    </div>
                                </div>`;
                            }
                        }).join('')}
                        <div class="border-t-2 border-purple-400 pt-4">
                            <h3 class="text-xl text-center mb-2">ÌÉêÌóòÎåÄ ÏÑ†ÌÉù (ÏÑ†ÌÉùÎêú Ìé´: ${window.explorationTeam.length}ÎßàÎ¶¨)</h3>
                            <div class="grid grid-cols-4 sm:grid-cols-8 gap-2 max-h-[25vh] overflow-y-auto p-1">${petSelectionHtml}</div>
                        </div>
                    </div>`
                }
            },
            skillModal: () => {
                const skillHtml = Object.keys(SKILL_DATA).map(id => {
                    const skill = SKILL_DATA[id];
                    const level = gameState.skills.levels[id] || 0;
                    const canBuy = gameState.skills.points >= skill.sp && level < skill.maxLevel;
                    return `
                    <div class="bg-black/40 p-3 rounded-lg">
                        <h4 class="font-bold">${skill.name} ${level > 0 ? `(Lv.${level})` : ''}</h4>
                        <p class="text-sm text-gray-300 my-1">${skill.desc(level)}</p>
                        <button onclick="window.gameAPI.buySkill('${id}')" class="btn w-full mt-2 bg-rose-600 border-rose-400 text-sm p-2" ${!canBuy ? 'disabled':''}>
                            ${level >= skill.maxLevel ? 'MAX' : `Î∞∞Ïö∞Í∏∞ (SP: ${skill.sp})`}
                        </button>
                    </div>`;
                }).join('');
                return {
                    title: "Ïä§ÌÇ¨Ìä∏Î¶¨",
                    content: `<p class="text-center mb-4">Î≥¥Ïú† Ïä§ÌÇ¨ Ìè¨Ïù∏Ìä∏: ${gameState.skills.points}</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">${skillHtml}</div>`
                }
            },
            bossModal: () => {
                const bossListHtml = Object.keys(BOSS_DATA).map(id => {
                    const boss = BOSS_DATA[id];
                    const isCleared = gameState.boss.cleared.includes(id);
                    return `<button onclick="window.gameAPI.startBossFight('${id}')" class="btn bg-red-900 border-red-700 p-4 rounded-lg text-left ${isCleared ? 'grayscale' : ''}">
                        <h4 class="text-xl font-bold">${boss.name} ${isCleared ? '(ÏôÑÎ£å)' : ''}</h4>
                        <p>HP: ${formatNumber(boss.hp)}</p>
                        <p>Î≥¥ÏÉÅ: ${formatNumber(boss.reward.money)}</p>
                    </button>`
                }).join('');
                const petSelectionHtml = gameState.pets.map(pet => {
                    const petData = PET_DATA[pet.type];
                    const isSelected = gameState.boss.team.includes(pet.id);
                    return `<div onclick="window.gameAPI.toggleBossTeam(${pet.id})" class="pet-card bg-black/40 p-2 rounded-lg text-center cursor-pointer ${isSelected ? 'selected' : ''}">
                        <div class="text-3xl">${petData.img}</div>
                        <div class="text-xs font-bold">${petData.name}</div>
                    </div>`;
                }).join('');

                const weaponShopHtml = Object.keys(WEAPON_DATA).map(id => {
                    const weapon = WEAPON_DATA[id];
                    const isOwned = gameState.weapons.owned.includes(id);
                    return `<button onclick="window.gameAPI.buyWeapon('${id}')" class="btn w-full bg-gray-800 border-gray-600 p-3 rounded-lg flex justify-between items-center" ${isOwned || gameState.money < weapon.cost ? 'disabled' : ''}>
                                <span>${weapon.name} <span class="text-cyan-300">(+${(weapon.bonus * 100).toLocaleString()}%)</span></span>
                                <span>${isOwned ? 'Î≥¥Ïú†Ï§ë' : formatNumber(weapon.cost)}</span>
                            </button>`;
                }).join("");

                const weaponEquipHtml = gameState.pets.map(pet => {
                    const petData = PET_DATA[pet.type];
                    const equippedWeaponId = gameState.weapons.equipped[pet.id];
                    const unequippedWeapons = gameState.weapons.owned.filter(wId => !Object.values(gameState.weapons.equipped).includes(wId));
                    if (equippedWeaponId) {
                        unequippedWeapons.push(equippedWeaponId);
                    }

                    const options = unequippedWeapons.map(wId => {
                        const weaponData = WEAPON_DATA[wId];
                        return `<option value="${wId}" ${wId === equippedWeaponId ? 'selected' : ''}>${weaponData.name}</option>`;
                    }).join('');

                    return `<div class="bg-black/40 p-3 rounded-lg flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-3xl">${petData.img}</span>
                                    <span>${petData.name}</span>
                                </div>
                                <select onchange="window.gameAPI.equipWeapon(${pet.id}, this.value)" class="weapon-select p-2 rounded-md">
                                    <option value="none">Ìï¥Ï†ú</option>
                                    ${options}
                                </select>
                            </div>`;
                }).join('');

                return {
                    title: "Î≥¥Ïä§ Î†àÏù¥Îìú",
                    content: `
                    <div class="flex border-b-2 border-red-500 mb-4">
                        <button class="tab-button active flex-1 p-3 text-lg" onclick="window.gameAPI.switchTab(event, 'bossSelectTab')">Î≥¥Ïä§ ÏÑ†ÌÉù</button>
                        <button class="tab-button flex-1 p-3 text-lg" onclick="window.gameAPI.switchTab(event, 'weaponShopTab')">Î¨¥Í∏∞ ÏÉÅÏ†ê</button>
                        <button class="tab-button flex-1 p-3 text-lg" onclick="window.gameAPI.switchTab(event, 'weaponEquipTab')">Î¨¥Í∏∞ Ïû•Ï∞©</button>
                    </div>
                    <div id="bossSelectTab" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${bossListHtml}</div>
                        <div class="border-t-2 border-purple-400 pt-4 mt-4">
                            <h3 class="text-xl text-center mb-2">Î≥¥Ïä§Ï†Ñ ÌåÄ ÏÑ†ÌÉù (${gameState.boss.team.length}/5)</h3>
                            <div class="grid grid-cols-4 sm:grid-cols-8 gap-2 max-h-[25vh] overflow-y-auto p-1">${petSelectionHtml}</div>
                        </div>
                    </div>
                    <div id="weaponShopTab" class="tab-content hidden space-y-2">
                        ${weaponShopHtml || '<p>Î¨¥Í∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>'}
                    </div>
                    <div id="weaponEquipTab" class="tab-content hidden space-y-2">
                        ${weaponEquipHtml || '<p>Ìé´Ïù¥ ÏóÜÏäµÎãàÎã§.</p>'}
                    </div>`
                }
            },
            titleModal: () => ({
                title: "Ïπ≠Ìò∏",
                content: `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">${Object.keys(TITLE_DATA).map(title => {
                    const data = TITLE_DATA[title];
                    const isUnlocked = gameState.titles.unlocked.includes(title);
                    const isEquipped = gameState.titles.equipped === title;
                    return `<div class="bg-black/40 p-3 rounded-lg ${!isUnlocked ? 'grayscale' : ''}">
                        <h4 class="font-bold text-lg">${title}</h4>
                        <p class="text-sm text-gray-400">${data.desc}</p>
                        <p class="text-sm text-cyan-300">Ìö®Í≥º: ${data.bonus.type !== 'none' ? `${(data.bonus.value * 100).toFixed(0)}%` : 'ÏóÜÏùå'}</p>
                        ${isUnlocked ? `<button onclick="window.gameAPI.equipTitle('${title}')" class="btn w-full mt-2 p-2 ${isEquipped ? 'bg-orange-500 border-orange-300' : 'bg-gray-600 border-gray-400'}" ${isEquipped ? 'disabled' : ''}>${isEquipped ? 'Ïû•Ï∞© Ï§ë' : 'Ïû•Ï∞©'}</button>` : '<p class="text-center mt-2 text-red-500">Ïû†ÍπÄ</p>'}
                    </div>`
                }).join('')}</div>`
            }),
            settingsModal: () => ({
                title: "ÏÑ§Ï†ï",
                content: `<div class="space-y-4">
                    <div class="bg-black/30 p-4 rounded-lg">
                        <h3 class="font-bold text-center text-lg mb-2">Ïø†Ìè∞ ÏûÖÎ†•</h3>
                        <div class="flex gap-2">
                            <input type="password" id="couponInput" class="flex-grow bg-gray-900 text-white p-3 rounded-lg border border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-300" placeholder="Ïø†Ìè∞ ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                            <button onclick="window.gameAPI.useCoupon()" class="btn bg-green-600 border-green-400 p-3 rounded-lg">ÏÇ¨Ïö©</button>
                        </div>
                    </div>
                    <button onclick="window.gameAPI.toggleNumberFormat()" class="btn w-full bg-purple-600 border-purple-400 p-3 rounded-lg">Ïà´Ïûê ÌëúÏãú Î∞©Ïãù Î≥ÄÍ≤Ω: ${gameState.settings.numberFormat === 'full' ? 'Ï†ÑÏ≤¥' : 'Îã®ÏúÑ'}</button>
                    <button onclick="window.gameAPI.saveGame(true)" class="btn w-full bg-cyan-600 border-cyan-400 p-3 rounded-lg">ÏàòÎèô Ï†ÄÏû•</button>
                    <button onclick="window.gameAPI.resetGame()" class="btn w-full bg-red-800 border-red-500 p-3 rounded-lg">Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî</button>
                </div>`
            }),
            confirmationModal: ({ message, onConfirm }) => ({
                title: "ÌôïÏù∏",
                content: `<div class="text-center">
                    <p class="text-lg mb-6">${message}</p>
                    <div class="flex justify-center gap-4">
                        <button id="confirmBtn" class="btn bg-green-600 border-green-400 px-8 py-2">Ïòà</button>
                        <button onclick="window.gameAPI.closeModal()" class="btn bg-red-600 border-red-400 px-8 py-2">ÏïÑÎãàÏò§</button>
                    </div>
                </div>`
            }),
            statsModal: () => ({
                title: "ÏÉÅÏÑ∏ Ïä§ÌÉØ",
                content: `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-black/40 p-3 rounded-lg">
                            <h3 class="font-bold text-lg">Í∏∞Î≥∏ Ï†ïÎ≥¥</h3>
                            <p>Ï¥ù ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ: ${new Date(gameState.stats.playTime * 1000).toISOString().substr(11, 8)}</p>
                            <p>Ï¥ù ÌÅ¥Î¶≠ ÌöüÏàò: ${gameState.stats.totalClicks.toLocaleString()}</p>
                            <p>Ï¥ù ÌöçÎìù Ïû¨Ìôî: ${formatNumber(gameState.stats.totalMoney)}</p>
                        </div>
                        <div class="bg-black/40 p-3 rounded-lg">
                            <h3 class="font-bold text-lg">Í∏∞Î°ù</h3>
                            <p>ÏµúÎåÄ Î≥¥Ïú† Ïû¨Ìôî: ${formatNumber(gameState.stats.maxMoney)}</p>
                            <p>ÌôòÏÉù ÌöüÏàò: ${gameState.stats.rebirths.toLocaleString()}</p>
                            <p>ÎΩëÍ∏∞ ÌöüÏàò: ${gameState.stats.gachaCount.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="mt-4 bg-black/40 p-3 rounded-lg">
                        <h3 class="font-bold text-lg text-center mb-2">ÏµúÍ∑º 1Î∂Ñ Ïû¨Ìôî Î≥ÄÎèô</h3>
                        <canvas id="statsChartCanvas"></canvas>
                    </div>
                `
            }),
            storyBookModal: () => {
                const storyHtml = Object.keys(STORY_BOOK_DATA).map(id => {
                    const story = STORY_BOOK_DATA[id];
                    const isUnlocked = !!gameState.storyBooks[id];
                    return `<div class="bg-black/40 p-4 rounded-lg">
                        <h3 class="text-xl font-bold ${isUnlocked ? 'text-cyan-300' : ''}">${story.name}</h3>
                        ${isUnlocked ? `<p class="mt-2 text-gray-300">${story.content}</p>` : `<button onclick="window.gameAPI.unlockStory('${id}')" class="btn bg-blue-600 border-blue-400 w-full mt-2" ${gameState.money < story.cost ? 'disabled' : ''}>Ïû†Í∏à Ìï¥Ï†ú (${formatNumber(story.cost)})</button>`}
                    </div>`;
                }).join('');
                return {
                    title: "Ïä§ÌÜ†Î¶¨Î∂Å",
                    content: `<div class="space-y-4">${storyHtml}</div>`
                };
            },
            craftingModal: () => {
                const craftHtml = Object.keys(CRAFTING_DATA).map(id => {
                    const craft = CRAFTING_DATA[id];
                    const canCraft = Object.keys(craft.materials).every(mat => (gameState.inventory.materials[mat] || 0) >= craft.materials[mat]);
                    return `<div class="bg-black/40 p-3 rounded-lg flex items-center justify-between">
                        <div>
                            <h4 class="font-bold text-lg">${craft.name}</h4>
                            <p class="text-sm text-gray-300">Ïû¨Î£å: ${Object.entries(craft.materials).map(([mat, amt]) => `${mat} ${amt}`).join(', ')}</p>
                        </div>
                        <button onclick="window.gameAPI.doCraft('${id}')" class="btn bg-amber-600 border-amber-400 p-2" ${!canCraft ? 'disabled': ''}>Ï†úÏûë</button>
                    </div>`;
                }).join('');
                const inventoryHtml = Object.entries(gameState.inventory.materials).map(([mat, amt]) => `<p>${mat}: ${amt}</p>`).join('');
                return {
                    title: "Ï†úÏûë",
                    content: `
                        <div class="mb-4 bg-black/30 p-3 rounded-lg">
                            <h3 class="font-bold text-center">Î≥¥Ïú† Ïû¨Î£å</h3>
                            <div class="text-center">${inventoryHtml || 'ÏóÜÏùå'}</div>
                        </div>
                        <div class="space-y-3">${craftHtml}</div>
                    `
                }
            },
            dungeonModal: () => ({title:"ÎçòÏ†Ñ", content:"<p>ÎçòÏ†Ñ Í∏∞Îä•ÏùÄ Í≥ß ÏóÖÎç∞Ïù¥Ìä∏ Îê©ÎãàÎã§!</p>"}),
            worldBossModal: () => ({title:"ÏõîÎìúÎ≥¥Ïä§", content:"<p>ÏõîÎìúÎ≥¥Ïä§ Í∏∞Îä•ÏùÄ Í≥ß ÏóÖÎç∞Ïù¥Ìä∏ Îê©ÎãàÎã§!</p>"}),
        };
        
        // --- Utilities & Helper Functions ---
        function showConfirmationModal(message, onConfirm) {
            showModal('confirmationModal', { message, onConfirm });
            setTimeout(() => {
                const confirmBtn = document.getElementById('confirmBtn');
                if(confirmBtn) {
                    confirmBtn.onclick = () => {
                        onConfirm();
                        closeModal();
                    };
                }
            }, 0);
        }
        function switchTab(event, targetTabId){event.currentTarget.parentElement.querySelectorAll(".tab-button").forEach(el=>el.classList.remove("active"));event.currentTarget.classList.add("active");DOMElements.modalContent.querySelectorAll(".tab-content").forEach(el=>el.classList.add("hidden"));document.getElementById(targetTabId).classList.remove("hidden")}
        function buyPet(type){const petData=PET_DATA[type];if(gameState.money>=petData.cost){changeMoney(-petData.cost);addPet(type);showToast(`${petData.name} Íµ¨Îß§ ÏôÑÎ£å!`,"success");showModal("shopModal")}else{showToast("ÎèàÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.","error")}}
        function doGacha(type) {
            let cost = 0, goldCost = 0, stardustCost = 0;
            if (type === 'normal') cost = 50000;
            else if (type === 'premium') goldCost = 10;
            else if (type === 'stardust') stardustCost = 100;
            if(gameState.money < cost || gameState.goldenAcorns < goldCost || gameState.stardust < stardustCost) { showToast('ÎπÑÏö©Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§.', 'error'); return; }
            changeMoney(-cost); changeGoldenAcorns(-goldCost); changeStardust(-stardustCost);
            gameState.stats.gachaCount++;
            updateMissionProgress('gacha', 1);
            const gachaBox = document.getElementById('gachaResultContainer');
            gachaBox.innerHTML = `<div class="text-8xl animate-spin">üåÄ</div>`;
            setTimeout(() => {
                const rates = GACHA_RATES[type];
                const totalWeight = rates.reduce((sum, pet) => sum + pet.weight, 0);
                let random = Math.random() * totalWeight;
                let resultPetType = rates[rates.length - 1].type;
                for (const pet of rates) { if (random < pet.weight) { resultPetType = pet.type; break; } random -= pet.weight; }
                addPet(resultPetType, 'gacha');
                const petData = PET_DATA[resultPetType];
                gachaBox.innerHTML = `<div class="text-center" style="animation: fadeIn 0.5s">
                    <div class="text-7xl">${petData.img}</div>
                    <div class="text-2xl font-bold mt-2 ${RARITY_COLORS[petData.rarity]}">${petData.name}</div>
                    <div class="text-lg px-3 py-1 rounded-full mt-1">${petData.rarity}</div></div>`;
            }, 1500);
        }
        function formatNumber(num){if(!isFinite(num))return"0";if(num < 10000) return Math.floor(num).toLocaleString("en-US"); if(gameState.settings.numberFormat==="korean"&&num>=1e4){const units=["","Îßå","Ïñµ","Ï°∞","Í≤Ω","Ìï¥"];const order=Math.floor(Math.log10(num)/4);if(order>=units.length)return num.toExponential(2);const value=num/Math.pow(10,order*4);return`${value.toFixed(2)}${units[order]}`}return num.toExponential(2);}
        function toggleNumberFormat(){gameState.settings.numberFormat=gameState.settings.numberFormat==="full"?"korean":"full";renderMoney(gameState.money, true);if(currentModal === 'settingsModal')showModal("settingsModal")}
        function findPetById(id){return gameState.pets.find(p=>p.id===id)}
        function showToast(message,type="default"){DOMElements.toastText.textContent=message;let colors={'default':'bg-gray-800/80 border-gray-500','success':'bg-green-600/80 border-green-400','error':'bg-red-600/80 border-red-400','info':'bg-cyan-500/80 border-cyan-300'};DOMElements.toast.className=`fixed bottom-10 left-1/2 px-6 py-3 rounded-lg shadow-xl text-lg ${colors[type]}`;gsap.fromTo(DOMElements.toast,{y:100,opacity:0,x:'-50%'},{y:0,opacity:1,duration:0.5,ease:'power4.out'});gsap.fromTo(DOMElements.toastProgress,{width:'100%'},{width:'0%',duration:3.5,ease:'linear',onComplete:()=>{gsap.to(DOMElements.toast,{opacity:0,y:100,duration:0.5,ease:'power4.in'})}})}
        function handleOfflineProgress(){const timeOffline=Date.now()-(gameState.lastSaveTime||Date.now());const maxOfflineTime=8*60*60*1e3;let effectiveTime=Math.min(timeOffline,maxOfflineTime);let offlineBonus = (gameState.skills.levels['a002'] ? SKILL_DATA['a002'].effect(gameState.skills.levels['a002']) : 0);if(gameState.artifacts.timeCrystal)effectiveTime*=1+ARTIFACT_DATA.timeCrystal.effect(gameState.artifacts.timeCrystal.level)+offlineBonus;if(effectiveTime>6e4){const passiveIncomeRate=calculateCPS().auto*.2;const earned=Math.floor(passiveIncomeRate*effectiveTime/1e3);if(earned>0){showToast(`${(timeOffline/36e5).toFixed(1)}ÏãúÍ∞ÑÏùò Ïò§ÌîÑÎùºÏù∏ Î≥¥ÏÉÅÏúºÎ°ú ${formatNumber(earned)}ÏùÑ ÌöçÎìùÌñàÏäµÎãàÎã§!`,"info");changeMoney(earned)}}}
        
        function useCoupon() {
            const input = document.getElementById('couponInput');
            if (!input) return;
            const code = input.value.toUpperCase(); // Case-insensitive
            
            const coupon = COUPONS[code];

            if (!coupon) {
                showToast('ÏûòÎ™ªÎêú Ïø†Ìè∞ ÏΩîÎìúÏûÖÎãàÎã§.', 'error');
                return;
            }

            if (gameState.couponsUsed.includes(code)) {
                showToast('Ïù¥ÎØ∏ ÏÇ¨Ïö©Ìïú Ïø†Ìè∞ÏûÖÎãàÎã§.', 'error');
                return;
            }

            // Grant rewards
            if (coupon.reward.money) changeMoney(coupon.reward.money);
            if (coupon.reward.goldenAcorns) changeGoldenAcorns(coupon.reward.goldenAcorns);
            if (coupon.reward.stardust) changeStardust(coupon.reward.stardust);
            
            gameState.couponsUsed.push(code);
            showToast(coupon.message, 'success');
            input.value = ''; // Clear input
        }

        // --- SAVE/LOAD ---
        function saveGame(isManual = false) {    
            gameState.lastSaveTime = Date.now();
            localStorage.setItem('dotoriGameSave_FinalChapter', JSON.stringify(gameState));    
            if(isManual) showToast('Í≤åÏûÑÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.', 'success');
        }
        function loadGame() {
            const savedGame = localStorage.getItem('dotoriGameSave_FinalChapter');
            if (savedGame) {
                const loadedState = JSON.parse(savedGame);
                gameState = deepMerge(JSON.parse(JSON.stringify(initialGameState)), loadedState);
                nextPetId = gameState.pets.length > 0 ? Math.max(0, ...gameState.pets.map(p => p.id || 0)) + 1 : 0;
            } else {
                gameState = JSON.parse(JSON.stringify(initialGameState));
            }
        }
        function resetGame(){showConfirmationModal('Ï†ïÎßêÎ°ú Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?<br>Î™®Îì† ÏßÑÌñâ ÏÉÅÌô©Ïù¥ ÏÇ¨ÎùºÏßëÎãàÎã§.', () => { localStorage.removeItem("dotoriGameSave_FinalChapter"); window.location.reload(); })}
        
        function deepMerge(target, source) {
            for (const key in source) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    if (!target[key] || typeof target[key] !== 'object') target[key] = {};
                    deepMerge(target[key], source[key]);
                } else {
                    target[key] = source[key];
                }
            }
            return target;
        }
        
        // --- Mission, Title, Rebirth, etc. Logic (Merged from original) ---
        const MISSION_TIERS = [ { req: () => true, pool: [{id:'click', t:500}, {id:'earnMoney', t:1e4}, {id:'buyPet', t:1}] }, { req: gs => gs.stats.maxMoney > 1e5, pool: [{id:'gacha', t:5}, {id:'enhance', t:1}, {id:'earnMoney', t:1e6}] }, { req: gs => gs.stats.rebirths > 0, pool: [{id:'exploration', t:1}, {id:'collectPet', t:10}, {id:'rebirth', t:1}] } ];
        const MISSION_TEXT = { click: t => `ÌÅ¥Î¶≠ ${t}Î≤à ÌïòÍ∏∞`, earnMoney: t => `Ïû¨Ìôî ${formatNumber(t)} ÌöçÎìùÌïòÍ∏∞`, buyPet: t => `Ìé´ ${t}ÎßàÎ¶¨ Íµ¨Îß§ÌïòÍ∏∞`, gacha: t => `Ìé´ ÎΩëÍ∏∞ ${t}Î≤à ÌïòÍ∏∞`, enhance: t => `Ìé´ Í∞ïÌôî ${t}Î≤à ÏãúÎèÑÌïòÍ∏∞`, exploration: t => `ÌÉêÌóò ${t}Î≤à ÏôÑÎ£åÌïòÍ∏∞`, collectPet: t => `Ìé´ ${t}Ï¢ÖÎ•ò ÏàòÏßëÌïòÍ∏∞`, rebirth: t => `ÌôòÏÉù ${t}Î≤à ÌïòÍ∏∞`, };
        function generateMissions() {if(gameState.missions.filter(m=>!m.claimed).length>=3)return;const currentTier=MISSION_TIERS.slice().reverse().find(t=>t.req(gameState));if(!currentTier)return;while(gameState.missions.length<3){const missionTemplate=currentTier.pool[Math.floor(Math.random()*currentTier.pool.length)];if(gameState.missions.some(m=>m.id===missionTemplate.id&&!m.claimed))continue;gameState.missions.push({id:missionTemplate.id,target:missionTemplate.t,progress:0,claimed:false,reward:{goldenAcorns:5+(gameState.stats.rebirths*2)}})}}
        function updateMissionProgress(missionId, value) {let missionCompleted=!1;gameState.missions.forEach(mission=>{if(mission.id===missionId&&!mission.claimed){mission.progress+=value;if(mission.progress>=mission.target)missionCompleted=!0}});if(missionCompleted&&currentModal==='missionModal')showModal('missionModal')}
        function claimMissionReward(index) {const mission=gameState.missions[index];if(mission&&mission.progress>=mission.target&&!mission.claimed){mission.claimed=!0;if(mission.reward.goldenAcorns)changeGoldenAcorns(mission.reward.goldenAcorns);showToast('ÎØ∏ÏÖò Î≥¥ÏÉÅ ÌöçÎìù!','success');gameState.missions.splice(index,1);generateMissions();showModal('missionModal')}}
        function renderMission(mission, index) {const progress=Math.min(mission.progress,mission.target);const percent=progress/mission.target*100;const canClaim=progress>=mission.target&&!mission.claimed;return`<div class="bg-black/40 p-3 rounded-lg"><p>${MISSION_TEXT[mission.id](mission.target)}</p><div class="flex items-center gap-4 mt-2"><div class="flex-grow progress-bar h-4"><div class="progress-bar-inner exp-bar" style="width: ${percent}%"></div></div><button onclick="window.gameAPI.claimMissionReward(${index})" class="btn text-sm px-4 py-1 rounded" ${!canClaim?"disabled":""}>Î≥¥ÏÉÅ (+${mission.reward.goldenAcorns} <i class="fa-solid fa-cookie-bite"></i>)</button></div></div>`}
        function checkTitleUnlocks() {Object.keys(TITLE_DATA).forEach(title=>{if(!gameState.titles.unlocked.includes(title)&&TITLE_DATA[title].unlock(gameState)){gameState.titles.unlocked.push(title);showToast(`Ïπ≠Ìò∏ ÌöçÎìù: [${title}]`,'info')}})}
        function equipTitle(title) {if(gameState.titles.unlocked.includes(title)){gameState.titles.equipped=title;showModal('titleModal')}}
        function doRebirth() {const rebirthReq=1e9;if(gameState.money<rebirthReq)return;showConfirmationModal('Ï†ïÎßêÎ°ú ÌôòÏÉùÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ìé´, Ïû¨Ìôî, Í∞ïÌôîÍ∞Ä Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.',()=>{const stardustGain=Math.floor(Math.log10(gameState.money)-7);if(stardustGain>0)changeStardust(stardustGain);const preserved={goldenAcorns:gameState.goldenAcorns,stardust:gameState.stardust,collection:gameState.collection,artifacts:gameState.artifacts,titles:gameState.titles,couponsUsed:gameState.couponsUsed,stats:{...gameState.stats,rebirths:gameState.stats.rebirths+1,totalMoney:0,maxMoney:0},settings:gameState.settings,storyBooks:gameState.storyBooks,skills:gameState.skills,boss:{...gameState.boss,team:[],activeBoss:null}};gameState={...JSON.parse(JSON.stringify(initialGameState)),...preserved};addPet('acorn','rebirth');generateMissions();showToast(`ÌôòÏÉù ÏôÑÎ£å! Ïä§ÌÉÄÎçîÏä§Ìä∏ ${stardustGain}Í∞ú ÌöçÎìù!`,'success');renderAll();closeModal()})}
        function buyArtifact(id) {const artifactData=ARTIFACT_DATA[id];if(!gameState.artifacts[id])gameState.artifacts[id]={level:0};const currentLevel=gameState.artifacts[id].level;if(currentLevel>=artifactData.maxLevel)return;const cost=artifactData.cost(currentLevel);if(gameState.stardust>=cost){changeStardust(-cost);gameState.artifacts[id].level++;showModal('rebirthModal')}}
        function selectForEnhance(id){const pet=findPetById(id);if(pet&&pet.locked)return;if(selectionState.enhance.includes(id))selectionState.enhance=selectionState.enhance.filter(p=>p!==id);else selectionState.enhance.push(id);showModal("enhanceModal")}
        function doEnhance(){if(selectionState.enhance.length!==2){showToast("Í∞ïÌôîÌï† Ìé´ 1, Ïû¨Î£å Ìé´ 1, Ï¥ù 2ÎßàÎ¶¨ ÏÑ†ÌÉù.","error");return}const p1=findPetById(selectionState.enhance[0]),p2=findPetById(selectionState.enhance[1]);if(!p1||!p2){selectionState.enhance=[];showModal("enhanceModal");return}const[base,mat]=p1.enhancement>=p2.enhancement?[p1,p2]:[p2,p1];if(base.type!==mat.type||base.enhancement!==mat.enhancement||base.evolution!==mat.evolution){showToast("ÎèôÏùº Ï¢ÖÎ•ò, Í∞ïÌôî, ÏßÑÌôî Ìé´Îßå Ïû¨Î£å Í∞ÄÎä•.","error");return}if(base.enhancement>=15){showToast("ÏµúÎåÄ Í∞ïÌôî.","error");return}const rate=Math.min(100,100-base.enhancement*6);if(Math.random()*100<rate){base.enhancement++;showToast("Í∞ïÌôî ÏÑ±Í≥µ!","success")}else{showToast("Í∞ïÌôî Ïã§Ìå®...","error")}removePetById(mat.id);selectionState.enhance=[];updateMissionProgress("enhance",1);showModal("enhanceModal")}
        function selectForEvolve(id){const pet=findPetById(id);if(pet&&pet.locked)return;if(selectionState.evolve.includes(id))selectionState.evolve=selectionState.evolve.filter(p=>p!==id);else selectionState.evolve.push(id);showModal("evolveModal")}
        function doEvolve(){if(selectionState.evolve.length!==3){showToast("ÏßÑÌôîÌï† Ìé´ 1, Ïû¨Î£å Ìé´ 2, Ï¥ù 3ÎßàÎ¶¨ ÏÑ†ÌÉù.","error");return}const pets=selectionState.evolve.map(id=>findPetById(id));if(pets.some(p=>!p)){selectionState.evolve=[];showModal("evolveModal");return}const base=pets[0];if(pets.some(p=>p.type!==base.type)){showToast("Î™®Îëê ÎèôÏùº Ï¢ÖÎ•ò Ìé´Ïù¥Ïñ¥Ïïº Ìï®.","error");return}if(base.evolution>=5){showToast("ÏµúÎåÄ ÏßÑÌôî.","error");return}const rate=Math.max(10,80-base.evolution*15);if(Math.random()*100<rate){base.evolution++;base.enhancement=0;showToast("ÏßÑÌôî ÏÑ±Í≥µ!","success")}else{showToast("ÏßÑÌôî Ïã§Ìå®...","error")}removePetById(pets[1].id);removePetById(pets[2].id);selectionState.evolve=[];showModal("petModal")}
        function toggleEquip(petId){const i=gameState.equippedPetIds.indexOf(petId);if(i>-1)gameState.equippedPetIds.splice(i,1);else if(gameState.equippedPetIds.length<gameState.petLimit)gameState.equippedPetIds.push(petId);else showToast('Ìé´ Ïû•Ï∞© Ïä¨Î°Ø Ï¥àÍ≥º.','error');renderEquippedPets();if(currentModal==='petModal')showModal('petModal')}
        function toggleLock(petId){const p=findPetById(petId);if(p){p.locked=!p.locked;showToast(p.locked?'Ïû†Í∏à ÏÑ§Ï†ï.':'Ïû†Í∏à Ìï¥Ï†ú.','info');if(currentModal==='petModal')showModal('petModal')}}
        function toggleExplorationTeam(petId){const i=window.explorationTeam.indexOf(petId);if(i>-1)window.explorationTeam.splice(i,1);else window.explorationTeam.push(petId);showModal('explorationModal')}
        function startExplorationWrapper(slotIndex, areaId){startExploration(slotIndex, areaId, [...window.explorationTeam]);window.explorationTeam=[]}
        function buySkill(id){const s=SKILL_DATA[id];const l=gameState.skills.levels[id]||0;if(gameState.skills.points>=s.sp&&l<s.maxLevel){gameState.skills.points-=s.sp;gameState.skills.levels[id]=l+1;if(s.type==='active'&&!(gameState.skills.unlocked||[]).includes(id)){if(!gameState.skills.unlocked)gameState.skills.unlocked=[];gameState.skills.unlocked.push(id)}renderSkillBar();showModal('skillModal')}}
        function activateSkill(id){const s=SKILL_DATA[id];if((gameState.skills.cooldowns[id]||0)>0)return;gameState.skills.cooldowns[id]=s.cooldown;const l=gameState.skills.levels[id]||1;if(id==='s001'){if(!gameState.skills.active)gameState.skills.active={};gameState.skills.active[id]=Date.now()+1e4}else if(id==='s002'){const income=calculateCPS().auto*60*(10+l);changeMoney(income,'skill');showToast(`${formatNumber(income)} Ïû¨Ìôî ÌöçÎìù`,'info')}else if(id==='s003'){changeGoldenAcorns(l);showToast(`Ìô©Í∏à ÎèÑÌÜ†Î¶¨ ${l}Í∞ú ÌöçÎìù`,'info')}renderSkillBar()}
        
        // --- Boss Fight Logic ---
        function buyWeapon(weaponId) {
            const weapon = WEAPON_DATA[weaponId];
            if (!weapon || gameState.weapons.owned.includes(weaponId) || gameState.money < weapon.cost) return;
            changeMoney(-weapon.cost);
            gameState.weapons.owned.push(weaponId);
            showToast(`${weapon.name} Íµ¨Îß§ ÏôÑÎ£å!`, 'success');
            if (currentModal === 'bossModal') showModal('bossModal');
        }

        function equipWeapon(petId, weaponId) {
            if (weaponId === 'none') {
                delete gameState.weapons.equipped[petId];
            } else {
                 // Unequip from any other pet that has it
                for (const pId in gameState.weapons.equipped) {
                    if (gameState.weapons.equipped[pId] === weaponId) {
                        delete gameState.weapons.equipped[pId];
                    }
                }
                gameState.weapons.equipped[petId] = weaponId;
            }
            if (currentModal === 'bossModal') showModal('bossModal');
        }

        function toggleBossTeam(petId){const i=gameState.boss.team.indexOf(petId);if(i>-1)gameState.boss.team.splice(i,1);else if(gameState.boss.team.length<5)gameState.boss.team.push(petId);showModal('bossModal')}
        
        function startBossFight(id){
            if(gameState.boss.team.length===0){
                showToast('Î≥¥Ïä§Ï†ÑÏóê Ï∞∏Ïó¨Ìï† Ìé´ÏùÑ 1ÎßàÎ¶¨ Ïù¥ÏÉÅ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.','error');
                return;
            }
            gameState.boss.activeBoss=id;
            const bossData = BOSS_DATA[id];
            gameState.boss.bossHp = bossData.hp;
            gameState.boss.petHps={};
            gameState.boss.team.forEach(pId=>{
                const p = findPetById(pId);
                if(p) {
                    const petData = PET_DATA[p.type];
                    const maxHp = (petData.cost / 10) * (1 + p.evolution * 0.5) || 100;
                    gameState.boss.petHps[pId] = maxHp;
                }
            });
            gameState.boss.isAttacking = false;
            gameState.boss.attackTargetId = null;
            gameState.boss.nextAttackTime = Date.now() + (bossData.attackSpeed * 1000);
            
            renderEquippedPets();
            closeModal();
        }

        function updateBossFight() {
            if (!gameState.boss.activeBoss) return;
            
            // Auto damage
            const autoDps = calculateCPS().auto * 0.2;
            if(autoDps > 0) {
                 gameState.boss.bossHp = Math.max(0, gameState.boss.bossHp - autoDps);
                 if(Math.random() < 0.1) { // Show floating text occasionally to reduce clutter
                    const bossArea = document.getElementById('boss-area');
                    if (bossArea) {
                        const damageText = document.createElement('div');
                        damageText.className = 'floating-text text-sm text-yellow-400';
                        damageText.textContent = `-${formatNumber(autoDps)}`;
                        damageText.style.left = `${Math.random() * 50 + 25}%`;
                        damageText.style.top = `${Math.random() * 40 + 20}%`;
                        bossArea.appendChild(damageText);
                        setTimeout(() => damageText.remove(), 1200);
                    }
                 }
                 renderBossFightScreen(); // Update HP bar
            }


            if (!gameState.boss.isAttacking && Date.now() >= gameState.boss.nextAttackTime) {
                bossAttackWindUp();
            }
        }

        function bossAttackWindUp() {
            if (!gameState.boss.activeBoss) return;
            const alivePets = gameState.boss.team.filter(pId => gameState.boss.petHps[pId] > 0);
            if (alivePets.length === 0) return;

            const targetId = alivePets[Math.floor(Math.random() * alivePets.length)];
            gameState.boss.isAttacking = true;
            gameState.boss.attackTargetId = targetId;
            
            const bossSprite = document.getElementById('boss-sprite');
            if (bossSprite) {
                const animType = BOSS_DATA[gameState.boss.activeBoss].animation;
                if(animType === 'shake') gsap.fromTo(bossSprite, {x:0}, {x:10, duration: 0.1, repeat: 5, yoyo: true});
                else if(animType === 'pulse') gsap.to(bossSprite, { scale: 1.2, duration: 0.2, yoyo: true, repeat: 2 });
                else if(animType === 'lunge') gsap.to(bossSprite, { y: -30, scale: 1.1, duration: 0.2, yoyo: true, repeat: 1 });
            }

            renderBossFightScreen();
            setTimeout(bossAttackExecute, 1500); // Dodge window
        }

        function bossAttackExecute() {
            if (!gameState.boss.activeBoss || !gameState.boss.isAttacking) return;

            const targetId = gameState.boss.attackTargetId;
            const bossData = BOSS_DATA[gameState.boss.activeBoss];

            if (targetId !== null) { // Attack was not dodged
                const pet = findPetById(targetId);
                gameState.boss.petHps[targetId] = Math.max(0, gameState.boss.petHps[targetId] - bossData.attack);
                if(pet) showToast(`${PET_DATA[pet.type].name}Ïù¥(Í∞Ä) ${formatNumber(bossData.attack)} ÌîºÌï¥Î•º ÏûÖÏóàÎã§!`, 'error');
                
                const alivePets = gameState.boss.team.filter(pId => gameState.boss.petHps[pId] > 0);
                if (alivePets.length === 0) {
                    showToast('Î™®Îì† Ìé´Ïù¥ Ïì∞Îü¨Ï†∏ Ìå®Î∞∞ÌñàÏäµÎãàÎã§.', 'error');
                    gameState.boss.activeBoss = null;
                    renderEquippedPets();
                    return;
                }
            }
            
            gameState.boss.isAttacking = false;
            gameState.boss.attackTargetId = null;
            gameState.boss.nextAttackTime = Date.now() + (bossData.attackSpeed * 1000);
            renderBossFightScreen();
        }

        function handlePetAttackOnBoss(petId) {
            if (!gameState.boss.activeBoss) return;
            const pet = findPetById(petId);
            if (!pet || gameState.boss.petHps[petId] <= 0) return;
            
            // Dodge attempt
            if (gameState.boss.isAttacking && gameState.boss.attackTargetId === petId) {
                const bossData = BOSS_DATA[gameState.boss.activeBoss];
                const petData = PET_DATA[pet.type];
                const grazeDamage = bossData.attack * 0.25; // Take 25% damage on successful dodge
                gameState.boss.petHps[petId] = Math.max(0, gameState.boss.petHps[petId] - grazeDamage);
                showToast(`${petData.name}Ïù¥(Í∞Ä) Í≥µÍ≤©ÏùÑ ÌöåÌîºÌñàÏßÄÎßå, ${formatNumber(grazeDamage)}Ïùò ÌîºÌï¥Î•º ÏûÖÏóàÎã§!`, 'info');
                gameState.boss.attackTargetId = null; // Mark as dodged
                renderBossFightScreen();
                return;
            }
            
            // Normal attack
            let damage = calculateCPS().click;
            const equippedWeaponId = gameState.weapons.equipped[pet.id];
            if (equippedWeaponId && WEAPON_DATA[equippedWeaponId]) {
                damage *= (1 + WEAPON_DATA[equippedWeaponId].bonus);
            }
            damage = Math.floor(damage);

            gameState.boss.bossHp = Math.max(0, gameState.boss.bossHp - damage);
            SoundManager.play('bossHit');

            const bossArea = document.getElementById('boss-area');
            if (bossArea) {
                const damageText = document.createElement('div');
                damageText.className = 'floating-text text-2xl text-red-500';
                damageText.textContent = `-${formatNumber(damage)}`;
                damageText.style.left = `${Math.random() * 50 + 25}%`;
                damageText.style.top = `${Math.random() * 40 + 20}%`;
                bossArea.appendChild(damageText);
                setTimeout(() => damageText.remove(), 1200);
            }
            
            if (gameState.settings.animations) {
                DOMElements.gameContainer.classList.add('screen-shake');
                setTimeout(() => DOMElements.gameContainer.classList.remove('screen-shake'), 300);
            }

            if (gameState.boss.bossHp <= 0) {
                const bossData = BOSS_DATA[gameState.boss.activeBoss];
                if (bossData.reward.money) changeMoney(bossData.reward.money);
                if (bossData.reward.stardust) changeStardust(bossData.reward.stardust);
                showToast(`${bossData.name} Ï≤òÏπò ÏôÑÎ£å!`, 'success');
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                gameState.boss.cleared.push(gameState.boss.activeBoss);
                checkTitleUnlocks();
                gameState.boss.activeBoss = null;
                renderEquippedPets();
            } else {
                renderBossFightScreen();
            }
        }
        
        // --- Expose functions to global scope for HTML onclick ---
        window.gameAPI = {
            closeModal, showModal, toggleNumberFormat, saveGame, resetGame,
            switchTab, buyPet, doGacha, toggleEquip, toggleLock,
            selectForEnhance, doEnhance, selectForEvolve, doEvolve,
            claimMissionReward, equipTitle, doRebirth, buyArtifact,
            claimExploration, startExplorationWrapper, toggleExplorationTeam,
            buySkill, activateSkill, toggleBossTeam, startBossFight, handlePetAttackOnBoss,
            doCraft, unlockStory, useCoupon, buyWeapon, equipWeapon
        };

        window.onload = init;
    })();
    </script>
</body>
  </html>
