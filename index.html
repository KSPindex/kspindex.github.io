<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로또 시뮬레이터: V3 파이널 빌드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #111827;
            --bg-surface: #1f2937;
            --bg-deep: #0c111c;
            --text-main: #f3f4f6;
            --text-dim: #9ca3af;
            --primary: #4f46e5;
            --accent: #f59e0b;
        }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-main); color: var(--text-main); }
        .surface { background-color: var(--bg-surface); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.15); }
        .btn:active:not(:disabled) { transform: translateY(0); filter: brightness(1); }

        .number-ball {
            width: 44px; height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: inset 0 -3px 4px rgba(0,0,0,0.3), 0 4px 6px rgba(0,0,0,0.2);
        }
        .number-ball.sm { width: 36px; height: 36px; font-size: 0.9rem; }
        .number-ball.selected {
            background-color: var(--primary);
            color: white;
            transform: scale(1.1) translateY(-3px);
            box-shadow: 0 0 20px color-mix(in srgb, var(--primary) 70%, transparent);
        }
        
        .result-ball-container {
            perspective: 1000px;
        }
        .result-ball {
            transform-style: preserve-3d;
            animation: flip-in 0.8s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }
        @keyframes flip-in {
            0% { transform: rotateY(-180deg) scale(0.5); opacity: 0; }
            100% { transform: rotateY(0deg) scale(1); opacity: 1; }
        }
        
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
            transform: translateY(-30px);
            opacity: 0;
        }
        .modal-backdrop.open { opacity: 1; pointer-events: all; }
        .modal-backdrop.open .modal-content { transform: translateY(0); opacity: 1; }

        #exp-bar-inner { transition: width 0.5s ease-in-out; }

        .tabs button.active {
            border-color: var(--primary);
            color: var(--text-main);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400">
                로또 시뮬레이터: V3 파이널 빌드
            </h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <main class="lg:col-span-2 surface rounded-2xl shadow-2xl p-6">
                <div id="game-area">
                    <!-- Main game content will be rendered here -->
                </div>
            </main>

            <aside class="space-y-6">
                <div class="surface rounded-2xl shadow-2xl p-6">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">플레이어 정보</h2>
                    <div class="mb-4">
                        <div class="flex justify-between items-baseline mb-1">
                            <p class="font-bold">레벨 <span id="player-level">1</span></p>
                            <p class="text-sm text-gray-400">EXP: <span id="player-exp">0</span> / <span id="exp-to-next-level">10</span></p>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="exp-bar-inner" class="bg-gradient-to-r from-purple-500 to-indigo-500 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <p class="text-gray-400">보유 자금</p>
                        <p id="current-money" class="text-3xl font-bold text-amber-400">₩ 10,000</p>
                    </div>
                </div>

                <div class="surface rounded-2xl shadow-2xl p-6">
                    <div class="tabs flex border-b border-gray-700 mb-4">
                        <button data-tab="actions" class="tab-btn flex-1 py-2 border-b-2 border-transparent text-gray-400 active">활동</button>
                        <button data-tab="history" class="tab-btn flex-1 py-2 border-b-2 border-transparent text-gray-400">나의 기록</button>
                        <button data-tab="stats" class="tab-btn flex-1 py-2 border-b-2 border-transparent text-gray-400">통계</button>
                    </div>
                    <div id="tab-content" class="min-h-[200px]">
                        <!-- Tab content will be rendered here -->
                    </div>
                </div>
            </aside>
        </div>
    </div>
    
    <div id="modal-container"></div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
    
        let state = {};

        const config = {
            expPerPlay: 1,
            expToLevel: (level) => Math.floor(10 * Math.pow(1.5, level - 1)),
            prizes: { 1: 0, 2: 50000000, 3: 1500000, 4: 50000, 5: 5000 },
            jackpotContribution: 500,
            perks: [
                { level: 2, description: "코인 토스 미니게임 해금", key: 'minigameUnlocked' },
                { level: 5, description: "로또 가격 10% 할인", key: 'lottoDiscount10' },
                { level: 7, description: "클릭 수입 2배 (+20원)", key: 'nogadaBonus1' },
                { level: 10, description: "로또 가격 20% 할인", key: 'lottoDiscount20' },
                { level: 15, description: "클릭 수입 5배 (+50원)", key: 'nogadaBonus2' },
            ]
        };
    
        const DOMElements = {
            gameArea: document.getElementById('game-area'),
            playerLevel: document.getElementById('player-level'),
            playerExp: document.getElementById('player-exp'),
            expToNextLevel: document.getElementById('exp-to-next-level'),
            expBarInner: document.getElementById('exp-bar-inner'),
            currentMoney: document.getElementById('current-money'),
            tabContent: document.getElementById('tab-content'),
            modalContainer: document.getElementById('modal-container'),
        };
    
        let audioContext;
        const sounds = {};

        function init() {
            loadState();
            initAudio();
            renderSelectionPhase();
            renderTabContent('actions');
            setupTabListeners();
            updateAllUI();
        }
        
        function getDefaultState() {
            return {
                level: 1, exp: 0, money: 10000, jackpot: 2000000000,
                selectedNumbers: [], savedCombinations: [], isDrawing: false,
                history: [],
                stats: { totalSpent: 0, totalWon: 0, highestPrize: 0, plays: 0, wins: { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 } },
            };
        }

        // --- AUDIO ---
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                sounds.click = { type: 'triangle', freq: 440, dur: 0.1, gain: 0.1 };
                sounds.draw = { type: 'sine', freq: 261, dur: 0.3, gain: 0.2 };
                sounds.win = { type: 'sine', freq: 523, dur: 0.4, gain: 0.2, ramp: 1046 };
                sounds.lose = { type: 'sawtooth', freq: 150, dur: 0.5, gain: 0.1, ramp: 100 };
                sounds.levelup = { type: 'triangle', freq: 659, dur: 0.5, gain: 0.2, ramp: 1318 };
            } catch (e) { console.warn("Web Audio API is not supported."); }
        }

        function playSound(name) {
            if (!audioContext || !sounds[name]) return;
            const s = sounds[name];
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.type = s.type;
            gainNode.gain.setValueAtTime(s.gain, audioContext.currentTime);
            oscillator.frequency.setValueAtTime(s.freq, audioContext.currentTime);
            if (s.ramp) oscillator.frequency.linearRampToValueAtTime(s.ramp, audioContext.currentTime + s.dur * 0.8);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + s.dur);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + s.dur);
        }
        
        // --- STATE & CORE LOGIC ---
        function addExp(amount) {
            state.exp += amount;
            let needed = config.expToLevel(state.level);
            while (state.exp >= needed) {
                state.level++;
                state.exp -= needed;
                playSound('levelup');
                needed = config.expToLevel(state.level);
            }
            updateAllUI();
        }
        
        function hasPerk(key) {
            return config.perks.some(p => p.level <= state.level && p.key === key);
        }

        function calculateCurrentLottoPrice() {
            let price = 1000;
            if (hasPerk('lottoDiscount20')) price *= 0.8;
            else if (hasPerk('lottoDiscount10')) price *= 0.9;
            return price;
        }

        function calculateNogadaAmount() {
            if (hasPerk('nogadaBonus2')) return 50;
            if (hasPerk('nogadaBonus1')) return 20;
            return 10;
        }

        // --- RENDER FUNCTIONS ---
        function renderSelectionPhase() {
            DOMElements.gameArea.innerHTML = `
                <div class="text-center mb-6 border-b-2 border-gray-700 pb-6">
                    <p class="text-lg text-gray-400">이번 회차 1등 당첨금 (누적)</p>
                    <p id="jackpot-amount" class="text-5xl font-bold text-amber-400 tracking-tighter">₩ 0</p>
                </div>
                <div class="bg-gray-900 rounded-lg p-4 mb-4 min-h-[80px] flex items-center justify-center">
                    <div id="selected-numbers-display" class="flex flex-wrap justify-center gap-3"></div>
                </div>
                <div class="grid grid-cols-7 md:grid-cols-9 gap-2 mb-6" id="number-grid"></div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-4">
                    <button id="auto-pick-btn" class="btn bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 px-4 rounded-lg"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i>자동</button>
                    <button id="reset-selection-btn" class="btn bg-rose-700 hover:bg-rose-600 text-white font-bold py-3 px-4 rounded-lg"><i class="fa-solid fa-trash mr-2"></i>초기화</button>
                    <button id="save-numbers-btn" class="btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-4 rounded-lg"><i class="fa-solid fa-floppy-disk mr-2"></i>저장</button>
                    <button id="load-numbers-btn" class="btn bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 px-4 rounded-lg"><i class="fa-solid fa-folder-open mr-2"></i>열기</button>
                </div>
                <button id="start-draw-btn" class="btn w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-extrabold text-lg py-4 rounded-lg disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed">
                    <span id="lotto-price-display">₩1,000</span>으로 추첨 시작!
                </button>
            `;
            createNumberGrid();
            updateSelectedNumbersUI();
            updateJackpotUI();
            bindSelectionPhaseEvents();
        }

        function renderResultPhase(userNumbers, winningNumbers, bonusNumber, rank, prize) {
            DOMElements.gameArea.innerHTML = `
                <div class="text-center">
                    <p class="text-2xl font-bold mb-4">추첨 결과</p>
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-3 text-gray-400">당첨 번호</h3>
                        <div id="winning-numbers-container" class="flex justify-center items-center flex-wrap gap-2 min-h-[52px]"></div>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-lg font-medium mb-3 text-gray-400">나의 번호</h3>
                        <div id="user-picks-container" class="flex justify-center flex-wrap gap-2 min-h-[52px]"></div>
                    </div>
                    <div id="results-display" class="bg-gray-900 p-6 rounded-lg min-h-[120px]">
                        <p class="text-4xl font-black mb-2">${rank > 0 ? `🎉 ${rank}등 당첨! 🎉` : '...낙첨...'}</p>
                        <p class="text-xl mb-1">당첨금: <span class="font-semibold text-amber-400">${prize.toLocaleString('ko-KR')}원</span></p>
                    </div>
                    <button id="play-again-btn" class="btn w-full mt-6 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg">새로운 도전</button>
                </div>
            `;
            
            const winningContainer = document.getElementById('winning-numbers-container');
            winningNumbers.forEach(num => winningContainer.appendChild(createBallElement(num, 'win', true)));
            const plus = document.createElement('span'); plus.className = 'text-3xl font-bold text-gray-500 mx-1'; plus.textContent = '+';
            winningContainer.appendChild(plus);
            winningContainer.appendChild(createBallElement(bonusNumber, 'bonus', true));

            const userContainer = document.getElementById('user-picks-container');
            userNumbers.forEach(num => {
                const ball = createBallElement(num, 'user', true);
                if (winningNumbers.includes(num)) ball.classList.add('ring-4', 'ring-green-400');
                else if (num === bonusNumber) ball.classList.add('ring-4', 'ring-amber-400');
                userContainer.appendChild(ball);
            });

            document.getElementById('play-again-btn').addEventListener('click', () => {
                state.isDrawing = false;
                state.selectedNumbers = [];
                renderSelectionPhase();
                updateAllUI();
            });
        }

        function setupTabListeners() {
            document.querySelectorAll('.tab-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const tabName = e.currentTarget.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    renderTabContent(tabName);
                });
            });
        }
        
        function renderTabContent(tabName) {
            let content = '';
            switch (tabName) {
                case 'actions':
                    content = `
                        <div class="space-y-3">
                            <button id="nogada-btn" class="btn w-full text-left p-4 rounded-lg bg-gray-700 hover:bg-gray-600">
                                <p class="font-bold"><i class="fa-solid fa-person-digging text-yellow-400 mr-3"></i>클릭</p>
                                <p class="text-sm text-gray-400">자금을 법니다. (현재: +<span id="nogada-amount">${calculateNogadaAmount()}</span>원)</p>
                            </button>
                            <button id="minigame-btn" class="btn w-full text-left p-4 rounded-lg bg-gray-700 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                                <p class="font-bold"><i class="fa-solid fa-coins text-amber-400 mr-3"></i>코인 토스</p>
                                <p class="text-sm text-gray-400">${hasPerk('minigameUnlocked') ? '자산을 두 배로 불릴 기회!' : '레벨 2에 해금됩니다.'}</p>
                            </button>
                        </div>
                    `;
                    break;
                case 'history':
                    if (state.history.length === 0) {
                        content = `<p class="text-gray-500 text-center">플레이 기록이 없습니다.</p>`;
                    } else {
                        content = `<div class="space-y-3 max-h-64 overflow-y-auto pr-2">${[...state.history].reverse().map(h => `
                            <div class="bg-gray-900 p-3 rounded-lg">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold">${h.rank > 0 ? `${h.rank}등` : '낙첨'}</span>
                                    <span class="font-bold ${h.prize > 0 ? 'text-green-400' : ''}">${h.prize.toLocaleString()}원</span>
                                </div>
                                <div class="flex flex-wrap gap-1">${h.userNumbers.map(n => createBallElement(n, 'display', true).outerHTML).join('')}</div>
                            </div>
                        `).join('')}</div>`;
                    }
                    break;
                case 'stats':
                    content = `
                        <ul class="space-y-2 text-sm">
                            <li><strong>총 사용 금액:</strong> ${state.stats.totalSpent.toLocaleString()}원</li>
                            <li><strong>총 당첨금:</strong> ${state.stats.totalWon.toLocaleString()}원</li>
                            <li><strong>수익률:</strong> ${state.stats.totalSpent > 0 ? ((state.stats.totalWon / state.stats.totalSpent) * 100).toFixed(2) : 0}%</li>
                            <li class="pt-2 border-t border-gray-600"><strong>1등:</strong> ${state.stats.wins[1]}회</li>
                            <li><strong>2등:</strong> ${state.stats.wins[2]}회</li>
                            <li><strong>3등:</strong> ${state.stats.wins[3]}회</li>
                        </ul>
                    `;
                    break;
            }
            DOMElements.tabContent.innerHTML = content;
            if (tabName === 'actions') bindActionTabEvents();
        }

        function createNumberGrid() {
            const grid = document.getElementById('number-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= 45; i++) {
                const ball = createBallElement(i, 'grid');
                if (state.selectedNumbers.includes(i)) ball.classList.add('selected');
                ball.addEventListener('click', () => handleNumberClick(i, ball));
                grid.appendChild(ball);
            }
        }

        function createBallElement(number, type, isSmall = false) {
            const ball = document.createElement('div');
            ball.dataset.number = number;
            ball.textContent = number;
            let colorClass = '';
            if (number <= 10) colorClass = 'bg-yellow-500 text-black';
            else if (number <= 20) colorClass = 'bg-blue-500 text-white';
            else if (number <= 30) colorClass = 'bg-red-500 text-white';
            else if (number <= 40) colorClass = 'bg-gray-600 text-white';
            else colorClass = 'bg-green-500 text-white';
            
            ball.className = `number-ball ${isSmall ? 'sm' : ''} ${colorClass}`;
            if (type === 'display') ball.classList.add('cursor-default');
            return ball;
        }

        // --- UI UPDATES ---
        function updateAllUI() {
            DOMElements.playerLevel.textContent = state.level;
            const needed = config.expToLevel(state.level);
            DOMElements.playerExp.textContent = state.exp;
            DOMElements.expToNextLevel.textContent = needed;
            DOMElements.expBarInner.style.width = `${(state.exp / needed) * 100}%`;
            DOMElements.currentMoney.textContent = `₩ ${state.money.toLocaleString('ko-KR')}`;
            
            if (!state.isDrawing) {
                updateJackpotUI();
                updateLottoPriceUI();
                const startBtn = document.getElementById('start-draw-btn');
                if(startBtn) startBtn.disabled = state.money < calculateCurrentLottoPrice() || state.selectedNumbers.length !== 6;
            }
        }
        
        function updateJackpotUI() {
            document.getElementById('jackpot-amount').textContent = `₩ ${state.jackpot.toLocaleString('ko-KR')}`;
        }
        
        function updateLottoPriceUI() {
            document.getElementById('lotto-price-display').textContent = `₩${calculateCurrentLottoPrice().toLocaleString('ko-KR')}`;
        }

        function updateSelectedNumbersUI() {
            const display = document.getElementById('selected-numbers-display');
            display.innerHTML = '';
            if (state.selectedNumbers.length === 0) {
                 display.innerHTML = `<span class="text-gray-500">6개의 번호를 선택해주세요.</span>`;
                 return;
            }
            state.selectedNumbers.sort((a,b)=>a-b).forEach(num => {
                display.appendChild(createBallElement(num, 'display', true));
            });
        }
        
        // --- EVENT BINDING ---
        function bindSelectionPhaseEvents() {
            document.getElementById('start-draw-btn').addEventListener('click', handleStartDraw);
            document.getElementById('auto-pick-btn').addEventListener('click', handleAutoPick);
            document.getElementById('reset-selection-btn').addEventListener('click', handleResetSelection);
        }

        function bindActionTabEvents() {
            document.getElementById('nogada-btn').addEventListener('click', () => {
                state.money += calculateNogadaAmount();
                playSound('click');
                updateAllUI();
            });
            const minigameBtn = document.getElementById('minigame-btn');
            minigameBtn.disabled = !hasPerk('minigameUnlocked');
            if(!minigameBtn.disabled) minigameBtn.addEventListener('click', handleCoinToss);
        }

        // --- EVENT HANDLERS ---
        function handleStartDraw() {
            const price = calculateCurrentLottoPrice();
            if (state.money < price || state.selectedNumbers.length !== 6 || state.isDrawing) return;

            state.isDrawing = true;
            state.money -= price; state.stats.totalSpent += price;
            state.stats.plays++; state.jackpot += config.jackpotContribution;
            addExp(config.expPerPlay);

            const userNumbers = [...state.selectedNumbers].sort((a,b)=>a-b);
            const numbers = Array.from({ length: 45 }, (_, i) => i + 1);
            shuffleArray(numbers);
            const winningNumbers = numbers.slice(0, 6).sort((a, b) => a - b);
            const bonusNumber = numbers[6];

            const matchCount = userNumbers.filter(num => winningNumbers.includes(num)).length;
            const bonusMatch = userNumbers.includes(bonusNumber);
            
            let rank = 0;
            if (matchCount === 6) rank = 1;
            else if (matchCount === 5 && bonusMatch) rank = 2;
            else if (matchCount === 5) rank = 3;
            else if (matchCount === 4) rank = 4;
            else if (matchCount === 3) rank = 5;

            let prize = 0;
            if (rank > 0) {
                prize = (rank === 1) ? state.jackpot : config.prizes[rank];
                state.money += prize; state.stats.totalWon += prize;
                state.stats.wins[rank]++;
                if(prize > state.stats.highestPrize) state.stats.highestPrize = prize;
                playSound('win');
            } else { playSound('lose'); }
            
            state.history.push({ userNumbers, rank, prize });
            if (rank === 1) state.jackpot = 2000000000;
            
            renderResultPhase(userNumbers, winningNumbers, bonusNumber, rank, prize);
            saveState();
            updateAllUI();
        }

        function handleNumberClick(number, ballElement) {
            if (state.isDrawing) return;
            playSound('click');
            const index = state.selectedNumbers.indexOf(number);
            if (index > -1) {
                state.selectedNumbers.splice(index, 1);
                ballElement.classList.remove('selected');
            } else if (state.selectedNumbers.length < 6) {
                state.selectedNumbers.push(number);
                ballElement.classList.add('selected');
            }
            updateSelectedNumbersUI();
            updateAllUI();
        }

        function handleAutoPick() {
            const numbers = Array.from({ length: 45 }, (_, i) => i + 1);
            shuffleArray(numbers);
            state.selectedNumbers = numbers.slice(0, 6);
            createNumberGrid();
            updateSelectedNumbersUI();
            updateAllUI();
        }

        function handleResetSelection() {
            state.selectedNumbers = [];
            createNumberGrid();
            updateSelectedNumbersUI();
            updateAllUI();
        }
        
        function handleCoinToss() {
            // Coin toss logic here
        }

        // --- UTILITY ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- SAVE & LOAD ---
        function saveState() {
            localStorage.setItem('lottoRemasteredV3', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('lottoRemasteredV3');
            state = getDefaultState();
            if (saved) {
                try {
                    const loadedState = JSON.parse(saved);
                    Object.assign(state, loadedState);
                } catch (e) {
                    console.error("Error loading saved state:", e);
                    localStorage.removeItem('lottoRemasteredV3');
                }
            }
        }

        init();
    });
    </script>
</body>
</html>

