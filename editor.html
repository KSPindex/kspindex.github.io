<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index-Space IDE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-language_tools.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-modelist.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-emmet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-beautify.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/keybinding-vscode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/keybinding-sublime.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/keybinding-vim.js"></script>
    
    <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-python.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-html.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-postcss.js"></script>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js" async></script>
    <script src="https://unpkg.com/fengari-web/dist/fengari-web.js"></script>
    
    <style>
        /* Index-Space Theme Variables - Unified with Desktop */
        :root {
            [cite_start]--color-background: #0D1117; [cite: 2]
            [cite_start]--color-text-primary: #E6EDF3; [cite: 3]
            [cite_start]--color-text-secondary: #8B949E; [cite: 3]
            --color-surface-1: #161B22; [cite_start]/* Primary background for main content */ [cite: 3]
            --color-surface-2: #0D1117; [cite_start]/* Darker background for sidebar/panels */ [cite: 3]
            [cite_start]--color-border: #30363D; [cite: 4]
            --color-accent: #58A6FF; [cite_start]/* Primary accent for highlights, active states */ [cite: 5]
            --color-selection-bg: rgba(88, 166, 255, 0.2); [cite_start]/* Selection background */ [cite: 5]
            [cite_start]--color-error: #DA3633; [cite: 6]
            [cite_start]--color-warning: #D29922; [cite: 6]
            --font-family: 'Inter', sans-serif; [cite_start]/* Default IDE font */ [cite: 7]
            --font-mono: 'Fira Code', monospace; [cite_start]/* Monospaced font for code */ [cite: 8]

            /* IDE Specific Overrides - based on Index-Space Desktop theme */
            --ide-bg-primary: var(--color-background); [cite_start]/* Darkest background */ [cite: 8]
            --ide-bg-secondary: var(--color-surface-1); [cite_start]/* Editor background */ [cite: 9]
            --ide-bg-tertiary: var(--color-surface-2); [cite_start]/* Top bar, tabs, sidebar header */ [cite: 10]
            --ide-bg-hover: rgba(48, 54, 61, 0.5); [cite_start]/* Semi-transparent border color for hover */ [cite: 11]
            [cite_start]--ide-text-primary: var(--color-text-primary); [cite: 12]
            [cite_start]--ide-text-secondary: var(--color-text-secondary); [cite: 13]
            --ide-text-inactive: var(--color-text-secondary); [cite_start]/* Similar to secondary for disabled elements */ [cite: 13]
            [cite_start]--ide-border-primary: var(--color-border); [cite: 14]
            --ide-accent-primary: var(--color-accent); [cite_start]/* Run button, active tab border */ [cite: 14]
            --ide-accent-secondary: var(--color-accent); [cite_start]/* Notification, other accents */ [cite: 15]
            [cite_start]--ide-error-color: var(--color-error); [cite: 15]
            [cite_start]--ide-warning-color: var(--color-warning); [cite: 15]
            --ide-minimap-bg: rgba(13, 17, 23, 0.7); [cite_start]/* Slightly darker, more transparent background */ [cite: 16]
        }

        body {
            [cite_start]font-family: var(--font-family); [cite: 17]
            [cite_start]background-color: var(--ide-bg-primary); [cite: 17]
            [cite_start]color: var(--ide-text-primary); [cite: 17]
            [cite_start]overflow: hidden; [cite: 18]
            [cite_start]font-size: 14px; [cite: 18]
            [cite_start]user-select: none; [cite: 18]
        }
        [cite_start]::-webkit-scrollbar { width: 8px; height: 8px; [cite: 19] }
        [cite_start]::-webkit-scrollbar-track { background: var(--ide-bg-tertiary); [cite: 20] }
        [cite_start]::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; [cite: 21] }
        
        #main-grid {
            [cite_start]display: grid; [cite: 22]
            grid-template-columns: 48px 250px 5px 1fr; [cite_start]/* Activity Bar, Sidebar, Resizer, Main View */ [cite: 22]
            grid-template-rows: 35px 1fr 5px 200px 24px; [cite_start]/* Top Bar, Main Editor Area, Resizer, Bottom Panel, Status Bar */ [cite: 23]
            [cite_start]height: 100vh; [cite: 24]
            [cite_start]width: 100vw; [cite: 24]
        }
        #top-bar {
            [cite_start]grid-area: 1 / 1 / 2 / 6; [cite: 25]
            [cite_start]background-color: var(--ide-bg-tertiary); [cite: 25]
            [cite_start]display: flex; [cite: 25]
            [cite_start]align-items: center; [cite: 25]
            [cite_start]padding: 0 10px; [cite: 26]
            [cite_start]z-index: 60; [cite: 26]
            [cite_start]border-bottom: 1px solid var(--ide-border-primary); [cite: 26]
        }
        #activity-bar {
            [cite_start]grid-area: 2 / 1 / 5 / 2; [cite: 27]
            [cite_start]background-color: var(--ide-bg-primary); [cite: 27]
            [cite_start]z-index: 50; [cite: 27]
            [cite_start]border-right: 1px solid var(--ide-border-primary); [cite: 27]
        }
        #sidebar {
            [cite_start]grid-area: 2 / 2 / 5 / 3; [cite: 28]
            [cite_start]background-color: var(--ide-bg-tertiary); [cite: 28]
            [cite_start]z-index: 40; [cite: 29]
            [cite_start]display: flex; [cite: 29]
            [cite_start]flex-direction: column; [cite: 29]
            [cite_start]border-right: 1px solid var(--ide-border-primary); [cite: 29]
        }
        #resizer-v {
            [cite_start]grid-area: 2 / 3 / 5 / 4; [cite: 30]
            [cite_start]cursor: col-resize; [cite: 30]
            [cite_start]z-index: 99; [cite: 30]
            [cite_start]background-color: var(--ide-border-primary); [cite: 30]
        }
        #main-view {
            [cite_start]grid-area: 2 / 4 / 3 / 5; [cite: 31]
            [cite_start]display: flex; [cite: 31]
            [cite_start]flex-direction: column; [cite: 31]
            [cite_start]overflow: hidden; [cite: 31]
        }
        #resizer-h {
            [cite_start]grid-area: 3 / 4 / 4 / 5; [cite: 32]
            [cite_start]cursor: row-resize; [cite: 32]
            [cite_start]z-index: 99; [cite: 32]
            [cite_start]background-color: var(--ide-border-primary); [cite: 32]
        }
        #bottom-panel {
            [cite_start]grid-area: 4 / 4 / 5 / 5; [cite: 33]
            [cite_start]background-color: var(--ide-bg-secondary); [cite: 33]
            [cite_start]border-top: 1px solid var(--ide-border-primary); [cite: 33]
        }
        #status-bar {
            [cite_start]grid-area: 5 / 1 / 6 / 6; [cite: 34]
            [cite_start]background-color: var(--ide-accent-primary); [cite: 34]
            [cite_start]color: var(--ide-bg-primary); [cite: 34]
            [cite_start]z-index: 100; [cite: 34]
            [cite_start]display: flex; [cite: 35]
            [cite_start]align-items: center; [cite: 35]
            [cite_start]justify-content: space-between; [cite: 35]
            [cite_start]padding: 0 16px; [cite: 35]
            [cite_start]font-size: 0.85rem; [cite: 35]
        }

        /* Ace Editor Customization */
        [cite_start].ace_editor { font-family: var(--font-mono) !important; [cite: 36] background: var(--ide-bg-secondary) !important; color: var(--ide-text-primary) !important; width: 100% !important; height: 100% !important;}
        [cite_start].ace_gutter { background: var(--ide-bg-secondary) !important; [cite: 37] color: var(--ide-text-inactive) !important; }
        [cite_start].ace_active-line { background: rgba(255, 255, 255, 0.05) !important; [cite: 38] }
        [cite_start].ace_cursor { color: var(--ide-text-secondary) !important; [cite: 39] }
        [cite_start].ace_selection { background: rgba(88, 166, 255, 0.25) !important; [cite: 40] } /* Uses ide-accent-primary */
        [cite_start].ace_minimap { background: var(--ide-minimap-bg); border-left: 1px solid var(--ide-border-primary); [cite: 41] }
        [cite_start].ace_minimap_slider { background: rgba(88, 166, 255, 0.2); border: 1px solid var(--ide-accent-primary); [cite: 42] }
        [cite_start].ace_error, .ace_warning { text-decoration: underline; text-decoration-style: wavy; [cite: 43] }
        [cite_start].ace_error { text-decoration-color: var(--ide-error-color); [cite: 44] }
        [cite_start].ace_warning { text-decoration-color: var(--ide-warning-color); [cite: 45] }
        [cite_start].ace_gutter-cell.ace_breakpoint { background-image: none !important; position: relative; [cite: 46] }
        [cite_start].ace_gutter-cell.ace_breakpoint::before { content: "●"; color: var(--ide-error-color); position: absolute; left: 50%; top: 50%; [cite: 47] transform: translate(-50%, -50%);}
        
        .overlay {
            [cite_start]position: fixed; [cite: 48]
            [cite_start]inset: 0; [cite: 48]
            background: rgba(13, 17, 23, 0.9); [cite_start]/* Use themed modal background */ [cite: 49]
            [cite_start]backdrop-filter: blur(8px); [cite: 49]
            [cite_start]z-index: 1000; [cite: 49]
            [cite_start]display:flex; [cite: 49]
            [cite_start]align-items: flex-start; [cite: 49]
            [cite_start]justify-content:center; [cite: 49]
        }
        .modal-base {
            [cite_start]background: var(--ide-bg-secondary); [cite: 50]
            [cite_start]margin-top:15vh; [cite: 50]
            [cite_start]width: 600px; [cite: 51]
            [cite_start]max-width: 90vw; [cite: 51]
            [cite_start]border-radius:8px; [cite: 51]
            [cite_start]box-shadow:0 10px 30px rgba(0,0,0,0.5); [cite: 51]
            [cite_start]display:flex; [cite: 51]
            [cite_start]flex-direction:column; [cite: 51]
            [cite_start]border: 1px solid var(--ide-border-primary); [cite: 51]
            [cite_start]color: var(--ide-text-primary); [cite: 51]
        }
        .modal-input {
            [cite_start]background:var(--ide-bg-primary); [cite: 52]
            [cite_start]border:1px solid var(--ide-border-primary); [cite: 52]
            [cite_start]outline:none; [cite: 52]
            [cite_start]padding:8px; [cite: 52]
            [cite_start]width:100%; [cite: 52]
            [cite_start]border-radius:4px; [cite: 52]
            [cite_start]color: var(--ide-text-primary); [cite: 52]
        }
        .context-menu-item:hover, .command-palette-item.active {
            [cite_start]background-color: var(--ide-bg-hover); [cite: 53]
            color: var(--ide-text-primary); [cite_start]/* Ensure text color stays readable */ [cite: 53]
        }

        .activity-bar-icon {
            position: relative; [cite_start]/* For the focus indicator */ [cite: 54]
            [cite_start]display: flex; [cite: 55]
            [cite_start]flex-direction: column; [cite: 55]
            [cite_start]align-items: center; [cite: 56]
            [cite_start]justify-content: center; [cite: 56]
            [cite_start]width: 100%; [cite: 56]
            padding: 12px 0; [cite_start]/* Adjust padding for better spacing */ [cite: 56]
            [cite_start]cursor: pointer; [cite: 57]
            [cite_start]color: var(--ide-text-inactive); [cite: 57]
            [cite_start]transition: all 0.2s ease; [cite: 57]
        }
        .activity-bar-icon:hover {
            [cite_start]color: var(--ide-text-primary); [cite: 58]
        }
        .activity-bar-icon.active {
            [cite_start]color: var(--ide-text-primary); [cite: 59]
            box-shadow: inset 2px 0 0 var(--ide-accent-primary); [cite_start]/* Left border indicator */ [cite: 59]
        }
        .activity-bar-icon svg {
            width: 24px; [cite_start]/* Standard icon size */ [cite: 60]
            [cite_start]height: 24px; [cite: 60]
            pointer-events: none; [cite_start]/* Allows click to pass through to parent */ [cite: 61]
        }


        [cite_start].sidebar-panel, .bottom-panel-content { display: none; [cite: 62] }
        [cite_start].sidebar-panel.active, .bottom-panel-content.active { display: flex; flex-direction: column; height: 100%; [cite: 63] }
        
        .bottom-panel-tab {
            [cite_start]padding: 8px 12px; [cite: 64]
            [cite_start]cursor: pointer; [cite: 64]
            [cite_start]font-size: 0.9em; [cite: 65]
            [cite_start]color: var(--ide-text-secondary); [cite: 65]
            [cite_start]transition: all 0.2s ease; [cite: 65]
        }
        .bottom-panel-tab:hover {
            [cite_start]background-color: var(--ide-bg-hover); [cite: 66]
        }
        .bottom-panel-tab.active {
            [cite_start]background-color: var(--ide-bg-secondary); [cite: 67]
            [cite_start]color: var(--ide-text-primary); [cite: 67]
            border-bottom: 2px solid var(--ide-accent-primary); [cite_start]/* Active tab indicator */ [cite: 67]
        }

        .editor-tab {
            [cite_start]position: relative; [cite: 68]
            background-color: var(--ide-bg-primary); [cite_start]/* Normal tab background */ [cite: 68]
            [cite_start]color: var(--ide-text-secondary); [cite: 69]
            [cite_start]padding: 8px 12px; [cite: 69]
            [cite_start]border-right: 1px solid var(--ide-border-primary); [cite: 69]
            [cite_start]cursor: pointer; [cite: 69]
            [cite_start]display: flex; [cite: 70]
            [cite_start]align-items: center; [cite: 70]
            [cite_start]gap: 8px; [cite: 70]
            [cite_start]font-size: 0.9em; [cite: 70]
            [cite_start]flex-shrink: 0; [cite: 70]
            [cite_start]transition: all 0.2s ease; [cite: 70]
        }
        .editor-tab:hover {
            [cite_start]background-color: var(--ide-bg-hover); [cite: 71]
            [cite_start]color: var(--ide-text-primary); [cite: 71]
        }
        .editor-tab.active {
            [cite_start]background-color: var(--ide-bg-secondary); [cite: 72]
            [cite_start]color: var(--ide-text-primary); [cite: 72]
            border-top: 2px solid var(--ide-accent-primary); [cite_start]/* Active tab indicator */ [cite: 72]
            padding-top: 6px; [cite_start]/* Adjust for border */ [cite: 73]
        }
        [cite_start].editor-tab.modified .tab-name::after { content: " ●"; [cite: 74] color: var(--ide-text-secondary); font-size: 10px; vertical-align: middle; }
        
        [cite_start]#editor-groups-container { display: grid; [cite: 75] grid-template-columns: 1fr; width: 100%; height: 100%; }
        [cite_start]#editor-groups-container.split { grid-template-columns: 1fr 5px 1fr; [cite: 76] }
        .editor-group {
            [cite_start]display: flex; [cite: 77]
            [cite_start]flex-direction: column; [cite: 77]
            [cite_start]overflow: hidden; [cite: 77]
            border-left: 1px solid var(--ide-border-primary); [cite_start]/* For split view border */ [cite: 77]
        }
        [cite_start].editor-pane { flex-grow: 1; [cite: 78] position: relative; }
        [cite_start]#editor-resizer-v { cursor: col-resize; background-color: var(--ide-border-primary); [cite: 79] }

        #welcome-screen {
            [cite_start]position: absolute; [cite: 80]
            [cite_start]inset: 0; [cite: 80]
            [cite_start]display: flex; [cite: 81]
            [cite_start]align-items: center; [cite: 81]
            [cite_start]justify-content: center; [cite: 81]
            [cite_start]text-align: center; [cite: 81]
            [cite_start]background-color: var(--ide-bg-secondary); [cite: 81]
            [cite_start]color: var(--ide-text-inactive); [cite: 81]
            [cite_start]font-size: 1.1em; [cite: 81]
            [cite_start]padding: 20px; [cite: 81]
            [cite_start]flex-direction: column; [cite: 81]
        }
        #welcome-screen h1 {
            [cite_start]font-size: 2.5em; [cite: 82]
            [cite_start]margin-bottom: 10px; [cite: 82]
            [cite_start]color: var(--ide-text-primary); [cite: 82]
        }
        #welcome-screen p {
            [cite_start]max-width: 600px; [cite: 83]
            [cite_start]line-height: 1.5; [cite: 83]
            [cite_start]color: var(--ide-text-secondary); [cite: 83]
        }
        #welcome-screen button {
            [cite_start]background-color: var(--ide-accent-primary); [cite: 84]
            [cite_start]color: var(--ide-bg-primary); [cite: 84]
            [cite_start]padding: 10px 20px; [cite: 85]
            [cite_start]border-radius: 6px; [cite: 85]
            [cite_start]margin-top: 20px; [cite: 85]
            [cite_start]cursor: pointer; [cite: 85]
            [cite_start]transition: all 0.2s ease; [cite: 85]
        }
        #welcome-screen button:hover {
            [cite_start]opacity: 0.9; [cite: 86]
            [cite_start]box-shadow: 0 4px 10px rgba(88, 166, 255, 0.3); [cite: 86]
        }

        /* File Explorer in Sidebar Specific Styles */
        .file-item {
            [cite_start]padding: 6px 8px; [cite: 87]
            [cite_start]border-radius: 4px; [cite: 87]
            [cite_start]cursor: pointer; [cite: 88]
            [cite_start]display: flex; [cite: 88]
            [cite_start]align-items: center; [cite: 88]
            [cite_start]gap: 8px; [cite: 88]
            [cite_start]font-size: 0.9em; [cite: 88]
            [cite_start]color: var(--ide-text-primary); [cite: 88]
            [cite_start]transition: background-color 0.1s ease; [cite: 88]
        }
        .file-item:hover {
            [cite_start]background-color: var(--ide-bg-hover); [cite: 89]
        }
        .file-item.selected {
            [cite_start]background-color: var(--color-selection-bg); [cite: 90]
            [cite_start]border-left: 2px solid var(--ide-accent-primary); [cite: 90]
            padding-left: 6px; [cite_start]/* Adjust padding for border */ [cite: 90]
        }
        .file-item.drag-over {
            [cite_start]background-color: var(--ide-accent-primary); [cite: 91]
            [cite_start]color: var(--ide-bg-primary); [cite: 91]
        }
        .file-item-icon {
            [cite_start]font-size: 1.1em; [cite: 92]
            [cite_start]flex-shrink: 0; [cite: 92]
        }
        .file-item-name {
            [cite_start]flex-grow: 1; [cite: 93]
            [cite_start]white-space: nowrap; [cite: 93]
            [cite_start]overflow: hidden; [cite: 93]
            [cite_start]text-overflow: ellipsis; [cite: 93]
        }
        .file-item-name.renaming {
            [cite_start]background: white; [cite: 94]
            [cite_start]color: black; [cite: 94]
            [cite_start]outline: none; [cite: 95]
            [cite_start]padding: 1px 3px; [cite: 95]
            [cite_start]border-radius: 3px; [cite: 95]
            [cite_start]border: 1px solid var(--ide-accent-primary); [cite: 95]
        }

        /* Context Menu Styles - Shared */
        .context-menu {
            [cite_start]position: fixed; [cite: 96]
            [cite_start]background: var(--ide-bg-secondary); [cite: 97]
            [cite_start]border: 1px solid var(--ide-border-primary); [cite: 97]
            [cite_start]border-radius: 6px; [cite: 97]
            [cite_start]box-shadow: 0 4px 12px rgba(0,0,0,0.3); [cite: 97]
            [cite_start]padding: 4px; [cite: 97]
            z-index: 2000; [cite_start]/* Higher than modals */ [cite: 97]
            [cite_start]opacity: 0; [cite: 98]
            [cite_start]transform: scale(0.95); [cite: 98]
            [cite_start]transition: all 0.1s ease-out; [cite: 98]
            [cite_start]pointer-events: none; [cite: 98]
            [cite_start]min-width: 150px; [cite: 98]
        }
        .context-menu.visible {
            [cite_start]opacity: 1; [cite: 99]
            [cite_start]transform: scale(1); [cite: 99]
            [cite_start]pointer-events: auto; [cite: 99]
        }
        .context-menu-item {
            [cite_start]padding: 8px 12px; [cite: 100]
            [cite_start]cursor: pointer; [cite: 100]
            [cite_start]border-radius: 4px; [cite: 101]
            [cite_start]white-space: nowrap; [cite: 101]
            [cite_start]display: flex; [cite: 101]
            [cite_start]align-items: center; [cite: 101]
            [cite_start]gap: 8px; [cite: 101]
            [cite_start]font-size: 0.8em; [cite: 101]
            [cite_start]color: var(--ide-text-primary); [cite: 101]
            [cite_start]transition: background-color 0.1s ease; [cite: 101]
        }
        .context-menu-item:hover {
            [cite_start]background: var(--ide-accent-primary); [cite: 102]
            [cite_start]color: white; [cite: 102]
        }
        .context-menu-item.disabled {
            [cite_start]color: var(--ide-text-inactive); [cite: 103]
            [cite_start]cursor: not-allowed; [cite: 103]
            [cite_start]opacity: 0.6; [cite: 103]
        }
        .context-menu-divider {
            [cite_start]height: 1px; [cite: 104]
            [cite_start]background: var(--ide-border-primary); [cite: 104]
            [cite_start]margin: 4px 0; [cite: 104]
        }

        /* Modal Styles - Shared with Index-Space Desktop modals */
        .modal-overlay {
            [cite_start]position: fixed; [cite: 105]
            [cite_start]top: 0; left: 0; width: 100%; height: 100%; [cite: 105]
            [cite_start]background: var(--color-modal-bg); backdrop-filter: blur(8px); [cite: 106]
            [cite_start]z-index: 20000; display: flex; justify-content: center; align-items: center; [cite: 106]
            [cite_start]animation: fadeIn 0.2s ease-out; [cite: 106]
        }
        .modal-dialog {
            [cite_start]background: var(--color-surface-1); [cite: 107]
            [cite_start]padding: 2rem; border-radius: 12px; [cite: 107]
            [cite_start]border: 1px solid var(--color-border); text-align: center; [cite: 108]
            [cite_start]max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; [cite: 108]
            [cite_start]box-shadow: 0 16px 64px rgba(0,0,0,0.5); [cite: 109]
            [cite_start]animation: slideIn 0.3s ease-out; [cite: 109]
            [cite_start]display: flex; flex-direction: column; [cite: 109]
            [cite_start]color: var(--color-text-primary); [cite: 109]
        }
        [cite_start].modal-dialog h3 { margin-bottom: 1rem; color: var(--color-text-primary); [cite: 110] }
        [cite_start].modal-dialog p { margin-bottom: 1.5rem; color: var(--color-text-secondary); [cite: 111] }
        .modal-dialog button {
            [cite_start]background: var(--color-surface-2); [cite: 112]
            [cite_start]border: 1px solid var(--color-border); [cite: 113]
            [cite_start]color: var(--color-text-primary); padding: 10px 20px; border-radius: 6px; [cite: 113]
            [cite_start]cursor: pointer; margin: 0 8px; font-size: 0.9rem; [cite: 113]
            [cite_start]transition: all 0.2s ease; [cite: 113]
        }
        [cite_start].modal-dialog button:hover { background: rgba(255,255,255,0.1); [cite: 114] }
        [cite_start].modal-dialog .primary-btn { background: var(--color-accent); border-color: var(--color-accent); [cite: 115] }
        [cite_start].modal-dialog .success-btn { background: var(--color-success); border-color: var(--color-success); [cite: 116] }
        [cite_start].modal-dialog .danger-btn { background: var(--color-error); border-color: var(--color-error); [cite: 117] }

        /* Preview Panel */
        #panel-preview iframe {
            background-color: #fff; [cite_start]/* Ensure white background for HTML preview */ [cite: 118]
        }

        /* Internal Terminal Styles */
        #panel-internal-terminal {
            [cite_start]font-family: var(--font-mono); [cite: 119]
            [cite_start]font-size: 0.9em; [cite: 119]
            [cite_start]line-height: 1.4; [cite: 120]
            [cite_start]background-color: var(--ide-bg-secondary); [cite: 120]
            [cite_start]color: var(--ide-text-primary); [cite: 120]
            [cite_start]padding: 10px; [cite: 120]
            white-space: pre-wrap; [cite_start]/* Preserve whitespace and wrap lines */ [cite: 120]
            [cite_start]overflow-y: auto; [cite: 121]
            word-break: break-all; [cite_start]/* Break long words */ [cite: 121]
            position: relative; [cite_start]/* For loading spinner positioning */ [cite: 122]
        }
        .terminal-output-line {
            [cite_start]padding: 2px 0; [cite: 123]
        }
        [cite_start].terminal-output-error { color: var(--ide-error-color); [cite: 124] }
        [cite_start].terminal-output-warning { color: var(--ide-warning-color); [cite: 125] }
        [cite_start].terminal-output-info { color: var(--ide-text-secondary); [cite: 126] }
        [cite_start].terminal-output-prompt { color: var(--ide-accent-primary); [cite: 127] }

        /* --- 로딩 스피너 및 메시지 스타일 --- */
        .terminal-loading-overlay {
            [cite_start]position: absolute; [cite: 128]
            [cite_start]top: 0; [cite: 128]
            [cite_start]left: 0; [cite: 129]
            [cite_start]right: 0; [cite: 129]
            [cite_start]bottom: 0; [cite: 129]
            background-color: rgba(13, 17, 23, 0.8); [cite_start]/* Semi-transparent dark overlay */ [cite: 129]
            display: flex; [cite_start]/* Flexbox for centering content */ [cite: 130]
            [cite_start]flex-direction: column; [cite: 131]
            [cite_start]justify-content: center; [cite: 131]
            [cite_start]align-items: center; [cite: 131]
            color: var(--ide-accent-primary); [cite_start]/* Spinner color */ [cite: 132]
            [cite_start]font-size: 1.2em; [cite: 132]
            z-index: 10; [cite_start]/* Above terminal output */ [cite: 132]
        }
        .spinner {
            [cite_start]border: 4px solid rgba(255, 255, 255, 0.3); [cite: 133]
            [cite_start]border-top: 4px solid var(--ide-accent-primary); [cite: 133]
            [cite_start]border-radius: 50%; [cite: 134]
            [cite_start]width: 30px; [cite: 134]
            [cite_start]height: 30px; [cite: 134]
            [cite_start]animation: spin 1s linear infinite; [cite: 134]
            [cite_start]margin-bottom: 10px; [cite: 134]
        }
        @keyframes spin {
            [cite_start]0% { transform: rotate(0deg); [cite: 135] }
            [cite_start]100% { transform: rotate(360deg); [cite: 136] }
        }
        .terminal-loading-message {
            [cite_start]margin-top: 10px; [cite: 137]
            [cite_start]font-size: 0.9em; [cite: 137]
            [cite_start]color: var(--ide-text-secondary); [cite: 137]
        }
    </style>
</head>
<body>

    <div id="main-grid">
        <div id="top-bar">
            <button id="back-btn" title="Back" class="p-1.5 rounded hover:bg-[var(--ide-bg-hover)] disabled:text-[var(--ide-text-inactive)] disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
            </button>
            <button id="forward-btn" title="Forward" class="p-1.5 rounded hover:bg-[var(--ide-bg-hover)] disabled:text-[var(--ide-text-inactive)] disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
            [cite_start]</button> [cite: 138]
            <div class="w-px h-5 bg-[var(--ide-border-primary)] mx-2"></div>
            <button id="run-btn" title="Run Code (F5)" class="p-1.5 rounded hover:bg-[var(--ide-bg-hover)] disabled:text-[var(--ide-text-inactive)] disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
            [cite_start]</button> [cite: 139]
            <button id="split-view-btn" title="Toggle Split View" class="p-1.5 rounded hover:bg-[var(--ide-bg-hover)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="3" x2="12" y2="21"></line></svg>
            [cite_start]</button> [cite: 140]
        </div>

        <div id="activity-bar" class="flex flex-col items-center">
            <div data-view="explorer" class="activity-bar-icon active" title="Explorer (Ctrl+Shift+E)">
                [cite_start]<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg> [cite: 141]
            </div>
            <div data-view="search" class="activity-bar-icon" title="Search (Ctrl+Shift+F)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </div>
            <div data-view="settings" class="activity-bar-icon flex-grow" title="Settings">
                [cite_start]<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> [cite: 142]
            </div>
        </div>
        
        <div id="sidebar">
            <div id="view-explorer" class="sidebar-panel active">
                <div class="p-2 flex justify-between items-center border-b border-[var(--ide-border-primary)]">
                    <h2 class="text-xs uppercase font-bold tracking-wider text-[var(--ide-text-secondary)]">Explorer</h2>
                    <div class="flex items-center space-x-1">
                        <button id="new-untitled-file-global" class="p-1 rounded hover:bg-[var(--ide-bg-hover)]" title="New Untitled File">
                            [cite_start]<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg> [cite: 144, 145]
                        </button>
                        <button id="new-folder-global" class="p-1 rounded hover:bg-[var(--ide-bg-hover)]" title="New Folder">
                            [cite_start]<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" /></svg> [cite: 146]
                        </button>
                    </div>
                </div>
                <div class="p-2 border-b border-[var(--ide-border-primary)]">
                    [cite_start]<input type="text" id="explorer-search" class="modal-input w-full text-xs" placeholder="Search files..."> [cite: 147]
                </div>
                <div id="file-explorer" class="flex-1 overflow-auto p-2"></div>
            </div>

            <div id="view-search" class="sidebar-panel">
                <div class="p-2 border-b border-[var(--ide-border-primary)]">
                    <h2 class="text-xs uppercase font-bold tracking-wider text-[var(--ide-text-secondary)] mb-2">Search</h2>
                    [cite_start]<input type="text" id="search-input" class="modal-input text-xs" placeholder="Search in all files..."> [cite: 148]
                </div>
                [cite_start]<div id="search-results" class="flex-1 overflow-auto mt-2 text-sm"></div> [cite: 149]
            </div>

            <div id="view-settings" class="sidebar-panel p-4 overflow-y-auto">
                <h2 class="text-lg font-bold mb-4 text-[var(--ide-text-primary)]">Settings</h2>
                <div class="space-y-6">
                    <div>
                        [cite_start]<label for="setting-theme" class="block text-sm font-medium mb-1">Theme</label> [cite: 150]
                        <select id="setting-theme" class="modal-input"></select>
                    </div>
                    <div>
                        [cite_start]<label for="setting-fontsize" class="block text-sm font-medium mb-1">Font Size</label> [cite: 151]
                        <input type="number" id="setting-fontsize" class="modal-input w-24" min="8" max="24">
                    </div>
                    <div>
                        [cite_start]<label for="setting-keymap" class="block text-sm font-medium mb-1">Key Binds</label> [cite: 152]
                        <select id="setting-keymap" class="modal-input">
                            <option value="default">Default</option>
                            [cite_start]<option value="vscode">VS Code</option> [cite: 153]
                            [cite_start]<option value="sublime">Sublime</option> [cite: 153]
                            [cite_start]<option value="vim">Vim</option> [cite: 153]
                        </select>
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="setting-linenumbers" class="text-sm font-medium">Show Line Numbers</label>
                        [cite_start]<input type="checkbox" id="setting-linenumbers" class="h-4 w-4 rounded accent-[var(--ide-accent-primary)]"> [cite: 154]
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="setting-minimap" class="text-sm font-medium">Show Minimap</label>
                        [cite_start]<input type="checkbox" id="setting-minimap" class="h-4 w-4 rounded accent-[var(--ide-accent-primary)]"> [cite: 155]
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="setting-wordwrap" class="text-sm font-medium">Word Wrap</label>
                        [cite_start]<input type="checkbox" id="setting-wordwrap" class="h-4 w-4 rounded accent-[var(--ide-accent-primary)]"> [cite: 156]
                    </div>
                    <div class="flex items-center justify-between">
                        <label for="setting-autosave" class="text-sm font-medium">Auto Save</label>
                        [cite_start]<input type="checkbox" id="setting-autosave" class="h-4 w-4 rounded accent-[var(--ide-accent-primary)]"> [cite: 157]
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">User Snippets (JSON)</label>
                        [cite_start]<div id="snippets-editor" class="w-full h-48 rounded" style="border: 1px solid var(--ide-border-primary)"></div> [cite: 158]
                        [cite_start]<button id="save-snippets-btn" class="mt-2 px-3 py-1 rounded bg-[var(--ide-accent-primary)] text-[var(--ide-bg-primary)] hover:opacity-80 text-sm">Save Snippets</button> [cite: 159]
                    </div>
                </div>
            </div>
        </div>

        <div id="resizer-v"></div>

        <div id="main-view">
            <div id="editor-groups-container">
                <div id="editor-group-1" class="editor-group">
                    <div class="editor-tabs flex-shrink-0 flex bg-[var(--ide-bg-tertiary)] overflow-x-auto"></div>
                    <div class="editor-pane flex-1 relative"></div>
                </div>
            [cite_start]</div> [cite: 160]
            <div id="welcome-screen">
                <h1>Welcome to Index-Space IDE!</h1>
                <p>Start by creating a new file or opening an existing one from the Explorer.</p>
                <button id="welcome-new-file-btn">Create New File</button>
            [cite_start]</div> [cite: 161]
        </div>
        
        [cite_start]<div id="resizer-h"></div> [cite: 162]
        
        <div id="bottom-panel" class="flex flex-col">
            <div class="tabs flex-shrink-0 flex bg-[var(--ide-bg-tertiary)] border-b border-[var(--ide-border-primary)] text-sm">
                <div data-panel="internal-terminal" class="bottom-panel-tab active">Terminal</div>
                [cite_start]<div data-panel="problems" class="bottom-panel-tab">Problems (<span id="problems-count">0</span>)</div> [cite: 163]
                <div data-panel="preview" class="bottom-panel-tab">Preview</div>
            </div>
            <div id="panel-internal-terminal" class="bottom-panel-content flex-1 active">
                <div id="terminal-output-log"></div>
                <div id="terminal-loading-overlay" class="terminal-loading-overlay hidden">
                    [cite_start]<div class="spinner"></div> [cite: 164]
                    <div id="terminal-loading-text">Loading environments...</div>
                </div>
            </div>
            <div id="panel-problems" class="bottom-panel-content flex-1 overflow-y-auto"></div>
            <div id="panel-preview" class="bottom-panel-content flex-1 overflow-y-auto">
                [cite_start]<iframe id="preview-frame" class="w-full h-full border-none"></iframe> [cite: 165]
            </div>
        </div>

        <div id="status-bar">
            <div class="flex items-center gap-4">
                <button id="cmd-palette-btn" class="hover:bg-black/20 px-2 py-0.5 rounded" title="Ctrl+Shift+P">Command Palette</button>
                <button id="beta-palette-btn" class="hover:bg-black/20 px-2 py-0.5 rounded">Beta</button>
            [cite_start]</div> [cite: 166]
            <div class="flex items-center gap-4"><span id="line-col"></span><span id="language-status">Plain Text</span></div>
        </div>
    </div>
    
    <div id="modal-overlay" class="overlay hidden"></div>
    <div id="context-menu" class="absolute z-[2000] bg-[var(--ide-bg-secondary)] border border-[var(--ide-border-primary)] rounded-md shadow-lg text-sm hidden py-1"></div>
    <div id="notification-toast" class="fixed bottom-4 right-4 bg-[var(--ide-accent-primary)] text-white px-4 py-2 rounded-md shadow-lg opacity-0 transition-opacity duration-300 z-[20001]"></div>
    <input type="file" id="file-importer" class="hidden" multiple>

<script type="module">
    // Define the parent iframe window reference for desktop.html communication
    [cite_start]let desktopIframeWindow = null; [cite: 167]

    const App = {
        state: {
            fs: null, 
            editors: { pane1: null, pane2: null }, 
            snippetsEditor: null, 
            activePane: 'pane1', 
            [cite_start]openFiles: { pane1: new Map(), pane2: new Map() }, [cite: 168]
            activePaths: { pane1: null, pane2: null }, 
            isSplitView: false,
            
            activeSidebarView: 'explorer', 
            activeBottomPanel: 'internal-terminal', // Default to internal terminal
            untitledCounter: 1, 
            
            settings: { 
                theme: 'Hyper Dark', 
                fontSize: 14, 
                showLineNumbers: true, 
                showMinimap: true,
                [cite_start]wordWrap: false, [cite: 169]
                [cite_start]autoSave: false, [cite: 170]
                keymap: 'default', 
                layout: { sidebar: '250px', panel: '200px', split: '1fr' } 
            },
            themes: { 
                [cite_start]'Hyper Dark': {}, [cite: 171]
                [cite_start]'VS Code Dark': {'--ide-bg-primary':'#1e1e1e','--ide-bg-secondary':'#252526','--ide-bg-tertiary':'#333333','--ide-text-primary':'#d4d4d4','--ide-text-secondary':'#808080'}, [cite: 171]
                [cite_start]'Solarized Light': {'--ide-bg-primary':'#fdf6e3','--ide-bg-secondary':'#f0eada','--ide-text-primary':'#657b83','--ide-text-secondary':'#93a1a1','--ide-accent-primary':'#268bd2'} [cite: 171]
            },
            lintResults: {}, 
            userSnippets: [], 
            [cite_start]autoSaveInterval: null, [cite: 172]
            debounceTimer: null,

            // Internal Terminal State
            pyodide: null, pyodideReady: false,
            fengari: null, // Lua environment
            luaReady: false,
        },
        dom: {}, 

        async init() {
            this.cacheDomElements();
            this.settings.init();
            await this.fs.init();
            this.editor.init();
            this.ui.init();
            this.layout.init();
            this.events.init();
            this.search.init();
            this.snippets.init();
            this.terminal.init(); // This will now only do a minimal setup

            [cite_start]this.ui.renderExplorer(); [cite: 178]
            [cite_start]this.ui.showNotification('Index-Space IDE Initialized.', 'success'); [cite: 178]

            // Listen for messages from parent (desktop.html)
            window.addEventListener('message', (event) => {
                if (event.source === window.parent && event.data && event.data.type === 'appReady' && event.data.payload.appId === 'terminal' && event.data.payload.windowId) {
                    console.log('IDE: Terminal app reported ready on desktop. Not directly connected to external terminal.');
                [cite_start]} [cite: 179]
            });
            // Announce to parent window (desktop.html) that editor is ready
            if (window.parent) {
                [cite_start]window.parent.postMessage({ type: 'appReady', payload: { appId: 'editor', windowId: window.frameElement ? window.frameElement.id : null } }, '*'); [cite: 180, 181]
            }
        },

        cacheDomElements() {
            const ids = [
                'main-grid', 'top-bar', 'run-btn', 'split-view-btn', 'activity-bar', 'sidebar', 'resizer-v', 'main-view', 'resizer-h', 
                'bottom-panel', 'status-bar', 'file-explorer', 'editor-groups-container', 'welcome-screen', 
                'context-menu', 'notification-toast', 'line-col', 'language-status', 
                [cite_start]'new-untitled-file-global', 'new-folder-global', 'welcome-new-file-btn', [cite: 182]
                'modal-overlay', 'cmd-palette-btn', 'beta-palette-btn',
                'setting-theme', 'setting-fontsize', 'setting-keymap', 'setting-linenumbers', 'setting-minimap', 'setting-wordwrap', 'setting-autosave', 'snippets-editor', 'save-snippets-btn',
                'file-importer', 'view-explorer', 'view-search', 'view-settings', 
                'panel-internal-terminal', 'panel-problems', 'panel-preview', 'preview-frame', 'problems-count',
                [cite_start]'terminal-output-log', // 이 ID가 ids 배열에 포함되어 있는지 다시 확인 [cite: 183]
                'terminal-loading-overlay',
                'terminal-loading-text',
                'explorer-search', 'search-input', 'search-results',
                'back-btn', 'forward-btn'
            [cite_start]]; [cite: 184]
            ids.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    this.dom[id.replace(/-/g, '_')] = element;
                } else {
                    [cite_start]console.error(`DOM element with ID '${id}' not found!`); [cite: 185]
                    // 개발 중에는 console.error가 가장 유용합니다.
                }
            });
            this.dom.editor_group_1 = {
                group: document.getElementById('editor-group-1'),
                tabs: document.querySelector('#editor-group-1 .editor-tabs'),
                pane: document.querySelector('#editor-group-1 .editor-pane'),
            [cite_start]}; [cite: 186]
        },
        
        // --- Core Modules ---
        fs: {
            DB_NAME: 'IndexSpace_IDE_VFS_v1', // NEW DB NAME for this editor version
            DB_VERSION: 1, 
            db: null,

            init() {
                return new Promise((resolve, reject) => {
                    [cite_start]const req = indexedDB.open(this.DB_NAME, this.DB_VERSION); [cite: 188]

                    req.onupgradeneeded = e => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('nodes')) {
                            const store = db.createObjectStore('nodes', { keyPath: 'id' });
                            store.createIndex('path', ['parentId', 'name'], { unique: true });
                        [cite_start]} [cite: 189]
                    };

                    req.onsuccess = async e => {
                        this.db = e.target.result;
                        [cite_start]await this.initDefaultFS(); [cite: 191]
                        resolve();
                    };

                    req.onerror = e => {
                        [cite_start]console.error("IndexedDB error:", e.target.error); [cite: 192]
                        [cite_start]reject(e.target.error); [cite: 192]
                    };
                });
            },

            async initDefaultFS() {
                [cite_start]let rootNode = await this._runTx('nodes', 'readonly', s => s.get('/')); [cite: 193]
                if (!rootNode) {
                    [cite_start]await this._runTx('nodes', 'readwrite', s => s.add({ id: '/', type: 'folder', name: '', parentId: null, ctime: new Date(), mtime: new Date(), size: 0 })); [cite: 194]
                }

                const defaultItems = [
                    { path: '/my-projects', type: 'folder' },
                    { path: '/my-projects/index.html', type: 'file', content: '<!DOCTYPE html>\n<html>\n<head>\n  <title>Hello Index-Space</title>\n  <style>body { font-family: "Inter", sans-serif; background-color: #1a1b26; color: #c0caf5; margin: 20px; [cite_start]}</style>\n</head>\n<body>\n  <h1>Welcome to Index-Space IDE!</h1>\n  <p>Edit this HTML file and see changes instantly in the Preview panel.</p>\n</body>\n</html>' }, [cite: 195]
                    { path: '/my-projects/main.py', type: 'file', content: '# Python script example\ndef greet(name):\n    print(f"Hello, {name} from Python!")\n\ngreet("Index-Space")\n\n# Press F5 or click ▶ to run this script in the Terminal.' [cite_start]}, [cite: 196]
                    { path: '/my-projects/script.lua', type: 'file', content: '-- Lua script example\nlocal message = "Hello, Index-Space from Lua!"\nprint(message)\n\n-- Press F5 or click ▶ to run this script in the Terminal.' [cite_start]}, [cite: 197]
                    { path: '/readme.md', type: 'file', content: '# Index-Space IDE\n\nThis is a browser-based Integrated Development Environment (IDE) built entirely with web technologies (HTML, CSS, JavaScript, IndexedDB).\n\n## Features:\n- **Virtual File System (VFS)**: All your files are stored locally in your browser.\n- **Code Editor**: Powered by Ace Editor with syntax highlighting, autocompletion, and themes.\n- **File Explorer**: Browse, create, rename, and delete files/folders.\n- **Run Code**: Execute Python, Lua, and JavaScript directly in the integrated Terminal.\n- **Live HTML Preview**: See your HTML changes instantly.\n- **Customizable Settings**: Adjust themes, font size, keybindings, and more.\n- **User Snippets**: Create your own code snippets.\n\nEnjoy coding!' [cite_start]} [cite: 198, 199]
                ];
                for (const item of defaultItems) {
                    if (!(await this.getNodeByPath(item.path))) {
                        try {
                            if (item.type === 'folder') {
                                [cite_start]await this.mkdir(item.path); [cite: 201]
                            } else {
                                [cite_start]await this.write(item.path, item.content); [cite: 202, 203]
                            }
                        } catch (e) {
                            [cite_start]console.warn(`Failed to create default item ${item.path}: ${e.message}`); [cite: 204]
                        }
                    }
                [cite_start]} [cite: 200]
            },

            async _runTx(storeName, mode, operation) {
                return new Promise((resolve, reject) => {
                    [cite_start]const tx = this.db.transaction(storeName, mode); [cite: 205]
                    const store = tx.objectStore(storeName);
                    let req;
                    try {
                        [cite_start]req = operation(store); [cite: 206]
                    } catch (e) {
                        tx.abort();
                        reject(e);
                        return;
                    [cite_start]} [cite: 207]
                    tx.oncomplete = () => resolve(req ? req.result : undefined);
                    tx.onerror = () => reject(tx.error);
                    tx.onabort = () => reject(tx.error);
                [cite_start]}); [cite: 208]
            },

            [cite_start]async _getNewId() { return `node-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`; [cite: 209] },

            async mkdir(path) {
                if (path === '/') { 
                    [cite_start]const existingRoot = await this.getNode('/'); [cite: 210]
                    if (!existingRoot) {
                        [cite_start]return this._runTx('nodes', 'readwrite', s => s.add({ id: '/', type: 'folder', name: '', parentId: null, ctime: new Date(), mtime: new Date(), size: 0 })); [cite: 211]
                    }
                    [cite_start]return existingRoot.id; [cite: 212]
                }
                [cite_start]const { parentPath, name } = this._parsePath(path); [cite: 213]
                [cite_start]const parent = await this.getNodeByPath(parentPath); [cite: 213]
                [cite_start]if (!parent || parent.type !== 'folder') throw new Error(`Invalid path: Parent folder '${parentPath}' not found or not a folder`); [cite: 214]
                [cite_start]const existingNode = await this._runTx('nodes', 'readonly', s => s.index('path').get([parent.id, name])); [cite: 215]
                if (existingNode) throw new Error(`An item named '${name}' already exists in '${parentPath}'`);

                [cite_start]const id = await this._getNewId(); [cite: 216]
                [cite_start]await this._runTx('nodes', 'readwrite', s => s.add({ id, parentId: parent.id, name, type: 'folder', ctime: new Date(), mtime: new Date(), size: 0 })); [cite: 217]
                return id;
            },

            async write(path, content = '') {
                [cite_start]const { parentPath, name } = this._parsePath(path); [cite: 218]
                [cite_start]const parent = await this.getNodeByPath(parentPath); [cite: 218]
                [cite_start]if (!parent || parent.type !== 'folder') throw new Error(`Parent folder '${parentPath}' not found or not a folder`); [cite: 219]
                let nodeData;
                let mimeType = '';
                [cite_start]let size = 0; [cite: 220]
                if (content instanceof Blob) {
                    mimeType = content.type || [cite_start]'application/octet-stream'; [cite: 221]
                    size = content.size;
                } else { // Assume string content
                    [cite_start]mimeType = 'text/plain'; [cite: 222]
                    [cite_start]size = new TextEncoder().encode(String(content)).length; [cite: 222]
                }

                [cite_start]const existingNode = await this._runTx('nodes', 'readonly', s => s.index('path').get([parent.id, name])); [cite: 223]
                const now = new Date();
                [cite_start]const id = existingNode ? existingNode.id : await this._getNewId(); [cite: 224]
                nodeData = {
                    id,
                    parentId: parent.id,
                    name,
                    type: 'file',
                    [cite_start]content, [cite: 225]
                    size,
                    mimeType,
                    [cite_start]ctime: existingNode ? existingNode.ctime : now, [cite: 226]
                    mtime: now
                };
                if (existingNode) {
                    [cite_start]await this._runTx('nodes', 'readwrite', s => s.put(nodeData)); [cite: 227, 228]
                } else {
                    [cite_start]await this._runTx('nodes', 'readwrite', s => s.add(nodeData)); [cite: 229]
                }
                [cite_start]return id; [cite: 230]
            },

            async read(id, format = 'string') {
                [cite_start]const node = await this.getNode(id); [cite: 231]
                [cite_start]if (!node || node.type !== 'file') throw new Error('Not a file or file not found.'); [cite: 231]
                if (node.content instanceof Blob) {
                    [cite_start]if (format === 'blob') return node.content; [cite: 232, 233]
                    [cite_start]if (format === 'string') return await node.content.text(); [cite: 233]
                    if (format === 'dataurl') {
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            [cite_start]reader.onloadend = () => resolve(reader.result); [cite: 234]
                            reader.onerror = reject;
                            reader.readAsDataURL(node.content);
                        [cite_start]}); [cite: 235]
                    }
                    [cite_start]return node.content; [cite: 236]
                } else { // Assume content is string
                    [cite_start]if (format === 'string') return String(node.content || ''); [cite: 237]
                    [cite_start]if (format === 'blob') return new Blob([String(node.content || '')], { type: node.mimeType || 'text/plain' }); [cite: 237]
                    if (format === 'dataurl') {
                        [cite_start]const blob = new Blob([String(node.content || '')], { type: node.mimeType || 'text/plain' }); [cite: 238]
                        return new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result);
                            reader.onerror = reject;
                            [cite_start]reader.readAsDataURL(blob); [cite: 239, 240]
                        });
                    }
                    [cite_start]return String(node.content || ''); [cite: 242]
                }
            },

            async list(path) {
                [cite_start]const p = await this.getNodeByPath(path); [cite: 243]
                [cite_start]if (!p) return []; [cite: 243]
                [cite_start]return this._runTx('nodes', 'readonly', s => s.index('path').getAll(IDBKeyRange.bound([p.id, ''], [p.id, '\uffff']))); [cite: 244]
            },

            async delete(id) {
                [cite_start]const n = await this.getNode(id); [cite: 245]
                [cite_start]if (!n) return; [cite: 245]
                if (n.type === 'folder') {
                    [cite_start]const c = await this.list(await this.constructPath(id)); [cite: 246]
                    for (const i of c) await this.delete(i.id);
                }
                [cite_start]await this._runTx('nodes', 'readwrite', s => s.delete(id)); [cite: 247]
            },

            async rename(id, newName) {
                [cite_start]const nodeToRename = await this.getNode(id); [cite: 248]
                [cite_start]if (!nodeToRename) throw new Error('Node not found for rename.'); [cite: 248]
                [cite_start]if (nodeToRename.id === '/') throw new Error("Cannot rename root folder."); [cite: 249]
                const parent = await this.getNode(nodeToRename.parentId);
                if (parent) {
                    [cite_start]const existing = await this._runTx('nodes', 'readonly', s => s.index('path').get([parent.id, newName])); [cite: 250]
                    if (existing && existing.id !== nodeToRename.id) {
                        [cite_start]throw new Error(`An item named '${newName}' already exists in this folder.`); [cite: 251]
                    }
                }

                await this._runTx('nodes', 'readwrite', s => {
                    s.get(id).onsuccess = e => {
                        const n = e.target.result;
                        [cite_start]n.name = newName; [cite: 252]
                        n.mtime = new Date();
                        s.put(n);
                    }
                [cite_start]}); [cite: 253]
            },

            async move(id, newParentPath) {
                [cite_start]const targetParent = await this.getNodeByPath(newParentPath); [cite: 254]
                [cite_start]if (!targetParent || targetParent.type !== 'folder') throw new Error(`Invalid target path: '${newParentPath}' is not a folder or does not exist.`); [cite: 254]
                [cite_start]const nodeToMove = await this.getNode(id); [cite: 255]
                [cite_start]if (!nodeToMove) throw new Error('Node not found for move.'); [cite: 255]
                [cite_start]if (nodeToMove.id === '/') throw new Error("Cannot move root folder."); [cite: 256]
                if (nodeToMove.parentId === targetParent.id) return;

                [cite_start]let currentCheckId = targetParent.id; [cite: 257]
                while(currentCheckId && currentCheckId !== '/') {
                    if (currentCheckId === nodeToMove.id) {
                        [cite_start]throw new Error("Cannot move a folder into itself or its sub-folder."); [cite: 258]
                    }
                    [cite_start]const checkNode = await this.getNode(currentCheckId); [cite: 259]
                    [cite_start]currentCheckId = checkNode ? checkNode.parentId : null; [cite: 259]
                }

                [cite_start]const existingNodeInTarget = await this._runTx('nodes', 'readonly', s => s.index('path').get([targetParent.id, nodeToMove.name])); [cite: 260]
                if (existingNodeInTarget) {
                    [cite_start]throw new Error(`An item named '${nodeToMove.name}' already exists in the target folder.`); [cite: 261]
                }

                await this._runTx('nodes', 'readwrite', s => {
                    s.get(id).onsuccess = e => {
                        const n = e.target.result;
                        n.parentId = targetParent.id;
                        [cite_start]n.mtime = new Date(); [cite: 262]
                        s.put(n);
                    }
                [cite_start]}); [cite: 263]
            },

            async copy(id, newParentPath) {
                [cite_start]const n = await this.getNode(id); [cite: 264]
                if(!n) return;

                const targetParent = await this.getNodeByPath(newParentPath);
                [cite_start]if (!targetParent || targetParent.type !== 'folder') throw new Error(`Invalid target path: '${newParentPath}' is not a folder or does not exist.`); [cite: 265]
                let newName = n.name;
                let counter = 1;
                let targetPathFull = `${newParentPath === '/' ? [cite_start]'' : newParentPath}/${newName}`; [cite: 266]
                while (await this.getNodeByPath(targetPathFull)) {
                    [cite_start]const nameParts = n.name.split('.'); [cite: 267]
                    [cite_start]const baseName = nameParts.slice(0, -1).join('.'); [cite: 267]
                    const ext = nameParts.length > 1 ? [cite_start]`.${nameParts[nameParts.length - 1]}` : ''; [cite: 267]
                    if (counter === 1) {
                        [cite_start]newName = `${baseName}(Copy)${ext}`; [cite: 268]
                    } else {
                        [cite_start]newName = `${baseName}(Copy ${counter})${ext}`; [cite: 270]
                    }
                    targetPathFull = `${newParentPath === '/' ? [cite_start]'' : newParentPath}/${newName}`; [cite: 271]
                    counter++;
                }

                if (n.type === 'folder') {
                    [cite_start]const newFolderId = await this.mkdir(`${newParentPath === '/' ? '' : newParentPath}/${newName}`); [cite: 272]
                    const children = await this.list(await this.constructPath(id));
                    for (const child of children) {
                        [cite_start]await this.copy(child.id, await this.constructPath(newFolderId)); [cite: 273]
                    }
                    [cite_start]return newFolderId; [cite: 274]
                } else {
                    [cite_start]const copiedContent = n.content instanceof Blob ? n.content : String(n.content || ''); [cite: 275]
                    const newFileId = await this.write(`${newParentPath === '/' ? '' : newParentPath}/${newName}`, copiedContent);
                    [cite_start]return newFileId; [cite: 276]
                }
            },

            async getNode(id) {
                [cite_start]return this._runTx('nodes', 'readonly', s => s.get(id)); [cite: 277]
            },

            async getNodeByPath(path) {
                [cite_start]if (path === '/') return this.getNode('/'); [cite: 278]
                let pid = '/';
                let n = null;
                [cite_start]const pathParts = path.split('/').filter(Boolean); [cite: 279]
                for (const name of pathParts) {
                    [cite_start]n = await this._runTx('nodes', 'readonly', s => s.index('path').get([pid, name])); [cite: 280]
                    [cite_start]if (!n) return null; [cite: 280]
                    pid = n.id;
                }
                [cite_start]return n; [cite: 281]
            },

            async constructPath(id) {
                [cite_start]if (id === '/') return '/'; [cite: 282]
                let p = [];
                let n = await this.getNode(id);
                [cite_start]if (!n) return null; [cite: 282]
                while (n && n.parentId !== null) {
                    [cite_start]p.unshift(n.name); [cite: 283]
                    [cite_start]if (n.parentId === '/') break; [cite: 284]
                    n = await this.getNode(n.parentId);
                }
                [cite_start]return `/${p.join('/')}`; [cite: 285]
            },

            _parsePath(path) {
                [cite_start]const p = path.split('/').filter(Boolean); [cite: 286]
                const name = p.pop() || [cite_start]''; [cite: 286]
                const parentPath = `/${p.join('/')}`;
                return { parentPath: parentPath === '' ? [cite_start]'/' : parentPath, name }; [cite: 287]
            },

            async getAllFilePaths(dirNode, currentPath = '/') {
                if (!dirNode) { // Handle cases where dirNode might be null initially
                    dirNode = await this.getNodeByPath('/'); [cite_start]// Try to get root [cite: 288]
                    if (!dirNode) return []; [cite_start]// If root doesn't exist, no paths [cite: 289]
                }

                [cite_start]let filePaths = []; [cite: 290]
                const children = await this.list(currentPath); // Get children directly from VFS for currentPath
                
                for (const node of children) {
                    const fullPath = `${currentPath === '/' ? [cite_start]'' : currentPath}/${node.name}`; [cite: 291]
                    if (node.type === 'file') {
                        [cite_start]filePaths.push(fullPath); [cite: 292]
                    } else if (node.type === 'folder') {
                        [cite_start]filePaths = filePaths.concat(await this.getAllFilePaths(node, fullPath)); [cite: 293] // Recursive call with actual node
                    }
                }
                [cite_start]return filePaths; [cite: 294]
            },
            async findNodesByContent(query, currentSearchPath = '/') {
                [cite_start]const results = []; [cite: 295]
                [cite_start]const lowerCaseQuery = query.toLowerCase(); [cite: 295]
                // This needs to iterate through all files, potentially recursively
                [cite_start]const allPaths = await this.getAllFilePaths(await this.getNodeByPath(currentSearchPath), currentSearchPath); [cite: 296]
                for(const path of allPaths) {
                    [cite_start]const node = await this.getNodeByPath(path); [cite: 297]
                    if (node && node.type === 'file' && node.mimeType && node.mimeType.startsWith('text/')) {
                        try {
                            [cite_start]const contentString = await this.read(node.id, 'string'); [cite: 298]
                            if (contentString.toLowerCase().includes(lowerCaseQuery)) {
                                [cite_start]results.push(node); [cite: 299]
                            }
                        } catch (readError) {
                            [cite_start]console.warn(`Could not read content for search: ${node.name}`, readError); [cite: 300]
                        }
                    }
                }
                [cite_start]return results; [cite: 301]
            }
        }, 
        
        settings: {
            init() {
                [cite_start]const saved = localStorage.getItem('indexspace_ide_settings_v1'); [cite: 302]
                if (saved) {
                    [cite_start]const parsedSettings = JSON.parse(saved); [cite: 303]
                    [cite_start]App.state.settings = { ...App.state.settings, ...parsedSettings, layout: { ...App.state.settings.layout, ...parsedSettings.layout }}; [cite: 304]
                }
                this.populateUI();
                [cite_start]this.applyAll(); [cite: 305]
            },
            [cite_start]save() { localStorage.setItem('indexspace_ide_settings_v1', JSON.stringify(App.state.settings)); [cite: 306] },
            populateUI() {
                [cite_start]App.dom.setting_theme.innerHTML = Object.keys(App.state.themes).map(t => `<option value="${t}">${t}</option>`).join(''); [cite: 307]
                [cite_start]App.dom.setting_theme.value = App.state.settings.theme; [cite: 307]
                App.dom.setting_fontsize.value = App.state.settings.fontSize;
                App.dom.setting_keymap.value = App.state.settings.keymap;
                App.dom.setting_linenumbers.checked = App.state.settings.showLineNumbers;
                App.dom.setting_minimap.checked = App.state.settings.showMinimap;
                [cite_start]App.dom.setting_wordwrap.checked = App.state.settings.wordWrap; [cite: 308]
                [cite_start]App.dom.setting_autosave.checked = App.state.settings.autoSave; [cite: 308]
            },
            applyAll() {
                const theme = App.state.themes[App.state.settings.theme] || [cite_start]{}; [cite: 309]
                const baseTheme = {'--ide-bg-primary':'#0D1117','--ide-bg-secondary':'#161B22','--ide-bg-tertiary':'#0D1117','--ide-text-primary':'#E6EDF3','--ide-text-secondary':'#8B949E','--ide-text-inactive':'#8B949E','--ide-border-primary':'#30363D','--ide-accent-primary':'#58A6FF','--ide-accent-secondary':'#58A6FF','--ide-error-color':'#DA3633','--ide-warning-color':'#D29922','--ide-minimap-bg':'rgba(13, 17, 23, 0.7)'};
                Object.entries(baseTheme).forEach(([key,val]) => document.documentElement.style.setProperty(key, val));
                [cite_start]Object.entries(theme).forEach(([key,val]) => document.documentElement.style.setProperty(key, val)); [cite: 310]
                const options = { 
                    fontSize: App.state.settings.fontSize + 'px', 
                    showGutter: App.state.settings.showLineNumbers,
                    showMinimap: App.state.settings.showMinimap,
                    wrap: App.state.settings.wordWrap,
                [cite_start]}; [cite: 311]
                Object.values(App.state.editors).forEach(editor => {
                    if (editor) {
                        editor.setOptions(options);
                        editor.setKeyboardHandler(App.state.settings.keymap === 'default' ? null : `ace/keyboard/${App.state.settings.keymap}`);
                    [cite_start]} [cite: 312]
                });
                if (App.state.settings.autoSave) {
                    if (!App.state.autoSaveInterval) {
                        App.state.autoSaveInterval = setInterval(() => {
                            Object.keys(App.state.editors).forEach(paneId => {
                                [cite_start]if (App.state.activePaths[paneId]) App.files.save(paneId); [cite: 314]
                            });
                        [cite_start]}, 2000); [cite: 315]
                    }
                } else {
                    [cite_start]clearInterval(App.state.autoSaveInterval); [cite: 316]
                    [cite_start]App.state.autoSaveInterval = null; [cite: 316]
                }

                [cite_start]App.dom.main_grid.style.gridTemplateColumns = `48px ${App.state.settings.layout.sidebar} 5px 1fr`; [cite: 317]
                [cite_start]App.dom.main_grid.style.gridTemplateRows = `35px 1fr 5px ${App.state.settings.layout.panel} 24px`; [cite: 317]
                
                this.resizeAllEditors();
            },
            [cite_start]update(key, value) { App.state.settings[key] = value; [cite: 318] this.applyAll(); this.save(); },
            resizeAllEditors() {
                setTimeout(() => {
                    Object.values(App.state.editors).filter(Boolean).forEach(editor => editor?.resize());
                    App.state.snippetsEditor?.resize();
                [cite_start]}, 10); [cite: 319]
            }
        },
        
        editor: {
            init() {
                [cite_start]this.createEditorInstance('pane1'); [cite: 320]
                // Ensure snippets-editor element exists before creating the Ace editor instance
                if (App.dom.snippets_editor) {
                    [cite_start]App.state.snippetsEditor = this.createSnippetsEditor(); [cite: 321]
                } else {
                    [cite_start]console.warn("Snippets editor element not found. Snippets functionality may be limited."); [cite: 322]
                }
            },
            createEditorInstance(paneId) {
                [cite_start]const domInfo = App.ui.getPaneDom(paneId); [cite: 323]
                const editor = ace.edit(domInfo.pane);
                
                editor.setOptions({
                    enableBasicAutocompletion: true, enableLiveAutocompletion: true, enableSnippets: true,
                    showPrintMargin: false, highlightActiveLine: true, fontFamily: 'var(--font-mono)', 
                    theme: 'ace/theme/tomorrow_night_eighties', enableEmmet: true, selectionStyle: "line"
                [cite_start]}); [cite: 324]
                [cite_start]editor.on("focus", () => App.state.activePane = paneId); [cite: 324]
                [cite_start]editor.on("changeSelection", () => App.ui.updateStatus()); [cite: 325]
                editor.on("change", () => {
                    const path = App.state.activePaths[paneId];
                    if (path) {
                        const data = App.state.openFiles[paneId].get(path);
                        [cite_start]if (data && !data.tabEl.classList.contains('modified')) data.tabEl.classList.add('modified'); [cite: 326]
                        clearTimeout(App.state.debounceTimer);
                        App.state.debounceTimer = setTimeout(() => {
                            const content = editor.getValue();
                            [cite_start]App.linter.lintFile(path, content); [cite: 327]
                            App.preview.update(path, content);
                        }, 500);
                    }
                [cite_start]}); [cite: 328]

                App.state.editors[paneId] = editor;
                this.setupCommands(editor);
                App.settings.applyAll();
                [cite_start]return editor; [cite: 329]
            },
            createSnippetsEditor() {
                [cite_start]const editor = ace.edit("snippets-editor"); [cite: 330]
                editor.setOptions({
                    mode: "ace/mode/json", showGutter: false, fontSize: "12px",
                    theme: 'ace/theme/tomorrow_night_eighties',
                [cite_start]}); [cite: 331]
                [cite_start]editor.setValue(JSON.stringify(App.snippets.get(), null, 2), 1); [cite: 331]
                return editor;
            },
            [cite_start]getActiveEditor() { return App.state.editors[App.state.activePane]; [cite: 332] },
            setupCommands(editor) {
                const commands = [
                    { name: "save", bindKey: {win: "Ctrl-S", mac: "Command-S"}, exec: () => App.files.save() },
                    { name: "run", bindKey: {win: "F5", mac: "F5"}, exec: () => App.files.runActive() },
                    [cite_start]{ name: 'format', bindKey: { win: 'Shift-Alt-F', mac: 'Shift-Option-F' }, exec: (editor) => App.formatter.formatCode(editor) }, [cite: 333]
                    { name: "togglecomment", bindKey: {win: "Ctrl-/", mac: "Command-/"}, exec: editor => editor.toggleCommentLines() },
                    { name: "duplicateline", bindKey: {win: "Ctrl-Shift-D", mac: "Command-Shift-D"}, exec: editor => editor.duplicateSelection() },
                    [cite_start]{ name: "movelinesup", bindKey: {win: "Alt-Up", mac: "Option-Up"}, exec: (e) => e.moveLinesUp() }, [cite: 334]
                    { name: "movelinesdown", bindKey: {win: "Alt-Down", mac: "Option-Down"}, exec: (e) => e.moveLinesDown() },
                    { name: "addcursorup", bindKey: {win: "Ctrl-Alt-Up", mac: "Command-Option-Up"}, exec: (e) => e.selectMoreLines(-1) },
                    [cite_start]{ name: "addcursordown", bindKey: {win: "Ctrl-Alt-Down", mac: "Command-Option-Down"}, exec: (e) => e.selectMoreLines(1) }, [cite: 335]
                ];
                [cite_start]commands.forEach(cmd => editor.commands.addCommand(cmd)); [cite: 336]
            }
        },
        
        ui: {
            init() {
                [cite_start]this.switchSidebarView('explorer'); [cite: 337]
                this.switchBottomPanel('internal-terminal'); [cite_start]// Default to internal terminal [cite: 337]
            },
            getPaneDom(paneId) {
                [cite_start]if (paneId === 'pane1') return App.dom.editor_group_1; [cite: 338]
                return {
                    group: document.getElementById('editor-group-2'),
                    tabs: document.querySelector('#editor-group-2 .editor-tabs'),
                    pane: document.querySelector('#editor-group-2 .editor-pane'),
                [cite_start]}; [cite: 339]
            },
            async renderExplorer() {
                [cite_start]const container = App.dom.file_explorer; [cite: 340]
                if (!container) {
                    [cite_start]console.error("File explorer container not found, cannot render explorer."); [cite: 341]
                    return;
                }
                [cite_start]container.innerHTML = ''; [cite: 342]
                const query = App.dom.explorer_search?.value.toLowerCase() || ''; // Add nullish coalescing for safety
                
                const render = async (parentId, pathPrefix = '', level = 0) => {
                    let items = await App.fs.list(pathPrefix || '/'); [cite_start]// Fetch children from VFS [cite: 343]

                    const itemsWithMatchStatus = await Promise.all(items.map(async item => {
                        const nameMatches = item.name.toLowerCase().includes(query);
                        let contentMatches = false;
                        [cite_start]if (item.type === 'folder' && query) { // Only search content if there's a query [cite: 344]
                            const folderPath = `${pathPrefix === '/' ? '' : pathPrefix}/${item.name}`;
                            const foundInContent = await App.fs.findNodesByContent(query, folderPath);
                            [cite_start]contentMatches = foundInContent && foundInContent.length > 0; [cite: 345]
                        }
                        return { item, matches: nameMatches || contentMatches };
                    [cite_start]})); [cite: 346]

                    const filteredItems = itemsWithMatchStatus
                        .filter(entry => entry.matches)
                        .map(entry => entry.item);
                    // Sort items: folders first, then files, both alphabetically
                    filteredItems.sort((a, b) => {
                        if (a.type === 'folder' && b.type !== 'folder') return -1;
                        if (a.type !== 'folder' && b.type === 'folder') return 1;
                        [cite_start]return a.name.localeCompare(b.name); [cite: 348]
                    }).forEach(async (node) => { // Use async forEach if there are awaits inside
                        const path = await App.fs.constructPath(node.id);
                        [cite_start]const el = document.createElement('div'); [cite: 349]
                        el.className = 'file-item p-1 rounded cursor-pointer flex items-center hover:bg-[var(--ide-bg-hover)]';
                        el.style.paddingLeft = `${level * 16 + 4}px`;
                        el.dataset.path = path;
                        [cite_start]el.dataset.id = node.id; [cite: 350]
                        el.draggable = true;
                        
                        const icon = node.type === 'folder' ? [cite_start](node.isOpen ? '📂' : '📁') : '📄'; [cite: 351]
                        el.innerHTML = `<span class="mr-2 pointer-events-none">${icon}</span><span class="pointer-events-none">${node.name}</span>`;
                        container.appendChild(el);
                        el.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (node.type === 'folder') { 
                                node.isOpen = !node.isOpen; 
                                [cite_start]App.ui.renderExplorer(); [cite: 353]
                            } else { 
                                [cite_start]App.files.open(path); [cite: 354]
                            }
                        [cite_start]}); [cite: 352]
                        el.addEventListener('dragstart', (e) => { 
                            e.stopPropagation(); 
                            e.dataTransfer.setData('text/plain', JSON.stringify({type: 'move', id: node.id})); 
                            e.dataTransfer.effectAllowed = 'move';
                        [cite_start]}); [cite: 355, 356]
                        el.addEventListener('dragover', (e) => { 
                            e.preventDefault(); 
                            e.stopPropagation(); 
                            if(node.type === 'folder') el.classList.add('drag-over'); 
                        [cite_start]}); [cite: 357, 358]
                        el.addEventListener('dragleave', (e) => { 
                            e.preventDefault(); 
                            e.stopPropagation(); 
                            el.classList.remove('drag-over'); 
                        [cite_start]}); [cite: 359, 360]
                        el.addEventListener('drop', async (e) => {
                            e.preventDefault(); e.stopPropagation();
                            el.classList.remove('drag-over');
                            
                            [cite_start]const data = JSON.parse(e.dataTransfer.getData('text/plain')); [cite: 362]
                            if (data.type === 'move' && data.id) {
                                const srcId = data.id;
                                [cite_start]const destId = node.type === 'folder' ? node.id : node.parentId; [cite: 363]
                                const destPath = await App.fs.constructPath(destId);

                                [cite_start]if (srcId === destId) return; [cite: 364]

                                try {
                                    await App.fs.move(srcId, destPath);
                                    [cite_start]App.ui.showNotification(`Moved ${node.name} to ${destPath}`, 'success'); [cite: 365]
                                    App.ui.renderExplorer();
                                } catch (err) {
                                    [cite_start]App.ui.showNotification(`Move failed: ${err.message}`, 'error'); [cite: 366]
                                }
                            }
                        [cite_start]}); [cite: 361, 367]
                        if (node.type === 'folder' && node.isOpen) {
                            [cite_start]await render(node.id, path, level + 1); [cite: 368, 369]
                        }
                    });
                [cite_start]}; [cite: 370]
                const rootNode = await App.fs.getNodeByPath('/'); 
                if (rootNode) {
                    [cite_start]await render(rootNode.id, '/', 0); [cite: 371]
                } else {
                    [cite_start]console.warn("Root file system node not found. File explorer might be empty."); [cite: 372]
                }
            },
            updateStatus() {
                [cite_start]const editor = App.editor.getActiveEditor(); [cite: 373]
                [cite_start]const paneId = App.state.activePane; [cite: 373]
                if (!editor || !paneId) return;
                const path = App.state.activePaths[paneId];
                [cite_start]if (!path) { App.dom.line_col.textContent = ''; [cite: 374] App.dom.language_status.textContent = ''; return; }
                
                [cite_start]const pos = editor.getCursorPosition(); [cite: 375]
                if (App.dom.line_col) { // Add null check for safety
                    [cite_start]App.dom.line_col.textContent = `Ln ${pos.row + 1}, Col ${pos.column + 1}`; [cite: 376]
                }
                if (App.dom.language_status) { // Add null check for safety
                    [cite_start]App.dom.language_status.textContent = ace.require("ace/ext/modelist").getModeForPath(path).caption; [cite: 377]
                }
            },
            switchSidebarView(viewId) {
                if (!App.dom.sidebar || !App.dom.main_grid || !App.dom.resizer_v) {
                    [cite_start]console.error("Sidebar or grid elements not found for switchSidebarView."); [cite: 378]
                    return;
                }

                if (App.state.activeSidebarView === viewId && App.dom.sidebar.style.display !== 'none') {
                    [cite_start]App.dom.main_grid.style.gridTemplateColumns = '48px 0px 0px 1fr'; [cite: 379]
                    App.dom.sidebar.style.display = 'none';
                    App.dom.resizer_v.style.display = 'none';
                } else {
                    [cite_start]App.dom.main_grid.style.gridTemplateColumns = `48px ${App.state.settings.layout.sidebar} 5px 1fr`; [cite: 380]
                    App.dom.sidebar.style.display = 'flex';
                    App.dom.resizer_v.style.display = 'block';
                    document.querySelectorAll('.sidebar-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById(`view-${viewId}`)?.classList.add('active');
                    document.querySelectorAll('.activity-bar-icon').forEach(i => i.classList.remove('active'));
                    [cite_start]document.querySelector(`.activity-bar-icon[data-view="${viewId}"]`)?.classList.add('active'); [cite: 381]
                }
                App.state.activeSidebarView = viewId;
                [cite_start]App.settings.resizeAllEditors(); [cite: 382]
            },
            switchBottomPanel(panelId) {
                if (!App.dom.bottom_panel || !App.dom.resizer_h || !App.dom.main_grid) {
                    [cite_start]console.error("Bottom panel or grid elements not found for switchBottomPanel."); [cite: 383]
                    return;
                }

                [cite_start]App.dom.bottom_panel.style.display = 'flex'; [cite: 384]
                [cite_start]App.dom.resizer_h.style.display = 'block'; [cite: 384]
                App.dom.main_grid.style.gridTemplateRows = `35px 1fr 5px ${App.state.settings.layout.panel} 24px`;
                document.querySelectorAll('.bottom-panel-content').forEach(p => p.classList.remove('active'));
                document.getElementById(`panel-${panelId}`)?.classList.add('active');
                document.querySelectorAll('.bottom-panel-tab').forEach(t => t.classList.remove('active'));
                [cite_start]document.querySelector(`.bottom-panel-tab[data-panel="${panelId}"]`)?.classList.add('active'); [cite: 385]
                [cite_start]App.state.activeBottomPanel = panelId; [cite: 385]
                App.settings.resizeAllEditors();
            },
            toggleBottomPanel() {
                if (!App.dom.bottom_panel || !App.dom.resizer_h || !App.dom.main_grid) {
                    [cite_start]console.error("Bottom panel or grid elements not found for toggleBottomPanel."); [cite: 386]
                    return;
                }

                [cite_start]const isVisible = App.dom.bottom_panel.style.display !== 'none'; [cite: 387]
                if (isVisible) {
                    [cite_start]App.dom.bottom_panel.style.display = 'none'; [cite: 388]
                    [cite_start]App.dom.resizer_h.style.display = 'none'; [cite: 388]
                    [cite_start]App.dom.main_grid.style.gridTemplateRows = '35px 1fr 0px 0px 24px'; [cite: 389]
                } else {
                    [cite_start]this.switchBottomPanel(App.state.activeBottomPanel); [cite: 390]
                }
                [cite_start]App.settings.resizeAllEditors(); [cite: 391]
            },
            showNotification(msg, type = 'success') {
                [cite_start]const toast = App.dom.notification_toast; [cite: 392]
                if (!toast) {
                    [cite_start]console.warn("Notification toast element not found."); [cite: 393]
                    return;
                }
                [cite_start]toast.textContent = msg; [cite: 394]
                toast.style.backgroundColor = type === 'error' ? [cite_start]'var(--ide-error-color)' : (type === 'warning' ? 'var(--ide-warning-color)' : 'var(--ide-accent-primary)'); [cite: 394]
                toast.classList.remove('opacity-0');
                [cite_start]setTimeout(() => toast.classList.add('opacity-0'), 3000); [cite: 395]
            },
            showModal(content) {
                if (!App.dom.modal_overlay) {
                    [cite_start]console.error("Modal overlay element not found, cannot show modal."); [cite: 396]
                    return;
                }
                [cite_start]App.dom.modal_overlay.innerHTML = ''; [cite: 397]
                App.dom.modal_overlay.appendChild(content);
                App.dom.modal_overlay.classList.remove('hidden');
            },
            hideModal() { 
                if (App.dom.modal_overlay) {
                    [cite_start]App.dom.modal_overlay.classList.add('hidden'); [cite: 398]
                } else {
                    [cite_start]console.warn("Modal overlay element not found, cannot hide modal."); [cite: 399]
                }
            },
            // Helper function to get node from explorer;
            getCurrentNodeFromExplorer(nodeId) {
                [cite_start]// For simplicity, assuming nodes in explorer are kept in a local structure or can be quickly retrieved. [cite: 400, 401]
                [cite_start]// If this needs to hit IndexedDB, it should be async. [cite: 402]
                // For now, let's just return a dummy type based on the ID for context menu, or make it async and fetch from App.fs
                [cite_start]// This is a placeholder, you might need to implement actual logic to retrieve the node object from your VFS. [cite: 403]
                [cite_start]// For a robust solution, you might query App.fs.getNode(nodeId) here (making showContextMenu async). [cite: 404]
                // But for now, we'll simulate based on common IDs.
                [cite_start]if (nodeId === '/') return { type: 'folder' }; [cite: 404]
                if (nodeId && nodeId.includes('file-')) return { type: 'file' }; [cite_start]// Dummy check for example [cite: 405]
                if (nodeId && nodeId.includes('folder-')) return { type: 'folder' }; [cite_start]// Dummy check for example [cite: 406]
                
                // Fallback: If target element has a dataset.path, try to infer type from extension or fetch from FS
                [cite_start]const selectedEl = document.querySelector(`.file-item[data-id="${nodeId}"]`); [cite: 407]
                if (selectedEl && selectedEl.dataset.path) {
                    [cite_start]const path = selectedEl.dataset.path; [cite: 408]
                    [cite_start]const parts = path.split('.'); [cite: 408]
                    [cite_start]const ext = parts[parts.length - 1]; [cite: 409]
                    if (['py', 'js', 'html', 'lua', 'md', 'txt'].includes(ext)) {
                        [cite_start]return { type: 'file' }; [cite: 410]
                    }
                    [cite_start]// This is a weak inference. [cite: 411] A stronger solution would be to await App.fs.getNode(nodeId)
                    [cite_start]// and use its actual `type` property. [cite: 412]
                }
                [cite_start]return null; [cite: 413]
            }
        },
        
        layout: {
            init() {
                const onDrag = (resizer, onMove, onEnd) => resizer?.addEventListener('mousedown', e => { // Add nullish coalescing
                    e.preventDefault(); 
                    [cite_start]const cb = (ev)=>onMove(ev); [cite: 414]
                    const upCb = () => { 
                        document.removeEventListener('mousemove', cb); 
                        if(onEnd) onEnd(); 
                    [cite_start]}; [cite: 415]
                    document.addEventListener('mousemove', cb); 
                    document.addEventListener('mouseup', upCb, { once: true }); 
                });
                // Add null checks for resizers before attaching event listeners
                if (App.dom.resizer_v) {
                    onDrag(App.dom.resizer_v, e => {
                        const newSidebarWidth = e.clientX - 48; 
                        [cite_start]if (newSidebarWidth > 150 && newSidebarWidth < window.innerWidth / 2) { [cite: 417]
                            App.dom.main_grid.style.gridTemplateColumns = `48px ${newSidebarWidth}px 5px 1fr`;
                        }
                    }, () => {
                        [cite_start]App.state.settings.layout.sidebar = App.dom.main_grid.style.gridTemplateColumns.split(' ')[1]; [cite: 418]
                        App.settings.save();
                        App.settings.resizeAllEditors();
                    [cite_start]}); [cite: 419]
                } else {
                    [cite_start]console.warn("Vertical resizer (resizer_v) not found."); [cite: 420]
                }

                if (App.dom.resizer_h) {
                    onDrag(App.dom.resizer_h, e => {
                        const newPanelHeight = window.innerHeight - e.clientY - 24; 
                        [cite_start]if (newPanelHeight > 100 && newPanelHeight < window.innerHeight / 2) { [cite: 421]
                            App.dom.main_grid.style.gridTemplateRows = `35px 1fr 5px ${newPanelHeight}px 24px`;
                        }
                    }, () => {
                        [cite_start]App.state.settings.layout.panel = App.dom.main_grid.style.gridTemplateRows.split(' ')[3]; [cite: 422]
                        App.settings.save();
                        App.settings.resizeAllEditors();
                    [cite_start]}); [cite: 423]
                } else {
                    [cite_start]console.warn("Horizontal resizer (resizer_h) not found."); [cite: 424]
                }
            },
            toggleSplitView() {
                if (!App.dom.editor_groups_container) {
                    [cite_start]console.error("Editor groups container not found, cannot toggle split view."); [cite: 425]
                    return;
                }

                [cite_start]App.state.isSplitView = !App.state.isSplitView; [cite: 426]
                [cite_start]const container = App.dom.editor_groups_container; [cite: 426]
                if (App.state.isSplitView) {
                    [cite_start]container.classList.add('split'); [cite: 427]
                    const group2HTML = `<div id="editor-group-2" class="editor-group"><div class="editor-tabs flex-shrink-0 flex bg-[var(--ide-bg-tertiary)] overflow-x-auto"></div><div class="editor-pane flex-1 relative"></div></div>`;
                    [cite_start]const resizerHTML = `<div id="editor-resizer-v-editor"></div>`; [cite: 428]
                    // Renamed for clarity, to avoid conflict with main resizer-v
                    [cite_start]// Insert adjacent HTML; [cite: 429] must ensure the element exists
                    if (App.dom.editor_group_1?.group) {
                         [cite_start]App.dom.editor_group_1.group.insertAdjacentHTML('afterend', resizerHTML + group2HTML); [cite: 430]
                         // Re-cache specific elements after they are added to DOM
                         [cite_start]App.dom.editor_resizer_v_editor = document.getElementById('editor-resizer-v-editor'); [cite: 431]
                    } else {
                        [cite_start]console.error("editor-group-1 not found for split view creation."); [cite: 432]
                        App.state.isSplitView = false; [cite_start]// Revert state if creation failed [cite: 432]
                        [cite_start]return; [cite: 433]
                    }
                   
                    App.dom.editor_group_2 = {
                        group: document.getElementById('editor-group-2'),
                        tabs: document.querySelector('#editor-group-2 .editor-tabs'),
                        [cite_start]pane: document.querySelector('#editor-group-2 .editor-pane'), [cite: 434]
                    };
                    [cite_start]App.editor.createEditorInstance('pane2'); [cite: 435]
                    App.state.activePane = 'pane2'; 
                    App.state.editors.pane2.focus();

                    // Add drag logic for the new editor-specific resizer
                    if (App.dom.editor_resizer_v_editor) {
                        const editorResizer = App.dom.editor_resizer_v_editor;
                        editorResizer.style.backgroundColor = 'var(--ide-border-primary)'; [cite_start]// Apply style [cite: 436]
                        editorResizer.style.cursor = 'col-resize'; [cite_start]// Apply cursor [cite: 437]
                        
                        editorResizer.addEventListener('mousedown', e => {
                            e.preventDefault();
                            [cite_start]const editorGroup1 = App.dom.editor_group_1.group; [cite: 438]
                            const editorGroup2 = App.dom.editor_group_2.group;
                            const startX = e.clientX;
                            [cite_start]const initialWidth1 = editorGroup1.offsetWidth; [cite: 439]
                            const initialWidth2 = editorGroup2.offsetWidth;
                            const containerWidth = editorGroup1.parentElement.offsetWidth; // editor-groups-container

                            [cite_start]const onMouseMove = (moveEvent) => { [cite: 440]
                                const deltaX = moveEvent.clientX - startX;
                                let newWidth1 = initialWidth1 + deltaX;
                                [cite_start]let newWidth2 = initialWidth2 - deltaX; [cite: 441]

                                // Prevent pane from becoming too small
                                [cite_start]const minWidth = 100; [cite: 442]
                                if (newWidth1 < minWidth) {
                                    [cite_start]newWidth1 = minWidth; [cite: 442]
                                    [cite_start]newWidth2 = containerWidth - newWidth1 - editorResizer.offsetWidth; [cite: 443]
                                }
                                if (newWidth2 < minWidth) {
                                    [cite_start]newWidth2 = minWidth; [cite: 444]
                                    [cite_start]newWidth1 = containerWidth - newWidth2 - editorResizer.offsetWidth; [cite: 444]
                                }

                                [cite_start]editorGroup1.style.flexBasis = `${newWidth1}px`; [cite: 445]
                                [cite_start]editorGroup2.style.flexBasis = `${newWidth2}px`; [cite: 445]
                                editorGroup1.style.flexGrow = '0'; [cite_start]// Fix flex-grow to maintain sizes during drag [cite: 446]
                                [cite_start]editorGroup2.style.flexGrow = '0'; [cite: 446]
                            };

                            const onMouseUp = () => {
                                [cite_start]document.removeEventListener('mousemove', onMouseMove); [cite: 447]
                                [cite_start]document.removeEventListener('mouseup', onMouseUp); [cite: 447]
                                // Reset flex-grow to 1 to allow resizing with window, but retain proportions
                                [cite_start]App.dom.editor_group_1.group.style.flexGrow = '1'; [cite: 448]
                                [cite_start]App.dom.editor_group_2.group.style.flexGrow = '1'; [cite: 448]
                                App.settings.resizeAllEditors();
                            };

                            document.addEventListener('mousemove', onMouseMove);
                            document.addEventListener('mouseup', onMouseUp);
                        });
                    [cite_start]} [cite: 449]

                } else {
                    [cite_start]container.classList.remove('split'); [cite: 450]
                    // Merge pane2 files into pane1 before removing pane2
                    App.state.openFiles.pane2.forEach((fileData, path) => {
                        // Only open if not already open in pane1 to avoid duplicates
                        if (!App.state.openFiles.pane1.has(path)) {
                            [cite_start]App.files.open(path, 'pane1', fileData.isUntitled, fileData.session.getValue()); [cite: 451]
                        }
                    });
                    [cite_start]document.getElementById('editor-group-2')?.remove(); [cite: 452]
                    document.getElementById('editor-resizer-v-editor')?.remove(); // Remove the editor-specific resizer
                    [cite_start]App.state.editors.pane2 = null; [cite: 453]
                    [cite_start]App.state.openFiles.pane2.clear(); [cite: 453]
                    App.state.activePaths.pane2 = null;
                    App.state.activePane = 'pane1'; 
                    // Set focus back to pane1's current active file, or first file if available
                    if (App.state.openFiles.pane1.size > 0) {
                        [cite_start]App.files.switch([...App.state.openFiles.pane1.keys()][App.state.openFiles.pane1.size -1], 'pane1'); [cite: 454]
                    } else {
                        // If pane1 also has no open files, show welcome screen
                        [cite_start]App.dom.welcome_screen.style.display = 'flex'; [cite: 455]
                    }
                }
                [cite_start]App.settings.resizeAllEditors(); [cite: 456]
            }
        },

        files: {
            async open(path, paneId = App.state.activePane, isUntitled = false, content = '') {
                // Ensure targetPaneId is valid even if split view is toggled off
                [cite_start]const targetPaneId = App.state.isSplitView ? paneId : 'pane1'; [cite: 457]

                // If trying to open in pane2 but split view is off, toggle it on first
                if (paneId === 'pane2' && !App.state.isSplitView) { 
                    [cite_start]App.layout.toggleSplitView(); [cite: 458]
                }

                // If file is already open in the target pane, just switch to it
                [cite_start]if (App.state.openFiles[targetPaneId].has(path)) return this.switch(path, targetPaneId); [cite: 459]
                let fileContent = content;
                if (!isUntitled) {
                    try {
                        [cite_start]const file = await App.fs.getNodeByPath(path); [cite: 460]
                        if (!file || file.type !== 'file') {
                            [cite_start]App.ui.showNotification(`Could not open: ${path}. Not a file or not found.`, 'error'); [cite: 461]
                            return;
                        }
                        [cite_start]// For non-text files (e.g., images), we should not attempt to read as string directly for Ace editor. [cite: 462]
                        [cite_start]// For this IDE, assuming most files opened in editor are text-based. [cite: 463]
                        [cite_start]// If it's a binary file, content will be a Blob, and Ace editor can't display it. [cite: 464]
                        // You might want a different handler for binary files (e.g., download or image preview)
                        if (file.mimeType && !file.mimeType.startsWith('text/')) {
                            [cite_start]App.ui.showNotification(`Cannot open binary file '${file.name}' in editor.`, 'warning'); [cite: 465]
                            return;
                        }
                        [cite_start]fileContent = await App.fs.read(file.id, 'string'); [cite: 466]
                    } catch (error) {
                        [cite_start]App.ui.showNotification(`Error reading file ${path}: ${error.message}`, 'error'); [cite: 467]
                        return;
                    }
                }
                
                if (App.dom.welcome_screen) { // Check if welcome screen element exists
                    [cite_start]App.dom.welcome_screen.style.display = 'none'; [cite: 468]
                }

                [cite_start]const modelist = ace.require("ace/ext/modelist"); [cite: 469]
                const mode = modelist.getModeForPath(path).mode;
                const session = ace.createEditSession(fileContent, mode);
                App.linter.setAnnotations(session, path);

                [cite_start]const tabEl = document.createElement('div'); [cite: 470]
                tabEl.className = 'editor-tab px-4 py-2 border-r border-[var(--ide-border-primary)] cursor-pointer flex items-center gap-2 flex-shrink-0';
                [cite_start]tabEl.dataset.path = path; tabEl.title = path; [cite: 471]
                const fileName = path.split('/').pop();
                tabEl.innerHTML = `<span class="tab-name">${fileName}</span><span class="close-tab text-xs p-0.5 rounded-full hover:bg-black/20" title="Ctrl+Shift+W">x</span>`;
                
                [cite_start]const domInfo = App.ui.getPaneDom(targetPaneId); [cite: 472]
                if (domInfo.tabs) { // Check if tabs element exists
                    [cite_start]domInfo.tabs.appendChild(tabEl); [cite: 473]
                } else {
                    [cite_start]console.error(`Editor tabs element for pane '${targetPaneId}' not found.`); [cite: 474]
                    return;
                }
                
                [cite_start]tabEl.onclick = () => this.switch(path, targetPaneId); [cite: 475]
                const closeButton = tabEl.querySelector('.close-tab');
                if (closeButton) {
                    [cite_start]closeButton.onclick = (e) => { e.stopPropagation(); [cite: 476] this.close(path, false, targetPaneId); };
                } else {
                    [cite_start]console.warn("Close tab button not found for new tab."); [cite: 477]
                }
                
                [cite_start]App.state.openFiles[targetPaneId].set(path, { session, tabEl, isUntitled }); [cite: 478]
                this.switch(path, targetPaneId);
                App.linter.lintFile(path, fileContent);
                App.preview.update(path, fileContent);
            },
            openUntitled(lang = 'js') {
                [cite_start]const ext = lang; [cite: 479]
                const path = `Untitled-${App.state.untitledCounter++}.${ext}`;
                const templates = {
                    js: '// New JavaScript File',
                    py: '# New Python File',
                    lua: '-- New Lua File',
                    [cite_start]html: '<!DOCTYPE html>\n<html>\n<head>\n  <title>New HTML File</title>\n</head>\n<body>\n\n</body>\n</html>', [cite: 480]
                };
                [cite_start]this.open(path, App.state.activePane, true, templates[ext]); [cite: 481]
            },
            switch(path, paneId) {
                [cite_start]if (App.state.activePaths[paneId] === path) return; [cite: 482]
                const oldPath = App.state.activePaths[paneId];
                if(oldPath && App.state.openFiles[paneId].has(oldPath)) {
                    [cite_start]App.state.openFiles[paneId].get(oldPath).tabEl.classList.remove('active'); [cite: 483]
                }
                
                [cite_start]App.state.activePaths[paneId] = path; [cite: 484]
                const data = App.state.openFiles[paneId].get(path);
                if (!data) {
                    [cite_start]console.error(`No file data found for path: ${path} in pane: ${paneId}`); [cite: 485]
                    // Optionally close the tab if data is missing or switch to another valid tab
                    [cite_start]this.close(path, true, paneId); [cite: 486]
                    return;
                }
                data.tabEl.classList.add('active');
                App.state.editors[paneId].setSession(data.session);
                [cite_start]App.state.editors[paneId].focus(); [cite: 487]
                this.updateRunButtonState(path);
                App.ui.updateStatus();
                App.preview.update(path, data.session.getValue());
            },
            close(path, force = false, paneId) {
                [cite_start]if (!paneId || !App.state.openFiles[paneId]) return; [cite: 488]
                const data = App.state.openFiles[paneId].get(path); if (!data) return;
                if (data.tabEl.classList.contains('modified') && !force) {
                    [cite_start]if(!confirm(`'${path}' has unsaved changes. Close anyway?`)) return; [cite: 489]
                }
                [cite_start]const domInfo = App.ui.getPaneDom(paneId); [cite: 490]
                if (domInfo.tabs && data.tabEl) { // Check before attempting to removeChild
                    [cite_start]domInfo.tabs.removeChild(data.tabEl); [cite: 491]
                } else {
                    [cite_start]console.warn(`Could not remove tab element for path ${path} in pane ${paneId}.`); [cite: 492]
                }
                [cite_start]App.state.openFiles[paneId].delete(path); [cite: 493]
                if (App.state.activePaths[paneId] === path) {
                    [cite_start]const remainingPaths = [...App.state.openFiles[paneId].keys()]; [cite: 494]
                    const nextPath = remainingPaths.pop();
                    if (nextPath) this.switch(nextPath, paneId);
                    else {
                        [cite_start]App.state.activePaths[paneId] = null; [cite: 495]
                        if(App.state.openFiles.pane1.size === 0 && (!App.state.isSplitView || App.state.openFiles.pane2.size === 0)) {
                           if (App.dom.welcome_screen) { // Check if welcome screen element exists
                               [cite_start]App.dom.welcome_screen.style.display = 'flex'; [cite: 496]
                           }
                        }
                        [cite_start]if (App.state.activePane === paneId) this.updateRunButtonState(null); [cite: 497]
                        App.ui.updateStatus();
                        App.preview.update(null, ''); // Clear preview
                    }
                }
            },
            async save(paneId) {
                const targetPaneId = paneId || [cite_start]App.state.activePane; [cite: 498]
                const path = App.state.activePaths[targetPaneId];
                if (!path) return;
                const data = App.state.openFiles[targetPaneId].get(path); if (!data) return;
                [cite_start]if (data.isUntitled) { App.events.showSaveAsModal(path, targetPaneId); [cite: 499] return; }
                
                [cite_start]const fileNode = await App.fs.getNodeByPath(path); [cite: 500]
                const newContent = data.session.getValue();
                
                let originalContent = '';
                if (fileNode) {
                    [cite_start]originalContent = await App.fs.read(fileNode.id, 'string'); [cite: 501]
                }

                if(originalContent !== newContent) {
                    try {
                        [cite_start]await App.fs.write(path, newContent); [cite: 502]
                        if (data.tabEl) { // Check if tabEl exists
                            [cite_start]data.tabEl.classList.remove('modified'); [cite: 503]
                        }
                        [cite_start]App.linter.lintFile(path, newContent); [cite: 504]
                        App.preview.update(path, newContent);
                        if (!App.state.settings.autoSave) App.ui.showNotification(`${path.split('/').pop()} saved.`, 'success');
                    } catch (error) {
                        [cite_start]App.ui.showNotification(`Failed to save ${path.split('/').pop()}: ${error.message}`, 'error'); [cite: 505]
                        console.error('Save error:', error);
                    }
                } else {
                    if (data.tabEl) { // Check if tabEl exists
                       [cite_start]data.tabEl.classList.remove('modified'); [cite: 506]
                    }
                }
            },
            async runActive() {
                [cite_start]const paneId = App.state.activePane; [cite: 507]
                const path = App.state.activePaths[paneId];
                if (!path) return App.ui.showNotification('No active file to run.', 'error');
                
                await this.save(paneId); [cite_start]// Auto-save before running [cite: 508]

                [cite_start]const ext = path.split('.').pop(); [cite: 509]
                const languageMap = { 'js': 'javascript', 'py': 'python', 'lua': 'lua', 'html': 'html' };
                [cite_start]const language = languageMap[ext]; [cite: 510]
                if (language) {
                    // Check environment readiness before running
                    if (language === 'python' && !App.state.pyodideReady) {
                        return App.terminal.loadPython();
                    }
                    if (language === 'lua' && !App.state.luaReady) {
                         return App.terminal.loadLua();
                    }

                    [cite_start]const content = App.state.openFiles[paneId].get(path).session.getValue(); [cite: 513]
                    App.terminal.runScriptContent(language, content, path); // Run in internal terminal
                    App.ui.switchBottomPanel('internal-terminal'); [cite_start]// Switch to internal terminal panel [cite: 514]
                    // Notify desktop.html about terminal activity
                    if (window.parent) {
                        [cite_start]window.parent.postMessage({ type: 'terminalActivity' }, '*'); [cite: 515]
                    }
                } else {
                    [cite_start]return App.ui.showNotification(`Cannot run .${ext} files directly.`, 'error'); [cite: 516]
                }
            },
            updateRunButtonState(path) {
                if (!App.dom.run_btn) { // Add null check for run_btn
                    [cite_start]console.warn("Run button element not found, cannot update its state."); [cite: 517]
                    return;
                }
                if (!path) { 
                    [cite_start]App.dom.run_btn.disabled = true; [cite: 518]
                    return; 
                }
                [cite_start]const ext = path.split('.').pop(); [cite: 519]
                const isRunnable = ['js', 'py', 'lua', 'html'].includes(ext);
                App.dom.run_btn.disabled = !isRunnable;
            }
        },
        
        terminal: { // Internal Terminal Module
            dom: { output: null, loadingOverlay: null, loadingText: null }, 
            state: {
                pyodideLoading: false,
                pyodideReady: false,
                [cite_start]luaLoading: false, [cite: 523]
                luaReady: false,
            },
            init() {
                // Ensure DOM elements are cached and available before use
                [cite_start]this.dom.output = App.dom.terminal_output_log; [cite: 524]
                this.dom.loadingOverlay = App.dom.terminal_loading_overlay;
                this.dom.loadingText = App.dom.terminal_loading_text;

                if (this.dom.output) { // Check if output element is available before clearing
                    [cite_start]this.clear(); [cite: 525]
                } else {
                    [cite_start]console.error("Terminal output element not found, cannot initialize terminal display."); [cite: 526]
                    [cite_start]this.log("Error: Terminal display is unavailable. Please check HTML structure.", "error"); [cite: 527]
                }
            },
            async loadPython() {
                if (this.state.pyodideReady || this.state.pyodideLoading) {
                    if(this.state.pyodideLoading) App.ui.showNotification('Python is already loading. Please wait.', 'info');
                    return;
                }
                
                this.state.pyodideLoading = true;
                this.dom.loadingOverlay.classList.remove('hidden');
                this.dom.loadingText.textContent = 'Loading Python environment...';
                this.log('Loading Python (Pyodide) environment...', 'info');

                try {
                    [cite_start]App.state.pyodide = await loadPyodide(); [cite: 531]
                    App.state.pyodide.setStdout({ batched: (str) => this.log(str) });
                    App.state.pyodide.setStderr({ batched: (str) => this.log(str, 'error') });
                    this.state.pyodideReady = true;
                    App.state.pyodideReady = true;
                    [cite_start]this.log('Python environment ready.', 'info'); [cite: 532]
                    App.ui.showNotification('Python environment is ready. You can run the code now.', 'success');
                    App.files.runActive(); // Retry running after successful load
                } catch (error) {
                    [cite_start]this.log(`Failed to load Python environment: ${error}`, 'error'); [cite: 533]
                    console.error("Python environment load error:", error); // Detailed console error
                } finally {
                    [cite_start]this.state.pyodideLoading = false; [cite: 534]
                    this.dom.loadingOverlay.classList.add('hidden');
                }
            },
            async loadLua() {
                if (this.state.luaReady || this.state.luaLoading) {
                    if(this.state.luaLoading) App.ui.showNotification('Lua is already loading. Please wait.', 'info');
                    return;
                }

                this.state.luaLoading = true;
                this.log('Initializing Lua (Fengari) environment...', 'info');

                try {
                    [cite_start]App.state.fengari = window.fengari; [cite: 537]
                    if (App.state.fengari) {
                        [cite_start]this.state.luaReady = true; [cite: 538]
                        App.state.luaReady = true;
                        [cite_start]this.log('Lua environment ready.', 'info'); [cite: 538]
                        App.ui.showNotification('Lua environment is ready. You can run the code now.', 'success');
                        App.files.runActive(); // Retry running after successful load
                    } else {
                        [cite_start]throw new Error("Fengari (Lua) library not found. Make sure it's loaded."); [cite: 539]
                    }
                } catch (error) {
                    [cite_start]this.log(`Failed to load Lua environment: ${error}`, 'error'); [cite: 540]
                    console.error("Lua environment load error:", error); // Detailed console error
                } finally {
                    [cite_start]this.state.luaLoading = false; [cite: 541]
                }
            },
            log(msg, level = 'log') {
                if (!this.dom.output) { // Ensure output element is defined before appending
                    [cite_start]console.error("Terminal output element is not defined, cannot log message:", msg); [cite: 544]
                    return;
                }
                [cite_start]const line = document.createElement('div'); [cite: 545]
                line.className = 'terminal-output-line';
                if (level === 'error') line.classList.add('terminal-output-error');
                if (level === 'warning') line.classList.add('terminal-output-warning');
                [cite_start]if (level === 'info') line.classList.add('terminal-output-info'); [cite: 546]
                if (level === 'prompt') line.classList.add('terminal-output-prompt');

                line.innerHTML = String(msg)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    [cite_start].replace(/'/g, "&#039;") [cite: 547]
                    .replace(/\n/g, '<br>'); 

                this.dom.output.appendChild(line);
                this.dom.output.scrollTop = this.dom.output.scrollHeight; 
            },
            clear() {
                if (this.dom.output) { // Ensure output element is defined before clearing
                    this.dom.output.innerHTML = ''; 
                    this.log('Index-Space IDE Terminal.', 'info');
                    this.log('Type your commands here or run scripts from the editor.', 'info');
                } else {
                    [cite_start]console.warn("Attempted to clear terminal but output element is not defined."); [cite: 548, 549]
                }
            },

            async runScriptContent(language, content, path = 'memory') {
                [cite_start]this.log(`\n$ Running ${language} script (${path})...`, 'prompt'); [cite: 550]
                try {
                    switch(language) {
                        case 'javascript':
                            [cite_start]const originalConsoleLog = console.log; [cite: 552]
                            [cite_start]const originalConsoleError = console.error; [cite: 552]
                            const capturedLogs = [];
                            const capturedErrors = [];

                            [cite_start]console.log = (...args) => capturedLogs.push(args.map(a => String(a)).join(' ')); [cite: 553]
                            [cite_start]console.error = (...args) => capturedErrors.push(args.map(a => String(a)).join(' ')); [cite: 553]

                            try {
                                [cite_start]new Function(content)(); [cite: 554]
                            } catch (e) {
                                [cite_start]capturedErrors.push(`Runtime Error: ${e.stack || e.message}`); [cite: 555]
                            } finally {
                                [cite_start]console.log = originalConsoleLog; [cite: 556]
                                [cite_start]console.error = originalConsoleError; [cite: 556]
                            }

                            [cite_start]if (capturedLogs.length > 0) this.log(capturedLogs.join('\n')); [cite: 557]
                            [cite_start]if (capturedErrors.length > 0) this.log(capturedErrors.join('\n'), 'error'); [cite: 557]
                            break;
                        case 'python':
                            if (App.state.pyodideReady && App.state.pyodide) {
                                [cite_start]await App.state.pyodide.runPythonAsync(content); [cite: 558]
                            } else {
                                [cite_start]this.log('Python environment not ready or not loaded.', 'error'); [cite: 559]
                            }
                            break;
                        [cite_start]case 'lua': [cite: 560]
                            if (App.state.luaReady && App.state.fengari) {
                                [cite_start]const fengari = App.state.fengari; [cite: 561]
                                const L = fengari.lauxlib.luaL_newstate();
                                fengari.lualib.luaL_openlibs(L);

                                const capturedLuaOutput = [];
                                fengari.lua.lua_pushcfunction(L, () => {
                                    const nargs = fengari.lua.lua_gettop(L);
                                    let s = "";
                                    [cite_start]for (let i = 1; i <= nargs; i++) { [cite: 562]
                                        s += fengari.lua.lua_tojsstring(L, i);
                                        [cite_start]if (i < nargs) s += "\t"; [cite: 563]
                                    }
                                    capturedLuaOutput.push(s);
                                    [cite_start]return 0; [cite: 564]
                                });
                                [cite_start]fengari.lua.lua_setglobal(L, "print"); [cite: 565]

                                const status = fengari.lualib.luaL_dostring(L, fengari.to_luastring(content));
                                if (status !== 0) {
                                    [cite_start]this.log(fengari.lua.lua_tojsstring(L, -1), 'error'); [cite: 566]
                                }
                                [cite_start]if (capturedLuaOutput.length > 0) this.log(capturedLuaOutput.join('\n')); [cite: 567]
                            } else {
                                [cite_start]this.log('Lua environment not ready or not loaded.', 'error'); [cite: 568]
                            }
                            break;
                        [cite_start]case 'html': [cite: 569]
                            [cite_start]App.ui.showNotification("HTML files are displayed in the Preview panel.", "info"); [cite: 570]
                            [cite_start]App.ui.switchBottomPanel('preview'); [cite: 570]
                            break;
                        default:
                            [cite_start]this.log(`No runtime available for ${language} scripts.`, 'error'); [cite: 571]
                    }
                } catch (e) {
                    [cite_start]this.log(`Execution Error for ${language}: ${e.stack || e.message}`, 'error'); [cite: 572]
                    console.error(`Full error for ${language} execution:`, e);
                } finally {
                    [cite_start]this.log(`--- End of ${language} execution ---`, 'info'); [cite: 573]
                    if (this.dom.output) { // Ensure output element exists before scrolling
                        [cite_start]this.dom.output.scrollTop = this.dom.output.scrollHeight; [cite: 574]
                    }
                }
            }
        },
        
        linter: {
            lintFile(path, content) {
                [cite_start]const ext = path.split('.').pop(); [cite: 575]
                const problems = [];
                const lines = content.split('\n');

                lines.forEach((line, i) => {
                    if (ext === 'js' && /var\s/.test(line)) {
                        problems.push({ row: i, column: 0, text: 'Consider using `let` or `const` instead of `var`.', type: 'warning' });
                    }
                    if (ext === 'py' && /print\s/.test(line) && !/print\(/.test(line) && !line.trim().startsWith('#')) {
                        problems.push({ row: i, column: 0, text: 'Python 3 requires `print(...)` syntax.', type: 'error' });
                    [cite_start]} [cite: 576]
                    // Basic HTML tag check for unclosed tags (very simple, not comprehensive)
                    if (ext === 'html') {
                        const openTags = [];
                        const matches = line.match(/<(\/?)([a-z][a-z0-9]*)\b[^>]*>/ig);
                        if (matches) {
                            matches.forEach(match => {
                                const isClosing = match.startsWith('</');
                                [cite_start]const tagName = match.match(/<(\/?)(\w+)/i)?.[2]?.toLowerCase(); [cite: 579]
                                if (tagName) {
                                    if (isClosing) {
                                        if (openTags.length > 0 && openTags[openTags.length - 1] === tagName) {
                                            [cite_start]openTags.pop(); [cite: 581]
                                        } else {
                                            [cite_start]problems.push({ row: i, column: line.indexOf(match), text: `Unmatched closing tag '</${tagName}>'.`, type: 'error' }); [cite: 582, 583]
                                        }
                                    } else {
                                        [cite_start]// Self-closing tags in HTML (e.g., <img />, <br />) can be complex. [cite: 584]
                                        // For simplicity, this linter only flags unclosed pairs.
                                        [cite_start]// A more robust HTML linter would need a proper HTML parser. [cite: 585]
                                        if (!match.endsWith('/>')) { // rudimentary check for non-self-closing
                                            [cite_start]openTags.push(tagName); [cite: 586]
                                        }
                                    }
                                }
                            [cite_start]}); [cite: 587]
                        }
                        // After processing a line, check if any unclosed tags remain for that line (might be false positive for multiline tags)
                        [cite_start]// A more precise linter would check after parsing the whole document. [cite: 588]
                        [cite_start]// For now, let's keep the simple line-by-line checks as per original. [cite: 589]
                        // Removed the original problematic HTML linting logic: `if (ext === 'html' && /<\/?([a-z][a-z0-9]*)\b[^>]*>/i.test(line) && !/<(\w+)[^>]*>.*<\/\1>/.test(line))`
                        [cite_start]// This was too broad and could generate many false positives. [cite: 590]
                    [cite_start]} [cite: 577, 578]
                });
                // Final check for unclosed HTML tags after all lines (simplified; a proper linter would be more complex)
                [cite_start]let tempOpenTags = []; [cite: 591]
                let lineNumMap = new Map(); [cite_start]// To track where a tag was opened [cite: 592]
                let charCount = 0; [cite_start]// To track character index for column [cite: 593]

                content.split('\n').forEach((line, i) => {
                    // Reset character count for each line to get column accurately
                    charCount = 0; 
                    [cite_start]const matches = [...line.matchAll(/<(\/?)([a-z][a-z0-9]*)\b[^>]*>/ig)]; // Use matchAll for index [cite: 594]
                    matches.forEach(match => {
                        const isClosing = match[1] === '/';
                        const tagName = match[2]?.toLowerCase();
                        [cite_start]const col = match.index; // Column is directly from match.index [cite: 595]

                        if (tagName) {
                            if (isClosing) {
                                [cite_start]const openTagIndex = tempOpenTags.lastIndexOf(tagName); [cite: 596]
                                if (openTagIndex !== -1) {
                                    tempOpenTags.splice(openTagIndex, 1);
                                [cite_start]} else { [cite: 597]
                                    [cite_start]problems.push({ row: i, column: col, text: `Unmatched closing tag '</${tagName}>'.`, type: 'error' }); [cite: 598]
                                }
                            } else {
                                if (!match[0].endsWith('/>') && !['br', 'img', 'input', 'link', 'meta', 'hr', 'source', 'area', 'base', 'col', 'embed', 'keygen', 'param', 'track', 'wbr'].includes(tagName)) { // Self-closing exceptions
                                    [cite_start]tempOpenTags.push(tagName); [cite: 599]
                                    [cite_start]lineNumMap.set(tagName, { row: i, column: col }); [cite: 600]
                                }
                            }
                        }
                    [cite_start]}); [cite: 601]
                });

                // Add problems for any remaining unclosed tags at the end of the document
                tempOpenTags.forEach(tagName => {
                    const originalPos = lineNumMap.get(tagName);
                    problems.push({ row: originalPos.row, column: originalPos.column, text: `Unclosed tag '<${tagName}>'.`, type: 'error' });
                [cite_start]}); [cite: 602]


                App.state.lintResults[path] = problems;
                this.setAnnotationsForPath(path);
                this.renderProblemsPanel();
            },
            setAnnotationsForPath(path) {
                Object.keys(App.state.editors).forEach(paneId => {
                    if (App.state.activePaths[paneId] === path) {
                        const session = App.state.editors[paneId]?.getSession();
                        [cite_start]if (session) this.setAnnotations(session, path); [cite: 603]
                    }
                [cite_start]}); [cite: 604]
            },
            setAnnotations(session, path) {
                   const problems = App.state.lintResults[path] || [cite_start][]; [cite: 605]
                   session.setAnnotations(problems);
            },
            renderProblemsPanel() {
                [cite_start]const container = App.dom.panel_problems; [cite: 606]
                if (!container) {
                    [cite_start]console.error("Problems panel container not found, cannot render problems."); [cite: 607]
                    return;
                }
                [cite_start]container.innerHTML = ''; [cite: 608]
                let totalProblems = 0;
                
                Object.entries(App.state.lintResults).forEach(([path, problems]) => {
                    if (problems.length > 0) {
                        const fileHeader = document.createElement('div');
                        fileHeader.className = 'p-1 font-bold text-[var(--ide-text-primary)] border-b border-[var(--ide-border-primary)]'; 
                        [cite_start]fileHeader.textContent = path; [cite: 609]
                        container.appendChild(fileHeader);
                        
                        problems.forEach(p => {
                            [cite_start]const item = document.createElement('div'); [cite: 610]
                            item.className = 'problem-item p-1 pl-3 ml-2 text-sm cursor-pointer hover:bg-[var(--ide-bg-hover)]';
                            const icon = p.type === 'error' ? '✖' : '⚠';
                            [cite_start]item.innerHTML = `<span class="text-[var(--ide-text-secondary)]">${icon} Ln ${p.row + 1}:</span> ${p.text}`; [cite: 611]
                            item.style.color = p.type === 'error' ? [cite_start]'var(--ide-error-color)' : 'var(--ide-warning-color)'; [cite: 612]
                            item.onclick = () => {
                                [cite_start]App.files.open(path); [cite: 613]
                                [cite_start]setTimeout(() => App.editor.getActiveEditor().gotoLine(p.row + 1, 0, true), 100); [cite: 613]
                                App.ui.switchBottomPanel('problems'); 
                            };
                            container.appendChild(item);
                            totalProblems++;
                        [cite_start]}); [cite: 614]
                    }
                });
                if (App.dom.problems_count) { // Check before updating textContent
                    [cite_start]App.dom.problems_count.textContent = totalProblems; [cite: 615, 616]
                }
            }
        },
        
        search: {
            init() {
                if (App.dom.search_input) { // Add null check for search_input
                    [cite_start]App.dom.search_input.addEventListener('keydown', e => { if (e.key === 'Enter') this.performSearch(); }); [cite: 617]
                } else {
                    [cite_start]console.warn("Search input element not found, search functionality may be limited."); [cite: 618]
                }
            },
            async performSearch() {
                const query = App.dom.search_input?.value || ''; [cite_start]// Add nullish coalescing [cite: 619]
                if (query.length < 2) {
                    if (App.dom.search_results) {
                        [cite_start]App.dom.search_results.innerHTML = ''; [cite: 620]
                    }
                    [cite_start]return; [cite: 621]
                }
                [cite_start]const resultsContainer = App.dom.search_results; [cite: 622]
                if (!resultsContainer) {
                    [cite_start]console.error("Search results container not found, cannot perform search."); [cite: 623]
                    return;
                }
                [cite_start]resultsContainer.innerHTML = ''; [cite: 624]
                const rootNode = await App.fs.getNodeByPath('/');
                const allFilePaths = await App.fs.getAllFilePaths(rootNode);

                [cite_start]const searchRegex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'); [cite: 625]
                for (const path of allFilePaths) {
                    [cite_start]let content; [cite: 626]
                    try {
                        [cite_start]const node = await App.fs.getNodeByPath(path); [cite: 627]
                        if (!node || node.type !== 'file' || !(node.mimeType && node.mimeType.startsWith('text/'))) {
                            [cite_start]continue; [cite: 628]
                        }
                        [cite_start]content = await App.fs.read(node.id, 'string'); [cite: 629]
                    } catch (e) {
                        [cite_start]console.warn(`Could not read file for search: ${path}`, e); [cite: 630]
                        continue;
                    }
                    
                    [cite_start]const lines = content.split('\n'); [cite: 631]
                    const fileResults = [];
                    lines.forEach((line, i) => {
                        if (line.toLowerCase().includes(query.toLowerCase())) {
                            fileResults.push({ lineNum: i + 1, lineContent: line });
                        }
                    [cite_start]}); [cite: 632]
                    if (fileResults.length > 0) {
                        [cite_start]const fileDiv = document.createElement('div'); [cite: 633, 634]
                        fileDiv.className = 'search-result-file text-[var(--ide-text-secondary)] font-bold p-1 border-b border-[var(--ide-border-primary)]';
                        fileDiv.textContent = path;
                        [cite_start]resultsContainer.appendChild(fileDiv); [cite: 635]
                        fileResults.forEach(res => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'search-result-item p-1 pl-3 ml-2 text-sm cursor-pointer hover:bg-[var(--ide-bg-hover)]';
                            itemDiv.innerHTML = `<span class="text-[var(--ide-text-inactive)]">${res.lineNum}: </span>` + 
                                                 res.lineContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                                                 [cite_start].replace(searchRegex, match => `<span style="background-color: var(--ide-accent-primary); color: var(--ide-bg-primary);">${match}</span>`); [cite: 636, 637]

                            itemDiv.onclick = () => {
                                App.files.open(path);
                                setTimeout(() => App.editor.getActiveEditor()?.gotoLine(res.lineNum, 0, true), 100); [cite_start]// Add null check [cite: 638]
                                App.ui.switchSidebarView('explorer'); 
                            };
                            [cite_start]resultsContainer.appendChild(itemDiv); [cite: 639]
                        });
                    }
                }
            }
        },

        preview: {
            update(path, content) {
                if (!App.dom.preview_frame) {
                    [cite_start]console.warn("Preview frame element not found, cannot update preview."); [cite: 640]
                    return;
                }
                if (path && path.endsWith('.html') && App.state.activePaths[App.state.activePane] === path) {
                    [cite_start]const blob = new Blob([content], { type: 'text/html' }); [cite: 641]
                    const url = URL.createObjectURL(blob);
                    App.dom.preview_frame.src = url;
                    [cite_start]App.dom.preview_frame.onload = () => URL.revokeObjectURL(url); [cite: 642]
                } else if (App.state.activeBottomPanel === 'preview') {
                    [cite_start]App.dom.preview_frame.src = 'about:blank'; [cite: 643]
                }
            }
        },

        snippets: {
            init() {
                [cite_start]const saved = localStorage.getItem('indexspace_ide_snippets_v1'); [cite: 644]
                App.state.userSnippets = saved ? JSON.parse(saved) : [{name: "log", code: "console.log($1);"},{name: "html-base", code: "<!DOCTYPE html>\\n<html>\\n<head>\\n  <title>$1</title>\\n</head>\\n<body>\\n\\n</body>\\n</html>"}];
                [cite_start]this.registerSnippets(); [cite: 645]
            },
            [cite_start]get() { return App.state.userSnippets; [cite: 646] },
            save(snippetsText) {
                try {
                    [cite_start]const parsed = JSON.parse(snippetsText); [cite: 647]
                    App.state.userSnippets = parsed;
                    localStorage.setItem('indexspace_ide_snippets_v1', JSON.stringify(parsed));
                    this.registerSnippets();
                    [cite_start]App.ui.showNotification('Snippets saved and loaded.', 'success'); [cite: 648]
                } catch(e) {
                    [cite_start]App.ui.showNotification('Invalid JSON format for snippets.', 'error'); [cite: 649]
                    App.terminal.log(`Snippet Error: ${e.message}`, 'error');
                }
            },
            registerSnippets() {
                [cite_start]const snippetManager = ace.require("ace/snippets").snippetManager; [cite: 650]
                const snippetText = App.state.userSnippets.map(s => `snippet ${s.name}\n\t${s.code.replace(/\n/g, '\n\t')}`).join('\n');
                ['javascript', 'python', 'lua', 'html'].forEach(mode => { 
                    const snippets = snippetManager.parseSnippetFile(snippetText);
                    snippetManager.register(snippets, mode);
                [cite_start]}); [cite: 651]
            }
        },

        formatter: {
            formatCode(editor) {
                [cite_start]if (!editor) editor = App.editor.getActiveEditor(); [cite: 652]
                const path = App.state.activePaths[App.state.activePane];
                if (!path || !editor) return; // Ensure editor exists before proceeding

                [cite_start]const ext = path.split('.').pop(); [cite: 653]
                const parserMap = { 'js': 'babel', 'py': 'python', 'html': 'html', 'css': 'css' }; 
                [cite_start]const parser = parserMap[ext]; [cite: 653]
                if (!parser || !window.prettier || !window.prettierPlugins) {
                    [cite_start]return App.ui.showNotification(`Formatting not available for .${ext} files (Prettier not loaded or parser missing).`, 'error'); [cite: 654, 655]
                }

                try {
                    [cite_start]const unformatted = editor.getValue(); [cite: 656]
                    const plugins = { 
                        'babel': prettierPlugins.babel, 
                        'python': prettierPlugins.python,
                        'html': prettierPlugins.html, 
                        [cite_start]'css': prettierPlugins.postcss [cite: 657]
                    };
                    const formatted = prettier.format(unformatted, {
                        parser: parser,
                        plugins: [plugins[parser]],
                        semi: true,
                        [cite_start]singleQuote: true, [cite: 659]
                        printWidth: 80,
                        tabWidth: 4,    
                        useTabs: false,
                        [cite_start]htmlWhitespaceSensitivity: 'css', [cite: 660]
                    });
                    [cite_start]const pos = editor.getCursorPosition(); [cite: 661]
                    editor.setValue(formatted, 1);
                    editor.moveCursorTo(pos.row, pos.column);
                    [cite_start]App.ui.showNotification('Code formatted.', 'success'); [cite: 662]
                } catch (e) {
                    [cite_start]App.ui.showNotification('Failed to format code.', 'error'); [cite: 663]
                    App.terminal.log(`Formatter Error: ${e.message}`, 'error');
                }
            }
        },
        
        events: {
            init() {
                // Add null checks for DOM elements before attaching event listeners
                [cite_start]App.dom.activity_bar?.addEventListener('click', e => { const view = e.target.closest('.activity-bar-icon')?.dataset.view; if (view) App.ui.switchSidebarView(view); }); [cite: 664]
                [cite_start]App.dom.bottom_panel?.querySelector('.tabs')?.addEventListener('click', e => { const panel = e.target.closest('.bottom-panel-tab')?.dataset.panel; if (panel) App.ui.switchBottomPanel(panel); }); [cite: 665]
                App.dom.new_untitled_file_global?.onclick = () => this.showNewFileModal();
                App.dom.welcome_new_file_btn?.onclick = () => this.showNewFileModal(); 
                App.dom.new_folder_global?.onclick = () => this.showNewItemModal('folder');
                
                [cite_start]App.dom.file_explorer?.oncontextmenu = (e) => this.showContextMenu(e); [cite: 666]
                App.dom.cmd_palette_btn?.onclick = () => this.showCommandPalette();
                App.dom.beta_palette_btn?.onclick = () => this.showBetaFeaturesPalette();
                App.dom.run_btn?.onclick = () => App.files.runActive();
                App.dom.split_view_btn?.onclick = () => App.layout.toggleSplitView();
                App.dom.save_snippets_btn?.onclick = () => App.snippets.save(App.state.snippetsEditor?.getValue() || ''); [cite_start]// Add null check for snippetsEditor [cite: 667]

                [cite_start]App.dom.explorer_search?.oninput = () => App.ui.renderExplorer(); [cite: 668]
                App.dom.search_input?.oninput = () => App.search.performSearch(); 
                
                App.dom.setting_theme?.onchange = (e) => App.settings.update('theme', e.target.value);
                [cite_start]App.dom.setting_fontsize?.oninput = (e) => App.settings.update('fontSize', parseInt(e.target.value)); [cite: 669]
                App.dom.setting_keymap?.onchange = (e) => App.settings.update('keymap', e.target.value);
                App.dom.setting_linenumbers?.onchange = (e) => App.settings.update('showLineNumbers', e.target.checked);
                [cite_start]App.dom.setting_minimap?.onchange = (e) => App.settings.update('showMinimap', e.target.checked); [cite: 670]
                App.dom.setting_wordwrap?.onchange = (e) => App.settings.update('wordWrap', e.target.checked);
                App.dom.setting_autosave?.onchange = (e) => App.settings.update('autoSave', e.target.checked);
                
                [cite_start]App.dom.file_importer?.onchange = (e) => this.readAndCreateFiles(e.target.files); [cite: 671]
                App.dom.view_explorer?.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; }); // Changed from explorerEl to App.dom.view_explorer
                App.dom.view_explorer?.addEventListener('drop', e => { e.preventDefault(); this.handleFileDrop(e); }); [cite_start]// Changed from explorerEl to App.dom.view_explorer [cite: 672]
                
                document.addEventListener('click', (e) => { 
                    if (App.dom.context_menu && !e.target.closest('#context-menu')) { // Add null check
                        App.dom.context_menu.classList.add('hidden'); 
                    [cite_start]} [cite: 673]
                });
                document.addEventListener('keydown', (e) => {
                    const activeEl = document.activeElement;
                    const isInputFocused = activeEl instanceof HTMLInputElement || activeEl instanceof HTMLTextAreaElement || activeEl?.classList.contains('renaming'); // Add null check
                    if (isInputFocused && !['Enter', 'Escape'].includes(e.key)) {
                        [cite_start]return; [cite: 675]
                    }

                    const isCtrlOrCmd = e.ctrlKey || e.metaKey; 

                    switch (e.key) {
                        [cite_start]case 'Delete': [cite: 676]
                        case 'Backspace': 
                            const selectedItems = App.dom.file_explorer?.querySelectorAll('.file-item.selected'); // Add null check
                            [cite_start]if (selectedItems?.length > 0) { // Add null check [cite: 677]
                                e.preventDefault(); 
                                [cite_start]this.showDeleteConfirmModal([...selectedItems].map(el => el.dataset.path)); [cite: 678]
                            }
                            break;
                        [cite_start]case 'F2': [cite: 679]
                            [cite_start]e.preventDefault(); [cite: 680]
                            const selectedExplorerItem = App.dom.file_explorer?.querySelector('.file-item.selected'); // Add null check
                            if (selectedExplorerItem) {
                                [cite_start]this.showRenameModal(selectedExplorerItem.dataset.path); [cite: 681]
                            }
                            break;
                        [cite_start]case 's': [cite: 682]
                            [cite_start]if (isCtrlOrCmd) { e.preventDefault(); [cite: 683] App.files.save(); }
                            break;
                        [cite_start]case 'j': [cite: 684]
                            [cite_start]if (isCtrlOrCmd) { e.preventDefault(); [cite: 685] App.ui.toggleBottomPanel(); }
                            break;
                        [cite_start]case 'e': [cite: 686]
                            [cite_start]if (isCtrlOrCmd && e.shiftKey) { e.preventDefault(); [cite: 687] App.ui.switchSidebarView('explorer'); }
                            break;
                        [cite_start]case 'f': [cite: 688]
                            [cite_start]if (isCtrlOrCmd && e.shiftKey) { e.preventDefault(); [cite: 689] App.ui.switchSidebarView('search'); }
                            break;
                        [cite_start]case 'n': [cite: 690]
                            if (isCtrlOrCmd) {
                                [cite_start]e.preventDefault(); [cite: 691]
                                if (e.shiftKey) { this.showNewFileModal(); } 
                                [cite_start]else { this.showNewItemModal('folder', '/'); [cite: 692] } 
                            }
                            break;
                        [cite_start]case 'p': [cite: 693]
                            [cite_start]if (isCtrlOrCmd && e.shiftKey) { e.preventDefault(); [cite: 694] this.showCommandPalette(); }
                            break;
                        [cite_start]case 'Escape': [cite: 695]
                            [cite_start]App.ui.hideModal(); [cite: 696]
                            App.dom.context_menu?.classList.add('hidden'); [cite_start]// Add null check [cite: 696]
                            [cite_start]App.editor.getActiveEditor()?.focus(); [cite: 697]
                            break;
                    }
                });
                App.dom.file_explorer?.addEventListener('click', e => { // Add null check
                    const itemEl = e.target.closest('.file-item');
                    App.dom.file_explorer.querySelectorAll('.file-item.selected').forEach(el => el.classList.remove('selected'));
                    if (itemEl) itemEl.classList.add('selected');
                [cite_start]}); [cite: 699]
            },
            showNewFileModal() {
                [cite_start]const content = document.createElement('div'); [cite: 700]
                content.className = 'modal-base p-4';
                content.innerHTML = `<h3 class="text-lg font-bold mb-4">Create New File</h3><div class="grid grid-cols-2 gap-2"></div>`;
                [cite_start]const grid = content.querySelector('.grid'); [cite: 701]
                [cite_start]const languages = { 'Python': 'py', 'Lua': 'lua', 'HTML': 'html', 'JavaScript': 'js' }; [cite: 701]
                Object.entries(languages).forEach(([name, ext]) => {
                    const btn = document.createElement('button');
                    btn.className = 'p-4 rounded hover:bg-[var(--ide-bg-hover)] bg-[var(--ide-bg-primary)]';
                    btn.textContent = name;
                    btn.onclick = () => {
                        [cite_start]App.files.openUntitled(ext); [cite: 703]
                        App.ui.hideModal();
                    };
                    grid.appendChild(btn);
                [cite_start]}); [cite: 702, 704]
                App.ui.showModal(content);
            },
            showNewItemModal(type, basePath = '/') { 
                [cite_start]const content = document.createElement('div'); [cite: 705]
                content.className = 'modal-base p-4';
                content.innerHTML = `<h3 class="text-lg font-bold mb-4">New ${type === 'folder' ? [cite_start]'Folder' : 'File'}</h3><input type="text" id="modal-input-name" class="modal-input" placeholder="Enter name...">`; [cite: 706]
                App.ui.showModal(content);
                [cite_start]const input = document.getElementById('modal-input-name'); [cite: 707]
                if (input) { // Check input before focusing
                    [cite_start]input.focus(); [cite: 708]
                    input.onkeydown = async (e) => { 
                        if (e.key === 'Enter' && input.value) { 
                            [cite_start]const name = input.value.trim(); [cite: 709]
                            if (!name) { App.ui.showNotification('Name cannot be empty.', 'error'); return; }
                            const path = `${basePath === '/' ? [cite_start]'' : basePath}/${name}`; [cite: 710]
                            try {
                                [cite_start]if (type === 'folder') await App.fs.mkdir(path); [cite: 711]
                                else await App.fs.write(path, ''); // Empty content for new file
                                [cite_start]App.ui.hideModal(); [cite: 712]
                                App.ui.renderExplorer(); 
                            } catch (error) {
                                [cite_start]App.ui.showNotification(`Error creating ${type}: ${error.message}`, 'error'); [cite: 713]
                            }
                        [cite_start]} else if (e.key === 'Escape') App.ui.hideModal(); [cite: 714]
                    };
                } else {
                    [cite_start]console.error("Modal input element (modal-input-name) not found for new item modal."); [cite: 715]
                }
            },
            [cite_start]// showContextMenu 함수는 이전 내용에서 이미 전체적으로 제공되었으므로, 여기서는 함수 정의만 남깁니다. [cite: 716]
            [cite_start]// 전체 함수 내용은 이전 답변의 'editor.html' 최종 버전을 참고하시거나, [cite: 717]
            // 아니면 이 다음부터 작성되는 전체 코드에 포함될 것입니다.
            showContextMenu(e) {
                [cite_start]e.preventDefault(); e.stopPropagation(); [cite: 718]
                const target = e.target.closest('.file-item');
                const path = target?.dataset.path;
                const nodeId = target?.dataset.id;
                
                [cite_start]let items = []; [cite: 719]
                if (nodeId) { // Context menu for a specific file/folder
                    [cite_start]// VFS.getNode는 비동기 함수이므로, 여기서는 데이터셋에서 직접 접근할 수 있는 정보만 사용합니다. [cite: 720]
                    [cite_start]// 더 복잡한 노드 정보가 필요하면 async/await로 getNode 호출이 필요합니다. [cite: 721]
                    [cite_start]// 편의를 위해 일단 type은 DOM에서 가져올 수 있다고 가정합니다 (예: data-type 속성 추가). [cite: 722]
                    // 또는 컨텍스트 메뉴를 열 때 getNode를 호출하여 메뉴 항목의 disabled 상태를 동적으로 결정할 수 있습니다.
                    // IMPORTANT: The getCurrentNodeFromExplorer helper below is a dummy. For robust production, 
                    [cite_start]// make this showContextMenu async and fetch the actual node: `const nodeFromExplorer = await App.fs.getNode(nodeId);` [cite: 723]
                    [cite_start]const nodeFromExplorer = App.ui.getCurrentNodeFromExplorer(nodeId); [cite: 724]
                    [cite_start]const isFile = nodeFromExplorer?.type === 'file'; [cite: 724]
                    [cite_start]const isFolder = nodeFromExplorer?.type === 'folder'; [cite: 724]
                    if (isFile) {
                        [cite_start]items.push({ label: 'Open', action: () => App.files.open(path) }); [cite: 725]
                        [cite_start]items.push({ label: 'Run File', action: () => App.files.runActive() }); [cite: 726]
                    }
                    [cite_start]items.push({ label: 'Rename', action: () => this.showRenameModal(path) }); [cite: 727]
                    [cite_start]items.push({ label: 'Delete', action: () => this.showDeleteConfirmModal([path]) }); [cite: 727]
                    
                    if (isFolder) {
                        items.push(null); [cite_start]// Divider [cite: 728]
                        [cite_start]items.push({ label: 'New File', action: () => this.showNewFileModal(path) }); [cite: 728]
                        [cite_start]items.push({ label: 'New Folder', action: () => this.showNewItemModal('folder', path) }); [cite: 729, 730]
                    }
                } else { // Context menu for empty space in explorer (assumed to be root or current view's base path)
                    // If no specific file/folder clicked, assume context is for the current folder being displayed
                    [cite_start]// For now, hardcode to root for simplicity, but in a real app, you'd get the current explorer path [cite: 731]
                    const currentExplorerPath = '/'; [cite_start]// Or from a state variable like App.state.currentExplorerViewPath [cite: 732]
                    [cite_start]items.push({ label: 'New File', action: () => this.showNewFileModal(currentExplorerPath) }); [cite: 732, 733]
                    [cite_start]items.push({ label: 'New Folder', action: () => this.showNewItemModal('folder', currentExplorerPath) }); [cite: 733]
                    items.push(null); [cite_start]// Divider [cite: 734]
                    [cite_start]items.push({ label: 'Refresh Explorer', action: () => App.ui.renderExplorer() }); [cite: 735]
                }

                [cite_start]const menuEl = App.dom.context_menu; [cite: 736]
                if (!menuEl) {
                    [cite_start]console.error("Context menu element not found."); [cite: 737]
                    return;
                }
                menuEl.innerHTML = items.map(item => item ? `<div class="context-menu-item px-4 py-2" data-label="${item.label}">${item.label}</div>` : '<div class="context-menu-divider"></div>').join('');
                menuEl.onclick = (ev) => { 
                    const actionLabel = ev.target.closest('.context-menu-item')?.dataset.label; [cite_start]// Use closest for safety [cite: 739]
                    if(actionLabel) {
                        const actionItem = items.find(i => i && i.label === actionLabel); [cite_start]// Check for null item [cite: 740]
                        [cite_start]actionItem?.action(); [cite: 741]
                    }
                    [cite_start]menuEl.classList.add('hidden'); [cite: 742]
                [cite_start]}; [cite: 738]
                menuEl.style.left = `${e.clientX}px`; menuEl.style.top = `${e.clientY}px`;
                menuEl.classList.remove('hidden');
            },
            showRenameModal(path) {
                [cite_start]const oldName = path.split('/').pop(); [cite: 743]
                const content = document.createElement('div'); content.className = 'modal-base p-4';
                content.innerHTML = `<h3 class="text-lg font-bold mb-4">Rename</h3><input type="text" id="modal-input-rename" class="modal-input">`;
                [cite_start]App.ui.showModal(content); [cite: 744]
                const input = document.getElementById('modal-input-rename'); 
                if (input) { // Check input before focusing
                    [cite_start]input.value = oldName; [cite: 745]
                    input.focus(); input.select();
                    input.onkeydown = async (e) => { 
                        if (e.key === 'Enter' && input.value) { 
                            [cite_start]const newName = input.value.trim(); [cite: 746]
                            if (!newName) { App.ui.showNotification('Name cannot be empty.', 'error'); return; }
                            try {
                                [cite_start]const nodeToRename = await App.fs.getNodeByPath(path); [cite: 747]
                                if (nodeToRename) {
                                    [cite_start]await App.fs.rename(nodeToRename.id, newName); [cite: 748]
                                    App.ui.hideModal(); 
                                    App.ui.renderExplorer();
                                    // Update open tab if renamed file is open
                                    ['pane1', 'pane2'].forEach(paneId => {
                                        if (App.state.openFiles[paneId].has(path)) {
                                            [cite_start]const fileData = App.state.openFiles[paneId].get(path); [cite: 749]
                                            App.state.openFiles[paneId].delete(path);
                                            [cite_start]const newPath = path.substring(0, path.lastIndexOf('/') + 1) + newName; [cite: 750]
                                            App.state.openFiles[paneId].set(newPath, fileData);
                                            [cite_start]if (fileData.tabEl) { // Check before accessing tabEl [cite: 751]
                                                fileData.tabEl.dataset.path = newPath;
                                                [cite_start]fileData.tabEl.title = newPath; [cite: 752]
                                                const tabNameSpan = fileData.tabEl.querySelector('.tab-name');
                                                if (tabNameSpan) {
                                                    [cite_start]tabNameSpan.textContent = newName; [cite: 753, 754]
                                                }
                                            }
                                            if (App.state.activePaths[paneId] === path) {
                                                [cite_start]App.state.activePaths[paneId] = newPath; [cite: 755, 756]
                                            }
                                        }
                                    });
                                    App.ui.updateStatus(); [cite_start]// Update status bar if needed [cite: 757]
                                } else {
                                    [cite_start]App.ui.showNotification(`Rename failed: Original node not found.`, 'error'); [cite: 758]
                                }
                            } catch (error) {
                                [cite_start]App.ui.showNotification(`Rename failed: ${error.message}`, 'error'); [cite: 759]
                            }
                        [cite_start]} else if (e.key === 'Escape') App.ui.hideModal(); [cite: 760]
                    };
                } else {
                    [cite_start]console.error("Modal input element (modal-input-rename) not found for rename modal."); [cite: 761]
                }
            },
            showDeleteConfirmModal(pathsToDelete) {
                [cite_start]if (!pathsToDelete || pathsToDelete.length === 0) return; [cite: 762]
                const itemNames = pathsToDelete.map(p => p.split('/').pop()).join(', ');
                [cite_start]const content = document.createElement('div'); content.className = 'modal-base p-4'; [cite: 763]
                content.innerHTML = `
                    <h3 class="text-lg font-bold mb-4">Confirm Deletion</h3>
                    <p class="text-[var(--ide-text-secondary)]">Are you sure you want to delete ${pathsToDelete.length} item(s)?</p>
                    <p class="text-[var(--ide-text-primary)] font-mono text-sm">${itemNames}</p>
                    <div class="flex justify-center mt-4">
                        <button id="modal-cancel-btn" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">Cancel</button>
                        <button id="modal-confirm-btn" class="px-4 py-2 rounded bg-[var(--ide-error-color)] hover:opacity-80 ml-2">Delete</button>
                    </div>
                [cite_start]`; [cite: 764]
                [cite_start]App.ui.showModal(content); [cite: 765]
                document.getElementById('modal-cancel-btn')?.onclick = () => App.ui.hideModal(); // Add null check
                document.getElementById('modal-confirm-btn')?.onclick = async () => { // Add null check
                    for (const path of pathsToDelete) {
                        try {
                            [cite_start]const node = await App.fs.getNodeByPath(path); [cite: 766]
                            if (node) {
                                // Ensure any open editors for this file are closed first
                                ['pane1', 'pane2'].forEach(paneId => {
                                    if (App.state.openFiles[paneId].has(path)) {
                                        App.files.close(path, true, paneId); // Force close
                                    [cite_start]} [cite: 768]
                                [cite_start]}); [cite: 769]
                                [cite_start]await App.fs.delete(node.id); [cite: 770]
                                App.ui.showNotification(`Deleted '${node.name}'`, 'success');
                            } else {
                                [cite_start]App.ui.showNotification(`Item '${path.split('/').pop()}' not found, skipping delete.`, 'warning'); [cite: 771]
                            }
                        } catch (error) {
                            [cite_start]App.ui.showNotification(`Failed to delete '${path.split('/').pop()}': ${error.message}`, 'error'); [cite: 772]
                            console.error('Delete error:', error);
                        }
                    }
                    [cite_start]App.ui.hideModal(); [cite: 773]
                    App.ui.renderExplorer();
                };
            },
            showSaveAsModal(untitledPath, paneId) {
                [cite_start]const content = document.createElement('div'); [cite: 774]
                content.className = 'modal-base p-4';
                content.innerHTML = `<h3 class="text-lg font-bold mb-4">Save As</h3><input type="text" id="modal-input-save" class="modal-input" placeholder="Enter file path (e.g., my-projects/app.js)">`;
                [cite_start]App.ui.showModal(content); [cite: 775]
                const input = document.getElementById('modal-input-save'); 
                if (input) { // Check input before focusing
                    [cite_start]input.focus(); [cite: 776]
                    input.onkeydown = async (e) => {
                        if (e.key === 'Enter' && input.value) {
                            [cite_start]const newPath = input.value.trim(); [cite: 777]
                            if (!newPath) { App.ui.showNotification('Path cannot be empty.', 'error'); return; }
                            [cite_start]const data = App.state.openFiles[paneId].get(untitledPath); [cite: 778]
                            if (!data) { 
                                [cite_start]App.ui.hideModal(); [cite: 779]
                                console.error(`No data for untitled file: ${untitledPath}`);
                                return;
                            }
                            try {
                                [cite_start]await App.fs.write(newPath, data.session.getValue()); [cite: 780]
                                App.files.close(untitledPath, true, paneId);
                                App.files.open(newPath, paneId); 
                                App.ui.hideModal();
                                [cite_start]App.ui.showNotification(`File saved as ${newPath}`, 'success'); [cite: 781]
                            } catch (error) {
                                [cite_start]App.ui.showNotification(`Save failed: ${error.message}`, 'error'); [cite: 782]
                                console.error("Save As error:", error);
                            }
                        [cite_start]} else if (e.key === 'Escape') App.ui.hideModal(); [cite: 783]
                    };
                } else {
                    [cite_start]console.error("Modal input element (modal-input-save) not found for save as modal."); [cite: 784]
                }
            },
            async readAndCreateFiles(files) {
                [cite_start]if (!files || files.length === 0) return; [cite: 785]
                for(const file of files) {
                    [cite_start]const reader = new FileReader(); [cite: 786]
                    reader.onload = async (e) => {
                        [cite_start]const content = e.target.result; [cite: 787]
                        // Determine if it's a text file based on MIME type or extension
                        const isTextFile = file.type.startsWith('text/') || [cite_start]['js', 'py', 'html', 'css', 'json', 'md', 'txt', 'lua'].some(ext => file.name.endsWith(`.${ext}`)); [cite: 788]
                        try {
                            // Default upload to root folder ('/')
                            [cite_start]const targetPath = '/'; [cite: 790]
                            // Ensure file.name starts with a slash if it's going into root directly
                            [cite_start]const fullTargetPath = `${targetPath}${file.name.startsWith('/') ? file.name.substring(1) : file.name}`; [cite: 791]
                            [cite_start]await App.fs.write(fullTargetPath, isTextFile ? content : new Blob([content], {type: file.type})); [cite: 792]
                            // Pass Blob for non-text files
                            [cite_start]App.ui.showNotification(`Uploaded '${file.name}'`, 'success'); [cite: 793]
                            App.ui.renderExplorer();
                        } catch (error) {
                            [cite_start]App.ui.showNotification(`Failed to upload '${file.name}': ${error.message}`, 'error'); [cite: 794]
                            console.error("File upload error:", error);
                        }
                    };
                    // Read as text for known text types, otherwise as ArrayBuffer (for Blob)
                    if (file.type.startsWith('text/') || ['js', 'py', 'html', 'css', 'json', 'md', 'txt', 'lua'].some(ext => file.name.endsWith(`.${ext}`))) {
                        [cite_start]reader.readAsText(file); [cite: 796]
                    } else {
                        reader.readAsArrayBuffer(file); [cite_start]// For non-text files, read as ArrayBuffer for Blob storage [cite: 797]
                    }
                }
            },
            [cite_start]handleFileImport(event) { this.readAndCreateFiles(event.target.files); [cite: 798] },
            [cite_start]handleFileDrop(event) { this.readAndCreateFiles(event.dataTransfer.files); [cite: 799] },
            async showCommandPalette() { // Changed to async because of App.fs.getNodeByPath
                [cite_start]const content = document.createElement('div'); [cite: 800]
                content.className = 'modal-base';
                content.innerHTML = `<input type="text" id="cmd-input" class="modal-input m-2" placeholder="Search files and commands..."><div id="cmd-list" class="overflow-y-auto max-h-[50vh]"></div>`;
                [cite_start]App.ui.showModal(content); [cite: 801]
                const input = document.getElementById('cmd-input'); 
                const list = document.getElementById('cmd-list');

                if (!input || !list) {
                    [cite_start]console.error("Command palette input or list element not found."); [cite: 802]
                    App.ui.hideModal();
                    return;
                }

                const commands = [
                    { label: 'File: New File...', action: () => this.showNewFileModal() },
                    { label: 'File: Save Active File', action: () => App.files.save() },
                    [cite_start]{ label: 'Edit: Format Document', action: () => App.formatter.formatCode() }, [cite: 803]
                    { label: 'View: Toggle Split View', action: () => App.layout.toggleSplitView() },
                    { label: 'Run: Run Active File', action: () => App.files.runActive() },
                    { label: 'View: Toggle Terminal', action: () => App.ui.toggleBottomPanel() },
                    [cite_start]{ label: 'Explorer: New Folder', action: () => this.showNewItemModal('folder') }, [cite: 804]
                    { label: 'Editor: Increase Font Size', action: () => App.settings.update('fontSize', App.state.settings.fontSize + 1) },
                    { label: 'Editor: Decrease Font Size', action: () => App.settings.update('fontSize', App.state.settings.fontSize - 1) },
                [cite_start]]; [cite: 805]
                
                const rootNode = await App.fs.getNodeByPath('/'); [cite_start]// Await this call [cite: 806]
                [cite_start]let allFiles = []; [cite: 807]
                if (rootNode) {
                    [cite_start]const filePaths = await App.fs.getAllFilePaths(rootNode); [cite: 808]
                    [cite_start]allFiles = filePaths.map(p => ({ label: `📄 ${p}`, action: () => App.files.open(p) })); [cite: 808]
                } else {
                    [cite_start]console.warn("Root node not found for command palette file listing."); [cite: 809, 810]
                }
                
                [cite_start]const allItems = [...commands, ...allFiles]; [cite: 811]
                this.setupPalette(input, list, allItems);
            },
            showBetaFeaturesPalette() {
                [cite_start]const content = document.createElement('div'); [cite: 812]
                content.className = 'modal-base';
                content.innerHTML = `<input type="text" id="cmd-input" class="modal-input m-2" placeholder="Search Beta Features..."><div id="cmd-list" class="overflow-y-auto max-h-[50vh]"></div>`;
                [cite_start]App.ui.showModal(content); [cite: 813]
                const input = document.getElementById('cmd-input'); 
                const list = document.getElementById('cmd-list');

                if (!input || !list) {
                    [cite_start]console.error("Beta palette input or list element not found."); [cite: 814]
                    App.ui.hideModal();
                    return;
                }

                const commands = [
                    { "label": "Beta: UI: Increase Font Size", "action": () => App.settings.update('fontSize', App.state.settings.fontSize + 1) },
                    { "label": "Beta: UI: Decrease Font Size", "action": () => App.settings.update('fontSize', App.state.settings.fontSize - 1) },
                    { "label": "Beta: Workspace: Clear All Data (Danger!)", "action": () => {
                        if (confirm("Are you sure you want to delete ALL IDE data (files, settings, snippets)? This cannot be undone.")) {
                            [cite_start]indexedDB.deleteDatabase(App.fs.DB_NAME); [cite: 815]
                            localStorage.clear(); [cite_start]// Clear all local storage settings etc. [cite: 816]
                            [cite_start]App.ui.showNotification("All IDE data cleared. Please refresh the page.", "error"); [cite: 817]
                            [cite_start]window.location.reload(); [cite: 817]
                        }
                    }},
                ];
                [cite_start]this.setupPalette(input, list, commands); [cite: 818]
            },
            setupPalette(input, list, items) {
                let activeItemIndex = -1; [cite_start]// Track active item for keyboard navigation [cite: 819]

                const renderList = (query='') => {
                    [cite_start]const filtered = items.filter(c => c.label.toLowerCase().includes(query.toLowerCase())); [cite: 820]
                    list.innerHTML = filtered.map((c, index) => 
                        `<div class="command-palette-item p-2 cursor-pointer hover:bg-[var(--ide-bg-hover)] ${index === activeItemIndex ? 'active' : ''}" data-label="${c.label}">${c.label}</div>`
                    ).join('');
                    if (filtered.length > 0 && activeItemIndex === -1) {
                        activeItemIndex = 0; [cite_start]// Set first item as active by default [cite: 822]
                        [cite_start]list.children[0]?.classList.add('active'); [cite: 823]
                    [cite_start]} [cite: 821]
                };
                const executeAction = (label) => {
                    [cite_start]items.find(c=>c.label===label)?.action(); [cite: 824]
                    [cite_start]App.ui.hideModal(); [cite: 825]
                };
                list.onclick = (e) => { 
                    [cite_start]const label = e.target.closest('.command-palette-item')?.dataset.label; [cite: 826]
                    if(label) executeAction(label); 
                };
                input.oninput = () => {
                    activeItemIndex = -1; [cite_start]// Reset active item on input change [cite: 827]
                    [cite_start]renderList(input.value); [cite: 828]
                };
                input.onkeydown = (e) => {
                    [cite_start]const currentItems = Array.from(list.children); [cite: 829]
                    if (e.key === 'ArrowDown') {
                        [cite_start]e.preventDefault(); [cite: 830]
                        if (activeItemIndex < currentItems.length - 1) {
                            [cite_start]if (activeItemIndex !== -1) currentItems[activeItemIndex].classList.remove('active'); [cite: 831]
                            activeItemIndex++;
                            currentItems[activeItemIndex].classList.add('active');
                            currentItems[activeItemIndex].scrollIntoView({ block: 'nearest' });
                        }
                    } else if (e.key === 'ArrowUp') {
                        [cite_start]e.preventDefault(); [cite: 832]
                        if (activeItemIndex > 0) {
                            [cite_start]currentItems[activeItemIndex].classList.remove('active'); [cite: 833]
                            activeItemIndex--;
                            currentItems[activeItemIndex].classList.add('active');
                            currentItems[activeItemIndex].scrollIntoView({ block: 'nearest' });
                        }
                    } else if (e.key === 'Enter') {
                        [cite_start]e.preventDefault(); [cite: 834]
                        if (activeItemIndex !== -1 && currentItems[activeItemIndex]) {
                            [cite_start]executeAction(currentItems[activeItemIndex].dataset.label); [cite: 835]
                        } else if (currentItems.length > 0) { // If nothing active, but items exist, execute first
                             [cite_start]executeAction(currentItems[0].dataset.label); [cite: 836]
                        }
                    } else if (e.key === 'Escape') {
                        [cite_start]App.ui.hideModal(); [cite: 837]
                    }
                }
                [cite_start]input.focus(); [cite: 838]
                renderList('');
            }
        }
    };

    App.init();
    </script>
</body>
</html>
