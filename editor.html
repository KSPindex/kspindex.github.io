<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Index-Space IDE (Remake)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600&family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-language_tools.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-modelist.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-emmet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/ext-beautify.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/keybinding-vscode.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/keybinding-sublime.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.33.0/keybinding-vim.js"></script>
    
    <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-python.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-html.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-postcss.js"></script>
    
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js" async></script>
    <script src="https://unpkg.com/fengari-web/dist/fengari-web.js"></script>
    
    <style>
        :root {
            --color-background: #0D1117;
            --color-text-primary: #E6EDF3;
            --color-text-secondary: #8B949E;
            --color-surface-1: #161B22;
            --color-surface-2: #0D1117;
            --color-border: #30363D;
            --color-accent: #58A6FF;
            --color-selection-bg: rgba(88, 166, 255, 0.2);
            --color-error: #DA3633;
            --color-warning: #D29922;
            --font-family: 'Inter', sans-serif;
            --font-mono: 'Fira Code', monospace;
            --ide-bg-primary: var(--color-background);
            --ide-bg-secondary: var(--color-surface-1);
            --ide-bg-tertiary: var(--color-surface-2);
            --ide-bg-hover: rgba(48, 54, 61, 0.5);
            --ide-text-primary: var(--color-text-primary);
            --ide-text-secondary: var(--color-text-secondary);
            --ide-text-inactive: var(--color-text-secondary);
            --ide-border-primary: var(--color-border);
            --ide-accent-primary: var(--color-accent);
            --ide-error-color: var(--color-error);
            --ide-warning-color: var(--color-warning);
            --ide-minimap-bg: rgba(13, 17, 23, 0.7);
        }
        body {
            font-family: var(--font-family);
            background-color: var(--ide-bg-primary);
            color: var(--ide-text-primary);
            overflow: hidden;
            font-size: 14px;
            user-select: none;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--ide-bg-tertiary); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        #main-grid {
            display: grid;
            grid-template-columns: 48px 250px 5px 1fr;
            grid-template-rows: 35px 1fr 5px 200px 24px;
            height: 100vh;
            width: 100vw;
        }
        #top-bar { grid-area: 1 / 1 / 2 / 6; background-color: var(--ide-bg-tertiary); display: flex; align-items: center; padding: 0 10px; z-index: 60; border-bottom: 1px solid var(--ide-border-primary); }
        #activity-bar { grid-area: 2 / 1 / 5 / 2; background-color: var(--ide-bg-primary); z-index: 50; border-right: 1px solid var(--ide-border-primary); }
        #sidebar { grid-area: 2 / 2 / 5 / 3; background-color: var(--ide-bg-tertiary); z-index: 40; display: flex; flex-direction: column; border-right: 1px solid var(--ide-border-primary); }
        #resizer-v { grid-area: 2 / 3 / 5 / 4; cursor: col-resize; z-index: 99; background-color: var(--ide-border-primary); }
        #main-view { grid-area: 2 / 4 / 3 / 5; display: flex; flex-direction: column; overflow: hidden; }
        #resizer-h { grid-area: 3 / 4 / 4 / 5; cursor: row-resize; z-index: 99; background-color: var(--ide-border-primary); }
        #bottom-panel { grid-area: 4 / 4 / 5 / 5; background-color: var(--ide-bg-secondary); border-top: 1px solid var(--ide-border-primary); }
        #status-bar { grid-area: 5 / 1 / 6 / 6; background-color: var(--ide-accent-primary); color: var(--ide-bg-primary); z-index: 100; display: flex; align-items: center; justify-content: space-between; padding: 0 16px; font-size: 0.85rem; }
        .ace_editor { font-family: var(--font-mono) !important; background: var(--ide-bg-secondary) !important; color: var(--ide-text-primary) !important; width: 100% !important; height: 100% !important;}
        .ace_gutter { background: var(--ide-bg-secondary) !important; color: var(--ide-text-inactive) !important; }
        .ace_active-line { background: rgba(255, 255, 255, 0.05) !important; }
        .ace_cursor { color: var(--ide-text-secondary) !important; }
        .ace_selection { background: var(--color-selection-bg) !important; }
        .ace_gutter-cell.ace_breakpoint::before { content: "●"; color: var(--ide-error-color); position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);}
        .overlay { position: fixed; inset: 0; background: rgba(13, 17, 23, 0.9); backdrop-filter: blur(8px); z-index: 1000; display:flex; align-items: flex-start; justify-content:center; }
        .modal-base { background: var(--ide-bg-secondary); margin-top:15vh; width: 600px; max-width: 90vw; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.5); display:flex; flex-direction:column; border: 1px solid var(--ide-border-primary); color: var(--ide-text-primary); }
        .modal-input { background:var(--ide-bg-primary); border:1px solid var(--ide-border-primary); outline:none; padding:8px; width:100%; border-radius:4px; color: var(--ide-text-primary); }
        .context-menu-item:hover, .command-palette-item.active { background-color: var(--ide-bg-hover); color: var(--ide-text-primary); }
        .activity-bar-icon { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding: 12px 0; cursor: pointer; color: var(--ide-text-inactive); transition: all 0.2s ease; }
        .activity-bar-icon:hover { color: var(--ide-text-primary); }
        .activity-bar-icon.active { color: var(--ide-text-primary); box-shadow: inset 2px 0 0 var(--ide-accent-primary); }
        .activity-bar-icon svg { width: 24px; height: 24px; pointer-events: none; }
        .sidebar-panel, .bottom-panel-content { display: none; }
        .sidebar-panel.active, .bottom-panel-content.active { display: flex; flex-direction: column; height: 100%; }
        .bottom-panel-tab { padding: 8px 12px; cursor: pointer; font-size: 0.9em; color: var(--ide-text-secondary); transition: all 0.2s ease; }
        .bottom-panel-tab:hover { background-color: var(--ide-bg-hover); }
        .bottom-panel-tab.active { background-color: var(--ide-bg-secondary); color: var(--ide-text-primary); border-bottom: 2px solid var(--ide-accent-primary); }
        .editor-tab { position: relative; background-color: var(--ide-bg-primary); color: var(--ide-text-secondary); padding: 8px 12px; border-right: 1px solid var(--ide-border-primary); cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9em; flex-shrink: 0; transition: all 0.2s ease; }
        .editor-tab:hover { background-color: var(--ide-bg-hover); color: var(--ide-text-primary); }
        .editor-tab.active { background-color: var(--ide-bg-secondary); color: var(--ide-text-primary); border-top: 2px solid var(--ide-accent-primary); padding-top: 6px; }
        .editor-tab.modified .tab-name::after { content: " ●"; color: var(--ide-text-secondary); font-size: 10px; vertical-align: middle; }
        #editor-groups-container { display: grid; grid-template-columns: 1fr; width: 100%; height: 100%; }
        #welcome-screen { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; text-align: center; background-color: var(--ide-bg-secondary); color: var(--ide-text-inactive); font-size: 1.1em; padding: 20px; flex-direction: column; }
        #welcome-screen h1 { font-size: 2.5em; margin-bottom: 10px; color: var(--ide-text-primary); }
        .file-item { padding: 6px 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: var(--ide-text-primary); transition: background-color 0.1s ease; }
        .file-item:hover { background-color: var(--ide-bg-hover); }
        .file-item.selected { background-color: var(--color-selection-bg); }
        .file-item.drag-over { background-color: var(--ide-accent-primary); color: var(--ide-bg-primary); }
        .context-menu { position: fixed; background: var(--ide-bg-secondary); border: 1px solid var(--ide-border-primary); border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); padding: 4px; z-index: 2000; opacity: 0; transform: scale(0.95); transition: all 0.1s ease-out; pointer-events: none; min-width: 150px; }
        .context-menu.visible { opacity: 1; transform: scale(1); pointer-events: auto; }
        .context-menu-item { padding: 8px 12px; cursor: pointer; border-radius: 4px; white-space: nowrap; font-size: 0.9em; color: var(--ide-text-primary); }
        .context-menu-divider { height: 1px; background: var(--ide-border-primary); margin: 4px 0; }
        #panel-internal-terminal { font-family: var(--font-mono); font-size: 0.9em; line-height: 1.4; background-color: var(--ide-bg-secondary); color: var(--ide-text-primary); padding: 10px; white-space: pre-wrap; overflow-y: auto; word-break: break-all; position: relative; }
        .terminal-output-error { color: var(--ide-error-color); }
        .terminal-output-warning { color: var(--ide-warning-color); }
        .terminal-output-info { color: var(--ide-text-secondary); }
        .terminal-output-prompt { color: var(--ide-accent-primary); }
        .terminal-loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(13, 17, 23, 0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--ide-accent-primary); font-size: 1.2em; z-index: 10; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid var(--ide-accent-primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .terminal-loading-message { margin-top: 10px; font-size: 0.9em; color: var(--ide-text-secondary); }
    </style>
</head>
<body>

    <div id="main-grid">
        <div id="top-bar">
            <button id="run-btn" title="Run Code (F5)" class="p-1.5 rounded hover:bg-[var(--ide-bg-hover)] disabled:text-[var(--ide-text-inactive)] disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
            </button>
        </div>

        <div id="activity-bar" class="flex flex-col items-center pt-2 space-y-2">
            <div data-view="explorer" class="activity-bar-icon active" title="Explorer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" /></svg>
            </div>
            <div data-view="search" class="activity-bar-icon" title="Search">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </div>
            <div data-view="settings" class="activity-bar-icon mt-auto mb-2" title="Settings">
                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z" /><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </div>
        </div>
        
        <div id="sidebar">
            <div id="view-explorer" class="sidebar-panel active">
                <div class="p-2 flex justify-between items-center border-b border-[var(--ide-border-primary)]">
                    <h2 class="text-xs uppercase font-bold tracking-wider text-[var(--ide-text-secondary)]">Explorer</h2>
                    <div class="flex items-center">
                        <button id="new-file-btn" class="p-1 rounded hover:bg-[var(--ide-bg-hover)]" title="New File">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" /><path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" /></svg>
                        </button>
                    </div>
                </div>
                <div id="file-explorer" class="flex-1 overflow-auto p-1"></div>
            </div>
             <div id="view-search" class="sidebar-panel p-2">Search Content</div>
            <div id="view-settings" class="sidebar-panel p-2">Settings Content</div>
        </div>

        <div id="resizer-v"></div>

        <div id="main-view">
            <div id="editor-tabs" class="editor-tabs flex-shrink-0 flex bg-[var(--ide-bg-tertiary)] overflow-x-auto"></div>
            <div id="editor-pane" class="editor-pane flex-1 relative">
                 <div id="editor"></div>
            </div>
            <div id="welcome-screen">
                <h1>Welcome to the IDE</h1>
                <p>Create or open a file to get started.</p>
            </div>
        </div>
        
        <div id="resizer-h"></div>
        
        <div id="bottom-panel" class="flex flex-col">
            <div class="tabs flex-shrink-0 flex bg-[var(--ide-bg-tertiary)] border-b border-[var(--ide-border-primary)] text-sm">
                <div data-panel="terminal" class="bottom-panel-tab active">Terminal</div>
                <div data-panel="problems" class="bottom-panel-tab">Problems</div>
            </div>
            <div id="panel-terminal" class="bottom-panel-content flex-1 active">
                <div id="terminal-output"></div>
                <div id="terminal-loading-overlay" class="terminal-loading-overlay hidden">
                    <div class="spinner"></div>
                    <div id="terminal-loading-text" class="terminal-loading-message"></div>
                </div>
            </div>
            <div id="panel-problems" class="bottom-panel-content flex-1 p-2">No problems detected.</div>
        </div>

        <div id="status-bar">
            <div><span id="line-col-status"></span></div>
            <div><span id="language-status"></span></div>
        </div>
    </div>
    
    <div id="context-menu" class="context-menu"></div>
    <div id="notification-toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg opacity-0 transition-opacity duration-300 z-[20001]"></div>

<script type="module">
    // =================================================================================
    // Application Controller
    // =================================================================================
    const App = {
        // --- State Management ---
        state: {
            fs: null,
            editor: null,
            activePath: null,
            openFiles: new Map(),
            untitledCounter: 1,
            pyodide: null,
            pyodideReady: false,
            pyodideLoading: false,
            fengari: null,
            luaReady: false,
            luaLoading: false,
        },
        // --- DOM Cache ---
        dom: {},

        // --- Initialization Sequence ---
        async init() {
            this.cacheDom();
            this.attachEventListeners();

            await VFS.init();
            this.state.fs = VFS;

            this.editor = Editor.init(this.dom.editor_pane);
            
            await this.ui.renderExplorer();
            this.ui.updateRunButton();
            
            // On-demand load Lua now, as it's very lightweight
            await Terminal.loadLua();
        },

        // --- DOM Element Caching ---
        cacheDom() {
            const ids = [
                'main-grid', 'top-bar', 'run-btn', 'activity-bar', 'sidebar', 'resizer-v', 'main-view', 'resizer-h', 
                'bottom-panel', 'status-bar', 'file-explorer', 'new-file-btn', 'editor-tabs', 'editor-pane', 'editor',
                'welcome-screen', 'context-menu', 'notification-toast', 'line-col-status', 'language-status',
                'terminal-output', 'terminal-loading-overlay', 'terminal-loading-text'
            ];
            ids.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    // Convert kebab-case to camelCase for easier access, e.g., 'run-btn' -> 'run_btn'
                    this.dom[id.replace(/-/g, '_')] = element;
                }
            });
        },

        // --- Centralized Event Listener Setup ---
        attachEventListeners() {
            // Run button
            if (this.dom.run_btn) {
                this.dom.run_btn.addEventListener('click', () => this.files.runActive());
            }

            // New file button
            if (this.dom.new_file_btn) {
                this.dom.new_file_btn.addEventListener('click', () => this.files.openUntitled());
            }

            // File explorer (Event Delegation)
            if (this.dom.file_explorer) {
                this.dom.file_explorer.addEventListener('click', (e) => {
                    const fileItem = e.target.closest('.file-item');
                    if (fileItem && fileItem.dataset.path) {
                        this.files.open(fileItem.dataset.path);
                    }
                });
            }

            // Editor Tabs (Event Delegation)
            if (this.dom.editor_tabs) {
                this.dom.editor_tabs.addEventListener('click', (e) => {
                    const tab = e.target.closest('.editor-tab');
                    const closeButton = e.target.closest('.close-tab');
                    
                    if (closeButton && tab && tab.dataset.path) {
                        e.stopPropagation(); // Prevent tab selection when closing
                        this.files.close(tab.dataset.path);
                    } else if (tab && tab.dataset.path) {
                        this.files.switchTo(tab.dataset.path);
                    }
                });
            }
            
            // Hide context menu on global click
            document.addEventListener('click', () => {
                if(this.dom.context_menu) this.dom.context_menu.classList.remove('visible');
            });
        },
        
        // --- Sub-modules (Namespaced for clarity) ---
        files: {
            // Open a file by its path
            async open(path, isUntitled = false, content = '') {
                if (App.state.openFiles.has(path)) {
                    this.switchTo(path);
                    return;
                }

                if (!isUntitled) {
                    try {
                        content = await App.state.fs.read(path);
                    } catch (e) {
                        App.ui.showNotification(`Error opening file: ${e.message}`, 'error');
                        return;
                    }
                }

                const session = Editor.createSession(path, content);
                App.state.openFiles.set(path, { session, isUntitled });

                this.switchTo(path);
                App.ui.renderTabs();
            },

            // Open a new, unsaved file
            openUntitled() {
                const path = `/Untitled-${App.state.untitledCounter++}.js`;
                const content = `// Welcome to your new file!\nconsole.log("Hello, World!");`;
                this.open(path, true, content);
            },
            
            // Switch the active editor session to the given path
            switchTo(path) {
                if (!App.state.openFiles.has(path)) return;

                App.state.activePath = path;
                const fileData = App.state.openFiles.get(path);
                App.state.editor.setSession(fileData.session);
                App.state.editor.focus();

                if(App.dom.welcome_screen) App.dom.welcome_screen.style.display = 'none';
                
                App.ui.updateActiveTab();
                App.ui.updateRunButton();
                App.ui.updateStatusBar();
            },
            
            // Close a file
            close(path) {
                if (!App.state.openFiles.has(path)) return;
                
                App.state.openFiles.delete(path);
                App.ui.renderTabs();
                
                if (App.state.activePath === path) {
                    const remainingFiles = Array.from(App.state.openFiles.keys());
                    if (remainingFiles.length > 0) {
                        this.switchTo(remainingFiles[remainingFiles.length - 1]);
                    } else {
                        App.state.activePath = null;
                        App.state.editor.setSession(Editor.createSession('empty', ''));
                        if(App.dom.welcome_screen) App.dom.welcome_screen.style.display = 'flex';
                        App.ui.updateRunButton();
                        App.ui.updateStatusBar();
                    }
                }
            },
            
            // Run the currently active file
            async runActive() {
                const path = App.state.activePath;
                if (!path) {
                    App.ui.showNotification('No active file to run.', 'warning');
                    return;
                }
                
                const content = App.state.editor.getValue();
                const ext = path.split('.').pop();
                
                Terminal.clear();
                Terminal.log(`$ Running ${path}...`, 'prompt');
                
                try {
                    switch (ext) {
                        case 'js':
                            await Terminal.runJS(content);
                            break;
                        case 'py':
                            await Terminal.runPython(content);
                            break;
                        case 'lua':
                            await Terminal.runLua(content);
                            break;
                        default:
                             App.ui.showNotification(`Cannot run .${ext} files directly.`, 'error');
                             Terminal.log(`Runtime not available for .${ext} files.`, 'error');
                    }
                } catch(e) {
                     Terminal.log(e.message, 'error');
                }
            }
        },

        ui: {
            // Render the entire file explorer
            async renderExplorer() {
                const fileList = await App.state.fs.list('/');
                if (App.dom.file_explorer) {
                    App.dom.file_explorer.innerHTML = fileList
                        .sort((a,b) => a.name.localeCompare(b.name))
                        .map(file => `<div class="file-item p-1 pl-2 rounded cursor-pointer hover:bg-[var(--ide-bg-hover)]" data-path="${file.path}">📄 ${file.name}</div>`)
                        .join('');
                }
            },

            // Render all open file tabs
            renderTabs() {
                if (App.dom.editor_tabs) {
                    App.dom.editor_tabs.innerHTML = Array.from(App.state.openFiles.keys()).map(path => {
                        const fileName = path.split('/').pop();
                        const isActive = path === App.state.activePath ? 'active' : '';
                        return `
                            <div class="editor-tab ${isActive}" data-path="${path}">
                                <span>${fileName}</span>
                                <span class="close-tab ml-2 px-1 rounded hover:bg-black/20">×</span>
                            </div>
                        `;
                    }).join('');
                }
            },

            // Update which tab is visually marked as active
            updateActiveTab() {
                if (App.dom.editor_tabs) {
                    this.renderTabs(); // Re-rendering is the simplest way to manage active state
                }
            },

            // Update status bar with cursor position and language
            updateStatusBar() {
                if(!App.state.activePath) {
                    if (App.dom.line_col_status) App.dom.line_col_status.textContent = '';
                    if (App.dom.language_status) App.dom.language_status.textContent = '';
                    return;
                }
                const pos = App.state.editor.getCursorPosition();
                const mode = App.state.editor.session.getMode().$id.split('/').pop();
                
                if (App.dom.line_col_status) App.dom.line_col_status.textContent = `Ln ${pos.row + 1}, Col ${pos.column + 1}`;
                if (App.dom.language_status) App.dom.language_status.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);
            },
            
            // Enable/disable the run button based on file type
            updateRunButton() {
                if (App.dom.run_btn) {
                    if (!App.state.activePath) {
                        App.dom.run_btn.disabled = true;
                        return;
                    }
                    const ext = App.state.activePath.split('.').pop();
                    const runnable = ['js', 'py', 'lua'].includes(ext);
                    App.dom.run_btn.disabled = !runnable;
                }
            },
            
            // Show a temporary notification
            showNotification(message, type = 'info') {
                const toast = App.dom.notification_toast;
                if (!toast) return;
                
                toast.textContent = message;
                toast.style.backgroundColor = type === 'error' ? 'var(--ide-error-color)' : '#333';
                toast.style.opacity = '1';
                
                setTimeout(() => {
                    toast.style.opacity = '0';
                }, 3000);
            }
        }
    };

    // =================================================================================
    // VFS (Virtual File System) Module using IndexedDB
    // =================================================================================
    const VFS = {
        db: null,
        DB_NAME: 'ide_vfs_remake',
        STORE_NAME: 'files',

        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(this.DB_NAME, 1);
                request.onupgradeneeded = e => {
                    this.db = e.target.result;
                    if (!this.db.objectStoreNames.contains(this.STORE_NAME)) {
                        this.db.createObjectStore(this.STORE_NAME, { keyPath: 'path' });
                    }
                };
                request.onsuccess = e => {
                    this.db = e.target.result;
                    this.initDefaultFiles().then(resolve);
                };
                request.onerror = e => reject(e.target.error);
            });
        },

        async initDefaultFiles() {
            const defaultFiles = {
                '/main.js': 'console.log("Hello from main.js!");',
                '/test.py': 'print("Hello from Python!")',
                '/app.lua': 'print("Hello from Lua!")',
            };
            for (const [path, content] of Object.entries(defaultFiles)) {
                 const existing = await this.read(path).catch(() => null);
                 if (existing === null) {
                     await this.write(path, content);
                 }
            }
        },

        async _tx(mode, callback) {
            const tx = this.db.transaction(this.STORE_NAME, mode);
            const store = tx.objectStore(this.STORE_NAME);
            return new Promise((resolve, reject) => {
                callback(store, resolve, reject);
                tx.oncomplete = () => {};
                tx.onerror = () => reject(tx.error);
            });
        },

        async write(path, content) {
            return this._tx('readwrite', (store, resolve) => {
                store.put({ path, content }).onsuccess = resolve;
            });
        },

        async read(path) {
            return this._tx('readonly', (store, resolve, reject) => {
                const request = store.get(path);
                request.onsuccess = () => {
                    request.result ? resolve(request.result.content) : reject(new Error('File not found'));
                };
            });
        },

        async list(dirPath) {
            return this._tx('readonly', (store, resolve) => {
                store.getAll().onsuccess = e => resolve(e.target.result);
            });
        }
    };

    // =================================================================================
    // Editor Module (Ace)
    // =================================================================================
    const Editor = {
        init(domElement) {
            const editor = ace.edit(domElement);
            editor.setOptions({
                theme: 'ace/theme/tomorrow_night_eighties',
                mode: 'ace/mode/javascript',
                enableBasicAutocompletion: true,
                enableLiveAutocompletion: true,
                showPrintMargin: false,
                fontSize: 14,
                fontFamily: 'var(--font-mono)',
            });
            editor.on("changeSelection", () => App.ui.updateStatusBar());
            return editor;
        },
        createSession(path, content) {
            const modelist = ace.require("ace/ext/modelist");
            const mode = modelist.getModeForPath(path).mode;
            const session = ace.createEditSession(content, mode);
            return session;
        }
    };

    // =================================================================================
    // Terminal Module
    // =================================================================================
    const Terminal = {
        showLoading(message) {
            if (App.dom.terminal_loading_overlay && App.dom.terminal_loading_text) {
                App.dom.terminal_loading_text.textContent = message;
                App.dom.terminal_loading_overlay.classList.remove('hidden');
            }
        },
        hideLoading() {
            if (App.dom.terminal_loading_overlay) {
                App.dom.terminal_loading_overlay.classList.add('hidden');
            }
        },
        log(message, type = 'log') {
            if (!App.dom.terminal_output) return;
            const line = document.createElement('div');
            line.textContent = message;
            if(type === 'error') line.className = 'terminal-output-error';
            if(type === 'prompt') line.className = 'terminal-output-prompt';
            if(type === 'info') line.className = 'terminal-output-info';
            App.dom.terminal_output.appendChild(line);
            App.dom.terminal_output.scrollTop = App.dom.terminal_output.scrollHeight;
        },
        clear() {
             if (App.dom.terminal_output) App.dom.terminal_output.innerHTML = '';
        },
        
        // --- On-Demand Loaders ---
        async loadPython() {
            if (App.state.pyodideReady || App.state.pyodideLoading) return;
            App.state.pyodideLoading = true;
            this.showLoading('Loading Python Environment (Pyodide)...');
            try {
                App.state.pyodide = await loadPyodide();
                App.state.pyodideReady = true;
                this.log('Python environment ready.', 'info');
                App.ui.showNotification('Python Ready. You can run the code now.', 'info');
            } catch(e) {
                this.log(`Error loading Python: ${e.message}`, 'error');
            } finally {
                App.state.pyodideLoading = false;
                this.hideLoading();
            }
        },
        async loadLua() {
            if (App.state.luaReady || App.state.luaLoading) return;
            App.state.luaLoading = true;
            try {
                App.state.fengari = window.fengari;
                if(App.state.fengari) App.state.luaReady = true;
            } catch(e) {
                this.log(`Error loading Lua: ${e.message}`, 'error');
            } finally {
                App.state.luaLoading = false;
            }
        },

        // --- Runtimes ---
        async runJS(code) {
            const originalLog = console.log;
            console.log = (...args) => this.log(args.join(' '));
            try {
                new Function(code)();
            } catch (e) {
                this.log(e.stack, 'error');
            } finally {
                console.log = originalLog;
            }
        },
        async runPython(code) {
            if (!App.state.pyodideReady) {
                await this.loadPython();
            }
             if (!App.state.pyodideReady) {
                this.log('Python environment could not be loaded.', 'error');
                return;
            }
            try {
                const stdout = [];
                const stderr = [];
                App.state.pyodide.setStdout({ batched: (s) => stdout.push(s) });
                App.state.pyodide.setStderr({ batched: (s) => stderr.push(s) });
                await App.state.pyodide.runPythonAsync(code);
                if (stdout.length) this.log(stdout.join('\n'));
                if (stderr.length) this.log(stderr.join('\n'), 'error');
            } catch (e) {
                this.log(e.message, 'error');
            }
        },
        async runLua(code) {
             if (!App.state.luaReady) {
                this.log('Lua environment not loaded.', 'error');
                return;
             }
             const fengari = App.state.fengari;
             const L = fengari.lauxlib.luaL_newstate();
             fengari.lualib.luaL_openlibs(L);
             const capturedOutput = [];
             fengari.lua.lua_pushcfunction(L, () => {
                 const nargs = fengari.lua.lua_gettop(L);
                 let s = "";
                 for (let i = 1; i <= nargs; i++) s += fengari.lua.lua_tojsstring(L, i) + (i < nargs ? "\t" : "");
                 capturedOutput.push(s);
                 return 0;
             });
             fengari.lua.lua_setglobal(L, "print");
             
             const status = fengari.lualib.luaL_dostring(L, fengari.to_luastring(code));
             if (status !== 0) {
                 this.log(fengari.lua.lua_tojsstring(L, -1), 'error');
             }
             if (capturedOutput.length) this.log(capturedOutput.join('\n'));
        }
    };

    // Kick off the application
    document.addEventListener('DOMContentLoaded', () => {
        App.init();
    });

</script>
</body>
</html>
